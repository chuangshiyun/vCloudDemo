!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(self,(function(){return(()=>{var e={508:function(e,t,r){var n;function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}
/*!
 * EventEmitter v5.2.8 - git.io/ee
 * Unlicense - http://unlicense.org/
 * Oliver Caldwell - https://oli.me.uk/
 * @preserve
 */!function(t){"use strict";function a(){}var o=a.prototype,s=t.EventEmitter;function c(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function u(e){return function(){return this[e].apply(this,arguments)}}function d(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!==i(e))&&d(e.listener)}o.getListeners=function(e){var t,r,n=this._getEvents();if(e instanceof RegExp)for(r in t={},n)n.hasOwnProperty(r)&&e.test(r)&&(t[r]=n[r]);else t=n[e]||(n[e]=[]);return t},o.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},o.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&((t={})[e]=r),t||r},o.addListener=function(e,t){if(!d(t))throw new TypeError("listener must be a function");var r,n=this.getListenersAsObject(e),a="object"===i(t);for(r in n)n.hasOwnProperty(r)&&-1===c(n[r],t)&&n[r].push(a?t:{listener:t,once:!1});return this},o.on=u("addListener"),o.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},o.once=u("addOnceListener"),o.defineEvent=function(e){return this.getListeners(e),this},o.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},o.removeListener=function(e,t){var r,n,i=this.getListenersAsObject(e);for(n in i)i.hasOwnProperty(n)&&-1!==(r=c(i[n],t))&&i[n].splice(r,1);return this},o.off=u("removeListener"),o.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},o.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},o.manipulateListeners=function(e,t,r){var n,a,o=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!==i(t)||t instanceof RegExp)for(n=r.length;n--;)o.call(this,t,r[n]);else for(n in t)t.hasOwnProperty(n)&&(a=t[n])&&("function"==typeof a?o.call(this,n,a):s.call(this,n,a));return this},o.removeEvent=function(e){var t,r=i(e),n=this._getEvents();if("string"===r)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},o.removeAllListeners=u("removeEvent"),o.emitEvent=function(e,t){var r,n,i,a,o=this.getListenersAsObject(e);for(a in o)if(o.hasOwnProperty(a))for(r=o[a].slice(0),i=0;i<r.length;i++)!0===(n=r[i]).once&&this.removeListener(e,n.listener),n.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},o.trigger=u("emitEvent"),o.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},o.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},o._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},o._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return t.EventEmitter=s,a},void 0===(n=function(){return a}.call(t,r,t,e))||(e.exports=n)}("undefined"!=typeof window?window:this||{})},703:(e,t,r)=>{var n,i,a,o;function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}o=function(){return function e(t,r,n){function i(o,s){if(!r[o]){if(!t[o]){if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[o]={exports:{}};t[o][0].call(u.exports,(function(e){return i(t[o][1][e]||e)}),u,u.exports,e,t,r,n)}return r[o].exports}for(var a=void 0,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){"use strict";var n=e("sdp");function i(e,t,r,i,a){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":a||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var c="msid:"+(i?i.id:"-")+" "+s+"\r\n";o+="a="+c,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o}function a(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},i=function(e,t,r,i){var a=n(e.parameters.apt,r),o=n(t.parameters.apt,i);return a&&o&&a.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var a=0;a<t.codecs.length;a++){var o=t.codecs[a];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!i(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}})),r}function o(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function s(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,r,n,i){var a=new Event("track");a.track=r,a.receiver=n,a.transceiver={receiver:n},a.streams=i,e.setTimeout((function(){t._dispatchEvent("track",a)}))}var d=function(r){var i=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){i[e]=a[e].bind(a)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof n;return i&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=i?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var o=r.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=n.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(d.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(d.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),d.prototype.onicecandidate=null,d.prototype.onaddstream=null,d.prototype.ontrack=null,d.prototype.onremovestream=null,d.prototype.onsignalingstatechange=null,d.prototype.oniceconnectionstatechange=null,d.prototype.onconnectionstatechange=null,d.prototype.onicegatheringstatechange=null,d.prototype.onnegotiationneeded=null,d.prototype.ondatachannel=null,d.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},d.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},d.prototype.getConfiguration=function(){return this._config},d.prototype.getLocalStreams=function(){return this.localStreams},d.prototype.getRemoteStreams=function(){return this.remoteStreams},d.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport,n.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(n),n},d.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(n=this.transceivers[i]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},d.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),n.getTracks().forEach((function(e){r.addTrack(e,n)}))}},d.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},d.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},d.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},d.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},d.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;i.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},d.prototype._gather=function(t,r){var i=this,a=this.transceivers[r].iceGatherer;if(!a.onlocalcandidate){var o=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),a.onlocalcandidate=function(e){if(!(i.usingBundle&&r>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:r};var s=e.candidate,c=!s||0===Object.keys(s).length;if(c)"new"!==a.state&&"gathering"!==a.state||(a.state="completed");else{"new"===a.state&&(a.state="gathering"),s.component=1,s.ufrag=a.getLocalParameters().usernameFragment;var u=n.writeCandidate(s);o.candidate=Object.assign(o.candidate,n.parseCandidate(u)),o.candidate.candidate=u,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var d=n.getMediaSections(i._localDescription.sdp);d[o.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",i._localDescription.sdp=n.getDescription(i._localDescription.sdp)+d.join("");var l=i.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",o),l&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout((function(){o.forEach((function(e){a.onlocalcandidate(e)}))}),0)}},d.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:n}},d.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},d.prototype._transceive=function(e,r,i){var o=a(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:n.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),i&&e.rtpReceiver&&o.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},d.prototype.setLocalDescription=function(e){var t,r,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=n.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=n.parseRtpParameters(e);i.transceivers[t].localCapabilities=r})),i.transceivers.forEach((function(e,t){i._gather(e.mid,t)}));else if("answer"===e.type){t=n.splitSections(i._remoteDescription.sdp),r=t.shift();var s=n.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var o=i.transceivers[t],c=o.iceGatherer,u=o.iceTransport,d=o.dtlsTransport,l=o.localCapabilities,h=o.remoteCapabilities;if(!(n.isRejected(e)&&0===n.matchPrefix(e,"a=bundle-only").length||o.rejected)){var m=n.getIceParameters(e,r),p=n.getDtlsParameters(e,r);s&&(p.role="server"),i.usingBundle&&0!==t||(i._gather(o.mid,t),"new"===u.state&&u.start(c,m,s?"controlling":"controlled"),"new"===d.state&&d.start(p));var f=a(l,h);i._transceive(o,f.codecs.length>0,!1)}}))}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},d.prototype.setRemoteDescription=function(i){var d=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!o("setRemoteDescription",i.type,d.signalingState)||d._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+d.signalingState));var l={};d.remoteStreams.forEach((function(e){l[e.id]=e}));var h=[],m=n.splitSections(i.sdp),p=m.shift(),f=n.matchPrefix(p,"a=ice-lite").length>0,v=n.matchPrefix(p,"a=group:BUNDLE ").length>0;d.usingBundle=v;var _=n.matchPrefix(p,"a=ice-options:")[0];return d.canTrickleIceCandidates=!!_&&_.substr(14).split(" ").indexOf("trickle")>=0,m.forEach((function(o,c){var u=n.splitLines(o),m=n.getKind(o),_=n.isRejected(o)&&0===n.matchPrefix(o,"a=bundle-only").length,E=u[0].substr(2).split(" ")[2],S=n.getDirection(o,p),C=n.parseMsid(o),T=n.getMid(o)||n.generateIdentifier();if(_||"application"===m&&("DTLS/SCTP"===E||"UDP/DTLS/SCTP"===E))d.transceivers[c]={mid:T,kind:m,protocol:E,rejected:!0};else{var g,R,A,O,I,P,y,N,b;!_&&d.transceivers[c]&&d.transceivers[c].rejected&&(d.transceivers[c]=d._createTransceiver(m,!0));var D,U,L=n.parseRtpParameters(o);_||(D=n.getIceParameters(o,p),(U=n.getDtlsParameters(o,p)).role="client"),y=n.parseRtpEncodingParameters(o);var k=n.parseRtcpParameters(o),M=n.matchPrefix(o,"a=end-of-candidates",p).length>0,w=n.matchPrefix(o,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===i.type||"answer"===i.type)&&!_&&v&&c>0&&d.transceivers[c]&&(d._disposeIceAndDtlsTransports(c),d.transceivers[c].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[c].iceTransport=d.transceivers[0].iceTransport,d.transceivers[c].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[c].rtpSender&&d.transceivers[c].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[c].rtpReceiver&&d.transceivers[c].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),"offer"!==i.type||_)"answer"!==i.type||_||(R=(g=d.transceivers[c]).iceGatherer,A=g.iceTransport,O=g.dtlsTransport,I=g.rtpReceiver,P=g.sendEncodingParameters,N=g.localCapabilities,d.transceivers[c].recvEncodingParameters=y,d.transceivers[c].remoteCapabilities=L,d.transceivers[c].rtcpParameters=k,w.length&&"new"===A.state&&(!f&&!M||v&&0!==c?w.forEach((function(e){s(g.iceTransport,e)})):A.setRemoteCandidates(w)),v&&0!==c||("new"===A.state&&A.start(R,D,"controlling"),"new"===O.state&&O.start(U)),!a(g.localCapabilities,g.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&g.sendEncodingParameters[0].rtx&&delete g.sendEncodingParameters[0].rtx,d._transceive(g,"sendrecv"===S||"recvonly"===S,"sendrecv"===S||"sendonly"===S),!I||"sendrecv"!==S&&"sendonly"!==S?delete g.rtpReceiver:(b=I.track,C?(l[C.stream]||(l[C.stream]=new e.MediaStream),r(b,l[C.stream]),h.push([b,I,l[C.stream]])):(l.default||(l.default=new e.MediaStream),r(b,l.default),h.push([b,I,l.default]))));else{(g=d.transceivers[c]||d._createTransceiver(m)).mid=T,g.iceGatherer||(g.iceGatherer=d._createIceGatherer(c,v)),w.length&&"new"===g.iceTransport.state&&(!M||v&&0!==c?w.forEach((function(e){s(g.iceTransport,e)})):g.iceTransport.setRemoteCandidates(w)),N=e.RTCRtpReceiver.getCapabilities(m),t<15019&&(N.codecs=N.codecs.filter((function(e){return"rtx"!==e.name}))),P=g.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var H,G=!1;"sendrecv"===S||"sendonly"===S?(G=!g.rtpReceiver,I=g.rtpReceiver||new e.RTCRtpReceiver(g.dtlsTransport,m),G&&(b=I.track,C&&"-"===C.stream||(C?(l[C.stream]||(l[C.stream]=new e.MediaStream,Object.defineProperty(l[C.stream],"id",{get:function(){return C.stream}})),Object.defineProperty(b,"id",{get:function(){return C.track}}),H=l[C.stream]):(l.default||(l.default=new e.MediaStream),H=l.default)),H&&(r(b,H),g.associatedRemoteMediaStreams.push(H)),h.push([b,I,H]))):g.rtpReceiver&&g.rtpReceiver.track&&(g.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===g.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),g.associatedRemoteMediaStreams=[]),g.localCapabilities=N,g.remoteCapabilities=L,g.rtpReceiver=I,g.rtcpParameters=k,g.sendEncodingParameters=P,g.recvEncodingParameters=y,d._transceive(d.transceivers[c],!1,G)}}})),void 0===d._dtlsRole&&(d._dtlsRole="offer"===i.type?"active":"passive"),d._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable"),Object.keys(l).forEach((function(t){var r=l[t];if(r.getTracks().length){if(-1===d.remoteStreams.indexOf(r)){d.remoteStreams.push(r);var n=new Event("addstream");n.stream=r,e.setTimeout((function(){d._dispatchEvent("addstream",n)}))}h.forEach((function(e){var t=e[0],n=e[1];r.id===e[2].id&&u(d,t,n,[r])}))}})),h.forEach((function(e){e[2]||u(d,e[0],e[1],[])})),e.setTimeout((function(){d&&d.transceivers&&d.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},d.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},d.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},d.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},d.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},d.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},d.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var a=r.transceivers.filter((function(e){return"audio"===e.kind})).length,o=r.transceivers.filter((function(e){return"video"===e.kind})).length,s=arguments[0];if(s){if(s.mandatory||s.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(a=!0===s.offerToReceiveAudio?1:!1===s.offerToReceiveAudio?0:s.offerToReceiveAudio),void 0!==s.offerToReceiveVideo&&(o=!0===s.offerToReceiveVideo?1:!1===s.offerToReceiveVideo?0:s.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--a<0&&(e.wantReceive=!1):"video"===e.kind&&--o<0&&(e.wantReceive=!1)}));a>0||o>0;)a>0&&(r._createTransceiver("audio"),a--),o>0&&(r._createTransceiver("video"),o--);var u=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(i,a){var o=i.track,s=i.kind,c=i.mid||n.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=r._createIceGatherer(a,r.usingBundle));var u=e.RTCRtpSender.getCapabilities(s);t<15019&&(u.codecs=u.codecs.filter((function(e){return"rtx"!==e.name}))),u.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),u.headerExtensions.forEach((function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=i.sendEncodingParameters||[{ssrc:1001*(2*a+1)}];o&&t>=15019&&"video"===s&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,s)),i.localCapabilities=u,i.sendEncodingParameters=d})),"max-compat"!==r._config.bundlePolicy&&(u+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){u+=i(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),u+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,u+="a="+n.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))}));var d=new e.RTCSessionDescription({type:"offer",sdp:u});return Promise.resolve(d)},d.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var o=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(o+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n";var s=n.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,n){if(!(n+1>s)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?o+="m=application 0 DTLS/SCTP 5000\r\n":o+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var u=a(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=i(e,u,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}}));var u=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(u)},d.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(i,a){if(!r._remoteDescription)return a(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var u=0;u<r.transceivers.length;u++)if(r.transceivers[u].mid===e.sdpMid){o=u;break}var d=r.transceivers[o];if(!d)return a(c("OperationError","Can not add ICE candidate"));if(d.rejected)return i();var l=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===l.protocol&&(0===l.port||9===l.port))return i();if(l.component&&1!==l.component)return i();if((0===o||o>0&&d.iceTransport!==r.transceivers[0].iceTransport)&&!s(d.iceTransport,l))return a(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=n.getMediaSections(r._remoteDescription.sdp))[o]+="a="+(l.type?h:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var m=0;m<r.transceivers.length&&(r.transceivers[m].rejected||(r.transceivers[m].iceTransport.addRemoteCandidate({}),(t=n.getMediaSections(r._remoteDescription.sdp))[m]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));m++);i()}))},d.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r])})),t}))}}}));var l=["createOffer","createAnswer"];return l.forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(l=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),d}},{sdp:2}],2:[function(e,t,r){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},n.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},n.getIceParameters=function(e,t){var r=n.splitLines(e);return{usernameFragment:(r=r.concat(n.splitLines(t))).filter((function(e){return 0===e.indexOf("a=ice-ufrag:")}))[0].substr(12),password:r.filter((function(e){return 0===e.indexOf("a=ice-pwd:")}))[0].substr(10)}},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var a=r[i],o=n.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(o){var s=n.parseRtpMap(o),c=n.matchPrefix(e,"a=fmtp:"+a+" ");switch(s.parameters=c.length?n.parseFmtp(c[0]):{},s.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(n.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(n.parseExtmap(e))})),t},n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)}));var i=0;return t.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=n.writeExtmap(e)})),r},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),a=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=s.length>0&&s[0].ssrc,u=n.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(n.rtx={ssrc:t}),r.push(n),a&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},r.push(n))}})),0===r.length&&c&&r.push({ssrc:c});var d=n.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=d}))),r},n.parseRtcpParameters=function(e){var t={},r=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var a=n.matchPrefix(e,"a=rtcp-mux");return t.mux=a.length>0,t},n.parseMsid=function(e){var t,r=n.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||n.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var a=n.writeRtpDescription(e.kind,t);if(a+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),a},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"===s(t)&&(t.exports=n)},{}],3:[function(e,t,n){(function(r){"use strict";var n=e("./adapter_factory.js");t.exports=n({window:r.window})}).call(this,void 0!==r.g?r.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(e,t,r){"use strict";var n=e("./utils");t.exports=function(t,r){var i=t&&t.window,a={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var o in r)hasOwnProperty.call(r,o)&&(a[o]=r[o]);var s=n.log,c=n.detectBrowser(i),u=e("./chrome/chrome_shim")||null,d=e("./edge/edge_shim")||null,l=e("./firefox/firefox_shim")||null,h=e("./safari/safari_shim")||null,m=e("./common_shim")||null,p={browserDetails:c,commonShim:m,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings};switch(c.browser){case"chrome":if(!u||!u.shimPeerConnection||!a.shimChrome)return s("Chrome shim is not included in this adapter release."),p;s("adapter.js shimming chrome."),p.browserShim=u,m.shimCreateObjectURL(i),u.shimGetUserMedia(i),u.shimMediaStream(i),u.shimSourceObject(i),u.shimPeerConnection(i),u.shimOnTrack(i),u.shimAddTrackRemoveTrack(i),u.shimGetSendersWithDtmf(i),u.shimSenderReceiverGetStats(i),u.fixNegotiationNeeded(i),m.shimRTCIceCandidate(i),m.shimMaxMessageSize(i),m.shimSendThrowTypeError(i);break;case"firefox":if(!l||!l.shimPeerConnection||!a.shimFirefox)return s("Firefox shim is not included in this adapter release."),p;s("adapter.js shimming firefox."),p.browserShim=l,m.shimCreateObjectURL(i),l.shimGetUserMedia(i),l.shimSourceObject(i),l.shimPeerConnection(i),l.shimOnTrack(i),l.shimRemoveStream(i),l.shimSenderGetStats(i),l.shimReceiverGetStats(i),l.shimRTCDataChannel(i),m.shimRTCIceCandidate(i),m.shimMaxMessageSize(i),m.shimSendThrowTypeError(i);break;case"edge":if(!d||!d.shimPeerConnection||!a.shimEdge)return s("MS edge shim is not included in this adapter release."),p;s("adapter.js shimming edge."),p.browserShim=d,m.shimCreateObjectURL(i),d.shimGetUserMedia(i),d.shimPeerConnection(i),d.shimReplaceTrack(i),m.shimMaxMessageSize(i),m.shimSendThrowTypeError(i);break;case"safari":if(!h||!a.shimSafari)return s("Safari shim is not included in this adapter release."),p;s("adapter.js shimming safari."),p.browserShim=h,m.shimCreateObjectURL(i),h.shimRTCIceServerUrls(i),h.shimCreateOfferLegacy(i),h.shimCallbacksAPI(i),h.shimLocalStreamsAPI(i),h.shimRemoteStreamsAPI(i),h.shimTrackEventTransceiver(i),h.shimGetUserMedia(i),m.shimRTCIceCandidate(i),m.shimMaxMessageSize(i),m.shimSendThrowTypeError(i);break;default:s("Unsupported browser!")}return p}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],5:[function(e,t,r){"use strict";var n=e("../utils.js"),i=n.log;function a(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(n){n.endsWith("Id")?a(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach((function(t){a(e,e.get(t),r)}))})))}function o(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var o=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((function(t){e.forEach((function(r){r.type===n&&r.trackId===t.id&&a(e,r,i)}))})),i}t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"===s(e)&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return r._ontrackpoly||(r._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(n){var i;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.track.id})):{track:n.track};var a=new Event("track");a.track=n.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)})),t.stream.getTracks().forEach((function(n){var i;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.id})):{track:n};var a=new Event("track");a.track=n,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)}))},r.addEventListener("addstream",r._ontrackpoly)),t.apply(r,arguments)}}else n.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}))},shimGetSendersWithDtmf:function(e){if("object"===s(e)&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){var i=this,a=r.apply(i,arguments);return a||(a=t(i,e),i._senders.push(a)),a};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;n.apply(t,arguments);var r=t._senders.indexOf(e);-1!==r&&t._senders.splice(r,1)}}var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;r._senders=r._senders||[],i.apply(r,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],a.apply(t,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===s(e)&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(e,[]);return t.forEach((function(t){t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSenderReceiverGetStats:function(e){if("object"===s(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach((function(t){t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return o(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=i.apply(e,[]);return t.forEach((function(t){t._pc=e})),t}),n.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return o(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var t=this;if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var r,n,i,o=arguments[0];return t.getSenders().forEach((function(e){e.track===o&&(r?i=!0:r=e)})),t.getReceivers().forEach((function(e){return e.track===o&&(n?i=!0:n=e),e.track===o})),i||r&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return a.apply(t,arguments)}}}},shimSourceObject:function(e){var t=e&&e.URL;"object"===s(e)&&e.HTMLMediaElement&&!("srcObject"in e.HTMLMediaElement.prototype)&&Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var r=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",(function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)})),e.addEventListener("removetrack",(function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)}))):this.src=""}})},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var n=t.getSenders();r.apply(this,arguments);var i=t.getSenders().filter((function(e){return-1===n.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(i)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var n=t._shimmedLocalStreams[r].indexOf(e);-1!==n&&t._shimmedLocalStreams[r].splice(n,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),i.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){var t=n.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return this.shimAddTrackRemoveTrackWithNative(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!r._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());r._streams[t.id]=n,r._reverseStreams[n.id]=t,t=n}i.apply(r,[t])};var a=e.RTCPeerConnection.prototype.removeStream;function o(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function s(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},a.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var a=n.getSenders().find((function(e){return e.track===t}));if(a)throw new DOMException("Track already exists.","InvalidAccessError");n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{};var o=n._streams[r.id];if(o)o.addTrack(t),Promise.resolve().then((function(){n.dispatchEvent(new Event("negotiationneeded"))}));else{var s=new e.MediaStream([t]);n._streams[r.id]=s,n._reverseStreams[s.id]=r,n.addStream(s)}return n.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments,n=arguments.length&&"function"==typeof arguments[0];return n?r.apply(e,[function(r){var n=o(e,r);t[0].apply(null,[n])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(e,arguments).then((function(t){return o(e,t)}))}}));var c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;return arguments.length&&arguments[0].type?(arguments[0]=s(e,arguments[0]),c.apply(e,arguments)):c.apply(e,arguments)};var u=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=u.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==r)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");r._streams=r._streams||{},Object.keys(r._streams).forEach((function(n){r._streams[n].getTracks().find((function(t){return e.track===t}))&&(t=r._streams[n])})),t&&(1===t.getTracks().length?r.removeStream(r._reverseStreams[t.id]):t.removeTrack(e.track),r.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=n.detectBrowser(e);!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=function(t,r){return i("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,r)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}}));var r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var i=this,a=arguments;if(arguments.length>0&&"function"==typeof e)return r.apply(this,arguments);if(0===r.length&&(0===arguments.length||"function"!=typeof arguments[0]))return r.apply(this,[]);var o=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},s=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var c=function(e){a[1](s(o(e)))};return r.apply(this,[c,arguments[0]])}return new Promise((function(e,t){r.apply(i,[function(t){e(s(o(t)))},t])})).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,n=new Promise((function(n,i){r.apply(t,[e[0],n,i])}));return e.length<2?n:n.then((function(){e[1].apply(null,[])}),(function(t){e.length>=3&&e[2].apply(null,[t])}))}})),t.version<52&&["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"===s(arguments[0])){var t=1===arguments.length?arguments[0]:void 0;return new Promise((function(n,i){r.apply(e,[n,i,t])}))}return r.apply(this,arguments)}})),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var a=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},fixNegotiationNeeded:function(e){n.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}))},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||("function"==typeof t?navigator.getDisplayMedia=function(e){return t(e).then((function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},navigator.mediaDevices.getUserMedia(e)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}}},{"../utils.js":14,"./getusermedia":6}],6:[function(e,t,r){"use strict";var n=e("../utils.js"),i=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,a=function(e){if("object"!==s(e)||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n="object"===s(e[r])?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var a={};"number"==typeof n.ideal?(a[i("min",r)]=n.ideal,t.optional.push(a),(a={})[i("max",r)]=n.ideal,t.optional.push(a)):(a[i("",r)]=n.ideal,t.optional.push(a))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",r)]=n.exact):["min","max"].forEach((function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,r)]=n[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===s(e.audio)){var o=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};o((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),o(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"===s(e.video)){var c=e.video.facingMode;c=c&&("object"===s(c)?c:{ideal:c});var u,d=t.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||d)&&(delete e.video.facingMode,"environment"===c.exact||"environment"===c.ideal?u=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(u=["front"]),u))return r.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return u.some((function(t){return-1!==e.label.toLowerCase().indexOf(t)}))}));return!r&&t.length&&-1!==u.indexOf("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=c.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=a(e.video),i("chrome: "+JSON.stringify(e)),n(e)}));e.video=a(e.video)}return i("chrome: "+JSON.stringify(e)),n(e)},c=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};r.getUserMedia=function(e,t,n){o(e,(function(e){r.webkitGetUserMedia(e,t,(function(e){n&&n(c(e))}))}))};var u=function(e){return new Promise((function(t,n){r.getUserMedia(e,t,n)}))};if(r.mediaDevices||(r.mediaDevices={getUserMedia:u,enumerateDevices:function(){return new Promise((function(t){var r={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources((function(e){t(e.map((function(e){return{label:e.label,kind:r[e.kind],deviceId:e.id,groupId:""}})))}))}))},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),r.mediaDevices.getUserMedia){var d=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return o(e,(function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(c(e))}))}))}}else r.mediaDevices.getUserMedia=function(e){return u(e)};void 0===r.mediaDevices.addEventListener&&(r.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),void 0===r.mediaDevices.removeEventListener&&(r.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":14}],7:[function(e,t,r){"use strict";var n=e("sdp"),i=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===s(e)&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),i=n.parseCandidate(e.candidate),a=Object.assign(r,i);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,i.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"===s(e)&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var r=t.createObjectURL.bind(t),n=t.revokeObjectURL.bind(t),a=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;return a.set(t,e),i.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return r(e)},t.revokeObjectURL=function(e){n(e),a.delete(e)};var c=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return c.get.apply(this)},set:function(e){return this.srcObject=a.get(e)||null,c.set.apply(this,[e])}});var u=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=a.get(arguments[1])||null),u.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=i.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){var t=n.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=n.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},a=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},o=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},s=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var a=n.matchPrefix(e.sdp,"a=max-message-size:");return a.length>0?i=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;if(e._sctp=null,r(arguments[0])){var t,n=a(arguments[0]),i=o(n),u=s(arguments[0],n);t=0===i&&0===u?Number.POSITIVE_INFINITY:0===i||0===u?Math.max(i,u):Math.min(i,u);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return t}}),e._sctp=d}return c.apply(e,arguments)}}},shimSendThrowTypeError:function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=this,n=t.apply(e,arguments);return r(n,e),n},i.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}}}},{"./utils":14,sdp:2}],8:[function(e,t,r){"use strict";var n=e("../utils"),i=e("./filtericeservers"),a=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=n.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var o=a(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=i(e.iceServers)),new o(e)},e.RTCPeerConnection.prototype=o.prototype},shimReplaceTrack:function(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}}},{"../utils":14,"./filtericeservers":9,"./getusermedia":10,"rtcpeerconnection-shim":1}],9:[function(e,t,r){"use strict";var n=e("../utils");t.exports=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&n.deprecated("RTCIceServer.url","RTCIceServer.urls");var a="string"==typeof i;return a&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=a?i[0]:i,!!i.length}}))}},{"../utils":14}],10:[function(e,t,r){"use strict";t.exports=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],11:[function(e,t,r){"use strict";var n=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){"object"===s(e)&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)&&Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var r=new Event("track");r.track=t,r.receiver={track:t},r.transceiver={receiver:r.receiver},r.streams=[e.stream],this.dispatchEvent(r)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"===s(e)&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"===s(e)&&e.HTMLMediaElement&&!("srcObject"in e.HTMLMediaElement.prototype)&&Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}})},shimPeerConnection:function(e){var t=n.detectBrowser(e);if("object"===s(e)&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(r,n){if(t.version<38&&r&&r.iceServers){for(var i=[],a=0;a<r.iceServers.length;a++){var o=r.iceServers[a];if(o.hasOwnProperty("urls"))for(var s=0;s<o.urls.length;s++){var c={url:o.urls[s]};0===o.urls[s].indexOf("turn")&&(c.username=o.username,c.credential=o.credential),i.push(c)}else i.push(r.iceServers[a])}r.iceServers=i}return new e.mozRTCPeerConnection(r,n)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}));var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,n){return a.apply(this,[e||null]).then((function(e){if(t.version<48&&(e=function(e){var t=new Map;return Object.keys(e).forEach((function(r){t.set(r,e[r]),t[r]=e[r]})),t}(e)),t.version<53&&!r)try{e.forEach((function(e){e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,n)}}},shimSenderGetStats:function(e){if("object"===s(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach((function(t){t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(e){if("object"===s(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(e,[]);return r.forEach((function(t){t._pc=e})),r}),n.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},shimRemoveStream:function(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;n.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&-1!==e.getTracks().indexOf(r.track)&&t.removeTrack(r)}))})},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(!e||!e.video){var r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return!0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e)})}}},{"../utils":14,"./getusermedia":12}],12:[function(e,t,r){"use strict";var n=e("../utils"),i=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,a=e&&e.MediaStreamTrack,o=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},c=function(e,n,a){var c=function(e){if("object"!==s(e)||e.require)return e;var t=[];return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n=e[r]="object"===s(e[r])?e[r]:{ideal:e[r]};if(void 0===n.min&&void 0===n.max&&void 0===n.exact||t.push(r),void 0!==n.exact&&("number"==typeof n.exact?n.min=n.max=n.exact:e[r]=n.exact,delete n.exact),void 0!==n.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof n.ideal?i[r]={min:n.ideal,max:n.ideal}:i[r]=n.ideal,e.advanced.push(i),delete n.ideal,Object.keys(n).length||delete e[r]}}})),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(i("spec: "+JSON.stringify(e)),e.audio&&(e.audio=c(e.audio)),e.video&&(e.video=c(e.video)),i("ff37: "+JSON.stringify(e))),r.mozGetUserMedia(e,n,(function(e){a(o(e))}))};if(r.mediaDevices||(r.mediaDevices={getUserMedia:function(e){return new Promise((function(t,r){c(e,t,r)}))},addEventListener:function(){},removeEventListener:function(){}}),r.mediaDevices.enumerateDevices=r.mediaDevices.enumerateDevices||function(){return new Promise((function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])}))},t.version<41){var u=r.mediaDevices.enumerateDevices.bind(r.mediaDevices);r.mediaDevices.enumerateDevices=function(){return u().then(void 0,(function(e){if("NotFoundError"===e.name)return[];throw e}))}}if(t.version<49){var d=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("The object can not be found here.","NotFoundError");return t}),(function(e){return Promise.reject(o(e))}))}}if(!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var l=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},h=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===s(e)&&"object"===s(e.audio)&&(e=JSON.parse(JSON.stringify(e)),l(e.audio,"autoGainControl","mozAutoGainControl"),l(e.audio,"noiseSuppression","mozNoiseSuppression")),h(e)},a&&a.prototype.getSettings){var m=a.prototype.getSettings;a.prototype.getSettings=function(){var e=m.apply(this,arguments);return l(e,"mozAutoGainControl","autoGainControl"),l(e,"mozNoiseSuppression","noiseSuppression"),e}}if(a&&a.prototype.applyConstraints){var p=a.prototype.applyConstraints;a.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===s(e)&&(e=JSON.parse(JSON.stringify(e)),l(e,"autoGainControl","mozAutoGainControl"),l(e,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[e])}}}r.getUserMedia=function(e,i,a){if(t.version<44)return c(e,i,a);n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(i,a)}}},{"../utils":14}],13:[function(e,t,r){"use strict";var n=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if("object"===s(e)&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach((function(r){r.id===e&&(t=r)})),this._remoteStreams&&this._remoteStreams.forEach((function(r){r.id===e&&(t=r)})),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var r=this;e.getTracks().forEach((function(n){t.call(r,n,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?-1===this._localStreams.indexOf(r)&&this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var r=this,n=e.getTracks();this.getSenders().forEach((function(e){-1!==n.indexOf(e.track)&&r.removeTrack(e)}))}})}},shimRemoteStreamsAPI:function(e){if("object"===s(e)&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}},shimCallbacksAPI:function(e){if("object"===s(e)&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,i=t.setLocalDescription,a=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};var c=function(e,t,r){var n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=c,c=function(e,t,r){var n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=c,c=function(e,t,r){var n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=c}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],a=0;a<e.iceServers.length;a++){var o=e.iceServers[a];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,i.push(o)):i.push(e.iceServers[a])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"===s(e)&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var r=this;if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var n=r.getTransceivers().find((function(e){return e.sender.track&&"audio"===e.sender.track.kind}));!1===e.offerToReceiveAudio&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveAudio||n||r.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=r.getTransceivers().find((function(e){return e.sender.track&&"video"===e.sender.track.kind}));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection("sendonly"):"recvonly"===i.direction&&i.setDirection("inactive"):!0!==e.offerToReceiveVideo||i||r.addTransceiver("video")}return t.apply(r,arguments)}}}},{"../utils":14}],14:[function(e,t,r){"use strict";var n=!0,i=!0;function a(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}t.exports={extractVersion:a,wrapPeerConnectionEvent:function(e,t,r){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);var a=function(e){var t=r(e);t&&n(t)};return this._eventMap=this._eventMap||{},this._eventMap[n]=a,i.apply(this,[e,a])};var a=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return a.apply(this,arguments);var n=this._eventMap[r];return delete this._eventMap[r],a.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+s(e)+". Please use a boolean."):(n=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+s(e)+". Please use a boolean."):(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"===("undefined"==typeof window?"undefined":s(window))){if(n)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var t=e&&e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r}}},{}]},{},[3])(3)},"object"===s(t)?e.exports=o():(i=[],void 0===(a="function"==typeof(n=o)?n.apply(t,i):n)||(e.exports=a))},61:function(e,t){var r,n,i,a;function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}a=function(e){"use strict";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1),e.encode=function(e){var r,n,i,a,o,s;if(e){for(i=e.length,n=0,r="";n<i;){if(a=255&e.charCodeAt(n++),n==i){r+=t.charAt(a>>2),r+=t.charAt((3&a)<<4),r+="==";break}if(o=e.charCodeAt(n++),n==i){r+=t.charAt(a>>2),r+=t.charAt((3&a)<<4|(240&o)>>4),r+=t.charAt((15&o)<<2),r+="=";break}s=e.charCodeAt(n++),r+=t.charAt(a>>2),r+=t.charAt((3&a)<<4|(240&o)>>4),r+=t.charAt((15&o)<<2|(192&s)>>6),r+=t.charAt(63&s)}return r}},Object.defineProperty(e,"__esModule",{value:!0})},"object"===o(t)?a(t):(n=[t],void 0===(i="function"==typeof(r=a)?r.apply(t,n):r)||(e.exports=i))},99:function(e,t){var r,n,i,a;function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}
/*!
 * md5js v1.0.7
 * (c) 2017-2018 penyuying
 * Released under the MIT License.
 */a=function(e){"use strict";e.md5=function(e,t){var r=e;function n(e,t){return e<<t|e>>>32-t}function i(e,t){var r,n,i,a,o;return i=2147483648&e,a=2147483648&t,o=(1073741823&e)+(1073741823&t),(r=1073741824&e)&(n=1073741824&t)?2147483648^o^i^a:r|n?1073741824&o?3221225472^o^i^a:1073741824^o^i^a:o^i^a}function a(e,t,r,a,o,s,c){return e=i(e,i(i(function(e,t,r){return e&t|~e&r}(t,r,a),o),c)),i(n(e,s),t)}function o(e,t,r,a,o,s,c){return e=i(e,i(i(function(e,t,r){return e&r|t&~r}(t,r,a),o),c)),i(n(e,s),t)}function s(e,t,r,a,o,s,c){return e=i(e,i(i(function(e,t,r){return e^t^r}(t,r,a),o),c)),i(n(e,s),t)}function c(e,t,r,a,o,s,c){return e=i(e,i(i(function(e,t,r){return t^(e|~r)}(t,r,a),o),c)),i(n(e,s),t)}function u(e){var t,r="",n="";for(t=0;t<=3;t++)r+=(n="0"+(e>>>8*t&255).toString(16)).substr(n.length-2,2);return r}var d,l,h,m,p,f,v,_,E,S=Array();for(S=function(e){for(var t,r=e.length,n=r+8,i=16*((n-n%64)/64+1),a=Array(i-1),o=0,s=0;s<r;)o=s%4*8,a[t=(s-s%4)/4]=a[t]|e.charCodeAt(s)<<o,s++;return o=s%4*8,a[t=(s-s%4)/4]=a[t]|128<<o,a[i-2]=r<<3,a[i-1]=r>>>29,a}(r),f=1732584193,v=4023233417,_=2562383102,E=271733878,d=0;d<S.length;d+=16)l=f,h=v,m=_,p=E,f=a(f,v,_,E,S[d+0],7,3614090360),E=a(E,f,v,_,S[d+1],12,3905402710),_=a(_,E,f,v,S[d+2],17,606105819),v=a(v,_,E,f,S[d+3],22,3250441966),f=a(f,v,_,E,S[d+4],7,4118548399),E=a(E,f,v,_,S[d+5],12,1200080426),_=a(_,E,f,v,S[d+6],17,2821735955),v=a(v,_,E,f,S[d+7],22,4249261313),f=a(f,v,_,E,S[d+8],7,1770035416),E=a(E,f,v,_,S[d+9],12,2336552879),_=a(_,E,f,v,S[d+10],17,4294925233),v=a(v,_,E,f,S[d+11],22,2304563134),f=a(f,v,_,E,S[d+12],7,1804603682),E=a(E,f,v,_,S[d+13],12,4254626195),_=a(_,E,f,v,S[d+14],17,2792965006),f=o(f,v=a(v,_,E,f,S[d+15],22,1236535329),_,E,S[d+1],5,4129170786),E=o(E,f,v,_,S[d+6],9,3225465664),_=o(_,E,f,v,S[d+11],14,643717713),v=o(v,_,E,f,S[d+0],20,3921069994),f=o(f,v,_,E,S[d+5],5,3593408605),E=o(E,f,v,_,S[d+10],9,38016083),_=o(_,E,f,v,S[d+15],14,3634488961),v=o(v,_,E,f,S[d+4],20,3889429448),f=o(f,v,_,E,S[d+9],5,568446438),E=o(E,f,v,_,S[d+14],9,3275163606),_=o(_,E,f,v,S[d+3],14,4107603335),v=o(v,_,E,f,S[d+8],20,1163531501),f=o(f,v,_,E,S[d+13],5,2850285829),E=o(E,f,v,_,S[d+2],9,4243563512),_=o(_,E,f,v,S[d+7],14,1735328473),f=s(f,v=o(v,_,E,f,S[d+12],20,2368359562),_,E,S[d+5],4,4294588738),E=s(E,f,v,_,S[d+8],11,2272392833),_=s(_,E,f,v,S[d+11],16,1839030562),v=s(v,_,E,f,S[d+14],23,4259657740),f=s(f,v,_,E,S[d+1],4,2763975236),E=s(E,f,v,_,S[d+4],11,1272893353),_=s(_,E,f,v,S[d+7],16,4139469664),v=s(v,_,E,f,S[d+10],23,3200236656),f=s(f,v,_,E,S[d+13],4,681279174),E=s(E,f,v,_,S[d+0],11,3936430074),_=s(_,E,f,v,S[d+3],16,3572445317),v=s(v,_,E,f,S[d+6],23,76029189),f=s(f,v,_,E,S[d+9],4,3654602809),E=s(E,f,v,_,S[d+12],11,3873151461),_=s(_,E,f,v,S[d+15],16,530742520),f=c(f,v=s(v,_,E,f,S[d+2],23,3299628645),_,E,S[d+0],6,4096336452),E=c(E,f,v,_,S[d+7],10,1126891415),_=c(_,E,f,v,S[d+14],15,2878612391),v=c(v,_,E,f,S[d+5],21,4237533241),f=c(f,v,_,E,S[d+12],6,1700485571),E=c(E,f,v,_,S[d+3],10,2399980690),_=c(_,E,f,v,S[d+10],15,4293915773),v=c(v,_,E,f,S[d+1],21,2240044497),f=c(f,v,_,E,S[d+8],6,1873313359),E=c(E,f,v,_,S[d+15],10,4264355552),_=c(_,E,f,v,S[d+6],15,2734768916),v=c(v,_,E,f,S[d+13],21,1309151649),f=c(f,v,_,E,S[d+4],6,4149444226),E=c(E,f,v,_,S[d+11],10,3174756917),_=c(_,E,f,v,S[d+2],15,718787259),v=c(v,_,E,f,S[d+9],21,3951481745),f=i(f,l),v=i(v,h),_=i(_,m),E=i(E,p);return 32==t?u(f)+u(v)+u(_)+u(E):u(v)+u(_)},Object.defineProperty(e,"__esModule",{value:!0})},"object"===o(t)?a(t):(n=[t],void 0===(i="function"==typeof(r=a)?r.apply(t,n):r)||(e.exports=i))},931:function(){!function(e){"use strict";var t,r;void 0===e.btoa&&(e.btoa=(t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),function(e){var r,n,i,a,o,s,c;for(n=i=0,a=e.length,s=(a-=o=a%3)/3<<2,o>0&&(s+=4),r=new Array(s);n<a;)c=e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<8|e.charCodeAt(n++),r[i++]=t[c>>18]+t[c>>12&63]+t[c>>6&63]+t[63&c];return 1==o?(c=e.charCodeAt(n++),r[i++]=t[c>>2]+t[(3&c)<<4]+"=="):2==o&&(c=e.charCodeAt(n++)<<8|e.charCodeAt(n++),r[i++]=t[c>>10]+t[c>>4&63]+t[(15&c)<<2]+"="),r.join("")})),void 0===e.atob&&(e.atob=(r=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1],function(e){var t,n,i,a,o,s,c,u,d,l;if((c=e.length)%4!=0)return"";if(/[^ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\+\/\=]/.test(e))return"";for(d=c,(u="="==e.charAt(c-2)?1:"="==e.charAt(c-1)?2:0)>0&&(d-=4),d=3*(d>>2)+u,l=new Array(d),o=s=0;o<c&&-1!=(t=r[e.charCodeAt(o++)])&&-1!=(n=r[e.charCodeAt(o++)])&&(l[s++]=String.fromCharCode(t<<2|(48&n)>>4),-1!=(i=r[e.charCodeAt(o++)]))&&(l[s++]=String.fromCharCode((15&n)<<4|(60&i)>>2),-1!=(a=r[e.charCodeAt(o++)]));)l[s++]=String.fromCharCode((3&i)<<6|a);return l.join("")}));var n=2654435769;function i(e,t){var r=e.length,n=r<<2;if(t){var i=e[r-1];if(i<(n-=4)-3||i>n)return null;n=i}for(var a=0;a<r;a++)e[a]=String.fromCharCode(255&e[a],e[a]>>>8&255,e[a]>>>16&255,e[a]>>>24&255);var o=e.join("");return t?o.substring(0,n):o}function a(e,t){var r,n=e.length,i=n>>2;0!=(3&n)&&++i,t?(r=new Array(i+1))[i]=n:r=new Array(i);for(var a=0;a<n;++a)r[a>>2]|=e.charCodeAt(a)<<((3&a)<<3);return r}function o(e){return 4294967295&e}function s(e,t,r,n,i,a){return(r>>>5^t<<2)+(t>>>3^r<<4)^(e^t)+(a[3&n^i]^r)}function c(e){return e.length<4&&(e.length=4),e}function u(e){if(/^[\x00-\x7f]*$/.test(e))return e;for(var t=[],r=e.length,n=0,i=0;n<r;++n,++i){var a=e.charCodeAt(n);if(a<128)t[i]=e.charAt(n);else if(a<2048)t[i]=String.fromCharCode(192|a>>6,128|63&a);else{if(!(a<55296||a>57343)){if(n+1<r){var o=e.charCodeAt(n+1);if(a<56320&&56320<=o&&o<=57343){var s=65536+((1023&a)<<10|1023&o);t[i]=String.fromCharCode(240|s>>18&63,128|s>>12&63,128|s>>6&63,128|63&s),++n;continue}}throw new Error("Malformed string")}t[i]=String.fromCharCode(224|a>>12,128|a>>6&63,128|63&a)}}return t.join("")}function d(e,t){return(null==t||t<0)&&(t=e.length),0===t?"":/^[\x00-\x7f]*$/.test(e)||!/^[\x00-\xff]*$/.test(e)?t===e.length?e:e.substr(0,t):t<32767?function(e,t){for(var r=new Array(t),n=0,i=0,a=e.length;n<t&&i<a;n++){var o=e.charCodeAt(i++);switch(o>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r[n]=o;break;case 12:case 13:if(!(i<a))throw new Error("Unfinished UTF-8 octet sequence");r[n]=(31&o)<<6|63&e.charCodeAt(i++);break;case 14:if(!(i+1<a))throw new Error("Unfinished UTF-8 octet sequence");r[n]=(15&o)<<12|(63&e.charCodeAt(i++))<<6|63&e.charCodeAt(i++);break;case 15:if(!(i+2<a))throw new Error("Unfinished UTF-8 octet sequence");var s=((7&o)<<18|(63&e.charCodeAt(i++))<<12|(63&e.charCodeAt(i++))<<6|63&e.charCodeAt(i++))-65536;if(!(0<=s&&s<=1048575))throw new Error("Character outside valid Unicode range: 0x"+s.toString(16));r[n++]=s>>10&1023|55296,r[n]=1023&s|56320;break;default:throw new Error("Bad UTF-8 encoding 0x"+o.toString(16))}}return n<t&&(r.length=n),String.fromCharCode.apply(String,r)}(e,t):function(e,t){for(var r=[],n=new Array(32768),i=0,a=0,o=e.length;i<t&&a<o;i++){var s=e.charCodeAt(a++);switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n[i]=s;break;case 12:case 13:if(!(a<o))throw new Error("Unfinished UTF-8 octet sequence");n[i]=(31&s)<<6|63&e.charCodeAt(a++);break;case 14:if(!(a+1<o))throw new Error("Unfinished UTF-8 octet sequence");n[i]=(15&s)<<12|(63&e.charCodeAt(a++))<<6|63&e.charCodeAt(a++);break;case 15:if(!(a+2<o))throw new Error("Unfinished UTF-8 octet sequence");var c=((7&s)<<18|(63&e.charCodeAt(a++))<<12|(63&e.charCodeAt(a++))<<6|63&e.charCodeAt(a++))-65536;if(!(0<=c&&c<=1048575))throw new Error("Character outside valid Unicode range: 0x"+c.toString(16));n[i++]=c>>10&1023|55296,n[i]=1023&c|56320;break;default:throw new Error("Bad UTF-8 encoding 0x"+s.toString(16))}if(i>=32766){var u=i+1;n.length=u,r[r.length]=String.fromCharCode.apply(String,n),t-=u,i=-1}}return i>0&&(n.length=i,r[r.length]=String.fromCharCode.apply(String,n)),r.join("")}(e,t)}function l(e,t){return null==e||0===e.length?e:(e=u(e),t=u(t),i(function(e,t){var r,i,a,c,u,d,l=e.length,h=l-1;for(i=e[h],a=0,d=0|Math.floor(6+52/l);d>0;--d){for(c=(a=o(a+n))>>>2&3,u=0;u<h;++u)r=e[u+1],i=e[u]=o(e[u]+s(a,r,i,u,c,t));r=e[0],i=e[h]=o(e[h]+s(a,r,i,h,c,t))}return e}(a(e,!0),c(a(t,!1))),!1))}function h(e,t){return null==e||0===e.length?e:(t=u(t),d(i(function(e,t){var r,i,a,c,u,d=e.length,l=d-1;for(r=e[0],a=o(Math.floor(6+52/d)*n);0!==a;a=o(a-n)){for(c=a>>>2&3,u=l;u>0;--u)i=e[u-1],r=e[u]=o(e[u]-s(a,r,i,u,c,t));i=e[l],r=e[0]=o(e[0]-s(a,r,i,0,c,t))}return e}(a(e,!1),c(a(t,!1))),!0)))}e.xxtea={utf8Encode:u,utf8Decode:d,encrypt:l,encryptToBase64:function(t,r){return e.btoa(l(t,r))},decrypt:h,decryptFromBase64:function(t,r){return null==t||0===t.length?t:h(e.atob(t),r)}}}(this||[eval][0]("this"))}},t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";r.r(n),r.d(n,{ChuangLiveEngine:()=>wr,default:()=>Hr});var e=r(99),t=r(61),a=r(931),o=new RegExp(/(?:(\w+):\/\/)?([^/:]+)(?::(\d*))?(?:([\/\w]+))?/),s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");const c={is:{isFunction:function(e){return"[object Function]"==Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"==Object.prototype.toString.call(e)},isArray:function(e){return Array.isArray?Array.isArray(e):"[object Array]"==Object.prototype.toString.call(e)},isString:function(e){return"[object String]"==Object.prototype.toString.call(e)},isRegex:function(e){return"[object RegExp]"==Object.prototype.toString.call(e)},isInteger:function(e){return"number"==typeof e&&e%1==0},isNumber:function(e){return"number"==typeof e},isBoolean:function(e){return"boolean"==typeof e},isEmpty:function(e){return!e||this.isString(e)&&/^\s*$/.test(e)},isASCII:function(e){return this.isString(e)&&/[\x00-\xff]+/g.test(e)},isLegal:function(e){return!/^\w\-/.test(e)}},dateFtt:function(e,t){var r={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var n in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length))),r)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?r[n]:("00"+r[n]).substr((""+r[n]).length)));return e},curTime:function(){return 0|Date.now()/1e3},curTimeInMilli:function(){return Date.now()},curTimeInUTC:function(){return(new Date).toISOString()},curTimeFtt:function(){var e=new Date;return this.dateFtt("yyyy-MM-dd hh:mm:ss",e)},uuid:function(e,t){var r,n,i=s,a=[];if(t=t||i.length,e)for(r=0;r<e;r++)a[r]=i[0|Math.random()*t];else for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",r=0;r<36;r++)a[r]||(n=0|16*Math.random(),a[r]=i[19==r?3&n|8:n]);return a.join("")},uuidFast:function(){for(var e,t=s,r=new Array(36),n=0,i=0;i<36;i++)8==i||13==i||18==i||23==i?r[i]="-":14==i?r[i]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),e=15&n,n>>=4,r[i]=t[19==i?3&e|8:e]);return r.join("")},randomnum:function(e){var t=Math.pow(10,e-1);return Math.floor(9*Math.random()*t)+t},randomnumExcept:function(e,t){for(var r=Math.pow(10,e-1),n=t;n==t;)n=Math.floor(9*Math.random()*r)+r;return n},randomString:function(e){var t=s,r=t.length,n=[];n[0]=t[0|Math.random()*(r-10)+10];for(var i=1,a=e;i<a;i++)n[i]=t[0|Math.random()*r];return n.join("")},randomChar:function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",r=t.length,n=[];n[0]=t[0|Math.random()*(r-10)+10];for(var i=1,a=e;i<a;i++)n[i]=t[0|Math.random()*r];return n.join("")},lengthInUtf8Bytes:function(e){var t=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(t?t.length:0)},md5String:function(t){return e.md5(t,32)},base64encode:function(e){return t.encode(e)},xxteaDecryptFromBase64:function(e,t){return a.decryptFromBase64(e,t)},copyChuangRect:function(e,t){t.left=e.left,t.top=e.top,t.right=e.right,t.bottom=e.bottom},count:function(e){var t=0;for(var r in e)t++;return t},keys:function(e){var t=[];for(var r in e)t.push(r);return t},toHump:function(e){return e.replace(/(?:\_|\.)(\w)/g,(function(e,t){return t.toUpperCase()}))},toLine:function(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()},parseUrl:function(e){if(!e)return null;var t=e.match(o);return t?{scheme:t[1],host:t[2],port:parseInt(t[3])||0,path:t[4]}:null},appendUrl:function(e,t){if(e.match(o)){var r=[],n=e.indexOf("?");for(var i in t)!1!==n?(n<0?r.push("?"):n<e.length-1&&r.push("&"),n=!1):r.push("&"),r.push(i),r.push("="),r.push(encodeURIComponent(t[i]));return e+r.join("")}return""}};function u(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var h=r(703);p.sessions={},p.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||p.extension.isInstalled()}return!0};var m={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout((function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var r=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var n=new Error("NavigatorUserMediaError");n.name="You cancelled the request for permission, giving up...",r(n)}else r(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(p.log("clearing ",t.data.id),window.clearTimeout(t.data.id))}))}};function p(e){if((e=e||{}).success="function"==typeof e.success?e.success:p.noop,e.error="function"==typeof e.error?e.error:p.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:p.noop,!p.initDone)return e.error("Library not initialized"),{};if(!p.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(p.log("Library initialized: "+p.initDone),!e.server)return e.error("Invalid server url"),{};var t=!1,r=null,n={},i=null,a=null,o=0,s=e.server;p.isArray(s)?(p.log("Multiple servers provided ("+s.length+"), will use the first that works"),s=null,a=e.server,p.debug(a)):t=0===s.indexOf("ws");var c=e.iceServers||[{urls:"stun:config.aocrtcr.com:3688"}],d=e.iceTransportPolicy,h=e.bundlePolicy,m=!0===e.ipv6,f=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(f=!0===e.withCredentials);var v=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(v=e.max_poll_events),v<1&&(v=1);var _=null;void 0!==e.token&&null!==e.token&&(_=e.token);var E=null;void 0!==e.apisecret&&null!==e.apisecret&&(E=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var S=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(S=e.keepAlivePeriod),isNaN(S)&&(S=25e3);var C=6e4;function T(e){var t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(C=e.longPollTimeout),isNaN(C)&&(C=6e4);var g=!1,R=null,A={},O=this,I=0,P={};function y(){if(null!=R)if(p.debug("Long poll..."),g){var t=s+"/"+R+"?rid="+(new Date).getTime();v&&(t=t+"&maxev="+v),_&&(t=t+"&token="+encodeURIComponent(_)),E&&(t=t+"&apisecret="+encodeURIComponent(E)),p.httpAPICall(t,{verb:"GET",withCredentials:f,success:N,timeout:C,error:function(t,r){if(p.error(t+":",r),++I>3)return g=!1,void e.error("Lost connection to the server (is it down?)");y()}})}else p.warn("Is the server down? (connected=false)")}function N(e,n){if(I=0,t||null==R||!0===n||y(),t||!p.isArray(e))if("keepalive"!==e.rtclib)if("ack"!==e.rtclib)if("success"!==e.rtclib)if("trickle"===e.rtclib){if(!(c=e.sender))return void p.warn("Missing sender...");if(!(d=A[c]))return void p.debug("This handle is not attached to this session");var i=e.candidate;p.debug("Got a trickled candidate on session "+R),p.debug(i);var a=d.webrtcStuff;a.pc&&a.remoteSdp?(p.debug("Adding remote candidate:",i),i&&!0!==i.completed?a.pc.addIceCandidate(i):a.pc.addIceCandidate(p.endOfCandidates)):(p.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),a.candidates||(a.candidates=[]),a.candidates.push(i),p.debug(a.candidates))}else{if("webrtcup"===e.rtclib)return p.debug("Got a webrtcup event on session "+R),p.debug(e),(c=e.sender)?(d=A[c])?void d.webrtcState(!0):void p.debug("This handle is not attached to this session"):void p.warn("Missing sender...");if("hangup"===e.rtclib){if(p.debug("Got a hangup event on session "+R),p.debug(e),!(c=e.sender))return void p.warn("Missing sender...");if(!(d=A[c]))return void p.debug("This handle is not attached to this session");d.webrtcState(!1,e.reason),d.hangup()}else if("detached"===e.rtclib){if(p.debug("Got a detached event on session "+R),p.debug(e),!(c=e.sender))return void p.warn("Missing sender...");if(!(d=A[c]))return;d.detached=!0,d.ondetached(),d.detach()}else if("media"===e.rtclib){if(p.debug("Got a media event on session "+R),p.debug(e),!(c=e.sender))return void p.warn("Missing sender...");if(!(d=A[c]))return void p.debug("This handle is not attached to this session");d.mediaState(e.type,e.receiving)}else if("slowlink"===e.rtclib){if(p.debug("Got a slowlink event on session "+R),p.debug(e),!(c=e.sender))return void p.warn("Missing sender...");if(!(d=A[c]))return void p.debug("This handle is not attached to this session");d.slowLink(e.uplink,e.lost)}else{if("error"===e.rtclib){var o,s;if(p.error("Ooops: "+e.error.code+" "+e.error.reason),p.debug(e),o=e.transaction)(s=P[o])&&s(e),delete P[o];return}if("event"===e.rtclib){var c;if(p.debug("Got a plugin event on session "+R),p.debug(e),!(c=e.sender))return void p.warn("Missing sender...");var u=e.plugindata;if(!u)return void p.warn("Missing plugindata...");p.debug("  -- Event is coming from "+c+" ("+u.plugin+")");var d,l=u.data;if(p.debug(l),!(d=A[c]))return void p.warn("This handle is not attached to this session");var h=e.jsep;h&&(p.debug("Handling SDP as well..."),p.debug(h));var m=d.onmessage;m?(p.debug("Notifying application..."),m(l,h)):p.debug("No provided notification callback")}else{if("timeout"===e.rtclib)return p.error("Timeout on session "+R),p.debug(e),void(t&&r&&r.readyState==WebSocket.OPEN&&r.close(3504,"Gateway timeout"));p.warn("Unknown message/event  '"+e.rtclib+"' on session "+R),p.debug(e)}}}else p.debug("Got a success on session "+R),p.debug(e),(o=e.transaction)&&((s=P[o])&&s(e),delete P[o]);else p.debug("Got an ack on session "+R),p.debug(e),(o=e.transaction)&&((s=P[o])&&s(e),delete P[o]);else p.vdebug("Got a keepalive on session "+R);else for(var f=0;f<e.length;f++)N(e[f],!0)}function b(){if(s&&t&&g){i=setTimeout(b,S);var e={rtclib:"keepalive",session_id:R,transaction:p.randomString(12)};_&&(e.token=_),E&&(e.apisecret=E),r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(e))}}function D(c){var u=p.randomString(12),d={rtclib:"create",transaction:u};if(c.reconnect&&(g=!1,d.rtclib="claim",d.session_id=R,r&&(r.onopen=null,r.onerror=null,r.onclose=null,i&&(clearTimeout(i),i=null))),_&&(d.token=_),E&&(d.apisecret=E),!s&&p.isArray(a)&&(s=a[o],console.log("server value",s),0===s.indexOf("ws")?(t=!0,console.log("Server #"+(o+1)+": trying WebSockets to contact ("+s+")")):(t=!1,console.log("Server #"+(o+1)+": trying REST API to contact ("+s+")"))),t)for(var l in r=p.newWebSocket(s,"rtclib-protocol"),n={error:function(){if(p.error("Error connecting to the WebSockets server... "+s),p.isArray(a)&&!c.reconnect)return++o===a.length?void c.error("Error connecting to any of the provided servers: Is the server down?"):(s=null,void setTimeout((function(){D(c)}),200));var e={url:r.url,error:"Error connecting to the WebSockets server: Is the server down?"};c.error(e)},open:function(){P[u]=function(e){if(p.debug(e),"success"!==e.rtclib)return p.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);i=setTimeout(b,S),g=!0,R=e.session_id?e.session_id:e.data.id,c.reconnect?p.log("Claimed session: "+R):p.log("Created session: "+R),p.sessions[R]=O,c.success()},r.send(JSON.stringify(d))},message:function(e){N(JSON.parse(e.data))},close:function(){if(s&&g){g=!1;var t={url:s,error:"Lost connection to the server (is it down?)"};e.error(t)}}})r.addEventListener(l,n[l]);else p.httpAPICall(s,{verb:"POST",withCredentials:f,body:d,success:function(e){if(p.debug(e),"success"!==e.rtclib)return p.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);g=!0,R=e.session_id?e.session_id:e.data.id,c.reconnect?p.log("Claimed session: "+R):p.log("Created session: "+R),p.sessions[R]=O,c.success()},error:function(e,t){if(p.error(e+":",t),p.isArray(a)&&!c.reconnect)return++o===a.length?void c.error("Error connecting to any of the provided servers: Is the server down?"):(s=null,void setTimeout((function(){D(c)}),200));""===t?c.error(e+": Is the server down?"):c.error(e+": "+t)}})}function U(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:p.noop,n.error="function"==typeof n.error?n.error:p.noop,!g)return p.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var i=A[e];if(!i||!i.webrtcStuff)return p.warn("Invalid handle"),void n.error("Invalid handle");var a=n.message,o=n.jsep,c=p.randomString(12),u={rtclib:"message",body:a,transaction:c};if(i.token&&(u.token=i.token),E&&(u.apisecret=E),o&&(u.jsep=o),p.debug("Sending message to plugin (handle="+e+"):"),p.debug(u),t)return u.session_id=R,u.handle_id=e,P[c]=function(e){if(p.debug("Message sent!"),p.debug(e),"success"===e.rtclib){var t=e.plugindata;if(!t)return p.warn("Request succeeded, but missing plugindata..."),void n.success();p.log("Synchronous transaction successful ("+t.plugin+")");var r=t.data;return p.debug(r),void n.success(r)}"ack"===e.rtclib?n.success():e.error?(p.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(p.error("Unknown error"),n.error("Unknown error"))},null!=u.body&&(u.body.rtt=i.webrtcStuff.rtt),u.rtt=i.webrtcStuff.rtt,void(r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(u)));p.httpAPICall(s+"/"+R+"/"+e,{verb:"POST",withCredentials:f,body:u,success:function(e){if(p.debug("Message sent!"),p.debug(e),"success"===e.rtclib){var t=e.plugindata;if(!t)return p.warn("Request succeeded, but missing plugindata..."),void n.success();p.log("Synchronous transaction successful ("+t.plugin+")");var r=t.data;return p.debug(r),void n.success(r)}"ack"===e.rtclib?n.success():e.error?(p.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(p.error("Unknown error"),n.error("Unknown error"))},error:function(e,t){p.error(e+":",t),n.error(e+": "+t)}})}function L(e,n){if(g){var i=A[e];if(i&&i.webrtcStuff){var a={rtclib:"trickle",candidate:n,transaction:p.randomString(12)};if(i.token&&(a.token=i.token),E&&(a.apisecret=E),p.vdebug("Sending trickle candidate (handle="+e+"):"),p.vdebug(a),t)return a.session_id=R,a.handle_id=e,void(r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(a)));p.httpAPICall(s+"/"+R+"/"+e,{verb:"POST",withCredentials:f,body:a,success:function(e){p.vdebug("Candidate sent!"),p.vdebug(e),"ack"===e.rtclib||p.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){p.error(e+":",t)}})}else p.warn("Invalid handle")}else p.warn("Is the server down? (connected=false)")}function k(e,t){(t=t||{}).success="function"==typeof t.success?t.success:p.noop,t.error="function"==typeof t.error?t.error:p.noop;var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff,i=t.text||t.data;if(!i)return p.warn("Invalid data"),void t.error("Invalid data");var a=t.label?t.label:p.dataChanDefaultLabel;return n.dataChannel[a]?"open"!==n.dataChannel[a].readyState?(n.dataChannel[a].pending.push(i),void t.success()):(p.log("Sending data on data channel <"+a+">"),p.debug(i),n.dataChannel[a].send(i),void t.success()):(function(e,t,r,n){var i=A[e];if(i&&i.webrtcStuff){var a=i.webrtcStuff,o=function(e){p.log("Received state change on data channel:",e);var t=e.target.label,r=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(p.log("State change on <"+t+"> data channel: "+r),"open"===r){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){p.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length);var n,o=u(a.dataChannel[t].pending);try{for(o.s();!(n=o.n()).done;){var s=n.value;p.log("Sending data on data channel <"+t+">"),p.debug(s),a.dataChannel[t].send(s)}}catch(e){o.e(e)}finally{o.f()}a.dataChannel[t].pending=[]}i.ondataopen(t)}};a.dataChannel[t]=r||a.pc.createDataChannel(t,{ordered:!0}),a.dataChannel[t].onmessage=function(e){p.log("Received message on data channel:",e);var t=e.target.label;i.ondata(e.data,t)},a.dataChannel[t].onopen=o,a.dataChannel[t].onclose=o,a.dataChannel[t].onerror=function(e){p.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],n&&a.dataChannel[t].pending.push(n)}else p.warn("Invalid handle")}(e,a,!1,i),void t.success())}function M(e,t){(t=t||{}).success="function"==typeof t.success?t.success:p.noop,t.error="function"==typeof t.error?t.error:p.noop;var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff;if(!n.dtmfSender){if(n.pc){var i=n.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!i)return p.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=i.dtmf,n.dtmfSender&&(p.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){p.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return p.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var a=t.dtmf;if(!a)return p.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var o=a.tones;if(!o)return p.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var s="number"==typeof a.duration?a.duration:500,c="number"==typeof a.gap?a.gap:50;p.debug("Sending DTMF string "+o+" (duration "+s+"ms, gap "+c+"ms)"),n.dtmfSender.insertDTMF(o,s,c),t.success()}function w(e,n){(n=n||{}).success="function"==typeof n.success?n.success:p.noop,n.error="function"==typeof n.error?n.error:p.noop;var i=!0===n.noRequest;p.log("Destroying handle "+e+" (only-locally="+i+")"),Z(e);var a=A[e];if(!a||a.detached)return delete A[e],void n.success();if(i)return delete A[e],void n.success();if(!g)return p.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var o={rtclib:"detach",transaction:p.randomString(12)};if(a.token&&(o.token=a.token),E&&(o.apisecret=E),t)return o.session_id=R,o.handle_id=e,r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(o)),delete A[e],void n.success();p.httpAPICall(s+"/"+R+"/"+e,{verb:"POST",withCredentials:f,body:o,success:function(t){p.log("Destroyed handle:"),p.debug(t),"success"!==t.rtclib&&p.error("Ooops: "+t.error.code+" "+t.error.reason),delete A[e],n.success()},error:function(t,r){p.error(t+":",r),delete A[e],n.success()}})}function H(e,t,r,n,i){var a=A[e];if(!a||!a.webrtcStuff)return p.warn("Invalid handle"),void n.error("Invalid handle");var o=a.webrtcStuff;p.debug("streamsDone:",i),i&&(p.debug("  -- Audio tracks:",i.getAudioTracks()),p.debug("  -- Video tracks:",i.getVideoTracks()));var s=!1;if(o.myStream&&r.update&&!o.streamExternal){if((!r.update&&ee(r)||r.update&&(r.addAudio||r.replaceAudio))&&i.getAudioTracks()&&i.getAudioTracks().length)if(o.myStream.addTrack(i.getAudioTracks()[0]),p.unifiedPlan){p.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]);var f=null;if((E=o.pc.getTransceivers())&&E.length>0){var v,_=u(E);try{for(_.s();!(v=_.n()).done;){if((R=v.value).sender&&R.sender.track&&"audio"===R.sender.track.kind||R.receiver&&R.receiver.track&&"audio"===R.receiver.track.kind){f=R;break}}}catch(e){_.e(e)}finally{_.f()}}f&&f.sender?f.sender.replaceTrack(i.getAudioTracks()[0]):o.pc.addTrack(i.getAudioTracks()[0],i)}else p.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]),o.pc.addTrack(i.getAudioTracks()[0],i);if((!r.update&&re(r)||r.update&&(r.addVideo||r.replaceVideo))&&i.getVideoTracks()&&i.getVideoTracks().length)if(o.myStream.addTrack(i.getVideoTracks()[0]),p.unifiedPlan){p.log((r.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]);var E,S=null;if((E=o.pc.getTransceivers())&&E.length>0){var C,g=u(E);try{for(g.s();!(C=g.n()).done;){var R;if((R=C.value).sender&&R.sender.track&&"video"===R.sender.track.kind||R.receiver&&R.receiver.track&&"video"===R.receiver.track.kind){S=R;break}}}catch(e){g.e(e)}finally{g.f()}}S&&S.sender?S.sender.replaceTrack(i.getVideoTracks()[0]):o.pc.addTrack(i.getVideoTracks()[0],i)}else p.log((r.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]),o.pc.addTrack(i.getVideoTracks()[0],i)}else o.myStream=i,s=!0;if(!o.pc){var O={iceServers:c,iceTransportPolicy:d,bundlePolicy:h};"chrome"===p.webRTCAdapter.browserDetails.browser&&(O.sdpSemantics=p.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var I={optional:[{DtlsSrtpKeyAgreement:!0}]};if(m&&I.optional.push({googIPv6:!0}),n.rtcConstraints&&"object"===l(n.rtcConstraints))for(var P in p.debug("Adding custom PeerConnection constraints:",n.rtcConstraints),n.rtcConstraints)I.optional.push(n.rtcConstraints[P]);"edge"===p.webRTCAdapter.browserDetails.browser&&(O.bundlePolicy="max-bundle"),p.log("Creating PeerConnection"),p.debug(I),o.pc=new RTCPeerConnection(O,I),p.debug(o.pc),o.pc.getStats&&(o.volume={},o.bitrate.value=0),p.log("Preparing local SDP and gathering candidates (trickle="+o.trickle+")"),o.pc.oniceconnectionstatechange=function(e){o.pc&&a.iceState(o.pc.iceConnectionState)},o.pc.onicecandidate=function(t){if(!t.candidate||"edge"===p.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)p.log("End of candidates."),o.iceDone=!0,!0===o.trickle?L(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:p.noop,t.error="function"==typeof t.error?t.error:p.noop;var r=A[e];if(!r||!r.webrtcStuff)return void p.warn("Invalid handle, not sending anything");var n=r.webrtcStuff;if(p.log("Sending offer/answer SDP..."),!n.mySdp)return void p.warn("Local SDP instance is invalid, not sending anything...");n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1);p.debug(t),n.sdpSent=!0,t.success(n.mySdp)}(e,n);else{var r={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===o.trickle&&L(e,r)}},o.pc.ontrack=function(e){if(p.log("Handling Remote Track"),p.debug(e),e.streams&&(o.remoteStream=e.streams[0],a.onremotestream(o.remoteStream,"track",e.track),!e.track.onended)){var t=null;p.log("Adding onended callback to track:",e.track),e.track.onended=function(e){p.log("Remote track removed:",e),o.remoteStream&&(clearTimeout(t),a.onremotestream(o.remoteStream,"ended",e.target))},e.track.onmute=function(e){p.log("Remote track muted:",e),o.remoteStream&&null==t&&(t=setTimeout((function(){p.log("Removing remote track"),a.onremotestream(o.remoteStream,"mute",e.target),t=null}),2520))},e.track.onunmute=function(e){if(p.log("Remote track flowing again:",e),null!=t)clearTimeout(t),t=null;else try{o.remoteStream.addTrack(e.target),a.onremotestream(o.remoteStream,"unmute",e.target)}catch(e){p.error(e)}}}}}if(s&&i){p.log("Adding local stream");var y=!0===n.simulcast2;i.getTracks().forEach((function(e){if(p.log("Adding local track:",e),y)if("audio"===e.kind)o.pc.addTrack(e,i);else{p.log("Enabling rid-based simulcasting:",e);var t=T(n.simulcastMaxBitrates);o.pc.addTransceiver(e,{direction:"sendrecv",streams:[i],sendEncodings:[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}]})}else o.pc.addTrack(e,i)}))}(function(e){if(p.debug("isDataEnabled:",e),"edge"===p.webRTCAdapter.browserDetails.browser)return p.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(r)&&!o.dataChannel[p.dataChanDefaultLabel]&&p.log("not Creating data channel"),o.myStream&&a.onlocalstream(o.myStream),t?o.pc.setRemoteDescription(t).then((function(){if(p.log("Remote description accepted!"),o.remoteSdp=t.sdp,o.candidates&&o.candidates.length>0){for(var i=0;i<o.candidates.length;i++){var a=o.candidates[i];p.debug("Adding remote candidate:",a),a&&!0!==a.completed?o.pc.addIceCandidate(a):o.pc.addIceCandidate(p.endOfCandidates)}o.candidates=[]}!function(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:p.noop,r.error="function"==typeof r.error?r.error:p.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:p.noop;var n=A[e];if(!n||!n.webrtcStuff)return p.warn("Invalid handle"),void r.error("Invalid handle");var i=n.webrtcStuff,a=!0===r.simulcast;a?p.log("Creating answer (iceDone="+i.iceDone+", simulcast="+a+")"):p.log("Creating answer (iceDone="+i.iceDone+")");var o=null;if(p.unifiedPlan){o={};var s=null,c=null,d=i.pc.getTransceivers();if(d&&d.length>0){var l,h=u(d);try{for(h.s();!(l=h.n()).done;){var m=l.value;m.sender&&m.sender.track&&"audio"===m.sender.track.kind||m.receiver&&m.receiver.track&&"audio"===m.receiver.track.kind?s||(s=m):(m.sender&&m.sender.track&&"video"===m.sender.track.kind||m.receiver&&m.receiver.track&&"video"===m.receiver.track.kind)&&(c||(c=m))}}catch(e){h.e(e)}finally{h.f()}}var f=ee(t),v=te(t);if(f||v){if(f&&v){if(s)try{s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",p.log("Setting audio transceiver to sendrecv:",s)}catch(e){p.error(e)}}else if(f&&!v)try{s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",p.log("Setting audio transceiver to sendonly:",s))}catch(e){p.error(e)}else if(!f&&v)if(s)try{s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",p.log("Setting audio transceiver to recvonly:",s)}catch(e){p.error(e)}else s=i.pc.addTransceiver("audio",{direction:"recvonly"}),p.log("Adding recvonly audio transceiver:",s)}else if(t.removeAudio&&s)try{s.setDirection?s.setDirection("inactive"):s.direction="inactive",p.log("Setting audio transceiver to inactive:",s)}catch(e){p.error(e)}var _=re(t),E=ne(t);if(_||E){if(_&&E){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",p.log("Setting video transceiver to sendrecv:",c)}catch(e){p.error(e)}}else if(_&&!E){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",p.log("Setting video transceiver to sendonly:",c)}catch(e){p.error(e)}}else if(!_&&E)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",p.log("Setting video transceiver to recvonly:",c)}catch(e){p.error(e)}else c=i.pc.addTransceiver("video",{direction:"recvonly"}),p.log("Adding recvonly video transceiver:",c)}else if(t.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",p.log("Setting video transceiver to inactive:",c)}catch(e){p.error(e)}}else o="firefox"===p.webRTCAdapter.browserDetails.browser||"edge"===p.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:te(t),offerToReceiveVideo:ne(t)}:{mandatory:{OfferToReceiveAudio:te(t),OfferToReceiveVideo:ne(t)}};p.debug(o);var S=re(t);if(S&&a&&"firefox"===p.webRTCAdapter.browserDetails.browser){p.log("Enabling Simulcasting for Firefox (RID)");var C=i.pc.getSenders()[1];p.log(C);var g=C.getParameters();p.log(g);var R=T(r.simulcastMaxBitrates);C.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:R.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:R.medium},{rid:"low",active:!0,priority:"low",maxBitrate:R.low}]})}i.pc.createAnswer(o).then((function(e){p.debug(e);var t={type:e.type,sdp:e.sdp};r.customizeSdp(t),e.sdp=t.sdp,p.log("Setting local description"),S&&a&&("chrome"===p.webRTCAdapter.browserDetails.browser?p.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==p.webRTCAdapter.browserDetails.browser&&p.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(r.error),i.mediaConstraints=o,i.iceDone||i.trickle?r.success(e):p.log("Waiting for all candidates...")}),r.error)}(e,r,n)}),n.error):function(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:p.noop,r.error="function"==typeof r.error?r.error:p.noop,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:p.noop;var n=A[e];if(!n||!n.webrtcStuff)return p.warn("Invalid handle"),void r.error("Invalid handle");var i=n.webrtcStuff,a=!0===r.simulcast;a?p.log("Creating offer (iceDone="+i.iceDone+", simulcast="+a+")"):p.log("Creating offer (iceDone="+i.iceDone+")");var o={};if(p.unifiedPlan){var s=null,c=null,d=i.pc.getTransceivers();if(d&&d.length>0){var l,h=u(d);try{for(h.s();!(l=h.n()).done;){var m=l.value;m.sender&&m.sender.track&&"audio"===m.sender.track.kind||m.receiver&&m.receiver.track&&"audio"===m.receiver.track.kind?s||(s=m):(m.sender&&m.sender.track&&"video"===m.sender.track.kind||m.receiver&&m.receiver.track&&"video"===m.receiver.track.kind)&&(c||(c=m))}}catch(e){h.e(e)}finally{h.f()}}var f=ee(t),v=te(t);f||v?f&&v?s&&(s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",p.log("Setting audio transceiver to sendrecv:",s)):f&&!v?s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",p.log("Setting audio transceiver to sendonly:",s)):!f&&v&&(s?(s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",p.log("Setting audio transceiver to recvonly:",s)):(s=i.pc.addTransceiver("audio",{direction:"recvonly"}),p.log("Adding recvonly audio transceiver:",s))):t.removeAudio&&s&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive",p.log("Setting audio transceiver to inactive:",s));var _=re(t),E=ne(t);_||E?_&&E?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",p.log("Setting video transceiver to sendrecv:",c)):_&&!E?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",p.log("Setting video transceiver to sendonly:",c)):!_&&E&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",p.log("Setting video transceiver to recvonly:",c)):(c=i.pc.addTransceiver("video",{direction:"recvonly"}),p.log("Adding recvonly video transceiver:",c))):t.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",p.log("Setting video transceiver to inactive:",c))}else o.offerToReceiveAudio=te(t),o.offerToReceiveVideo=ne(t);!0===r.iceRestart&&(o.iceRestart=!0);p.debug(o);var S=re(t);if(S&&a&&"firefox"===p.webRTCAdapter.browserDetails.browser){p.log("Enabling Simulcasting for Firefox (RID)");var C=i.pc.getSenders().find((function(e){return"video"===e.track.kind}));if(C){var g=C.getParameters();g||(g={});var R=T(r.simulcastMaxBitrates);g.encodings=[{rid:"h",active:!0,maxBitrate:R.high},{rid:"m",active:!0,maxBitrate:R.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:R.low,scaleResolutionDownBy:4}],C.setParameters(g)}}i.pc.createOffer(o).then((function(e){p.debug(e);var t={type:e.type,sdp:e.sdp};r.customizeSdp(t),e.sdp=t.sdp,p.log("Setting local description"),S&&a&&("chrome"===p.webRTCAdapter.browserDetails.browser||"safari"===p.webRTCAdapter.browserDetails.browser?(p.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),r=!1,n=[-1],i=[-1],a=null,o=null,s=null,c=null,u=-1,d=0;d<t.length;d++){if(h=t[d].match(/m=(\w+) */)){if("video"===h[1]){if(!(n[0]<0)){u=d;break}r=!0}else if(n[0]>-1){u=d;break}}else if(r){var l=t[d].match(/a=ssrc-group:FID (\d+) (\d+)/);if(l)n[0]=l[1],i[0]=l[2],t.splice(d,1),d--;else{if(n[0]){if((f=t[d].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(a=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(o=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(s=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" label:(.+)"))&&(c=f[1]),0===t[d].indexOf("a=ssrc:"+i[0])){t.splice(d,1),d--;continue}if(0===t[d].indexOf("a=ssrc:"+n[0])){t.splice(d,1),d--;continue}}0!=t[d].length||(t.splice(d,1),d--)}}}if(n[0]<0){u=-1,r=!1;for(d=0;d<t.length;d++){var h;if(h=t[d].match(/m=(\w+) */)){if("video"===h[1]){if(!(n[0]<0)){u=d;break}r=!0}else if(n[0]>-1){u=d;break}}else if(r){if(n[0]<0){var m=t[d].match(/a=ssrc:(\d+)/);if(m){n[0]=m[1],t.splice(d,1),d--;continue}}else{var f;if((f=t[d].match("a=ssrc:"+n[0]+" cname:(.+)"))&&(a=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" msid:(.+)"))&&(o=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" mslabel:(.+)"))&&(s=f[1]),(f=t[d].match("a=ssrc:"+n[0]+" label:(.+)"))&&(c=f[1]),0===t[d].indexOf("a=ssrc:"+i[0])){t.splice(d,1),d--;continue}if(0===t[d].indexOf("a=ssrc:"+n[0])){t.splice(d,1),d--;continue}}0!==t[d].length||(t.splice(d,1),d--)}}}if(n[0]<0)return p.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;u<0&&(u=t.length);n[1]=Math.floor(4294967295*Math.random()),n[2]=Math.floor(4294967295*Math.random()),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random());for(d=0;d<n.length;d++)a&&(t.splice(u,0,"a=ssrc:"+n[d]+" cname:"+a),u++),o&&(t.splice(u,0,"a=ssrc:"+n[d]+" msid:"+o),u++),s&&(t.splice(u,0,"a=ssrc:"+n[d]+" mslabel:"+s),u++),c&&(t.splice(u,0,"a=ssrc:"+n[d]+" label:"+c),u++),a&&(t.splice(u,0,"a=ssrc:"+i[d]+" cname:"+a),u++),o&&(t.splice(u,0,"a=ssrc:"+i[d]+" msid:"+o),u++),s&&(t.splice(u,0,"a=ssrc:"+i[d]+" mslabel:"+s),u++),c&&(t.splice(u,0,"a=ssrc:"+i[d]+" label:"+c),u++);t.splice(u,0,"a=ssrc-group:FID "+n[2]+" "+i[2]),t.splice(u,0,"a=ssrc-group:FID "+n[1]+" "+i[1]),t.splice(u,0,"a=ssrc-group:FID "+n[0]+" "+i[0]),t.splice(u,0,"a=ssrc-group:SIM "+n[0]+" "+n[1]+" "+n[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==p.webRTCAdapter.browserDetails.browser&&p.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(r.error),i.mediaConstraints=o,i.iceDone||i.trickle?(p.log("Offer ready"),p.debug(r),r.success(e)):p.log("Waiting for all candidates...")}),r.error)}(e,r,n)}function G(e,t,r){(r=r||{}).success="function"==typeof r.success?r.success:p.noop,r.error="function"==typeof r.error?r.error:J;var n=r.jsep;if(t&&n)return p.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(t||n&&n.type&&n.sdp))return p.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");r.media="object"===l(r.media)&&r.media?r.media:{audio:!0,video:!0};var i=r.media,a=A[e];if(!a||!a.webrtcStuff)return p.warn("Invalid handle"),void r.error("Invalid handle");var o,s=a.webrtcStuff;if(s.trickle=(o=r.trickle,p.debug("isTrickleEnabled:",o),!1!==o),s.pc){if(p.log("Updating existing media session"),i.update=!0,r.stream)r.stream!==s.myStream&&p.log("Renegotiation involves a new external stream");else{if(i.addAudio){if(i.keepAudio=!1,i.replaceAudio=!1,i.removeAudio=!1,i.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return p.error("Can't add audio stream, there already is one"),void r.error("Can't add audio stream, there already is one")}else i.removeAudio?(i.keepAudio=!1,i.replaceAudio=!1,i.addAudio=!1,i.audioSend=!1):i.replaceAudio&&(i.keepAudio=!1,i.addAudio=!1,i.removeAudio=!1,i.audioSend=!0);if(s.myStream&&s.myStream.getAudioTracks()&&0!==s.myStream.getAudioTracks().length?!ee(i)||i.removeAudio||i.replaceAudio||(i.keepAudio=!0):(i.replaceAudio&&(i.keepAudio=!1,i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),ee(i)&&(i.keepAudio=!1,i.addAudio=!0)),i.addVideo){if(i.keepVideo=!1,i.replaceVideo=!1,i.removeVideo=!1,i.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return p.error("Can't add video stream, there already is one"),void r.error("Can't add video stream, there already is one")}else i.removeVideo?(i.keepVideo=!1,i.replaceVideo=!1,i.addVideo=!1,i.videoSend=!1):i.replaceVideo&&(i.keepVideo=!1,i.addVideo=!1,i.removeVideo=!1,i.videoSend=!0);s.myStream&&s.myStream.getVideoTracks()&&0!==s.myStream.getVideoTracks().length?!re(i)||i.removeVideo||i.replaceVideo||(i.keepVideo=!0):(i.replaceVideo&&(i.keepVideo=!1,i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),re(i)&&(i.keepVideo=!1,i.addVideo=!0)),i.addData&&(i.data=!0)}if(ee(i)&&i.keepAudio&&re(i)&&i.keepVideo)return a.consentDialog(!1),void H(e,n,i,r,s.myStream)}else i.update=!1,i.keepAudio=!1,i.keepVideo=!1;if(i.update&&!s.streamExternal){if(i.removeAudio||i.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var c=s.myStream.getAudioTracks()[0];p.log("Removing audio track:",c),s.myStream.removeTrack(c);try{c.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var d=!0;if(i.replaceAudio&&p.unifiedPlan&&(d=!1),d){var h,m=u(s.pc.getSenders());try{for(m.s();!(h=m.n()).done;){var f=h.value;f&&f.track&&"audio"===f.track.kind&&(p.log("Removing audio sender:",f),s.pc.removeTrack(f))}}catch(e){m.e(e)}finally{m.f()}}}}if(i.removeVideo||i.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){var v=s.myStream.getVideoTracks()[0];p.log("Removing video track:",v),s.myStream.removeTrack(v);try{v.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var _=!0;if(i.replaceVideo&&p.unifiedPlan&&(_=!1),_){var E,S=u(s.pc.getSenders());try{for(S.s();!(E=S.n()).done;){var C=E.value;C&&C.track&&"video"===C.track.kind&&(p.log("Removing video sender:",C),s.pc.removeTrack(C))}}catch(e){S.e(e)}finally{S.f()}}}}}if(r.stream){var T=r.stream;if(p.log("MediaStream provided by the application"),p.debug(T),i.update&&s.myStream&&s.myStream!==r.stream&&!s.streamExternal){try{var g,R=u(s.myStream.getTracks());try{for(R.s();!(g=R.n()).done;){var O=g.value;p.log(O),O&&O.stop()}}catch(e){R.e(e)}finally{R.f()}}catch(e){}s.myStream=null}return s.streamExternal=!0,a.consentDialog(!1),void H(e,n,i,r,T)}if(ee(i)||re(i)){if(!p.isGetUserMediaAvailable())return void r.error("getUserMedia not available");var I={mandatory:{},optional:[]};a.consentDialog(!0);var P=ee(i);if(P&&i&&"object"===l(i.audio)&&(P=i.audio),i.audio instanceof MediaStream){try{H(e,n,i,r,i.audio),a.consentDialog(!1)}catch(G){a.consentDialog(!1),r.error({code:G.code,name:G.name,message:G.message})}return}var y=re(i);if(y&&i){var N=!0===r.simulcast,b=!0===r.simulcast2;if(!N&&!b||n||i.video||(i.video="hires"),i.video&&"screen"!=i.video&&"window"!=i.video){if(i.video instanceof MediaStream){try{H(e,n,i,r,i.video),a.consentDialog(!1)}catch(G){a.consentDialog(!1),r.error({code:G.code,name:G.name,message:G.message})}return}if("object"===l(i.video))y=i.video;else{var D=0,U=0;"lowres"===i.video?(U=240,240,D=320):"lowres-16:9"===i.video?(U=180,180,D=320):"hires"===i.video||"hires-16:9"===i.video||"hdres"===i.video?(U=720,720,D=1280):"fhdres"===i.video?(U=1080,1080,D=1920):"4kres"===i.video?(U=2160,2160,D=3840):"stdres"===i.video?(U=480,480,D=640):"stdres-16:9"===i.video?(U=360,360,D=640):(p.log("Default video setting is stdres 4:3"),U=480,480,D=640),p.log("Adding media constraint:",i.video),y={height:{ideal:U},width:{ideal:D}},p.log("Adding video constraint:",y)}}else if("screen"===i.video||"window"===i.video){var L=function(t,o){a.consentDialog(!1),t?r.error(t):H(e,n,i,r,o)},k=function(e,t,n){p.log("Adding media constraint (screen capture)"),p.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(r){e.addTrack(r.getAudioTracks()[0]),t(null,e)}),(function(r){s.myStream=e,t(r)})).catch((function(e){a.consentDialog(!1),r.error(e)})):t(null,e)})).catch((function(e){a.consentDialog(!1),t(e)}))};if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return I.video={},i.screenshareFrameRate&&(I.video.frameRate=i.screenshareFrameRate),i.screenshareHeight&&(I.video.height=i.screenshareHeight),i.screenshareWidth&&(I.video.width=i.screenshareWidth),I.audio=i.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(I).then((function(t){a.consentDialog(!1),ee(i)&&!i.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(a){t.addTrack(a.getAudioTracks()[0]),H(e,n,i,r,t)}),(function(e){s.myStream=t,r.error(e)})).catch((function(e){a.consentDialog(!1),r.error(e)})):H(e,n,i,r,t)}),(function(e){a.consentDialog(!1),r.error(e)})).catch((function(e){a.consentDialog(!1),r.error(e)}));if("chrome"===p.webRTCAdapter.browserDetails.browser){var M=p.webRTCAdapter.browserDetails.version,w=33;window.navigator.userAgent.match("Linux")&&(w=35),M>=26&&M<=w?(I={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate,chromeMediaSource:"screen"}},audio:ee(i)&&!i.keepAudio},k(I,L)):p.extension.getScreen((function(e,t){if(e)return a.consentDialog(!1),r.error(e);(I={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=t,k(I,L,ee(i)&&!i.keepAudio)}))}else if("firefox"===p.webRTCAdapter.browserDetails.browser){if(!(p.webRTCAdapter.browserDetails.version>=33)){var G=new Error("NavigatorUserMediaError");return G.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void r.error(G)}I={video:{mozMediaSource:i.video,mediaSource:i.video},audio:ee(i)&&!i.keepAudio},k(I,(function(e,t){if(L(e,t),!e)var r=t.currentTime,n=window.setInterval((function(){t||window.clearInterval(n),t.currentTime==r&&(window.clearInterval(n),t.onended&&t.onended()),r=t.currentTime}),500)}))}return}}i&&"screen"===i.video&&("object"==l(i.video)||i.video instanceof MediaStream||i.audi instanceof MediaStream)||(console.log(!(i.video instanceof MediaStream),i.video instanceof MediaStream),navigator.mediaDevices.enumerateDevices().then((function(t){var o=t.some((function(e){return"audioinput"===e.kind})),s=function(e){if(p.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!==l(e.video)||"object"!==l(e.video.mandatory))return!1;var t=e.video.mandatory;if(t.chromeMediaSource)return"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource;if(t.mozMediaSource)return"window"===t.mozMediaSource||"screen"===t.mozMediaSource;if(t.mediaSource)return"window"===t.mediaSource||"screen"===t.mediaSource;return!1}(i)||t.some((function(e){return"videoinput"===e.kind})),c=ee(i),u=re(i),d=function(e){return p.debug("isAudioSendRequired:",e),!!e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(i),h=function(e){return p.debug("isVideoSendRequired:",e),!!e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(i);if(c||u||d||h){var m=!!c&&o,f=!!u&&s;if(!m&&!f)return a.consentDialog(!1),r.error("No capture device found"),!1;if(!m&&d)return a.consentDialog(!1),r.error("Audio capture is required, but no capture device found"),!1;if(!f&&h)return a.consentDialog(!1),r.error("Video capture is required, but no capture device found"),!1}var v={audio:!(!o||i.keepAudio)&&P,video:!(!s||i.keepVideo)&&y};p.debug("getUserMedia constraints",v),a.consentDialog(void 0,"constraints",v),v.audio||v.video?navigator.mediaDevices.getUserMedia(v).then((function(t){a.consentDialog(!1),H(e,n,i,r,t)})).catch((function(e){a.consentDialog(!1),r.error({code:e.code,name:e.name,message:e.message})})):(a.consentDialog(!1),H(e,n,i,r,T))})).catch((function(e){a.consentDialog(!1),r.error("enumerateDevices error",e)})))}else H(e,n,i,r)}function x(e,t){(t=t||{}).success="function"==typeof t.success?t.success:p.noop,t.error="function"==typeof t.error?t.error:J;var r=t.jsep,n=A[e];if(!n||!n.webrtcStuff)return p.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff;if(r){if(!i.pc)return p.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");i.pc.setRemoteDescription(r).then((function(){if(p.log("Remote description accepted!"),i.remoteSdp=r.sdp,i.candidates&&i.candidates.length>0){for(var e=0;e<i.candidates.length;e++){var n=i.candidates[e];p.debug("Adding remote candidate:",n),n&&!0!==n.completed?i.pc.addIceCandidate(n):i.pc.addIceCandidate(p.endOfCandidates)}i.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}function F(e,t){var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),0;var n=t?"remote":"local",i=r.webrtcStuff;return i.volume[n]||(i.volume[n]={value:0}),i.pc&&i.pc.getStats&&("chrome"===p.webRTCAdapter.browserDetails.browser||"safari"===p.webRTCAdapter.browserDetails.browser)?t&&!i.remoteStream?(p.warn("Remote stream unavailable"),0):t||i.myStream?i.volume[n].timer?i.volume[n].value:(p.log("Starting "+n+" volume monitor"),i.volume[n].timer=setInterval((function(){i.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(t&&!e.remoteSource||!t&&"media-source"!==e.type||(i.volume[n].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(p.warn("Local stream unavailable"),0):(p.warn("Getting the "+n+" volume unsupported by browser"),0)}function V(e,t){var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),!0;var n=r.webrtcStuff;return n.pc?n.myStream?t?n.myStream.getVideoTracks()&&0!==n.myStream.getVideoTracks().length?!n.myStream.getVideoTracks()[0].enabled:(p.warn("No video track"),!0):n.myStream.getAudioTracks()&&0!==n.myStream.getAudioTracks().length?!n.myStream.getAudioTracks()[0].enabled:(p.warn("No audio track"),!0):(p.warn("Invalid local MediaStream"),!0):(p.warn("Invalid PeerConnection"),!0)}function B(e,t,r){var n=A[e];if(!n||!n.webrtcStuff)return p.warn("Invalid handle"),!1;var i=n.webrtcStuff;return i.pc?i.myStream?t?i.myStream.getVideoTracks()&&0!==i.myStream.getVideoTracks().length?(i.myStream.getVideoTracks()[0].enabled=!r,!0):(p.warn("No video track"),!1):i.myStream.getAudioTracks()&&0!==i.myStream.getAudioTracks().length?(i.myStream.getAudioTracks()[0].enabled=!r,!0):(p.warn("No audio track"),!1):(p.warn("Invalid local MediaStream"),!1):(p.warn("Invalid PeerConnection"),!1)}function W(e,t){var r=A[e];return r&&r.webrtcStuff?r.webrtcStuff.pc?(U(e,{message:{request:"publish_message",content:t}}),!0):(p.warn("Invalid PeerConnection"),!1):(p.warn("Invalid handle"),!1)}function j(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(p.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval((function(){r.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1,n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:("audio"===e.mediaType||e.id.toLowerCase().indexOf("audio")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName?"candidate-pair"===e.type&&e.id.indexOf("RTCIceCandidatePair")>=0&&e.bytesSent>100&&(!0,r.rtt=1e3*e.currentRoundTripTime,r.bytesSent=e.bytesSent,r.bytesReceived=e.bytesReceived,p.log("rtt====="+r.rtt)):(t=!0,n=!0),t)if(r.videorecvinfo=e,r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var i=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===p.webRTCAdapter.browserDetails.browser&&(i/=1e3);var a=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/i);"safari"===p.webRTCAdapter.browserDetails.browser&&(a=parseInt(a/1e3)),r.bitrate.value=a,r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}n&&(r.audiorecvinfo=e)}}))}))}),1e3),0):(p.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function Y(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(p.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval((function(){r.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1,n=!1;if("video"===e.mediaType&&"outbound-rtp"===e.type&&e.id.indexOf("rtcp")<0&&(t=!0),"audio"===e.mediaType&&"outbound-rtp"===e.type&&e.id.indexOf("rtcp")<0&&(n=!0),"candidate-pair"===e.type&&e.id.indexOf("RTCIceCandidatePair")>=0&&e.bytesSent>100&&(!0,r.rtt=1e3*e.currentRoundTripTime,r.bytesSent=e.bytesSent,r.bytesReceived=e.bytesReceived,p.log("rtt====="+r.rtt)),t)if(r.videosendinfo=e,r.bitrate.bsnow=e.bytesSent,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var i=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===p.webRTCAdapter.browserDetails.browser&&(i/=1e3);var a=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/i);"safari"===p.webRTCAdapter.browserDetails.browser&&(a=parseInt(a/1e3)),r.bitrate.value=a,r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}n&&(r.audiosendinfo=e)}}))}))}),1e3),0):(p.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function K(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;if(!r.pc)return{};var n={};return n.width=r.videosendinfo.frameWidth,n.height=r.videosendinfo.frameHeight,n}function X(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;if(!r.pc)return{};var n={};return n.width=r.videorecvinfo.frameWidth,n.height=r.videorecvinfo.frameHeight,n}function q(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?(r.videosendinfo.currentRoundTripTime=r.rtt,r.videosendinfo.kbitsPerSecond=r.bitrate.value||0,r.audiosendinfo.currentRoundTripTime=r.rtt,r.audiosendinfo.kbitsPerSecond=r.bitrate.value||0,r):{}}function $(e){var t=A[e];if(!t||!t.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?(r.videorecvinfo.currentRoundTripTime=r.rtt,r.videorecvinfo.kbitsPerSecond=r.bitrate.value||0,r.audiorecvinfo.currentRoundTripTime=r.rtt,r.audiorecvinfo.kbitsPerSecond=r.bitrate.value||0,r):{}}function Q(e,t){var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var n=r.webrtcStuff;return n.pc?(navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t}},audio:!1}).then((function(e){var t=e.getVideoTracks()[0],r=n.pc.getSenders().find((function(e){return e.track.kind==t.kind}));console.log("found sender:",r);var i=n.myStream.getVideoTracks()[0];n.myStream.removeTrack(i),i.stop(),n.myStream.addTrack(t),r.replaceTrack(t)})),0):-1}function z(e,t){var r=A[e];if(!r||!r.webrtcStuff)return p.warn("Invalid handle"),"Invalid handle";var n=r.webrtcStuff;return n.pc?(navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t}},video:!1}).then((function(e){var t=e.getAudioTracks()[0],r=n.pc.getSenders().find((function(e){return e.track.kind==t.kind}));console.log("audio found sender:",r);var i=n.myStream.getAudioTracks()[0];n.myStream.removeTrack(i),i.stop(),n.myStream.addTrack(t),r.replaceTrack(t)})),0):-1}function J(e){p.error("WebRTC error:",e)}function Z(e,n){p.log("Cleaning WebRTC stuff");var i=A[e];if(i){var a=i.webrtcStuff;if(a){if(!0===n){var o={rtclib:"hangup",transaction:p.randomString(12)};i.token&&(o.token=i.token),E&&(o.apisecret=E),p.debug("Sending hangup request (handle="+e+"):"),p.debug(o),t?(o.session_id=R,o.handle_id=e,r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(o))):p.httpAPICall(s+"/"+R+"/"+e,{verb:"POST",withCredentials:f,body:o})}a.remoteStream=null,a.volume&&(a.volume.local&&a.volume.local.timer&&clearInterval(a.volume.local.timer),a.volume.remote&&a.volume.remote.timer&&clearInterval(a.volume.remote.timer)),a.volume={},a.bitrate.timer&&clearInterval(a.bitrate.timer),a.bitrate.timer=null,a.bitrate.bsnow=null,a.bitrate.bsbefore=null,a.bitrate.tsnow=null,a.bitrate.tsbefore=null,a.bitrate.value=null;try{if(!a.streamExternal&&a.myStream){p.log("Stopping local stream tracks");var c,d=u(a.myStream.getTracks());try{for(d.s();!(c=d.n()).done;){var l=c.value;p.log(l),l&&l.stop()}}catch(e){d.e(e)}finally{d.f()}}}catch(e){}a.streamExternal=!1,a.myStream=null;try{a.pc.close()}catch(e){}a.pc=null,a.candidates=null,a.mySdp=null,a.remoteSdp=null,a.iceDone=!1,a.dataChannel={},a.dtmfSender=null}i.oncleanup()}}function ee(e){return p.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function te(e){return p.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function re(e){return p.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function ne(e){return p.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}D(e),this.getServer=function(){return s},this.setServers=function(e){o=0,s=(a=e)[0]},this.isConnected=function(){return g},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:p.noop,e.error="function"==typeof e.error?e.error:p.noop,e.reconnect=!0,D(e)},this.getSessionId=function(){return R},this.destroy=function(a){!function(a){(a=a||{}).success="function"==typeof a.success?a.success:p.noop,a.error="function"==typeof a.error?a.error:p.noop;var o=!0===a.unload,c=!0;void 0!==a.notifyDestroyed&&null!==a.notifyDestroyed&&(c=!0===a.notifyDestroyed);var u=!0===a.cleanupHandles;if(p.log("Destroying session "+R+" (unload="+o+")"),!R)return p.warn("No session to destroy"),a.success(),void(c&&e.destroyed());if(u)for(var d in A)w(d,{noRequest:!0});if(!g)return p.warn("Is the server down? (connected=false)"),R=null,void a.success();var l={rtclib:"destroy",transaction:p.randomString(12)};_&&(l.token=_);E&&(l.apisecret=E);if(o)return t?(r.onclose=null,r&&r.readyState==WebSocket.OPEN&&r.close(),r=null):navigator.sendBeacon(s+"/"+R,JSON.stringify(l)),p.log("Destroyed session:"),R=null,g=!1,a.success(),void(c&&e.destroyed());if(t){l.session_id=R;var h=function(){for(var e in n)r.removeEventListener(e,n[e]);r.removeEventListener("message",m),r.removeEventListener("error",v),i&&clearTimeout(i),r&&r.readyState==WebSocket.OPEN&&r.close()},m=function(t){var r=JSON.parse(t.data);r.session_id==l.session_id&&r.transaction==l.transaction&&(h(),a.success(),c&&e.destroyed())},v=function(t){h(),a.error("Failed to destroy the server: Is the server down?"),c&&e.destroyed()};return r.addEventListener("message",m),r.addEventListener("error",v),void(r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(l)))}p.httpAPICall(s+"/"+R,{verb:"POST",withCredentials:f,body:l,success:function(t){p.log("Destroyed session:"),p.debug(t),R=null,g=!1,"success"!==t.rtclib&&p.error("Ooops: "+t.error.code+" "+t.error.reason),a.success(),c&&e.destroyed()},error:function(t,r){p.error(t+":",r),R=null,g=!1,a.success(),c&&e.destroyed()}})}(a)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:p.noop,e.error="function"==typeof e.error?e.error:p.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:p.noop,e.iceState="function"==typeof e.iceState?e.iceState:p.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:p.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:p.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:p.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:p.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:p.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:p.noop,e.ondata="function"==typeof e.ondata?e.ondata:p.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:p.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:p.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:p.noop,!g)return p.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=e.plugin;if(!n)return p.error("Invalid plugin"),void e.error("Invalid plugin");var i=e.opaqueId,a=e.token?e.token:_,o=p.randomString(12),c={rtclib:"attach",plugin:n,opaque_id:i,transaction:o};a&&(c.token=a);E&&(c.apisecret=E);if(t)return P[o]=function(t){if(p.debug(t),"success"!==t.rtclib)return p.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;p.log("Created handle: "+r);var i={session:O,plugin:n,id:r,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null},rtt:0,videosendinfo:{},audiosendinfo:{},videorecvinfo:{},audiorecvinfo:{}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return F(r,!0)},getRemoteVolume:function(){return F(r,!0)},getLocalVolume:function(){return F(r,!1)},isAudioMuted:function(){return V(r,!1)},muteAudio:function(){return B(r,!1,!0)},unmuteAudio:function(){return B(r,!1,!1)},isVideoMuted:function(){return V(r,!0)},muteVideo:function(){return B(r,!0,!0)},unmuteVideo:function(){return B(r,!0,!1)},getBitrate:function(){return j(r)},sendPublishMessage:function(e){return W(r,e)},getSendBitrate:function(){return Y(r)},getPushResolution:function(){return K(r)},getPullResolution:function(){return X(r)},getSendInfo:function(){return q(r)},getRecvInfo:function(){return $(r)},send:function(e){U(r,e)},data:function(e){k(r,e)},dtmf:function(e){M(r,e)},selectCamera:function(e){return Q(r,e)},selectAudioDevice:function(e){return z(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){G(r,!0,e)},createAnswer:function(e){G(r,!1,e)},handleRemoteJsep:function(e){x(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){Z(r,!0===e)},detach:function(e){w(r,e)}};A[r]=i,e.success(i)},c.session_id=R,void(r&&r.readyState==WebSocket.OPEN&&r.send(JSON.stringify(c)));p.httpAPICall(s+"/"+R,{verb:"POST",withCredentials:f,body:c,success:function(t){if(p.debug(t),"success"!==t.rtclib)return p.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;p.log("Created handle: "+r);var i={session:O,plugin:n,id:r,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return F(r,!0)},getRemoteVolume:function(){return F(r,!0)},getLocalVolume:function(){return F(r,!1)},isAudioMuted:function(){return V(r,!1)},muteAudio:function(){return B(r,!1,!0)},unmuteAudio:function(){return B(r,!1,!1)},isVideoMuted:function(){return V(r,!0)},muteVideo:function(){return B(r,!0,!0)},unmuteVideo:function(){return B(r,!0,!1)},getBitrate:function(){return j(r)},sendPublishMessage:function(){return W(r,e)},getSendBitrate:function(){return Y(r)},getPushResolution:function(){return K(r)},getPullResolution:function(){return X(r)},getSendInfo:function(){return q(r)},getRecvInfo:function(){return $(r)},send:function(e){U(r,e)},data:function(e){k(r,e)},dtmf:function(e){M(r,e)},selectCamera:function(e){return Q(r,e)},selectAudioDevice:function(e){return z(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){G(r,!0,e)},createAnswer:function(e){G(r,!1,e)},handleRemoteJsep:function(e){x(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){Z(r,!0===e)},detach:function(e){w(r,e)}};A[r]=i,e.success(i)},error:function(t,r){p.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}(e)},this.breaki=function(){r&&r.readyState==WebSocket.OPEN&&r.close()}}p.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,r=e&&e.Promise||Promise,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},extension:e&&e.extension||m,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||h,httpAPICall:function(e,n){var i={method:n.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===n.verb&&(i.headers["Content-Type"]="application/json"),void 0!==n.withCredentials&&(i.credentials=!0===n.withCredentials?"include":n.withCredentials?n.withCredentials:"omit"),n.body&&(i.body=JSON.stringify(n.body));var a=t(e,i).catch((function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})}));if(n.timeout){var o=new r((function(e,t){var r=setTimeout((function(){return clearTimeout(r),t({message:"Request timed out",timeout:n.timeout})}),n.timeout)}));a=r.race([a,o])}return a.then((function(e){return e.ok?l(n.success)===l(p.noop)?e.json().then((function(e){n.success(e)})).catch((function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:r.reject({message:"API call failed",response:e})})).catch((function(e){l(n.error)===l(p.noop)&&n.error(e.message||"<< internal error >>",e)})),a}}},p.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||m,webRTCAdapter:e&&e.adapter||h,httpAPICall:function(e,r){var n=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},i=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return t.ajax(t.extend(n,i,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){l(r.success)===l(p.noop)&&r.success(e)},error:function(e,t,n){l(r.error)===l(p.noop)&&r.error(t,n)}}))}}},p.noop=function(){},p.dataChanDefaultLabel="WebRTCDataChannel",p.endOfCandidates=null,p.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:p.noop,p.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),p.trace=p.noop,p.debug=p.noop,p.vdebug=p.noop,p.log=p.noop,p.warn=p.noop,p.error=p.noop,!0===e.debug||"all"===e.debug)p.trace=console.trace.bind(console),p.debug=console.debug.bind(console),p.vdebug=console.debug.bind(console),p.log=console.log.bind(console),p.warn=console.warn.bind(console),p.error=console.error.bind(console);else if(Array.isArray(e.debug)){var t,r=u(e.debug);try{for(r.s();!(t=r.n()).done;){var n=t.value;switch(n){case"trace":p.trace=console.trace.bind(console);break;case"debug":p.debug=console.debug.bind(console);break;case"vdebug":p.vdebug=console.debug.bind(console);break;case"log":p.log=console.log.bind(console);break;case"warn":p.warn=console.warn.bind(console);break;case"error":p.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}}catch(e){r.e(e)}finally{r.f()}}p.log("Initializing library");var i=e.dependencies||p.useDefaultDependencies();p.isArray=i.isArray,p.webRTCAdapter=i.webRTCAdapter,p.httpAPICall=i.httpAPICall,p.newWebSocket=i.newWebSocket,p.extension=i.extension,p.extension.init(),p.listDevices=function(e,t){e="function"==typeof e?e:p.noop,null==t&&(t={audio:!0,video:!0}),p.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(r){p.debug(r),e(r);try{var n,i=u(t.getTracks());try{for(i.s();!(n=i.n()).done;){var a=n.value;a&&a.stop()}}catch(e){i.e(e)}finally{i.f()}}catch(e){}}))})).catch((function(t){p.error(t),e([])})):(p.warn("navigator.mediaDevices unavailable"),e([]))},p.attachMediaStream=function(e,t){try{e.srcObject=t}catch(r){try{e.src=URL.createObjectURL(t)}catch(e){p.error("Error attaching stream to element")}}},p.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(r){try{e.src=t.src}catch(e){p.error("Error reattaching stream to element")}}};var a=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+a];if(window.addEventListener(a,(function(e){for(var t in p.log("Closing window"),p.sessions)p.sessions[t]&&p.sessions[t].destroyOnUnload&&(p.log("Destroying session "+t),p.sessions[t].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()})),p.safariVp8=!1,"safari"===p.webRTCAdapter.browserDetails.browser&&p.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){var s,c=u(RTCRtpSender.getCapabilities("video").codecs);try{for(c.s();!(s=c.n()).done;){var d=s.value;if(d&&d.mimeType&&"video/vp8"===d.mimeType.toLowerCase()){p.safariVp8=!0;break}}}catch(e){c.e(e)}finally{c.f()}p.safariVp8?p.log("This version of Safari supports VP8"):p.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var l=new RTCPeerConnection({});l.createOffer({offerToReceiveVideo:!0}).then((function(e){p.safariVp8=-1!==e.sdp.indexOf("VP8"),p.safariVp8?p.log("This version of Safari supports VP8"):p.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),l.close(),l=null}))}if(p.unifiedPlan=!1,"firefox"===p.webRTCAdapter.browserDetails.browser&&p.webRTCAdapter.browserDetails.version>=59)p.unifiedPlan=!0;else if("chrome"===p.webRTCAdapter.browserDetails.browser&&p.webRTCAdapter.browserDetails.version<72)p.unifiedPlan=!1;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var h=new RTCPeerConnection;try{h.addTransceiver("audio"),p.unifiedPlan=!0}catch(e){}h.close()}else p.unifiedPlan=!1;p.initDone=!0,e.callback()}},p.isWebrtcSupported=function(){return!!window.RTCPeerConnection},p.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},p.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",n=0;n<e;n++){var i=Math.floor(Math.random()*t.length);r+=t.substring(i,i+1)}return r};const f=p;const v={BUILD:"20201019-1526",SDKVERSION:"2.2.1.1",SELFVERSION:"2.4.7",SIGVERSION:"1.0.0",DEVICE_TYPE:"Web",DPKEYS:{MESSAGE:"DPM",PUBLISH:"DPP",WATCH:"DPW"},ACT_PHASE:{LOGIN:"login",LOGIN_CONN:"login-conn",SIG_LOGIN:"sig-login",RELOGIN:"relogin",LOAD:"load",LOAD_TOKEN:"load-tk",LOAD_KEY_N_UID:"load-key",LOAD_DP:"load-dp",LOAD_CONFIG:"load-config",LOAD_FOLLOW:"load-follow",PUSH:"push",PUSH_FIN:"push-fin",UNPUSH:"unpush",REPUSH:"repush",PULL:"pull",UNPULL:"unpull",REPULL:"repull",SIG_AUTH_PUB:"sig-ap",SIG_START_PUB:"sig-spub",SIG_START_PUB_FAIL:"sig-spub-fail",SIG_SET_WATCH_INFO:"sig-swi",STM_ASK_AUTH:"stm-ask-auth",STM_ASK_SERVER:"stm-ask-server",STM_CONNECT:"stm-conn",STM_PUSH:"stm-push",STM_PUSH_PUSH:"stm-push-p",STM_PULL:"stm-pull",STM_PULL_PULL:"stm-pull-p",STM_UNPUSH:"stm-npush",STM_UNPULL:"stm-npull",LOGOUT_MIX:"logout-mix",LOGOUT_STREAMS:"logout-stms",LOGOUT_LOGOUT:"logout-logout",LOGOUT:"logout",MIX_START:"mix-start",MIX_UPDATE:"mix-update",MIX_STOP:"mix-stop",MIX_STARTIN:"mix-start-in",MIX_STOPIN:"mix-stop-in",MIXIN_RESTART_DELAY:"mixin_restart_delay",MIXIN_START:"mixin-start",MIXIN_STOP:"mixin-stop",MIXIN_RESTART:"mixin_restart",SIG_REQMERGE:"sig-reqm",SIG_REQMERGESTAT:"sig-reqmstat",SIG_REQMERGESTAT_DELAY:"sig-reqm-d",SIG_RESTART:"sig-restart"},ACT_PROC:{LOGIN_CONN:"login-conn",SIG_LOGIN:"sig-login",LOAD_DP:"load-dp",LOAD_CONFIG:"load-config",LOAD_FOLLOW:"load-follow",DP:"dp",UID:"uid",KEY:"key",TOKEN:"tk",FOLLOW:"follow",DP_RETRY:"dp-r",UID_RETRY:"uid-r",KEY_RETRY:"key-r",TOKEN_RETRY:"tk-r",CONFIG_RETRY:"config-r",FOLLOW_RETRY:"follow-r",SIG_AUTH_PUB:"sig-ap",SIG_START_PUB:"sig-spub",SIG_SET_WATCH_INFO:"sig-swi",SIG_STOP_PUB:"sig-npub",SIG_START_PULL:"sig-spull",SIG_STOP_PULL:"sig-npull",STM_ASK_AUTH:"stm-ask-auth",STM_ASK_SERVER:"stm-ask-server",STM_CONNECT:"stm-conn",STM_PUSH:"stm-push",STM_PUSH_PUSH:"stm-push-p",STM_PUSH_ASK_AUTH:"stm-push-aa",STM_PULL:"stm-pull",STM_PULL_PULL:"stm-pull-p",STM_UNPUSH:"stm-npush",STM_UNPULL:"stm_npull",STM_CLOSE:"stm-close",LOGOUT_MIX:"logout-mix",LOGOUT_STREAMS:"logout-stms",LOGOUT:"logout",MIX_UPDATE:"mix-update",MIX_STARTIN:"mix-startin",MIX_STOPIN:"mix_stopin",MIXIN_RESTART_DELAY:"mixin_restart_delay",SIG_REQMERGE:"sig-reqm",SIG_REQMERGESTAT:"sig-reqmstat",SIG_REQMERGESTAT_DELAY:"sig-reqm-d",SIG_STOPMERGE:"sig-nm"},ACT_FLOW:{PRE_LOAD:"pload"},ACT_NET_FAIL:"net-fail",ROOM_STATUS:{PRELOGIN:1,LOGIN_PROC:2,LOGIN:3,LOGOUT_PROC:4},ChuangRoomState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangPublishState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangPlayState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangStreamUpdateType:{ADD:"add",DELETE:"delete"},ChuangStreamState:{AUDIO_MUTE:"audio-mute",AUDIO_UNMUTE:"audio-unmute",VIDEO_MUTE:"video-mute",VIDEO_UNMUTE:"video-unmute"},ChuangPlayStreamEvent:{AUDIO_INITIALIZE:"audio-initialize",VIDEO_INITIALIZE:"video-initialize",AUDIO_DISCONNECTED:"auido-disconnected",VIDEO_DISCONNECTED:"video-disconnected",AUDIO_RECEIVE_FIRST_FRAME:"audio-receive-first-frame",VIDEO_RECEIVE_FIRST_FRAME:"video-receive-first-frame",AUDIO_DECODING:"audio-encoding",VIDEO_DECODING:"video-encoding",AUDIO_STUCK:"audio-stuck",VIDEO_STUCK:"video-stuck"},CONN_STATUS:{OFFLINE:WebSocket.CLOSED,ONLINE:WebSocket.OPEN,CONNECTING:WebSocket.CONNECTING,CLOSING:WebSocket.CLOSING},STREAM_STATUS:{CLOSED:1,CONNECTING:2,CONNECTED:4},ICS_STATUS:{FAILED:"failed",DISCONNECTED:"disconnected"},MIX_STATUS:{PRESTART:1,START:2,UPDATE:3,STOP:4},ChuangUserRole:{ANCHOR:1,AUDIENCE:2,INTER_ACTION:3},ChuangPublishChannel:{MAIN:0,AUX:1,SAUX:2},STREAM_TYPE:{RTC:0,MERGE:1},LEAVE_REASON:{NORMAL:0,BAD_NETWORK:1,BANNED_BY_SERVER:2},ChuangStreamMode:{BOTH:0,AUDIO:1,VIDEO:2},ChuangStreamType:{RTC:0,MIX:1},STREAM_REVOKE:{CAMERA:"camera",MICROPHONE:"microphone",SCREEN:"screen"},VIDEO_SOURCE:{CAMERA:1,SCREEN:2,CUSTOM:3},AUDIO_SOURCE:{MICROPHONE:1,DESKTOP:2,CUSTOM:3},SCREEN_LEVEL:{DEFAULT:1,LOW:2,MIDDLE:3,HIGH:4},ChuangVideoConfigPreset:{CHUANG_VIDEO_CONFIG_PRESET_180P:"320 * 180_15_300",CHUANG_VIDEO_CONFIG_PRESET_270P:"480 * 270_15_400",CHUANG_VIDEO_CONFIG_PRESET_360P:"640*360_15_600",CHUANG_VIDEO_CONFIG_PRESET_540P:"960*540_15_1200",CHUANG_VIDEO_CONFIG_PRESET_720P:"1280*720_15_1500",CHUANG_VIDEO_CONFIG_PRESET_1080P:"1920*1080_15_3000"},ChuangLogLevel:{LEVEL_VERBOSE:0,LEVEL_DEBUG:1,LEVEL_INFO:2,LEVEL_WARN:3,LEVEL_ERROR:4,LEVEL_NONE:5},VIDEO_CONFIG_PRESET:{P1920X1080_30_1024:"1920*1080_30_1024",P1920X1080_30_512:"1920*1080_30_512",P1920X1080_30_256:"1920*1080_30_256",P1280X960_30_1024:"1280*960_30_1024",P1280X960_30_512:"1280*960_30_512",P1280X960_30_256:"1280*960_30_256",P960X720_30_1024:"960*720_30_1024",P960X720_30_512:"960*720_30_512",P960X720_30_256:"960*720_30_256",P640X480_30_1024:"640*480_30_1024",P640X480_30_512:"640*480_30_512",P640X480_30_256:"640*480_30_256",P320X240_30_1024:"320*240_30_1024",P320X240_30_512:"320*240_30_512",P320X240_30_256:"320*240_30_256"},SCREEN_CONFIG_PRESET:{P1280X960_30_1024:"1280*960_30_1024",P1280X960_30_2048:"1280*960_30_2048",P1280X960_30_3072:"1280*960_30_3072",P960X720_30_1024:"960*720_30_1024",P960X720_30_2048:"960*720_30_2048",P960X720_30_3072:"960*720_30_3072",P640X480_30_1024:"640*480_30_1024",P640X480_30_2048:"640*480_30_2048",P640X480_30_3072:"640*480_30_3072",P320X240_30_1024:"320*240_30_1024",P320X240_30_2048:"320*240_30_2048",P320X240_30_3072:"320*240_30_3072",P1280X960_15_1024:"1280*960_15_1024",P1280X960_15_2048:"1280*960_15_2048",P1280X960_15_3072:"1280*960_15_3072",P960X720_15_1024:"960*720_15_1024",P960X720_15_2048:"960*720_15_2048",P960X720_15_3072:"960*720_15_3072",P640X480_15_1024:"640*480_15_1024",P640X480_15_2048:"640*480_15_2048",P640X480_15_3072:"640*480_15_3072",P320X240_15_1024:"320*240_15_1024",P320X240_15_2048:"320*240_15_2048",P320X240_15_3072:"320*240_15_3072",P1280X960_10_1024:"1280*960_10_1024",P1280X960_10_2048:"1280*960_10_2048",P1280X960_10_3072:"1280*960_10_3072",P960X720_10_1024:"960*720_10_1024",P960X720_10_2048:"960*720_10_2048",P960X720_10_3072:"960*720_10_3072",P640X480_10_1024:"640*480_10_1024",P640X480_10_2048:"640*480_10_2048",P640X480_10_3072:"640*480_10_3072",P320X240_10_1024:"320*240_10_1024",P320X240_10_2048:"320*240_10_2048",P320X240_10_3072:"320*240_10_3072",P1280X960_5_1024:"1280*960_5_1024",P1280X960_5_2048:"1280*960_5_2048",P1280X960_5_3072:"1280*960_5_3072",P960X720_5_1024:"960*720_5_1024",P960X720_5_2048:"960*720_5_2048",P960X720_5_3072:"960*720_5_3072",P640X480_5_1024:"640*480_5_1024",P640X480_5_2048:"640*480_5_2048",P640X480_5_3072:"640*480_5_3072",P320X240_5_1024:"320*240_5_1024",P320X240_5_2048:"320*240_5_2048",P320X240_5_3072:"320*240_5_3072"},ChuangMixResolutions:{R800_600:"0",R432_768:"1",R768_432:"2",R1280_720:"3",R720_1280:"4"}};var _=function(e,t,r){return{s:e,r:t,v:r}},E=[_("Windows 10",/(Windows 10.0|Windows NT 10.0)/i,"10.0"),_("Windows 8.1",/(Windows 8.1|Windows NT 6.3)/i,"6.3"),_("Windows 8",/(Windows 8|Windows NT 6.2)/i,"6.2"),_("Windows 7",/(Windows 7|Windows NT 6.1)/i,"6.1"),_("Windows Vista",/Windows NT 6.0/i,"6.0"),_("Windows Server 2003",/Windows NT 5.2/i,"5.2"),_("Windows XP",/(Windows NT 5.1|Windows XP)/i,"5.1"),_("Windows 2000",/(Windows NT 5.0|Windows 2000)/i,"5.0"),_("Windows 2008",/Windows NT 6.0; WOW64/i,"6.0"),_("Windows 2008",/Windows NT 6.1; WOW64/i,"6.1"),_("Windows 2012",/Windows NT 6.3; Win64/i,"6.3"),_("Windows ME",/(Win 9x 4.90|Windows ME)/i,"4.90"),_("Windows 98",/(Windows 98|Win98)/i,"4.10"),_("Windows 95",/(Windows 95|Win95|Windows_95)/i,"4.00"),_("Windows NT 4.0",/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/i,"4.0"),_("Windows CE",/Windows CE/i,""),_("Windows 3.11",/Win16/i,"3.1"),_("Chrome OS",/CrOS/i,""),_("Mac OS X",/Mac OS X (10([_|\.])11([0-9_\.]*))/i,"Capitan"),_("Mac OS X",/Mac OS X (10([_|\.])10([0-9_\.]*))/i,"Yosemite"),_("Mac OS X",/Mac OS X (10([_|\.])9([0-9_\.]*))/i,"Mavericks"),_("Mac OS X",/Mac OS X (10([_|\.])8([0-9_\.]*))/i,"Mountain Lion"),_("Mac OS X",/Mac OS X (10([_|\.])7([0-9_\.]*))/i,"Lion"),_("Mac OS X",/Mac OS X (10([_|\.])6([0-9_\.]*))/i,"Snow Leopard"),_("Mac OS X",/Mac OS X (10([_|\.])5([0-9_\.]*))/i,"Leopard"),_("Mac OS X",/Mac OS X (10([_|\.])4([0-9_\.]*))/i,"Tiger"),_("Mac OS X",/Mac OS X (10([_|\.])3([0-9_\.]*))/i,"Panther"),_("Mac OS X",/Mac OS X (10([_|\.])2([0-9_\.]*))/i,"Jaguar"),_("Mac OS X",/Mac OS X (10([_|\.])1([0-9_\.]*))/i,"Puma"),_("Mac OS X",/Mac OS X (10([_|\.])0([0-9_\.]*))/i,"Cheetah"),_("Mac OS",/(Mac OS|MacPPC|MacIntel|Mac_PowerPC|Macintosh)/i,""),_("Ubuntu",/Ubuntu\/([0-9\.]*)/i,""),_("CentOs",/CentOs\/([0-9\.]*)/i,""),_("Debian",/Debian/i,""),_("Gentoo",/Gentoo/i,""),_("Android",/Android/i,""),_("Open BSD",/OpenBSD/i,""),_("Sun OS",/SunOS/i,""),_("iOS",/(iPhone|iPad|iPod)/i,""),_("QNX",/QNX/i,""),_("UNIX",/UNIX/i,""),_("BeOS",/BeOS/i,""),_("OS/2",/OS\/2/i,""),_("Search Bot",/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/i,""),_("Linux",/Linux/i,"")];const S={biCache:null,getBrowserInfo:function(){if(!this.biCache){var e,t,r,n=navigator.userAgent,i=n.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];"Chrome"===i[1]&&null!=(e=n.match(/(OPR(?=\/))\/?(\d+)/i))&&(i=e),"Safari"===i[1]&&null!=(e=n.match(/version\/(\d+)/i))&&(i[2]=e[1]),~n.toLowerCase().indexOf("qqbrowser")&&null!=(e=n.match(/(qqbrowser(?=\/))\/?(\d+)/i))&&(i=e),~n.toLowerCase().indexOf("micromessenger")&&null!=(e=n.match(/(micromessenger(?=\/))\/?(\d+)/i))&&(i=e),~n.toLowerCase().indexOf("edge")&&null!=(e=n.match(/(edge(?=\/))\/?(\d+)/i))&&(i=e),~n.toLowerCase().indexOf("trident")&&null!=(e=/\brv[ :]+(\d+)/g.exec(n)||[])&&(i=[null,"IE",e[1]]);for(var a=0,o=E.length;a<o;a++)if((t=E[a]).r.test(navigator.userAgent.toLowerCase())){r=t;break}this.biCache={name:i[1],version:i[2],os:r?r.s:"Other",osversion:r?r.v:""}}return this.biCache},isChrome:function(){var e=this.getBrowserInfo();return e.name&&"Chrome"===e.name},isSafari:function(){var e=this.getBrowserInfo();return e.name&&"Safari"===e.name},isEdge:function(){var e=this.getBrowserInfo();return e.name&&"Edge"===e.name},isFireFox:function(){var e=this.getBrowserInfo();return e.name&&"Firefox"===e.name},isOpera:function(){var e=this.getBrowserInfo();return e.name&&"OPR"===e.name},isQQBrowser:function(){var e=this.getBrowserInfo();return e.name&&"QQBrowser"===e.name},isWeChatBrowser:function(){var e=this.getBrowserInfo();return e.name&&"MicroMessenger"===e.name},isSupportedPC:function(){var e=this.getBrowserInfo().os;return"Linux"===e||"Mac OS X"===e||"Mac OS"===e||-1!==e.indexOf("Windows")},isSupportedMobile:function(){var e=this.getBrowserInfo().os;return"Android"===e||"iOS"===e},_isChromeKernel:function(){return!!navigator.userAgent.match(/chrome\/[\d]./i)},_isLegacyChrome:function(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35},_getChromeKernelVersion:function(){var e=navigator.userAgent.match(/chrome\/[\d]./i);return e&&e[0]&&e[0].split("/")[1]},_getNettype:function(){return window.navigator.connection&&window.navigator.connection.effectiveType}};function C(e,t){for(var r in t){var n=t[r];e=e.replace(new RegExp("\\$\\{"+r+"\\}","gm"),n)}return e}function T(e,t,r){var n,i=e.replace(/-/g,"_"),a={code:e,no:0};return T.CODE.CHUANG_LOGIN_FAILED_APPID===e||T.CODE.CHUANG_WEBRTC_SIGNAL_ERROR===e?a.no=r&&r.errcode?r.errcode:-1:a.no=T.ErrorCode[i]||-1,t?a.msg=r?C(t,r):t:(n=T.MSG[i])&&(a.msg=r?C(n,r):n),a}T.CODE={CHUANG_ENGINE_NOT_INIT:"CHUANG_ENGINE_NOT_INIT",CHUANG_APPID_NULL:"CHUANG_APPID_NULL",CHUANG_APPID_INVALID:"CHUANG_APPID_INVALID",CHUANG_APPKEY_NULL:"CHUANG_APPKEY_NULL",CHUANG_APPKEY_INVALID:"CHUANG_APPKEY_INVALID",CHUANG_INVALID_PARAMETERS:"CHUANG_INVALID_PARAMETERS",CHUANG_ROLE_PERMISSION_ERROR:"CHUANG_ROLE_PERMISSION_ERROR",CHUANG_NOT_LOGIN:"CHUANG_NOT_LOGIN",CHUANG_PUBLISH_MESSAGE_BEFORE_PUBLISH:"CHUANG_PUBLISH_MESSAGE_BEFORE_PUBLISH",CHUANG_VIDEO_CONFIG_ERROR:"CHUANG_VIDEO_CONFIG_ERROR",CHUANG_AUDIO_CONFIG_ERROR:"CHUANG_AUDIO_CONFIG_ERROR",CHUANG_PUBLISH_STREMID_AUTH_FAILED:"CHUANG_PUBLISH_STREMID_AUTH_FAILED",CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:"CHUANG_STREAM_DISCONNECTED_BAD_NETWORK",CHUANG_RTMP_TRANSFORM_CONNECT_FAILED:"CHUANG_RTMP_TRANSFORM_CONNECT_FAILED",CHUANG_USERID_NULL:"CHUANG_USERID_NULL",CHUANG_USERID_TOO_LONG:"CHUANG_USERID_TOO_LONG",CHUANG_USERID_INVALID:"CHUANG_USERID_INVALID",CHUANG_ROOMID_NULL:"CHUANG_ROOMID_NULL",CHUANG_ROOMID_TOO_LONG:"CHUANG_ROOMID_TOO_LONG",CHUANG_ROOMID_INVALID:"CHUANG_ROOMID_INVALID",CHUANG_MIX_STREAMID_NULL:"CHUANG_MIX_STREAMID_NULL",CHUANG_MIX_STREAMID_TOO_LONG:"CHUANG_MIX_STREAMID_TOO_LONG",CHUANG_MIX_STREAMID_INVALID:"CHUANG_MIX_STREAMID_INVALID",CHUANG_MIX_STREAM_PARAMETER_INVALID:"CHUANG_MIX_STREAM_PARAMETER_INVALID",CHUANG_MIX_STREAM_ADDRESS_INVALID:"CHUANG_MIX_STREAM_ADDRESS_INVALID",CHUANG_MIX_STREAM_CONFIG_ERROR:"CHUANG_MIX_STREAM_CONFIG_ERROR",CHUANG_STREAMID_EXIST:"CHUANG_STREAMID_EXIST",CHUANG_WEBRTC_CHANNEL_EXISTS:"CHUANG_WEBRTC_CHANNEL_EXISTS",CHUANG_MIX_STREAM_TOO_MUCH:"CHUANG_MIX_STREAM_TOO_MUCH",CHUANG_MIX_NO_STREAM:"CHUANG_MIX_NO_STREAM",CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:"CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED",CHUANG_TOKEN_AUTH_ERROR:"CHUANG_TOKEN_AUTH_ERROR",CHUANG_TOKEN_AUTH_FAILED:"CHUANG_TOKEN_AUTH_FAILED",CHUANG_MIX_STREAM_BEFORE_PUBLISH:"CHUANG_MIX_STREAM_BEFORE_PUBLISH",CHUANG_LOGIN_FAILED_APPID:"CHUANG_LOGIN_FAILED_APPID",CHUANG_LOGIN_FAILED_BANNED:"CHUANG_LOGIN_FAILED_BANNED",CHUANG_LOGIN_FAILED:"CHUANG_LOGIN_FAILED",CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:"CHUANG_ROOM_DISCONNECTED_BAD_NETWORK",CHUANG_LOGIN_FAILED_PARAM_ERROR:"CHUANG_LOGIN_FAILED_PARAM_ERROR",CHUANG_ROOM_RECONNECTED:"CHUANG_ROOM_RECONNECTED",CHUANG_STREAMID_NULL:"CHUANG_STREAMID_NULL",CHUANG_STREAMID_TOO_LONG:"CHUANG_STREAMID_TOO_LONG",CHUANG_STREAMID_INVALID:"CHUANG_STREAMID_INVALID",CHUANG_RTMP_ADDRESS_INVALID:"CHUANG_RTMP_ADDRESS_INVALID",CHUANG_RTMP_ADDRESS_TOO_LONG:"CHUANG_RTMP_ADDRESS_TOO_LONG",CHUANG_PUBLISH_MESSAGE_NULL:"CHUANG_PUBLISH_MESSAGE_NULL",CHUANG_NO_MIC_PERMISSION:"CHUANG_NO_MIC_PERMISSION",CHUANG_NO_CAMERA_PERMISSION:"CHUANG_NO_CAMERA_PERMISSION",CHUANG_MIC_CAPTURE_DATA_FAILED:"CHUANG_MIC_CAPTURE_DATA_FAILED",CHUANG_CAMERA_INIT_FAILED:"CHUANG_CAMERA_INIT_FAILED",CHUANG_MIC_INIT_FAILED:"CHUANG_MIC_INIT_FAILED",CHUANG_CANVAS_NULL:"CHUANG_CANVAS_NULL",CHUANG_CUSTOM_VIDEO_CONFIG_ERROR:"CHUANG_CUSTOM_VIDEO_CONFIG_ERROR",CHUANG_CUSTOM_VIDEO_CAPTURE_CALLED_ERROR:"CHUANG_CUSTOM_VIDEO_CAPTURE_CALLED_ERROR",CHUANG_PUBLISH_CHANNEL_ERROR:"CHUANG_PUBLISH_CHANNEL_ERROR",CHUANG_PUBLISH_STREAM_RECONNECTED:"CHUANG_PUBLISH_STREAM_RECONNECTED",CHUANG_PLAY_STREAM_RECONNECTED:"CHUANG_PLAY_STREAM_RECONNECTED",CHUANG_STARTPREVIEW_NOT_SETPREVIEW:"CHUANG_STARTPREVIEW_NOT_SETPREVIEW",CHUANG_WEBRTC_SIGNAL_ERROR:"CHUANG_WEBRTC_SIGNAL_ERROR",CHUANG_WEBRTC_DOM_NOT_FOUND:"CHUANG_WEBRTC_DOM_NOT_FOUND",CHUANG_WEBRTC_ADDRESS_INVALID:"CHUANG_WEBRTC_ADDRESS_INVALID",CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED:"CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED",CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED:"CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED",CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED:"  CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED",CHUANG_WEBRTC_PUBLISH_EXCEPTION:"CHUANG_WEBRTC_PUBLISH_EXCEPTION",CHUANG_WEBRTC_PULL_EXCEPTION:"CHUANG_WEBRTC_PULL_EXCEPTION",CHUANG_WEBRTC_ICE_ERROR:"CHUANG_WEBRTC_ICE_ERROR",CHUANG_WEBRTC_ERROR:"CHUANG_WEBRTC_ERROR",CHUANG_WEBRTC_UNKNOWN_ERROR:"CHUANG_WEBRTC_UNKNOWN_ERROR"},T.ErrorCode={CHUANG_SUCCESS:0,CHUANG_ENGINE_NOT_INIT:10001,CHUANG_APPID_NULL:10002,CHUANG_APPID_INVALID:10003,CHUANG_APPKEY_NULL:10004,CHUANG_APPKEY_INVALID:10005,CHUANG_INVALID_PARAMETERS:10008,CHUANG_ROLE_PERMISSION_ERROR:10009,CHUANG_USERID_NULL:11001,CHUANG_USERID_TOO_LONG:11002,CHUANG_USERID_INVALID:11003,CHUANG_ROOMID_NULL:11004,CHUANG_ROOMID_TOO_LONG:11005,CHUANG_ROOMID_INVALID:11006,CHUANG_TOKEN_AUTH_ERROR:11007,CHUANG_TOKEN_AUTH_FAILED:11008,CHUANG_LOGIN_FAILED_APPID:11009,CHUANG_LOGIN_FAILED_BANNED:11010,CHUANG_LOGIN_FAILED:11011,CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:11012,CHUANG_LOGIN_FAILED_PARAM_ERROR:11013,CHUANG_ROOM_RECONNECTED:11014,CHUANG_STREAMID_NULL:12001,CHUANG_STREAMID_TOO_LONG:12002,CHUANG_STREAMID_INVALID:12003,CHUANG_RTMP_ADDRESS_INVALID:12004,CHUANG_RTMP_ADDRESS_TOO_LONG:12005,CHUANG_PUBLISH_MESSAGE_NULL:12006,CHUANG_STREAMID_EXIST:12007,CHUANG_NOT_LOGIN:12008,CHUANG_PUBLISH_MESSAGE_BEFORE_PUBLISH:12009,CHUANG_VIDEO_CONFIG_ERROR:12010,CHUANG_AUDIO_CONFIG_ERROR:12011,CHUANG_PUBLISH_STREMID_AUTH_FAILED:12012,CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:12013,CHUANG_RTMP_TRANSFORM_CONNECT_FAILED:12014,CHUANG_NO_MIC_PERMISSION:12015,CHUANG_NO_CAMERA_PERMISSION:12016,CHUANG_MIC_CAPTURE_DATA_FAILED:12017,CHUANG_CAMERA_INIT_FAILED:12019,CHUANG_MIC_INIT_FAILED:12020,CHUANG_CANVAS_NULL:12021,CHUANG_CUSTOM_VIDEO_CONFIG_ERROR:12022,CHUANG_CUSTOM_VIDEO_CAPTURE_CALLED_ERROR:12023,CHUANG_PUBLISH_CHANNEL_ERROR:12024,CHUANG_PUBLISH_STREAM_RECONNECTED:12025,CHUANG_PLAY_STREAM_RECONNECTED:12026,CHUANG_STARTPREVIEW_NOT_SETPREVIEW:12027,CHUANG_MIX_STREAM_ADDRESS_INVALID:13001,CHUANG_MIX_STREAMID_TOO_LONG:13002,CHUANG_MIX_STREAM_TOO_MUCH:13003,CHUANG_MIX_STREAM_BEFORE_PUBLISH:13004,CHUANG_MIX_STREAM_CONFIG_ERROR:13005,CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:13006,CHUANG_MIX_STREAM_PARAMETER_INVALID:13007,CHUANG_MIX_STREAMID_NULL:13008,CHUANG_MIX_STREAMID_INVALID:13009,CHUANG_MIX_NO_STREAM:13010,CHUANG_WEBRTC_DOM_NOT_FOUND:100001,CHUANG_WEBRTC_ADDRESS_INVALID:100002,CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED:100003,CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED:100004,CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED:100005,CHUANG_WEBRTC_PUBLISH_EXCEPTION:100006,CHUANG_WEBRTC_ICE_ERROR:100007,CHUANG_WEBRTC_ERROR:100008,CHUANG_WEBRTC_CHANNEL_EXISTS:100009,CHUANG_WEBRTC_PULL_EXCEPTION:100010,CHUANG_WEBRTC_UNKNOWN_ERROR:100011,CHUANG_WEBRTC_SIGNAL_ERROR:100012},T.MSG={CHUANG_ENGINE_NOT_INIT:"sdk未初始化，就调用非静态方法",CHUANG_APPID_NULL:"appId为空",CHUANG_APPID_INVALID:"appId包含非法字符",CHUANG_APPKEY_NULL:"appKey传空",CHUANG_APPKEY_INVALID:"appKey 包含非法字符",CHUANG_INVALID_PARAMETERS:"参数错误",CHUANG_ROLE_PERMISSION_ERROR:"操作与角色不符",CHUANG_NOT_LOGIN:"未登录房间或登录房间未成功，调用推流、拉流前必须登录房间成功",CHUANG_PUBLISH_MESSAGE_BEFORE_PUBLISH:"发送推流附加消息时还未推流成功",CHUANG_VIDEO_CONFIG_ERROR:"视频配置错误",CHUANG_AUDIO_CONFIG_ERROR:"音频配置错误",CHUANG_PUBLISH_STREMID_AUTH_FAILED:"推流ID非法，可能已经被占用",CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:"网络原因导致推流或播流中断重连",CHUANG_RTMP_TRANSFORM_CONNECT_FAILED:"转推RTMP连接服务器失败",CHUANG_USERID_NULL:"用户ID为空",CHUANG_USERID_TOO_LONG:"用户ID过长，长度应小于256字节，最长为255字节",CHUANG_USERID_INVALID:"用户ID非法",CHUANG_ROOMID_NULL:"房间ID为空",CHUANG_ROOMID_TOO_LONG:"房间ID过长，长度应小于256字节，最长为255字节",CHUANG_ROOMID_INVALID:"用户ID非法",CHUANG_MIX_STREAMID_NULL:"混流ID为空",CHUANG_MIX_STREAMID_TOO_LONG:"混流ID过⻓ ⻓度应⼩于256字节，最长为255字节",CHUANG_MIX_STREAMID_INVALID:"混流ID包含非法字符",CHUANG_MIX_STREAM_PARAMETER_INVALID:"混流参数错误",CHUANG_MIX_STREAM_ADDRESS_INVALID:"RTMP地址非法",CHUANG_MIX_STREAM_CONFIG_ERROR:"混流配置设置错误",CHUANG_STREAMID_EXIST:"流ID已经存在",CHUANG_WEBRTC_CHANNEL_EXISTS:"已经存在一个主流或副流",CHUANG_MIX_STREAM_TOO_MUCH:"混入输入流数量过多，最多允许混9路流",CHUANG_MIX_NO_STREAM:"没有可参与混流的流或者因为混流未成功不能进行混流布局更新",CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:"混流输出分辨率不支持",CHUANG_MIX_STREAM_BEFORE_PUBLISH:"未推流成功就发起混流",CHUANG_TOKEN_AUTH_ERROR:"token 校验出错，可能是token过期或者token传错",CHUANG_TOKEN_AUTH_FAILED:"token校验失败，可能是网络异常导致校验超时",CHUANG_LOGIN_FAILED_APPID:"登录失败,一般是AppId/AppKey错误导致",CHUANG_LOGIN_FAILED_BANNED:"由于被封禁导致登录失败",CHUANG_LOGIN_FAILED:"其他原因导致登录失败",CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:"网络原因导致房间链接断开",CHUANG_LOGIN_FAILED_PARAM_ERROR:"参数错误导致登录失败，login.ack中errcode 为-202时",CHUANG_ROOM_RECONNECTED:"房间重连成功",CHUANG_STREAMID_NULL:"流ID为空",CHUANG_STREAMID_TOO_LONG:"流ID过长，长度应小于256字符，最长为255字符",CHUANG_STREAMID_INVALID:"流ID包含非法字符",CHUANG_RTMP_ADDRESS_INVALID:"推流转推RTMP地址非法",CHUANG_RTMP_ADDRESS_TOO_LONG:"推流转推RTMP地址过长，长度应小于1024字节",CHUANG_PUBLISH_MESSAGE_NULL:"推流附加消息为空",CHUANG_NO_MIC_PERMISSION:"无麦克风权限",CHUANG_NO_CAMERA_PERMISSION:"无摄像头权限",CHUANG_MIC_CAPTURE_DATA_FAILED:"推流音频采集数据失败",CHUANG_CAMERA_INIT_FAILED:"采集视像头初始化失败 摄像头名称设置错误或找不到设备",CHUANG_MIC_INIT_FAILED:"麦克风初始化失败",CHUANG_CANVAS_NULL:"预览canvas view 为空",CHUANG_CUSTOM_VIDEO_CONFIG_ERROR:"设置视频自定义采集格式错误",CHUANG_CUSTOM_VIDEO_CAPTURE_CALLED_ERROR:"自定义采集接口调用错误",CHUANG_PUBLISH_CHANNEL_ERROR:"推流通道设置错误",CHUANG_PUBLISH_STREAM_RECONNECTED:"推流重连成功",CHUANG_PLAY_STREAM_RECONNECTED:"播流重连成功",CHUANG_STARTPREVIEW_NOT_SETPREVIEW:"从未设置预览就是开始预览",CHUANG_WEBRTC_SIGNAL_ERROR:"信令发生了错误:${req},${errcode}",CHUANG_WEBRTC_DOM_NOT_FOUND:"找不到id为${domId}的网页元素",CHUANG_WEBRTC_ADDRESS_INVALID:"当前地址非https或localhost，无法使用本SDK",CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED:"浏览器不支持WebRTC组件",CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED:"用户禁用了采集权限",CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED:"无法开启媒体设备",CHUANG_WEBRTC_PUBLISH_EXCEPTION:"RTC推流异常: ${err}",CHUANG_WEBRTC_PULL_EXCEPTION:"RTC播流异常: ${err}",CHUANG_WEBRTC_ICE_ERROR:"WebRTC ICE严重错误",CHUANG_WEBRTC_ERROR:"WebRTC P2P其它异常",CHUANG_WEBRTC_UNKNOWN_ERROR:"未知异常: ${err}"};const g=T;const R={DPServer:["https://glb.aocrtcr.com"],DP_Reconn_Retry:1,DP_Conn_Timeout:5e3,DP_Cache_Time:1e4,UIDServer:["https://config.aocrtcr.com"],UID_Reconn_Retry:2,UID_Conn_Timeout:5e3,UID_Cache_Time:864e5,KEYServer:["https://config.aocrtcr.com"],KEY_Reconn_Retry:2,KEY_Conn_Timeout:5e3,KEY_Cache_Time:864e5,TOKENServer:["https://api-rtc.chuangcache.com"],TOKEN_Reconn_Retry:2,TOKEN_Conn_Timeout:5e3,TOKEN_Cache_Time:36e5,CONFIGServer:["https://config.aocrtcr.com"],CONFIG_Reconn_Retry:2,CONFIG_Conn_Timeout:5e3,CONFIG_Cache_Time:1e4,FOLLOWServer:[],FOLLOW_Reconn_Retry:3,FOLLOW_Conn_Timeout:5e3,RTCConfig:{client:{device:"unknown",ip:"124.202.169.82",uid:0},message_server:{retry_count:3},udp:{publish_retry_count_normal:1,publish_retry_count_nat:3,watch_retry_count_normal:1,watch_retry_count_nat:3}},StunServer:["stun:config.aocrtcr.com:3688"],SerUploadServer:"https://report.aocrtcr.com:8190",LogUpload:!1,LogUploadServer:"https://api-rtc.chuangcache.com",LogUploadItvl:6e5,LogUploadKeys:["crtc","dyf8c4HhBsciG31iSRFYKlHwpAGfyeVn"],EventUploadServer:"https://api-rtc.chuangcache.com",EventUploadKeys:["crtc","dyf8c4HhBsciG31iSRFYKlHwpAGfyeVn"],AjaxTimeout:6e3,Signal_Conn_Timeout:6e3,Signal_Reconn_Delay:1e3,Signal_Reconn_Retry:3,Signal_Ping_Interval:1e4,Signal_Pong_Timeout:3e4,Signal_login_Timeout:5e3,Signal_authpublish_Timeout:1e4,Signal_startpublish_Timeout:1e4,Signal_stoppublish_Timeout:1e4,Signal_startplay_Timeout:1e4,Signal_stopplay_Timeout:1e4,Signal_logout_Timeout:1e4,Signal_reqlist_Timeout:1e4,Signal_reqmerge_Timeout:1e4,Signal_stopmerge_Timeout:1e4,Signal_reqmergestat_Timeout:1e4,Signal_setwatchinfo_Timeout:5e3,Signal_Stream_Heartbeat_Interval:5e3,Signal_mergestat_Timeout:3e4,Stream_PushAddr:"140.210.79.43",Stream_PushPort:8080,Stream_PullAddr:"140.210.79.43",Stream_PushMode:3,Stream_Disconn_Cooldown:1e3,Stream_Disconn_Recover:6e3,Stream_Push_Reconn_Retry:2,Stream_Pull_Reconn_Retry:2,Stream_Default_Retry:2,Stream_Ask_Server_Timeout:1e3,Stream_Push_Conn_Timeout:5e3,Stream_Pull_Conn_Timeout:5e3,Stream_Close_Timeout:1e3,Stream_Rtt_Interval:1e3,Stream_CheckConn_Timeout:5e3,Pull_Event_Interval:2e3,Pull_Event_Timeout:5e3,Room_uid_Timeout:3e3,Room_dp_Timeout:3e3,Room_key_Timeout:3e3,Room_tk_Timeout:1e3,RTCLibDebug:!1,Mix_Stream_Gain:"1.0",Mix_Stream_Back:"1",Mix_Stream_Mixa:"255",Mix_Stream_Mixv:"1"};var A,O=["TRACE","DEBUG","INFO","WARN","ERROR","NONE"],I=0,P=window.console||{log:function(){}},y=["trace","debug","info","warn","error"],N=function(){var e,t=arguments[0],r=arguments;if(r[0]=(e=new Date).toLocaleString()+":"+e.getMilliseconds()+" ChuangLiveEngine ["+(O[t]||"DEFAULT")+"]:",R.LogUpload,!(t<I))return(P[y[t]]||P.log).apply(P,r)},b={},D={TRACE:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,NONE:5,enableLogUpload:function(){R.LogUpload=!0},disableLogUpload:function(){R.LogUpload=!1},setLogLevel:function(e){e>5?e=5:e<0&&(e=0),I=e},trace:function(){for(var e=[0],t=0;t<arguments.length;t++)e.push(arguments[t]);N.apply(this,e)},debug:function(){for(var e=[1],t=0;t<arguments.length;t++)e.push(arguments[t]);N.apply(this,e)},info:function(){for(var e=[2],t=0;t<arguments.length;t++)e.push(arguments[t]);N.apply(this,e)},warning:A=function(){for(var e=[3],t=0;t<arguments.length;t++)e.push(arguments[t]);N.apply(this,e)},deprecate:function(e){b[e]||(A.apply(void 0,arguments),b[e]=!0)},error:function(){for(var e=[4],t=0;t<arguments.length;t++)e.push(arguments[t]);N.apply(this,e)},noop:function(){}};D.setLogLevel(D.INFO);const U=D;function L(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._listeners={},this.on=this.addEventListener,this.off=this.removeEventListener,this._linkers=null,this.linkname=null,this.linktag=null,this.timerId=null,this.timerFunc=null,this.timerFlag=!0}var t,r,n;return t=e,n=[{key:"changeTimerCore",value:function(e){e&&(H=e)}},{key:"getTimerCore",value:function(){return H}},{key:"createEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n={};return n.type=e,n.intransit=!1,n.event={type:t},r&&(n.event.data=r),n}},{key:"watcherEvent",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e.createEvent("watcher",t,r)}}],(r=[{key:"uninit",value:function(){for(var e in this._listeners)delete this._listeners[e];this.linkClose(),this.timerDisable()}},{key:"addEventListener",value:function(e,t){return void 0===this._listeners[e]&&(this._listeners[e]=[]),"function"==typeof t&&this._listeners[e].push(t),this}},{key:"hasListeners",value:function(e){return!(!this._listeners[e]||!this._listeners[e].length)}},{key:"removeEventListener",value:function(e,t){var r;return this._listeners[e]&&-1!==(r=this._listeners[e].indexOf(t))&&this._listeners[e].splice(r,1),this}},{key:"removeEvent",value:function(e){return this._listeners[e]&&delete this._listeners[e],this}},{key:"dispatchEvent",value:function(e){var t;for(t in this._listeners[e.type])if(this._listeners[e.type]&&this._listeners[e.type].hasOwnProperty(t)&&"function"==typeof this._listeners[e.type][t])try{this._listeners[e.type][t](e.event)}catch(r){U.debug("[".concat(e.type,"] Error ").concat(t," event"),r)}if(this._linkers)for(var r=0,n=this._linkers.length;r<n;r++){var i=this._linkers[r];w.transmit(i,e,this)}}},{key:"linkOpen",value:function(e){if(e)return this.linkname=e,w.regist(e,this),this}},{key:"linkClose",value:function(){this.linkname&&w.unregist(this.linkname)}},{key:"linkTag",value:function(e){return this.linktag=e,this}},{key:"linkAdd",value:function(e){this._linkers||(this._linkers=[]),this._linkers.push(e)}},{key:"linkRemove",value:function(e){if(this._linkers){var t=this._linkers.indexOf(e);t>-1&&this._linkers.splice(t,1)}}},{key:"timerEnable",value:function(e){return e&&(this.timerFunc=e,!this.timerId&&(this.timerId=H.regist(this))),this}},{key:"timerDisable",value:function(){this.timerId&&H.unregist(this.timerId),this.timerId=null,this.timerFunc=null}},{key:"timerAdd",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n=n||e;var i={type:e,data:r};H.commit(this.timerId,n,i,t)}},{key:"timerRemove",value:function(e){H.uncommit(this.timerId,e)}},{key:"timerStart",value:function(){this.timerFlag=!0}},{key:"timerStop",value:function(){this.timerFlag=!1}}])&&L(t.prototype,r),n&&L(t,n),e}();k.Type={SOCKET:"socket",HEARTBEAT:"heartbeat",WATCHER:"watcher",SIGNAL:"signal",SIGNAL_STM:"signal-stream",STREAM:"stream",RESOURCE:"resource",TIMER:"timer",APP:"app"},k.Create={socket:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return k.createEvent("socket",e,t)},heartbeat:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return k.createEvent("heartbeat",e,t)},signal:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return k.createEvent("signal",e,t)},signal_stream:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(r=k.createEvent("signal-stream",e,n)).event.streamId=t,r},stream:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(r=k.createEvent("stream",e,n)).event.streamId=t,r},resource:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return k.createEvent("resource",e,t)},app:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return k.createEvent("app",e,t)}},k.Name={room:function(e){return"room#"+e}};const M=k;var w={_ebevents:{},_eventInterceptor:null,regist:function(e,t){if(this._ebevents[e])throw new Error("duplicate event: "+e);this._ebevents[e]=t},unregist:function(e){delete this._ebevents[e]},transmit:function(e,t,r){var n=null;return!!(n=this._ebevents[e])&&(!t.intransit&&(t.intransit=!0,n.dispatchEvent(t),t.intransit=!1,!0))}},H={itvl:null,curtick:0,curticktime:0,timerIndex:100,embEvents:{},timerobjss:{},timerobjcount:0,regist:function(e){return this.embEvents[this.timerIndex]=e,this.timerobjss[this.timerIndex]={},this.timerIndex++},unregist:function(e){var t=this.timerobjss[e];if(t){var r=0;for(var n in t)r++;this.timerobjcount-=r,delete this.timerobjss[e]}delete this.embEvents[e]},commit:function(e,t,r,n){var i=this;if(this.embEvents[e])if(this.timerobjss[e][t])U.warning("Timer add duplicate hashkey: ",t);else{var a=n<0;n<0&&(n=-n);var o={data:r,interval:n,lasttick:Date.now()-(a?n:0)};this.timerobjss[e][t]=o,this.timerobjcount++,this.itvl||(this.curtick=Date.now(),this.itvl=setInterval((function(){for(var e in i.timerobjss){var t=i.embEvents[e];if(t.timerFlag){var r=i.timerobjss[e];for(var n in r){var a=r[n];a.lasttick+a.interval<=i.curtick&&(a.lasttick=i.curtick,t.timerFunc(a.data))}}}i.curtick+=200,i.curticktime++,i.curticktime>300&&(i.curticktime=0,i.curtick=Date.now())}),200))}},uncommit:function(e,t){this.embEvents[e]&&this.timerobjss[e][t]&&(delete this.timerobjss[e][t],this.timerobjcount--,0==this.timerobjcount&&(clearInterval(this.itvl),this.itvl=null))}};function G(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}const x=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.channel=t,this.streamtype=v.STREAM_TYPE.RTC,this.video=v.VIDEO_SOURCE.CAMERA,this.audio=v.AUDIO_SOURCE.MICROPHONE,this.streamstat=t==v.ChuangPublishChannel.MAIN?v.ChuangStreamMode.BOTH:v.ChuangStreamMode.VIDEO,this.mixv="1",this.cameraId=null,this.microphoneId=null,this.rtmpAddress="",this.encodeWidth=640,this.encodeHeight=480,this.captureHeight=640,this.captureWidth=480,this.fps=30,this.maxBitrateInKbps=null,this.source=""}var t,r,n;return t=e,(r=[{key:"useCamera",value:function(){return this.video=v.VIDEO_SOURCE.CAMERA,this}},{key:"isCamera",value:function(){return this.video==v.VIDEO_SOURCE.CAMERA}},{key:"useScreen",value:function(){return this.video=v.VIDEO_SOURCE.SCREEN,this}},{key:"isScreen",value:function(){return this.video==v.VIDEO_SOURCE.SCREEN}},{key:"useCustom",value:function(){return this.video=v.VIDEO_SOURCE.CUSTOM,this.audio=v.VIDEO_SOURCE.CUSTOM,this}},{key:"isCustom",value:function(){return this.video==v.VIDEO_SOURCE.CUSTOM}},{key:"useMicrophone",value:function(){return this.audio=v.AUDIO_SOURCE.MICROPHONE,this}},{key:"useDesktopAudio",value:function(){return this.audio=v.AUDIO_SOURCE.DESKTOP,this}},{key:"setAudioConfig",value:function(e){this.setMicrophoneId(e.audioDeviceId)}},{key:"setVideoConfig",value:function(e){this.setCaptureResolution(e.captureWidth,e.captureHeight).setVideoResolution(e.encodeWidth,e.encodeHeight).setVideoFps(e.fps).setVideoBitrate(e.bitrateKbps).setRenderMode(e.renderMode).setCameraId(e.videoDeviceId)}},{key:"setVideoConfigPreset",value:function(e){var t=e.split(/[*_]/);return this.setVideoResolution(t[0],t[1]),this.setVideoFps(t[2]),this.setVideoBitrate(t[3]),this}},{key:"setStreamstat",value:function(e){return e<v.ChuangStreamMode.BOTH||e>v.ChuangStreamMode.VIDEO||this.channel==v.ChuangPublishChannel.AUX||(this.streamstat=e),this}},{key:"setCameraId",value:function(e){return e?(this.cameraId=e,this):this}},{key:"setMicrophoneId",value:function(e){return e?(this.microphoneId=e,this):this}},{key:"setRtmpAddress",value:function(e){return this.rtmpAddress=e,this}},{key:"setCaptureResolution",value:function(e,t){return e=parseInt(e),t=parseInt(t),!e||e<240||!t||t<180||(this.captureWidth=e,this.captureHeight=t),this}},{key:"setVideoResolution",value:function(e,t){return e=parseInt(e),t=parseInt(t),!e||e<240||!t||t<180||(this.encodeWidth=e,this.encodeHeight=t),this}},{key:"setVideoFps",value:function(e){return!(e=parseInt(e))||e<5||(this.fps=e),this}},{key:"setVideoBitrate",value:function(e){return!(e=parseInt(e))||e<32||(this.maxBitrateInKbps=e),this}},{key:"setScreenLevel",value:function(e){return this}},{key:"setRenderMode",value:function(e){return e?(this.option=e,this):this}},{key:"setMixv",value:function(e){if(e)return this.mixv=e,this}},{key:"setSource",value:function(e){var t=e.captureStream()||video.mozCaptureStream(),r=new MediaStream,n=t.getVideoTracks()[0]&&t.getVideoTracks()[0].clone(),i=t.getAudioTracks()[0]&&t.getAudioTracks()[0].clone();this.streamstat!=v.ChuangStreamMode.AUDIO&&r.addTrack(n),this.streamstat!=v.ChuangStreamMode.VIDEO&&r.addTrack(i),this.source=r}},{key:"getVideoConfig",value:function(){return this}}])&&G(t.prototype,r),n&&G(t,n),e}();function F(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var V=function(){function e(t,r,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.streamId=r,this.domId=t;var a=document;this.$dom=a.getElementById(t),(n=n||{}).fit=n.fit||"cover",n.muted=1==n.muted,n.autoplay=!1!==n.autoplay,this.options=n,this.$container=a.createElement("div"),this.$container.setAttribute("id","player_"+r),this.$container.setAttribute("style","width: 100%; height: 100%; position: relative; background: none; overflow: hidden;"),this.$dom&&this.$dom.appendChild(this.$container),this.$video=a.createElement("video"),n.streamType&&1==n.video?this.$video.setAttribute("style","width: 100%; transform: rotateY(180deg); height: 100%; margin:0 auto; display:none; background: black; object-fit: ".concat(this.options.fit,";")):this.$video.setAttribute("style","width: 100%;  height: 100%; margin:0 auto; display:none; background: black; object-fit: ".concat(this.options.fit,";")),this.$video.muted=this.options.muted,!0===n.muted&&this.$video.setAttribute("muted",""),this.$video.autoplay=this.options.autoplay,!0===n.autoplay&&this.$video.setAttribute("autoplay",""),this.$video.setAttribute("playsinline",""),this.$container.appendChild(this.$video),this.videoEventBind=this.videoEvent.bind(this),this.$video.addEventListener("playing",this.videoEventBind),this.$video.addEventListener("canplay",this.videoEventBind),this.$video.addEventListener("abort",this.videoEventBind),this.$video.addEventListener("onerror",this.videoEventBind),this.$video.addEventListener("suspend",this.videoEventBind),this.$video.addEventListener("stalled",this.videoEventBind),this.$video.addEventListener("pause",this.videoEventBind),this.$video.addEventListener("onvolumechange",this.videoEventBind),this.event=i}var t,r,n;return t=e,(r=[{key:"videoEvent",value:function(e){}},{key:"attachStream",value:function(e){f.attachMediaStream(this.$video,e);var t=e.getVideoTracks();null==t||0===t.length||(this.$video.style.display="block")}},{key:"play",value:function(){return this.$video.play()}},{key:"cleanup",value:function(){this.$video.removeEventListener("playing",this.videoEventBind),this.$video.removeEventListener("canplay",this.videoEventBind),this.$video.removeEventListener("abort",this.videoEventBind),this.$video.removeEventListener("onerror",this.videoEventBind),this.$video.removeEventListener("suspend",this.videoEventBind),this.$video.removeEventListener("stalled",this.videoEventBind),this.$video.removeEventListener("pause",this.videoEventBind),f.attachMediaStream(this.$video,null),this.$container.removeChild(this.$video),this.$dom&&this.$dom.removeChild(this.$container)}},{key:"playStream",value:function(){this.$dom||U.error(g.MSG.CHUANG_CANVAS_NULL),this.$dom.style.display="block"}},{key:"stopPlayStream",value:function(){this.$dom.style.display="none"}},{key:"playLocal",value:function(e,t){this.$video.muted=!0,f.attachMediaStream(this.$video,e);var r=e.getVideoTracks();null==r||0===r.length?this.$video.style.display="none":this.$video.style.display="block"}},{key:"playRemote",value:function(e){this.$video.muted=this.options.muted,this.remoteEventBind||(this.remoteEvent=function(){},this.$video.addEventListener("playing",this.remoteEvent),this.remoteEventBind=!0),f.attachMediaStream(this.$video,e);var t=e.getVideoTracks();null==t||0===t.length||(this.$video.style.display="block")}}])&&F(t.prototype,r),n&&F(t,n),e}();V.Event={NOT_AUTO_PLAY:"not-auto-play"};const B=V;function W(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var j="_connect",Y="_connectNext",K="_connectRetry",X=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.event=r||new M,this.sockAddr=[],this.addrIndex=0,this.needReconnect=!1,this.reconnTry=0,this.reconnTryMax=3,this.connTimeout=5e3,this.connTimeoutId=0,this.isInit=!0,this.sendbytes=0,this.recvbytes=0,this.startTime=Date.now(),this.lastSendTime=null,this.lastRecvTime=null,this.lts=0,this.socketId=t,this.connection=null}var t,r,n;return t=e,(r=[{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"setConnTimeout",value:function(e){return this.connTimeout=e,this}},{key:"setReconnTryMax",value:function(e){return this.reconnTryMax=e,this}},{key:"getSendBytes",value:function(){return this.sendbytes}},{key:"getRecvBytes",value:function(){return this.recvbytes}},{key:"getDuration",value:function(){return Math.ceil((Date.now()-this.startTime)/1e3)}},{key:"getCurServer",value:function(){return this.sockAddr&&this.addrIndex<this.sockAddr.length?this.sockAddr[this.addrIndex]:null}},{key:"clearServers",value:function(){this.sockAddr=[],this.addrIndex=0,this.reconnTry=0}},{key:"open",value:function(e){this.sockAddr=e?e instanceof Array?e:[e]:this.sockAddr,this.reconnTry=0,this.addrIndex=0,this.close(),this._connect()}},{key:"reopen",value:function(){this._connect()}},{key:j,value:function(){var t=this;this.isInit=!0,this.needReconnect=!0,U.debug("["+this.socketId+"] start connect: "+this.sockAddr[this.addrIndex]+" "+this.reconnTry+"/"+this.reconnTryMax),this.lts=(new Date).getTime(),this.connection=new WebSocket(this.sockAddr[this.addrIndex]),this.connection.binaryType="arraybuffer",this.connection.url,this.connection.onopen=function(r){U.debug("["+t.socketId+"] socket opened: "+t.sockAddr[t.addrIndex]),t.needReconnect=!0,t.isInit=!1,t.sendbytes=0,t.recvbytes=0,t.startTime=Date.now(),t.lastSendTime=null,t.lastRecvTime=null,clearTimeout(t.connTimeoutId),t.event.dispatchEvent(M.Create.socket(e.Event.CONNECT,r))},this.connection.onmessage=function(r){if(t.reconnTry=0,r.data instanceof ArrayBuffer)t.event.dispatchEvent(M.Create.socket(e.Event.BINARY,r.data));else{t.recvbytes+=c.lengthInUtf8Bytes(r.data);var n=JSON.parse(r.data);t.lastRecvTime=Date.now(),t.event.dispatchEvent(M.Create.socket(e.Event.MESSAGE,n))}},this.connection.onclose=function(r){t.needReconnect?t.isInit?(U.debug("["+t.socketId+"] socket connect error/timeout"),t._connectNext()):(t._connectRetry(r),t.event.dispatchEvent(M.Create.socket(e.Event.DISCONNECT,r))):(U.debug("["+t.socketId+"] socket closed"),clearTimeout(t.connTimeoutId),t.connection.onopen=void 0,t.connection.onclose=void 0,t.connection.onerror=void 0,t.connection.onmessage=void 0,t.connection=void 0)},this.connection.onerror=function(r){U.trace("["+t.socketId+"] connect error."),t.event.dispatchEvent(M.Create.socket(e.Event.ERROR,r))},this.connTimeoutId=setTimeout((function(){t.connection&&t.connection.readyState!=WebSocket.OPEN&&t.connection.close()}),this.connTimeout)}},{key:K,value:function(){++this.reconnTry,this.reconnTry>this.reconnTryMax&&(this.reconnTry=0,this.addrIndex++)}},{key:Y,value:function(){this.reconnTry=0,++this.addrIndex,this.addrIndex>=this.sockAddr.length?this.event.dispatchEvent(M.Create.socket(e.Event.DISCONNECT)):this._connect()}},{key:"close",value:function(){this.needReconnect=!1,clearTimeout(this.connTimeoutId),this.connection&&this.connection.readyState!=WebSocket.CLOSED&&this.connection.readyState!=WebSocket.CLOSING&&(this.connection.onclose=void 0,this.connection.onopen=void 0,this.connection.onerror=void 0,this.connection.onmessage=void 0,this.connection.close(),this.connection=void 0)}},{key:"stopReconnect",value:function(){this.needReconnect=!1}},{key:"sendMessage",value:function(e){if(this.connection&&this.connection.readyState==WebSocket.OPEN){var t=JSON.stringify(e);this.sendbytes+=c.lengthInUtf8Bytes(t),this.lastSendTime=Date.now(),this.connection.send(t)}}}])&&W(t.prototype,r),n&&W(t,n),e}();X.Event={CONNECT:"connect",DISCONNECT:"disconnect",BINARY:"binary",MESSAGE:"message",ERROR:"error"};const q=X;var $=0,Q=0;const z={getHTTPSendBytes:function(){return $},getHTTPRecvBytes:function(){return Q},resetHTTPByetsCount:function(){$=0,Q=0},get:function(e,t,r,n,i){var a=new XMLHttpRequest;if(a.timeout=t||R.AjaxTimeout,a.open("GET",e,!0),i)for(var o in i)"withCredentials"==o?a.withCredentials=!0:a.setRequestHeader(o,i[o]);a.onload=function(e){var t={responseText:a.responseText,status:a.status};Q+=c.lengthInUtf8Bytes(a.responseText),r&&r(t)},a.onerror=function(t){n&&n(t,a.status,a.responseText,e)},a.ontimeout=function(t){n&&n(t,e)},a.send(null)},post:function(e,t,r,n,i,a){var o=new XMLHttpRequest,s="";if(o.timeout=r||R.AjaxTimeout,o.open("POST",e,!0),o.setRequestHeader("Content-type","application/json; charset=utf-8"),a)for(var u in a)"withCredentials"==u?o.withCredentials=!0:o.setRequestHeader(u,a[u]);o.onload=function(e){Q+=c.lengthInUtf8Bytes(o.responseText),n&&n(o.responseText)},o.onerror=function(t){i&&i(t,e)},o.ontimeout=function(t){i&&i(t,e)},s="string"!=typeof t?JSON.stringify(t):t,$+=c.lengthInUtf8Bytes(s),o.send(s)},shouldUseHttps:function(){return"https:"==document.location.protocol}};function J(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Z=function(){function e(t,r,n,i,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.len=0,this.waitUid=[],this.seq=0,this.storage=null,this.url=t,this.paramsCallback=r,this.timeout=n||R.AjaxTimeout,this.delay=i||500,this.workingTimeoutId=0,this.netfailtime=0,this.ajaxs=new Array(a||1).fill(0),this.itemNum=o||1}var t,r,n;return t=e,(r=[{key:"addSessionStorage",value:function(e,t){try{var r="ChuangBuriedpoint-"+e;U.info("addSession",r),this.storage.setItem(r,t)}catch(e){return"QuotaExceededError"==e.name&&(U.warning("超出临时存储限额！"),this.storage.clear(),this.storage.setItem(r,t)),void U.warning("add to storage get error",e)}}},{key:"delSessionStorage",value:function(e){try{this.storage.removeItem(e)}catch(e){U.warning("del from storage get error",e)}}},{key:"addItem",value:function(e){if(0===e.uid)this.waitUid.push(e);else{if(this.waitUid.length){if(this.waitUid.forEach((function(t){t.uid=e.uid})),window.sessionStorage){this.storage=window.sessionStorage;for(var t=0,r=this.waitUid.length;t<r;t++){if(this.storage.length>=99){var n=[];for(var i in this.storage)n.push({seq:i,value:this.storage[i]});for(var a=0,o=n.length-98;a<o;a++)n[a].seq.includes("ChuangBuriedpoint-")&&this.delSessionStorage(n[a].seq)}this.addSessionStorage(this.waitUid[0].seq,JSON.stringify(this.waitUid[0])),this.waitUid.shift()}this.addSessionStorage(e.seq,JSON.stringify(e))}}else if(window.sessionStorage){if(this.storage=window.sessionStorage,this.storage.length>=100){for(var i in n=[],U.warning("report queue maxed out."),this.storage)n.push({seq:i,value:this.storage[i]});for(t=0,r=n.length-99;t<r;t++)n[t].seq.includes("ChuangBuriedpoint-")&&this.delSessionStorage(n[t].seq)}this.addSessionStorage(e.seq,JSON.stringify(e))}this.startWorking()}}},{key:"startWorking",value:function(){var e=this;this.workingTimeoutId||(this.workingTimeoutId=setTimeout((function(){e.workingTimeoutId=0,e.working()}),this.delay+(this.netfailtime?100*Math.pow(10,Math.min(this.netfailtime,2)):0)))}},{key:"working",value:function(){var e=this.ajaxs.indexOf(0);if(!(e<0)&&this.storage.length){this.lastLen=this.len,this.len=this.storage.length>3?3:this.storage.length;for(var t=[],r=0;r<this.len;r++){var n=this.storage.key(r);n.includes("ChuangBuriedpoint-")&&t.push(JSON.parse(this.storage[n]))}var i=this.paramsCallback(t),a="value="+c.base64encode(JSON.stringify(i));this.ajaxs[e]=1;var o=this;z.post(this.url,a,this.timeout,(function(t){if(0==JSON.parse(t).code){for(var r=[],n=0;n<o.len;n++){var i=o.storage.key(n);r.push(i)}r.forEach((function(e){o.storage.removeItem(e)})),o.netfailtime=0}else setInterval((function(){o.storage.length?o.working():clearInterval()}),2e3),o.netfailtime>2&&(U.info("serverReport is failed 3 times"),o.storage.clear()),o.netfailtime++;o.ajaxs[e]=0}),(function(t){o.ajaxs[e]=0,o.netfailtime++,o.startWorking()}))}}}])&&J(t.prototype,r),n&&J(t,n),e}(),ee={core:null,init:function(){return this.core=this.core||new Z(R.SerUploadServer+"/rpt/",this.getParams.bind(this),null,500,3,10),this},getParams:function(e){return{info:e}},_common:function(e,t,r,n){if(e.appid=t.appid||kr.appId,e.build=kr.getSDKVersion(),e.platform=v.DEVICE_TYPE,e.osbuild=S.getBrowserInfo().os+" "+S.getBrowserInfo().osversion,e.devicetype=S.getBrowserInfo().name+" "+S.getBrowserInfo().version,e.nettype=S._getNettype(),e.signalstrength=0,e.ctime=c.curTimeFtt(),e.seq=this.core.seq++,e.uid=t.uid||0,e.uidstring=t.uid_string||"",e.streamname=e.streamname||"",e.ip=e.ip||"0.0.0.0",e.port=e.port||0,e.width=e.width||0,e.height=e.height||0,e.time=0,e.reporttype=r,e.content=JSON.stringify(n),window.localStorage){var i=window.localStorage;i.uuid||i.setItem("uuid",c.uuid())}e.uuid=i.uuid,this.core.addItem(e)},room:function(e,t,r){this._common({},r,t,e)},push:function(e,t,r,n,i,a){var o={};o.streamname=n,o.ip=this.getpushIp(r),o.port=this.getpushPort(r),o.width=i||0,o.height=a||0,this._common(o,r,t,e)},pull:function(e,t,r,n,i,a){var o={};o.streamname=n,o.ip=this.getpullIp(r),o.port=this.getpullPort(r),o.width=i,o.height=a,this._common(o,r,t,e)},mix:function(e,t,r,n,i,a){var o={};o.streamname=n,o.ip=this.getpushIp(r),o.port=this.getpushPort(r),o.width=i,o.height=a,this._common(o,r,t,e)},getpushIp:function(e){var t=kr.getroom(e.innerid).rtcPusher.getCurServer();if(!t)return"0.0.0.0";var r=c.parseUrl(t).host.split("-");return r.pop(),r.join(".")},getpullIp:function(e){var t=kr.getroom(e.innerid).rtcPuller.getCurServer();if(!t)return"0.0.0.0";var r=c.parseUrl(t).host.split("-");return r.pop(),r.join(".")},getpushPort:function(e){var t=kr.getroom(e.innerid).rtcPusher.getCurServer();return t?c.parseUrl(t).port:0},getpullPort:function(e){var t=kr.getroom(e.innerid).rtcPuller.getCurServer();return t?c.parseUrl(t).port:0},CODES:{REPORT_TYPE_NORMAL:0,REPORT_TYPE_INITIALIZE_FAILED:1,REPORT_TYPE_NETWORK_CHANGE:3,REPORT_TYPE_SERVER_NO_RESPONSE:4,REPORT_TYPE_SERVER_TIMEOUT:5,REPORT_TYPE_RECV_ERROR_AUDIO_CONFIG:8,REPORT_TYPE_PUBLISH_START:9,REPORT_TYPE_PLAY_START:10,REPORT_TYPE_PUBLISH_SUCCEED:11,REPORT_TYPE_PLAY_SUCCEED:12,REPORT_TYPE_CLOSE_NORMAL:13,REPORT_TYPE_PUBLISH_DISCONNECTED:14,REPORT_TYPE_VIDEO_ENCODE_TIME_TOO_LONG:15,REPORT_TYPE_PLAY_STREAM_NOT_FOUND:16,REPORT_TYPE_RECV_CLOSE_PACKET:17,REPORT_TYPE_RECV_SERVER_ERROR:18,REPORT_TYPE_RECV_FIRST_AUDIO:19,REPORT_TYPE_RECV_FIRST_VIDEO:20,REPORT_TYPE_PUBLISH_RESOLUTION_UP:21,REPORT_TYPE_PUBLISH_RESOLUTION_DOWN:22,REPORT_TYPE_BWE_NO_CALLBACK:23,REPORT_TYPE_BWE_CHANGE_INFO:24,REPORT_TYPE_PUBLISH_VIDEO_ENCODER_GL_RUNTIME_EXCEPTION:25,REPORT_TYPE_PUBLISH_VIDEO_ENCODER_START_EXCEPTION:26,REPORT_TYPE_PUBLISH_VIDEO_FRAME_TIMEOUT:27,REPORT_TYPE_RTMP_BAD_NETWORK:100,REPORT_TYPE_RTMP_CONNECT_FAILED:101,REPORT_TYPE_GET_SERVER_LIST_SUCCEED:201,REPORT_TYPE_GET_SERVER_LIST_FAILED:202,REPORT_TYPE_GET_CONFIG_SUCCEED:203,REPORT_TYPE_GET_CONFIG_FAILED:204,REPORT_TYPE_PUBLISH_CONFIG:205,REPORT_TYPE_PARSE_SERVER_LIST_JSON_FAILED:206,REPORT_TYPE_PARSE_SERVER_LIST_JSON_WRONG_CLIENT_INFO:207,REPORT_TYPE_LOGIN_CALLED_FROM_USER:208,REPORT_TYPE_LOGOUT_CALLED_FROM_USER:209,REPORT_TYPE_USER_LOGIN_RESULT:210,REPORT_TYPE_MESS_LOGIN_SUCCEED:300,REPORT_TYPE_MESS_LOGIN_FAILED:301,REPORT_TYPE_MESS_LOGOUT_ROOM:302,REPORT_TYPE_MESS_AUTH_PUBLISH_SUCCEED:303,REPORT_TYPE_MESS_AUTH_PUBLISH_FAILED:304,REPORT_TYPE_MESS_DISCONNECT:305,REPORT_TYPE_MESS_CONNECT_PROCESS_TIMEOUT:306,REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT:307,REPORT_TYPE_MESS_MERGE_START:308,REPORT_TYPE_MESS_MERGE_STOP:309,REPORT_TYPE_MESS_MERGE_SUCCESS:310,REPORT_TYPE_MESS_MERGE_RESTART_PARSE_ACK_FAILED:311,REPORT_TYPE_MESS_MERGE_RESTART_PROGRESS_TIMEOUT:312,REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ERROR:313,REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ZERO:314,REPORT_TYPE_MESS_MERGE_RESTART_CHECK_INTERNAL_ERROR:315,REPORT_TYPE_MESS_MERGE_RESTART_REQ_INTERNAL_ERROR:316,REPORT_TYPE_MESS_MERGE_RESTART_UNKNOWN_REASON:317,REPORT_TYPE_MESS_START_PUBLISH_FAILED:318,REPORT_TYPE_MESS_BANNED_BY_APP:319,REPORT_TYPE_MESS_MERGE_FAILED_ERROR_RESOLUTION:320,REPORT_TYPE_MESS_MERGE_FAILED_INVALID_RTMP_ADDR:321,MESS_MERGE_CB_INVALID_PARAMETERS_FROM_SERVER:322,REPORT_TYPE_MESS_MERGE_FAILED_INVALID_PUBLISH_ADDRESS:323,REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD:324,REPORT_TYPE_SYSTEM_CAMERA_PERMISSION_DENIED:400,REPORT_TYPE_PING_STATUS:501,REPORT_TYPE_LOG_INFO:502}}.init();function te(e){return(te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function re(e,t){return!t||"object"!==te(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ne(e){var t="function"==typeof Map?new Map:void 0;return(ne=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return ie(e,arguments,se(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),oe(n,e)})(e)}function ie(e,t,r){return(ie=ae()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&oe(i,r.prototype),i}).apply(null,arguments)}function ae(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function oe(e,t){return(oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function se(e){return(se=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ce(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ue(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function de(e,t,r){return t&&ue(e.prototype,t),r&&ue(e,r),e}window.RepCore={name:"SerReporter",version:"0.1.0",evt:ee};var le="login",he="authpublish",me="startpublish",pe="stoppublish",fe="heartbeat",ve="reqlist",_e="reqmerge",Ee="stopmerge",Se="reqmergestat",Ce="setwatchinfo",Te="streamheartbeat",ge="startplay",Re="stopplay",Ae="logout",Oe="success",Ie=2,Pe=function(){function e(t){ce(this,e),this.pingIntervalId=0,this.pongTimeoutId=0,this.event=t}return de(e,[{key:"start",value:function(){var t=this;this.pingIntervalId=setInterval((function(){t.event.dispatchEvent(M.Create.heartbeat(e.Event.BEAT)),!t.pongTimeoutId&&(t.pongTimeoutId=setTimeout((function(){t.event.dispatchEvent(M.Create.heartbeat(e.Event.TIMEOUT,{reason:"pong timeout"}))}),R.Signal_Pong_Timeout))}),R.Signal_Ping_Interval)}},{key:"onPong",value:function(){clearTimeout(this.pongTimeoutId),this.pongTimeoutId=0}},{key:"stop",value:function(){clearTimeout(this.pongTimeoutId),clearInterval(this.pingIntervalId),this.pongTimeoutId=0,this.pingIntervalId=0,this.onPing=null,this.onTimeout=null}}]),e}();Pe.Event={BEAT:"beat",TIMEOUT:"timeout"};var ye=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&oe(e,t)}(i,e);var t,r,n=(t=i,r=ae(),function(){var e,n=se(t);if(r){var i=se(this).constructor;e=Reflect.construct(n,arguments,i)}else e=n.apply(this,arguments);return re(this,e)});function i(){return ce(this,i),n.call(this)}return de(i,[{key:"stepup",value:function(e,t,r){this._step(e,t,r,0)}},{key:"stepdown",value:function(e,t,r){this._step(e,t,r,1)}},{key:"_step",value:function(e,t,r,n){var i=t?e+"#"+t:e;if(!this[i])return this[i+"#s"]=n,void(this[i]=r);this[i+"#s"]!=n&&(this[i+"#s"]=n,this[i]=this[i]>=r?this[i]+1:r)}},{key:"filter",value:function(e,t,r){var n=t?e+"#"+t:e;return!!this[n]&&this[n]>r}},{key:"reset",value:function(){for(var e in this)delete this[e]}}]),i}(ne(Object));ye.KEY={LOGIN:"login",PUSH:"push",PULL:"pull",MIX:"mix"};var Ne=function(){function e(t){var r=this;ce(this,e),this.seq=0,this.sessionid="",this.rparam=t,this.event=(new M).timerEnable((function(e){return r.onTimer(e)})),this.socket=new q("SK-"+c.randomString(4),this.event).setConnTimeout(R.Signal_Conn_Timeout).setReconnTryMax(R.Signal_Reconn_Retry),this.event.on("socket",(function(e){r.onSocketEvent(e)})),this.messConStart=c.curTimeInMilli(),this.heartBeat=new Pe(this.event),this.event.on("heartbeat",(function(e){r.onHeartEvent(e)})),this.seqFilter=new ye}return de(e,[{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"nextseq",value:function(){return this.seq++,this.seq.toString()}},{key:"curtime",value:function(){return parseInt(Date.now()/1e3).toString()}},{key:"getMisc",value:function(){return navigator.userAgent}},{key:"getConnState",value:function(){return this.socket.connection?this.socket.connection.readyState:v.CONN_STATUS.OFFLINE}},{key:"connect",value:function(e){e?this.socket.open(e):this.socket.reopen()}},{key:"getCurServer",value:function(){return this.socket.getCurServer()}},{key:"clearServers",value:function(){this.socket.clearServers()}},{key:"close",value:function(){this.seq=0,this.seqFilter.reset(),this.socket.close(),this.heartBeat.stop(),this.event.timerStop()}},{key:"onSocketEvent",value:function(t){switch(t.type){case q.Event.CONNECT:this.messConEnd=c.curTimeInMilli(),this.event.dispatchEvent(M.Create.signal(e.Event.CONNECT,{url:t.data.currentTarget.url,messConEnd:this.messConEnd}));break;case q.Event.DISCONNECT:this.heartBeat.stop(),this.event.timerStop(),this.event.dispatchEvent(M.Create.signal(e.Event.DISCONNECT));break;case q.Event.MESSAGE:var r=t.data,n=c.toHump("recv."+r.command);c.is.isFunction(this[n])?(r.seq&&(r.seq=parseInt(r.seq)),this[n](r)):U.warning("[recv] unknown cmd: "+r.command)}}},{key:"onHeartEvent",value:function(e){switch(e.type){case Pe.Event.BEAT:this.sendHeartBeat();break;case Pe.Event.TIMEOUT:U.warning("HeartBeat timeout."),this.socket&&this.socket.readyState!=WebSocket.CLOSED&&(this.socket.close(),this.connect())}}},{key:"onTimer",value:function(t){switch(t.type){case e.TimerEvent.REQLIST:ee.room("",ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),this.sendReqlist()}}},{key:"sendLogin",value:function(){this.messLoginStart=c.curTimeInMilli(),this.socket.sendMessage({command:le,uid:this.rparam.uid,uid_string:this.rparam.uid_string,expass:this.rparam.expass,roomname:this.rparam.roomname,roomname_string:this.rparam.roomname_string,seq:this.nextseq(),sessionid:"",version:v.SIGVERSION,appid:this.rparam.appid,nickname:this.rparam.nickname,act:this.rparam.act,misc:this.getMisc(),platform:v.DEVICE_TYPE,sysver:kr.sysver,devmodel:kr.devmodel,reconnect:this.rparam.reconnect}),this.seqFilter.stepup(ye.KEY.LOGIN,null,this.seq)}},{key:"recvLoginAck",value:function(t){if(!this.seqFilter.filter(ye.KEY.LOGIN,null,t.seq))if(-201!=t.errcode){this.sessionid=t.sessionid,this.heartBeat.start(),this.rparam.userlist=t.userlist;var r={};if(r.msg=t.status,this.rparam.loginContent=r,Oe!=t.status)return this.rparam.errcode=t.errcode,void this.event.dispatchEvent(M.Create.signal(e.Event.LOGINFAIL,Ie));this.messLoginEnd=c.curTimeInMilli(),this.rparam.messlogin=this.messLoginEnd-this.messLoginStart,this.event.dispatchEvent(M.Create.signal(e.Event.LOGINROOM,this.rparam.userlist,this.rparam.loginContent))}else U.error("appId 不可用")}},{key:"startReqlist",value:function(){this.sendReqlist(),this.event.timerStart(),this.event.timerAdd(e.TimerEvent.REQLIST,R.Signal_reqlist_Timeout)}},{key:"sendReqlist",value:function(e){this.socket.sendMessage({command:ve,uid:this.rparam.uid,roomname:this.rparam.roomname,curtime:this.curtime(),seq:this.nextseq(),sessionid:this.sessionid,streaminfo:e})}},{key:"recvUserlist",value:function(t){this.event.timerRemove(e.TimerEvent.REQLIST),U.debug(t),t.list?(U.info("userlist recv",t),this.event.dispatchEvent(M.Create.signal(e.Event.USERLIST,t))):U.warning("no list entry for userlist")}},{key:"sendHeartBeat",value:function(){this.socket.sendMessage({command:fe,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,duration:this.socket.getDuration().toString(),seq:this.nextseq(),sessionid:this.sessionid})}},{key:"recvHeatbeatAck",value:function(e){this.heartBeat.onPong()}},{key:"sendStreamHeartBeat",value:function(e,t){this.socket.sendMessage({command:Te,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,duration:t.toString(),seq:this.nextseq(),sessionid:this.sessionid,streamname:e})}},{key:"recvStreamheartbeatAck",value:function(e){}},{key:"sendAuthpublish",value:function(e){this.messAuthStart=c.curTimeInMilli(),this.socket.sendMessage({command:he,uid:this.rparam.uid,streamname:e,expass:this.rparam.expass,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,version:v.SIGVERSION,appid:this.rparam.appid,nickname:this.rparam.nickname,misc:this.getMisc()}),this.seqFilter.stepup(ye.KEY.PUSH,e,this.seq)}},{key:"recvAuthpublishAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(ye.KEY.PUSH,r,t.seq)){var n={roomid:t.roomid,status:t.status};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] get roomid: "+t.roomid):n.errcode=t.errcode,this.messAuthEnd=c.curTimeInMilli(),this.rparam.messauthpublish=this.messAuthEnd-this.messAuthStart,this.event.dispatchEvent(M.Create.signal_stream(e.Event.AUTH_PUBLISH,r,n))}}},{key:"sendStartpublish",value:function(e,t){this.socket.sendMessage({command:me,roomname:this.rparam.roomname,uid:this.rparam.uid,pushaddr:t.pushaddr,pushport:t.pushport,streaminfo:t,seq:this.nextseq(),sessionid:this.sessionid,streamtype:"0"}),this.seqFilter.stepup(ye.KEY.PUSH,e,this.seq)}},{key:"recvStartpublishAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(ye.KEY.PUSH,r,t.seq)){var n={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : start publish",t):n.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal_stream(e.Event.START_PUBLISH,r,n))}}},{key:"sendStoppublish",value:function(e,t){this.socket.sendMessage({command:pe,uid:this.rparam.uid,roomid:t.roomid,roomname:this.rparam.roomname,stoptime:this.curtime(),seq:this.nextseq(),sessionid:this.sessionid,streamname:e}),this.seqFilter.stepdown(ye.KEY.PUSH,e,this.seq)}},{key:"recvStoppublishAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(ye.KEY.PUSH,r,t.seq)){var n={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : stop publish",t):n.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal_stream(e.Event.STOP_PUBLISH,r,n))}}},{key:"sendReqMerge",value:function(e){this.socket.sendMessage({command:_e,uid:this.rparam.uid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,mergeinfo:e}),this.seqFilter.stepup(ye.KEY.MIX,null,this.seq)}},{key:"recvReqmergeAck",value:function(t){if(!this.seqFilter.filter(ye.KEY.MIX,null,t.seq)){var r={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : req merge",t):r.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal(e.Event.REQMERGE,r))}}},{key:"sendReqmergeStat",value:function(e){this.socket.sendMessage({command:Se,uid:this.rparam.uid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,pushaddr:e.pushaddr,pushport:e.pushport,rtmpaddr:e.rtmpaddr,mergestreamid:e.mergestreamid})}},{key:"recvReqmergestatAck",value:function(t){var r={};e.noError(t.errcode)?r.connect_count=parseInt(t.connected_count)||0:r.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal(e.Event.REQMERGESTAT,r))}},{key:"sendStopMerge",value:function(e){this.socket.sendMessage({command:Ee,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,pushaddr:e.pushaddr,pushport:e.pushport,rtmpaddr:e.rtmpaddr,mergestreamid:e.mergestreamid}),this.seqFilter.stepdown(ye.KEY.MIX,null,this.seq)}},{key:"recvStopmergeAck",value:function(t){if(!this.seqFilter.filter(ye.KEY.MIX,null,t.seq)){var r={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : stop merge",t):r.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal(e.Event.STOPMERGE,r))}}},{key:"sendSetwatchinfo",value:function(e){this.socket.sendMessage({command:Ce,uid:this.rparam.uid,watchaddr:e.host,watchport:e.port.toString(),roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid})}},{key:"recvSetwatchinfoAck",value:function(t){var r={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : set watch info",t):r.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal(e.Event.SET_WATCHINFO,r))}},{key:"sendStartplay",value:function(e,t,r){this.socket.sendMessage({command:ge,playaddr:t.pushaddr?t.pushaddr+":"+t.pushport:"",sessionid:this.sessionid,uid:this.rparam.uid||"",roomname:r||this.rparam.roomname,roomid:t.roomid||"",seq:this.nextseq(),streamname:e,streamstat:t.streamstat}),this.seqFilter.stepup(ye.KEY.PULL,e,this.seq)}},{key:"recvStartplayAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(ye.KEY.PULL,r,t.seq)){var n={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : start play",t):n.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal_stream(e.Event.START_PLAY,r,n))}}},{key:"sendStopplay",value:function(e,t,r){this.socket.sendMessage({command:Re,roomname:this.rparam.roomname,seq:this.nextseq(),streamname:e,sessionid:this.sessionid,uid:this.rparam.uid,roomid:t.roomid,duration:r.toString()}),this.seqFilter.stepdown(ye.KEY.PULL,e,this.seq)}},{key:"recvStopplayAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(ye.KEY.PULL,r,t.seq)){var n={};e.noError(t.errcode)?U.info("client ["+kr.clientId+"] : stop play",t):n.errcode=t.errcode,this.event.dispatchEvent(M.Create.signal_stream(e.Event.STOP_PLAY,r,n))}}},{key:"sendLogout",value:function(){this.heartBeat.stop(),this.socket.stopReconnect(),this.socket.sendMessage({command:Ae,uid:this.rparam.uid,expass:this.rparam.expass,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,appid:this.rparam.appid}),this.seqFilter.stepdown(ye.KEY.LOGIN,null,this.seq),this.getConnState()!==v.CONN_STATUS.ONLINE&&this.recvLogoutAck()}},{key:"recvLogoutAck",value:function(t){this.close();var r={};r.msg=t?t.status:"",this.rparam.loginContent=r,this.event.dispatchEvent(M.Create.signal(e.Event.LOGOUTROOM,this.rparam.loginContent))}}],[{key:"noError",value:function(e){return"0"==e}}]),e}();Ne.TimerEvent={REQLIST:"reqlist"},Ne.Event={CONNECT:"connect",DISCONNECT:"diconnect",LOGINROOM:"loginroom",USERLIST:"userlist",LOGINFAIL:"loginfail",LOGOUTROOM:"logoutroom",SET_WATCHINFO:"setwatchinfo",AUTH_PUBLISH:"authpublish",START_PUBLISH:"startpublish",STOP_PUBLISH:"stoppublish",START_PLAY:"startplay",STOP_PLAY:"stopplay",REQMERGE:"reqmerge",REQMERGESTAT:"reqmergestat",STOPMERGE:"stopmerge"};const be=Ne;function De(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Ue(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ue(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function Ue(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Le(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ke(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Me(e,t,r){return t&&ke(e.prototype,t),r&&ke(e,r),e}var we=function(){function e(t,r,n){var i=this;Le(this,e),this.streamId=t,this.islocal=!!r,this.option=this.islocal?r.option||{fit:"contain"}:n.option||{fit:"contain"},this.streaminConfig=this.islocal?new Fe(r):null,this.roomid=null,this.sparam=null,this.domId=null,this.video_mute=!1,this.audio_mute=!1,this.puship="",this.pushport="",this.pullip="",this.pullport="",this.pluginHandle=null,this.domplayer=null,this.bytesSent=0,this.bytesReceived=0,this.width=0,this.height=0,this.source=r.source,this.event=(new M).timerEnable((function(e){return i.onTimer(e)}))}return Me(e,[{key:"uninit",value:function(){this.domplayer&&this.domplayer.cleanup(),this.domplayer=null,this.islocal&&this.pluginHandle&&e.clearHackedLocalstream(this.pluginHandle),this.pluginHandle=null}},{key:"startPreview",value:function(){this.domplayer.playStream()}},{key:"stopPreview",value:function(){this.domplayer.stopPlayStream()}},{key:"linkEvent",value:function(e){this.event.linkAdd(e)}},{key:"unlinkEvent",value:function(e){this.event.linkRemove(e)}},{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"getStreamId",value:function(){return this.streamId}},{key:"getroomid",value:function(){return this.roomid}},{key:"getoption",value:function(){return this.option}},{key:"setSparam",value:function(e){return this.sparam=e,this}},{key:"getSparam",value:function(){return this.islocal?null:this.sparam}},{key:"setDomId",value:function(e){return this.domId=e,this}},{key:"initDomplayer",value:function(e){this.domId&&(this.domplayer||(this.domplayer=new B(this.domId,this.streamId,e,this.event)))}},{key:"savePluginHandle",value:function(e){this.islocal&&this.pluginHandle||(this.pluginHandle=e)}},{key:"getPluginHandle",value:function(){return this.pluginHandle}},{key:"getMediaStream",value:function(){return this.islocal?this.pluginHandle&&this.pluginHandle.webrtcStuff&&this.pluginHandle.webrtcStuff.myStream:this.pluginHandle&&this.pluginHandle.webrtcStuff&&this.pluginHandle.webrtcStuff.remoteStream}},{key:"getStreamConfig",value:function(){return this.islocal?this.streaminConfig:null}},{key:"getBytes",value:function(){return{sent:this.bytesSent,rev:this.bytesReceived}}},{key:"isMain",value:function(){return!this.islocal||v.ChuangPublishChannel.MAIN==this.streaminConfig.channel}},{key:"isAux",value:function(){return!this.islocal||v.ChuangPublishChannel.AUX==this.streaminConfig.channel}},{key:"isCamera",value:function(){return!this.islocal||v.VIDEO_SOURCE.CAMERA==this.streaminConfig.video}},{key:"isScreen",value:function(){return!!this.islocal&&v.VIDEO_SOURCE.SCREEN==this.streaminConfig.video}},{key:"stop",value:function(){this.domplayer&&this.domplayer.cleanup(),this.domplayer=null}},{key:"attachStream",value:function(e){e||(e=this.getMediaStream()),e&&this.domplayer&&this.domplayer.attachStream(e)}},{key:"resume",value:function(){this.domplayer.play()}},{key:"play",value:function(){var e=this;if(!this.islocal){var t=this.domplayer.play();t&&t.catch&&t.catch((function(t){t&&t.message&&(t.message.indexOf("interrupted")>=0||t.message.indexOf("abort")>=0)||e.event.dispatchEvent(M.Create.stream(B.Event.NOT_AUTO_PLAY,e.streamId))}))}}},{key:"onStream",value:function(t){if(this.islocal){var r=t.getVideoTracks();r&&r.length&&(r[0].onended=this.onRevokeVideo.bind(this));var n=t.getAudioTracks();n&&n.length&&(n[0].onended=this.onRevokeAudio.bind(this))}this.event.dispatchEvent(M.Create.stream(e.Event.ON_STREAM,this.streamId,this))}},{key:"onStartplay",value:function(){this.event.dispatchEvent(M.Create.stream(e.Event.ON_STARTPLAY,this.streamId,this))}},{key:"onPoooolStat",value:function(t){this.event.dispatchEvent(M.Create.stream(e.Event.POOL_STAT,this.streamId,{loss:t.loss,realframerate:t.realframerate,rtt:t.rtt&&t.rtt}))}},{key:"onAudioMute",value:function(t){this.audio_mute=t,t?this.event.dispatchEvent(M.Create.stream(e.Event.AUDIO_MUTE,this.streamId)):this.event.dispatchEvent(M.Create.stream(e.Event.AUDIO_UNMUTE,this.streamId))}},{key:"onVideoMute",value:function(t){this.video_mute=t,t?this.event.dispatchEvent(M.Create.stream(e.Event.VIDEO_MUTE,this.streamId)):this.event.dispatchEvent(M.Create.stream(e.Event.VIDEO_UNMUTE,this.streamId))}},{key:"onRevokeVideo",value:function(){var t=this.isCamera()?v.STREAM_REVOKE.CAMERA:v.STREAM_REVOKE.SCREEN;this.event.dispatchEvent(M.Create.stream(e.Event.VIDEO_REVOKE,this.streamId,t))}},{key:"onRevokeAudio",value:function(){var t=v.STREAM_REVOKE.MICROPHONE;this.event.dispatchEvent(M.Create.stream(e.Event.AUDIO_REVOKE,this.streamId,t))}},{key:"firstAudio",value:function(){this.event.dispatchEvent(M.Create.stream(e.Event.AUDIO_RECEIVE_FIRST_FRAME,this.streamId))}},{key:"firstVideo",value:function(){this.event.dispatchEvent(M.Create.stream(e.Event.VIDEO_RECEIVE_FIRST_FRAME,this.streamId))}},{key:"onReceiveStreamAttachedMessage",value:function(t){0!=t.length?this.event.dispatchEvent(M.Create.stream(e.Event.RECEIVE_STREAM_ATTACHED_MESSAGE,this.streamId,{msg:t})):U.warning(g.MSG.CHUANG_PUBLISH_MESSAGE_NULL)}}],[{key:"createHackedLocalstream",value:function(t,r,n){var i=t.streamId,a=null,o="local-stream-"+i,s={plugin:"rtclib.plugin.recordplay",opaqueId:o,success:function(r){t.savePluginHandle(r),r.createOffer({media:t.getStreamConfig().toMediaSpec(),simulcast:!1,success:function(e){U.info(" Got SDP!"),U.debug(e)},error:function(t){if("Invalid handle"!=t)if("hack"!=t.message){U.error(" createOffer error",t);var r=e.wrapCreateOfferError(t);n&&n(r)}else a.destroy({cleanupHandles:!1})}})},onlocalstream:function(e){throw U.info(" ::: Got a local stream :::"),U.debug(e),t.onStream(e),r&&r(e),new Error("hack")}};f.httpAPICall=function(e,t){t.body&&("create"==t.body.rtclib?setTimeout((function(){t.success({rtclib:"success",session_id:c.randomString(12)})}),1):"attach"==t.body.rtclib?t.success({rtclib:"success",data:{id:o}}):"destroy"==t.body.rtclib&&t.success({rtclib:"success"}))},a=new f({server:"https://yedemon.hack",success:function(){a.attach(s)},destroyed:function(){}})}},{key:"clearHackedLocalstream",value:function(e){if(e){var t=e.webrtcStuff;if(t){t.remoteStream=null,t.volume&&(t.volume.local&&t.volume.local.timer&&clearInterval(t.volume.local.timer),t.volume.remote&&t.volume.remote.timer&&clearInterval(t.volume.remote.timer)),t.volume={},t.bitrate.timer&&clearInterval(t.bitrate.timer),t.bitrate.timer=null,t.bitrate.bsnow=null,t.bitrate.bsbefore=null,t.bitrate.tsnow=null,t.bitrate.tsbefore=null,t.bitrate.value=null;try{if(!t.streamExternal&&t.myStream){f.log("Stopping local stream tracks");var r,n=De(t.myStream.getTracks());try{for(n.s();!(r=n.n()).done;){var i=r.value;f.log(i),i&&i.stop()}}catch(e){n.e(e)}finally{n.f()}}}catch(e){}t.streamExternal=!1,t.myStream=null;try{t.pc.close()}catch(e){}t.pc=null,t.candidates=null,t.mySdp=null,t.remoteSdp=null,t.iceDone=!1,t.dataChannel={},t.dtmfSender=null}}}},{key:"closeMstream",value:function(e){var t,r=De(e.getTracks());try{for(r.s();!(t=r.n()).done;){var n=t.value;n&&n.stop()}}catch(e){r.e(e)}finally{r.f()}}},{key:"wrapCreateOfferError",value:function(t){if(t){if("No capture device found"==t)return g(g.CODE.CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED);if("NotAllowedError"==t.name)return ee.room("",ee.CODES.REPORT_TYPE_INITIALIZE_FAILED,{}),ee.room("",ee.CODES.REPORT_TYPE_SYSTEM_CAMERA_PERMISSION_DENIED,{}),g(g.CODE.CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED);if("NotReadableError"==t.name&&"Could not start audio source"==t.message)return g(g.CODE.CHUANG_MIC_INIT_FAILED);if("NotReadableError"==t.name&&"Could not start video source"==t.message)return g(g.CODE.CHUANG_CAMERA_INIT_FAILED);if("NotFoundError"===t.name)return g(g.CODE.CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED)}var r=e.errorToMessage(t);return g(g.CODE.CHUANG_WEBRTC_PUBLISH_EXCEPTION,null,{err:r})}},{key:"errorToMessage",value:function(e){return c.is.isObject(e)?e.message?e.message:JSON.stringify(e):c.is.isString(e)?e:null}}]),e}();we.Event={POOL_STAT:"pool-stat",VIDEO_REVOKE:"video-revoke",AUDIO_REVOKE:"audio-revoke",MUTE_VIDEO:"mute-video",UNMUTE_VIDEO:"unmute-video",MUTE_AUDIO:"mute-audio",UNMUTE_AUDIO:"unmute-audio",VIDEO_MUTE:"video-mute",VIDEO_UNMUTE:"video-unmute",AUDIO_MUTE:"audio-mute",AUDIO_UNMUTE:"audio-unmute",ON_STREAM:"on-stream",PUBLISH_DISCONNECTED:"publish-disconnect",PUBLISH_CONNECTING:"publish-connecting",PUBLISH_CONNECTED:"publish-connected",PLAY_DISCONNECTED:"play-disconnect",PLAY_CONNECTING:"play-connecting",PLAY_CONNECTED:"play-connected",ON_STARTPLAY:"on-startplay",AUDIO_INITIALIZE:"audio-initialize",VIDEO_INITIALIZE:"video-initialize",VIDEO_RECEIVE_FIRST_FRAME:"first-video",AUDIO_RECEIVE_FIRST_FRAME:"first-audio",AUDIO_STUCK:"audio-stuck",VIDEO_STUCK:"video-stuck",AUDIO_DISCONNECTED:"audio-disconnected",VIDEO_DISCONNECTED:"video-disconnected",AUDIO_DECODING:"audio-decoding",VIDEO_DECODING:"video-decoding",RECEIVE_STREAM_ATTACHED_MESSAGE:"receive-stream-attached-message"};const He=we;var Ge={WIDTH:640,HEIGHT:480,FRAMERATE:30},xe={WIDTH:1280,HEIGHT:720,FRAMERATE:15},Fe=function(){function e(t){Le(this,e),this.channel=t.channel,this.streamtype=t.streamtype,this.streamstat=t.streamstat,v.ChuangPublishChannel.AUX==this.channel&&(this.streamstat=v.ChuangStreamMode.VIDEO),this.video=t.video,this.audio=t.audio,this.cameraId=t.cameraId,this.microphoneId=t.microphoneId,this.rtmpAddr=t.rtmpAddress,this.mixv=t.mixv||(this.streamstat==v.ChuangStreamMode.AUDIO?0:1),this.source=t.source;var r=v.VIDEO_SOURCE.CAMERA==this.video?Ge:xe;this.frameRate=v.VIDEO_SOURCE.CAMERA==this.video?r.FRAMERATE:t.fps?t.fps:r.FRAMERATE,this.videoWidth=t.encodeWidth?t.encodeWidth:r.WIDTH,this.videoHeight=t.encodeHeight?t.encodeHeight:r.HEIGHT,this.captureWidth=t.captureWidth?t.captureWidth:r.WIDTH,this.captureHeight=t.captureHeight?t.captureHeight:r.HEIGHT,this.initBandwidth=t.maxBitrateInKbps?t.maxBitrateInKbps<<10:1048576,this.keyframeInterval=2e3}return Me(e,[{key:"getRtmpAddr",value:function(e,t,r){var n=c.appendUrl(this.rtmpAddr,{uid:e,expass:t});return""!=n?n+"/"+r:""}},{key:"toMediaSpec",value:function(){var e={},t=this.streamstat==v.ChuangStreamMode.BOTH||this.streamstat==v.ChuangStreamMode.VIDEO;return this.streamstat==v.ChuangStreamMode.BOTH||this.streamstat==v.ChuangStreamMode.AUDIO?v.AUDIO_SOURCE.MICROPHONE==this.audio?e.audio=!this.microphoneId||{deviceId:{exact:this.microphoneId}}:v.AUDIO_SOURCE.DESKTOP==this.audio?(e.captureDesktopAudio=!0,e.audio=!1):v.AUDIO_SOURCE.CUSTOM==this.audio&&(e.audio=this.source):e.audio=!1,e.replaceAudio=!1,t?v.VIDEO_SOURCE.CAMERA==this.video?(e.video={width:this.videoWidth,height:this.videoHeight},this.cameraId&&(e.video.deviceId={exact:this.cameraId})):v.VIDEO_SOURCE.SCREEN==this.video?(e.video="screen",e.screenshareWidth=this.videoWidth,e.screenshareHeight=this.videoHeight,e.screenshareFrameRate=this.frameRate):v.VIDEO_SOURCE.CUSTOM==this.video&&(e.video=this.source,e.screenshareWidth=this.videoWidth,e.screenshareHeight=this.videoHeight,e.screenshareFrameRate=this.frameRate):e.video=!1,e.replaceVideo=!1,e.data=!0,e}}]),e}();function Ve(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Be(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function We(e,t,r){return t&&Be(e.prototype,t),r&&Be(e,r),e}var je=1,Ye=9,Ke=!1,Xe={},qe={},$e={},Qe=[],ze={},Je={},Ze=function(){function e(t,r){Ve(this,e),this.uid=t,this.tag=r,this.bindTarget=null,this.data=null,this.exdata=null,this.machineFunc=null,this.inFinPhase=!1,this.processFunc=null,this.inFinProcess=!1,this.curPhaseItem=null,this.nextPhase=e.DONE,this.curProcItems={},this.curProcRes=null,this.dest=[],this.mstat=Ye,this.error=null,this.autoremove=!1,this.startTime=0,this.endTime=0,this.records=null,this.recording=!1}return We(e,[{key:"summary",value:function(){var e=this.bind;this.bind=null;var t=JSON.stringify(this);return this.bind=e,t}},{key:"record",value:function(){return this.recording=!0,this.records=[],this}},{key:"bind",value:function(e){return this.bindTarget=e,this}},{key:"bindData",value:function(e){return this.data=e,this.exdata=e,this}},{key:"defMachine",value:function(e){return this.machineFunc=e,this}},{key:"start",value:function(e,t,r){if(this.machineFunc){var n={actTag:this.tag,actUId:this.uid,phase0:e,phase:e,params:t,dest:r};et.queueAct(this,n)}else U.warning(this.tag+" has no machine function.")}},{key:"cancel",value:function(e){this.mstat==je&&et.unphase0(this,e||!1)}},{key:"setError",value:function(e){this.error=e}},{key:"isActive",value:function(){return this.mstat==je}},{key:"isPhase",value:function(e){return this.curPhaseItem&&this.curPhaseItem==e}},{key:"jump",value:function(e,t){if(this.mstat===je){for(var r in this.curProcItems){var n=this.curProcItems[r];et.clearProcess(n)}this.curProcItems={},this.curProcRes=t,this.nextPhase=e,et.nextPhase(this)}}},{key:"stop",value:function(){e.cutail(this.tag),this.cancel(!1)}},{key:"defProcess",value:function(e){return this.processFunc=e,this}},{key:"process",value:function(e,t,r,n){if(this.inFinPhase)U.warning("process in fin$ phase: "+this.curPhaseItem.phase);else{var i=this.curProcItems[e];if(i)return U.warning("process "+e+" exists at phase: "+this.curPhaseItem.phase),void U.info("hint: use process#1...n as your process instead.");i={procTag:r,actUId:this.uid,process:e,params:t,timeout:n&&c.is.isInteger(n)?n:null,timeoutId:null},this.curProcItems[e]=i,et.queueProcess(i),this.recording&&this.inFinProcess&&et.recordProcess(this,e)}}},{key:"finished",value:function(t,r){if(!this.curProcItems[t])return!1;var n=this.curProcItems[t];if(!et.shiftProcess(n))return!1;if(delete this.curProcItems[t],this.processFunc&&(this.inFinProcess=!0,this.processFunc.call(this.bindTarget,e.$.FIN+t,r,this),this.inFinProcess=!1),this.curProcRes[t]=r,0===c.count(this.curProcItems)){this.inFinPhase=!0;var i=this.machineFunc.call(this.bindTarget,e.$.FIN+this.curPhaseItem.phase,this.curProcRes,this);i&&e.NULL!==i&&(this.nextPhase=i),this.inFinPhase=!1,et.nextPhase(this)}return!0}},{key:"failed",value:function(e,t){if(!this.curProcItems[e])return!1;var r=this.curProcItems[e];return!!et.shiftProcess(r)&&(delete this.curProcItems[e],this.mstat==je?et.unphase0(this,t):et.clearup(this),!0)}},{key:"repeat",value:function(e){if(!this.curProcItems[e])return!1;var t=this.curProcItems[e];return!!et.isProcessing(t)&&(ot.uncommit(t),it.commit(t),!0)}},{key:"result",value:function(e,t){this.curProcRes[e]=t}}],[{key:"onQueue",value:function(e,t){c.is.isRegex(e)?Qe.push({regex:e,func:t}):$e[e]=t}},{key:"cutail",value:function(e){var t=qe[e];!t||t.length<=1||t.splice(1,t.length-1)}},{key:"create",value:function(t,r){if(!t)return null;if(!r)return null;if(Xe[t])throw new Error("duplicate act: "+t);var n;return n=new e(t,r),Xe[t]=n,n}},{key:"find",value:function(e){var t;return(t=Xe[e])?t:null}},{key:"remove",value:function(e){var t=Xe[e];if(t){t.mstat==je&&et.unphase0(t,!1);var r=t.tag,n=qe[r];n&&0!=n.length?n[0]==t.curPhaseItem&&(t.autoremove=!0):et.deleteAct(t)}}},{key:"finish",value:function(e,t){for(var r in Xe){if(Xe[r].finished(e,t))break}}},{key:"fail",value:function(e,t){for(var r in Xe){if(Xe[r].failed(e,t))break}}},{key:"setProcKey",value:function(e){Je[e]=1}},{key:"unsetProcKey",value:function(e){delete Je[e]}},{key:"changeItemDriveCore",value:function(e,t){e&&t&&(nt.setDriveCore(e),it.setDriveCore(t),window.AELite&&(window.AELite.drv_phase=e,window.AELite.drv_proc=t))}},{key:"changeTimeoutDriveCore",value:function(e){e&&(ot.setDriveCore(e),window.AELite&&(window.AELite.drv_toproc=e))}},{key:"setFlow",value:function(e,t){return c.is.isObject(e)?(e.flow=t,e):{flow:t}}},{key:"getFlow",value:function(e){return e&&e.curPhaseItem&&e.curPhaseItem.params&&e.curPhaseItem.params.flow}}]),e}();Ze.$={UN:"un$",FIN:"fin$",TO:"to$"},Ze.DONE="$done",Ze.SKIP="$skip",Ze.NULL="$null",Ze.dummy=Ze.create("dummy","dummy"),Ze.dummy.defMachine((function(){return Ze.DONE})).defProcess((function(){}));var et={unphase0:function(e,t){e.mstat=Ye,e.error=t;var r=e.curProcItems;e.curProcItems={};var n=null;try{n=e.machineFunc.call(e.bindTarget,Ze.$.UN+e.curPhaseItem.phase0,void 0,e)}catch(e){}if(n){for(var i in r)et.clearProcess(r[i]);r=null,e.curPhaseItem.phase=Ze.$.UN+e.curPhaseItem.phase0,e.nextPhase=n,e.recording&&et.record(e),0==c.count(e.curProcItems)&&et.nextPhase(e)}else e.curProcItems=r,!1!==t?et.clearup(e):(e.mstat=je,e.error=null)},clearup:function(e){for(var t in e.curProcItems){var r=e.curProcItems[t];et.clearProcess(r)}e.curProcItems={},e.curProcRes=null,e.nextPhase=Ze.DONE,et.callDest(e),et.shiftPhase(e)},callDest:function(e){e.endTime=Date.now(),e.curPhaseItem.phase=Ze.DONE,e.mstat=Ye;var t=null;if(null===e.error){var r=0;for(var n in e.curProcRes)t=e.curProcRes[n],r++;1!=r&&(t=e.curProcRes)}for(var i=e.dest,a=0,o=i.length;a<o;a++)try{i[a]&&i[a](t,e.error,e)}catch(e){U.warning("calldest error",e)}e.dest.splice(0,o),e.error=null},deleteAct:function(e){e.bindTarget=null,e.data=null,e.exdata=null,e.dest=null,delete Xe[e.uid]},queueAct:function(e,t){var r=t.actTag,n=qe[r];if(n||(n=[],qe[r]=n),n.length>=1){var i=$e[r];if(i)i.call(e,n,t);else for(var a=0,o=Qe.length;a<o;a++)if(Qe[a].regex.test(r)){Qe[a].func.call(e,n,t);break}}n.push(t),1==n.length&&nt.commit(t)},shiftPhase:function(e){var t=e.tag,r=qe[t];r.length&&r.shift(),r.length?(e.autoremove=!1,nt.commit(r[0])):e.autoremove&&et.deleteAct(e)},nextPhase:function(e){e.curPhaseItem.phase=e.nextPhase,nt.commit(e.curPhaseItem)},queueProcess:function(e){var t=e.procTag;if(null!=t&&Je[t]){var r=ze[t];r||(r=[],ze[t]=r),r.push(e),1==r.length&&it.commit(e)}else it.commit(e)},shiftProcess:function(e){var t=e.procTag;if(ot.uncommit(e),null==t||!Je[t])return!0;var r=ze[t];return!(!r.length||r[0]!==e)&&(r.shift(),r.length&&it.commit(r[0]),!0)},clearProcess:function(e){var t=e.procTag;if(ot.uncommit(e),null!=t&&Je[t]){for(var r=ze[t],n=!1,i=0,a=r.length;i<a;i++)r[i]==e&&(0==i&&(n=!0),r.splice(i,1),i--,a--);r.length&&n&&it.commit(r[0])}},isProcessing:function(e){var t=e.procTag;if(null==t||!Je[t])return!0;var r=ze[t];return!(!r.length||r[0]!==e)},resetRecord:function(e){e.records.splice(0,e.records.length)},record:function(e){var t={phase:e.curPhaseItem.phase,processes:et.listProcItem(e.curProcItems)};e.records.push(t)},recordProcess:function(e,t){e.records.length&&e.records[e.records.length-1].processes.push(t)},listProcItem:function(e){var t=[];for(var r in e)t.push(r);return t},reset:function(){var e;for(var t in qe={},ze={},Xe)(e=Xe[t]).mstat==je&&et.clearup(e)}},tt=function(){function e(t,r){Ve(this,e),this.driveFunc=r,this.driveCore=t,this.driveId=this.driveCore.regist(this)}return We(e,[{key:"setDriveCore",value:function(e){this.driveCore.unregist(this),this.driveCore=e,this.driveId=this.driveCore.regist(this)}},{key:"commit",value:function(e){this.driveCore.commit(this.driveId,e)}},{key:"uncommit",value:function(e){this.driveCore.uncommit(this.driveId,e)}},{key:"drive",value:function(e){for(var t,r=0,n=e.length;r<n;r++)t=this.driveFunc(e[r]);if(t)throw t}}]),e}(),rt={driveMax:156,driveTime:0,itvl:0,drives:[],itemss:[],regist:function(e){return this.drives.push(e),this.itemss.push([]),this.drives.length-1},unregist:function(e){var t=this.drives.indexOf(e);t>=0&&(this.drives.splice(t,1),this.itemss.splice(t,1))},commit:function(e,t){var r=this;e>=this.drives.length||(this.itemss[e].push(t),this.itvl||(this.itvl=setInterval((function(){for(var e=0,t=r.drives.length;e<t;e++){var n=r.itemss[e];n.length&&r.drives[e].drive(n.splice(0,n.length))}var i=!0;for(e=0,t=r.drives.length;e<t;e++)if(r.itemss[e].length>0){i=!1;break}i&&r.driveTime++,r.driveTime>=r.driveMax&&(clearInterval(r.itvl),r.itvl=0,r.driveTime=0)}),64)))}},nt=new tt(rt,(function(e){Ke&&console.log("phase:",e);var t=e.actTag;if(e===(qe[t]&&qe[t].length?qe[t][0]:null)){var r=e.actUId,n=Xe[r],i=null;if(n)for(;;){if(e.phase==Ze.DONE)return et.callDest(n),void et.shiftPhase(n);e.phase==e.phase0?(n.recording&&et.resetRecord(n),n.curPhaseItem!=e&&(n.curPhaseItem=e,n.startTime=Date.now(),n.dest.splice(0,n.dest.length),n.dest.push(e.dest),delete e.dest,n.mstat=je),i=e.params):i=n.curProcRes,n.curProcItems={},n.curProcRes={};try{n.nextPhase=n.machineFunc.call(n.bindTarget,e.phase,i,n)}catch(e){return U.warning(e,r),void(n.mstat==je?et.unphase0(n,g(g.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR,null,{err:e.message})):et.clearup(n))}if(n.recording&&et.record(n),0!=c.count(n.curProcItems))return;n.curPhaseItem.phase=n.nextPhase}}})),it=new tt(rt,(function(e){Ke&&console.log("proc:",e);var t=e.actUId,r=e.process,n=Xe[t];if(n&&n.curProcItems[r]===e)try{if(!n.processFunc)return void n.finished(r,null);n.processFunc.call(n.bindTarget,r,e.params,n),e.timeout&&ot.commit(e)}catch(e){U.warning(e,t,r),n.failed(r,g(g.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR,null,{err:e.message}))}})),at={drive:null,items:{},regist:function(e){return this.drive=e,0},unregist:function(e){this.drive=null},commit:function(e,t){var r=this;if(!t.timeout)return!1;t.timeoutId&&clearTimeout(t.timeoutId),t.timeoutId=setTimeout((function(){delete r.items[t.timeoutId],t.timeoutId=null,r.drive.drive([t])}),t.timeout),this.items[t.timeoutId]=t},uncommit:function(e,t){delete this.items[t.timeoutId],t.timeoutId&&clearTimeout(t.timeoutId),t.timeoutId=null}},ot=new tt(at,(function(e){Ke&&console.log(Ze.$.TO+"proc:",e);var t=e.actUId,r=e.process,n=Xe[t];n&&n.curProcItems[r]===e&&n.processFunc&&n.processFunc.call(n.bindTarget,Ze.$.TO+r,null,n)}));function st(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}window.AELite={name:"Action E. Lite",version:"1.2.0",creator:"yelirong@aocyun.com",core:Xe,q_acts:qe,q_procs:ze,drv_phase:rt,drv_proc:null,drv_toproc:at,debug:function(){Ke=!0},reset:function(){et.reset()}};var ct={success:function(){this.rtclib&&this.rtclib.attach(this.pluginCallback)},error:function(e){if(U.warning(this.connectName+"connect to "+e.url+" onRTClibError: "+e.error),"Error connecting to the WebSockets server: Is the server down?"==e.error){if(ee.room("",ee.CODES.REPORT_TYPE_SERVER_NO_RESPONSE,this.rparam),this.rtclib&&!this.rtclib.isConnected()){var t=g(g.CODE.CHUANG_WEBRTC_ERROR,null,{err:g.MSG.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK});this.ondisconnect(t)}}else if("Lost connection to the server (is it down?)"==e.error){ee.room("",ee.CODES.REPORT_TYPE_SERVER_TIMEOUT,this.rparam);t=g(g.CODE.CHUANG_WEBRTC_ERROR,null,{err:g.MSG.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK});this.ondisconnect(t)}},destory:function(){U.debug(this.connectName+" onRTClibDestory"),this.rtclib&&this.rtclib.breaki(),this.connact.finished(v.ACT_PROC.STM_CLOSE)}},ut={success:function(e){this.pluginHandle=e,U.info(this.connectName+" Plugin attached! ("+this.pluginHandle.getPlugin()+", id="+this.pluginHandle.getId()+")"),this.onconnect(),this.connact.finished(v.ACT_PROC.STM_CONNECT)},error:function(e){var t=dt.errorToMessage(e),r=g(g.CODE.CHUANG_WEBRTC_ERROR,null,{err:t});this.ondisconnect(r)},consentDialog:function(e,t,r){void 0===e&&U.debug(this.connectName+" on "+t,r)},iceState:function(e){if(U.info(this.connectName+" ice state "+e),this.pcstate=e,v.ICS_STATUS.FAILED==e){var t=g(g.CODE.CHUANG_WEBRTC_ICE_ERROR);this.ondisconnect(t)}},mediaState:function(e,t){U.info(this.connectName+" media state "+e,t)},webrtcState:function(e,t){U.info(this.connectName+" webrtc state is "+(e?"up":"down")+" now"+t)},onmessage:function(e,t){if(e){var r=e.result;if(null!=r&&void 0!==r.status&&null!==r.status){var n=r.status;if("preparing"===n||"refreshing"===n)this.pluginCallback.onmessage_preparing(r,t);else if("recording"===n){null!=t&&this.pluginHandle.handleRemoteJsep({jsep:t});var i=r.id;null!=i&&(U.info(this.connectName+" The ID of the current recording is "+i),this.recordingId=i),this.pluginCallback.onmessage_recording(r)}else if("slow_link"===n)this.pluginCallback.onmessage_slow_link(r);else if("publish"===n)this.pluginCallback.onmessage_publish(r);else if("playing"===n)this.pluginCallback.onmessage_playing(r);else if("publishmessage"===n)this.pluginCallback.onmessage_message(r);else if("stopped"===n)U.info(this.connectName+" Session has stopped!"),this.recordingId=null,this.pluginHandle.hangup();else if("videostat"===n){var a={};a.loss=r.loss,a.realframerate=r.realframerate,this.pluginCallback.onmessage_videostat(a)}}else{U.info(this.connectName+" ::: Got unknown error message :::"),U.debug(e);var o=e.error;this.pluginHandle.hangup();var s=dt.errorToMessage(o),c=g(g.CODE.CHUANG_WEBRTC_ERROR,null,{err:s});U.info("ondisconnect when error"),this.ondisconnect(c)}}else U.error(this.connectName+" on undefined message!!!")},onmessage_preparing:function(e,t){},onmessage_slow_link:function(e){},onmessage_playing:function(e){},onmessage_videostat:function(e,t){},onmessage_publish:function(e){},oncleanup:function(){U.info(this.connectName+" ::: Got a cleanup notification :::"),this.pcstate="closed"}},dt=function(){function e(t,r){for(var n in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.connectName=null,this.rparam=r,this.ccstream=t,this.startTime=Date.now(),this.needReconnect=!0,this.wssUrl=null,this.rtclib=null,this.pluginCallback={plugin:"rtclib.plugin.recordplay"},ut)this.pluginCallback[n]=ut[n].bind(this);this.pluginHandle=null,this.recordingId=null,this.pcstate=null,this.connact=null}var t,r,n;return t=e,n=[{key:"errorToMessage",value:function(e){return c.is.isObject(e)?e.message?e.message:JSON.stringify(e):c.is.isString(e)?e:null}},{key:"filterStatus",value:function(e){var t={};for(var r in e&&e.ssrc&&(t.ssrc=e.ssrc),e)"number"==typeof e[r]&&"timestamp"!=r&&"ssrc"!=r&&(t[r]=e[r]);return t}}],(r=[{key:"uninit",value:function(){}},{key:"createAct",value:function(e,t,r){var n=Ze.find(e);return n||(n=Ze.create(e,e)).defMachine(t).defProcess(r),n.bind(this),this.connact=n,n}},{key:"getDuration",value:function(){return Math.ceil((Date.now()-this.startTime)/1e3)}},{key:"connect",value:function(e){this.wssUrl=e;for(var t=[],r=0,n=R.StunServer.length;r<n;r++)t.push({urls:R.StunServer[r]});this.rtclib=new f({server:this.wssUrl,iceServers:t,success:ct.success.bind(this),error:ct.error.bind(this),destroyed:ct.destory.bind(this)})}},{key:"close",value:function(){this.rtclib&&this.rtclib.destroy&&this.rtclib.destroy({cleanupHandles:!0}),this.rtclib=null}},{key:"muteAudio",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.muteAudio();return this.pluginHandle.send({message:{request:"configure",muteaudio:!0}}),e}},{key:"unmuteAudio",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.unmuteAudio();return this.pluginHandle.send({message:{request:"configure",muteaudio:!1}}),e}},{key:"mutevideo",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.muteVideo();return this.pluginHandle.send({message:{request:"configure",mutevideo:!0}}),e}},{key:"unmutevideo",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.unmuteVideo();return this.pluginHandle.send({message:{request:"configure",mutevideo:!1}}),e}},{key:"sendStreamAttachedMessage",value:function(e){this.pluginHandle&&this.pluginHandle.sendPublishMessage(e)}},{key:"getStream",value:function(){return this.ccstream}},{key:"getBitrate",value:function(){}},{key:"getVolume",value:function(){}},{key:"getResolution",value:function(){}},{key:"getVideoStreamStatus",value:function(){}},{key:"getAudioStreamStatus",value:function(){}},{key:"getStreamStatus",value:function(){}},{key:"onconnect",value:function(){}},{key:"ondisconnect",value:function(e){}}])&&st(t.prototype,r),n&&st(t,n),e}();const lt=dt;function ht(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function mt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function pt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function ft(e,t,r){return t&&pt(e.prototype,t),r&&pt(e,r),e}var vt=function(){function e(){mt(this,e),this.servers=null,this.serverIndex=0,this.servers_lastfail=null,this.fail_cooldown=0,this.retry=0,this.maxRetry=0,this.conn_timeout=0,this.cache_time=0,this.respCache=null,this.respCacheTime=0,this.onSuccess=null,this.onFailure=null,this.onRetry=null,this.reqKey=8357}return ft(e,[{key:"get",value:function(e,t){if(t)var r="https://"+this.servers[this.serverIndex];else r=this.servers[this.serverIndex];var n=this,i=this.reqKey;z.get(r+e,this.conn_timeout,(function(e){i==n.reqKey&&n.onSuccess&&n.onSuccess(e)}),(function(e,t,r,a){i==n.reqKey&&(U.debug("Ajax failed when loading ["+a+"]",e),n.nextServer())}))}},{key:"post",value:function(e,t){var r=this.servers[this.serverIndex],n=this,i=this.reqKey;z.post(r+e,t,this.conn_timeout,(function(e){i==n.reqKey&&n.onSuccess&&n.onSuccess(e)}),(function(e,t){i==n.reqKey&&(U.debug("Ajax failed when posting ["+t+"]",e),n.nextServer())}))}},{key:"cacheResp",value:function(e){this.cache_time>0&&(this.respCache=e,this.respCacheTime=c.curTimeInMilli())}},{key:"getCacheResp",value:function(){return this.cache_time>0&&this.respCache&&this.respCacheTime+this.cache_time>c.curTimeInMilli()?this.respCache:null}},{key:"nextServer",value:function(){this.serverIndex++,this.serverIndex>=this.servers.length&&(this.serverIndex=0,this.retry++,this.retry>=this.maxRetry||!this.maxRetry)?this.onFailure&&this.onFailure():this.onRetry&&this.onRetry()}},{key:"resetServer",value:function(){this.serverIndex=0,this.retry=0}},{key:"close",value:function(){this.reqKey=c.randomnum(12),this.onSuccess=null,this.onFailure=null,this.onRetry=null}}]),e}();function _t(e,t,r,n){e&&(e.r&&e.r[0]&&(t.push(e.r[0].ip),r.push(e.r[0].ip)),e.m&&e.m[0]&&n.push("wss://"+e.m[0].ip+"/conn"))}var Et=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.start=c.curTimeInMilli(),this.end=c.curTimeInMilli(),this.loadCore.serverIndex=0,this.loadCore.servers=R.DPServer,this.loadCore.maxRetry=R.DP_Reconn_Retry,this.loadCore.cache_time=R.DP_Cache_Time,this.loadCore.conn_timeout=R.DP_Conn_Timeout,this.loadCore.onSuccess=function(e){r.onSuccess(e)},this.res=null,this.loadCore.onFailure=function(e,t,n){r.end=c.curTimeInMilli(),r.cost=r.end-r.start;var i={serverlist:{httpcode:t,cost:r.cost,host:r.loadCore.servers[r.loadCore.serverIndex],response:c.base64encode(n)}};ee.room(i,ee.CODES.REPORT_TYPE_GET_SERVER_LIST_FAILED,{}),r.event.dispatchEvent(M.Create.resource(At.Event.DP_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.uid="",this.appkey="",this.device=v.DEVICE_TYPE.toLocaleLowerCase(),this.event=t}return ft(e,[{key:"onSuccess",value:function(e){var t;this.res=e;var r=null;try{r=JSON.parse(e.responseText)}catch(e){}if(!r||!r.client||!r.server)return this.loadCore.nextServer(),void ee.room(JSON.parse(e.responseText),ee.CODES.REPORT_TYPE_PARSE_SERVER_LIST_JSON_FAILED,{});var n=r.client,i=this.start.toString();if(n.appid!=this.appkey&&n.device!=this.device&&n.uid!=this.uid)return ee.room({error:{msg:"wrong client info",uid:this.uid+"|"+n.uid,device:this.device+"|"+n.device,appid:this.appkey+"|"+n.appid,ts:i+"|"+n.ts}},ee.CODES.REPORT_TYPE_PARSE_SERVER_LIST_JSON_WRONG_CLIENT_INFO,{}),void this.loadCore.nextServer();var a=r.server,o=[],s=[],u=[];if(c.is.isArray(a))for(var d=0,l=a.length;d<l;d++)_t(a[d],o,s,u);else{if(!c.is.isObject(a))return void this.loadCore.nextServer();_t(a,o,s,u)}if(0!=o.length&&0!=s.length&&0!=u.length){var h=(ht(t={},v.DPKEYS.PUBLISH,o),ht(t,v.DPKEYS.WATCH,s),ht(t,v.DPKEYS.MESSAGE,u),t);this.loadCore.cacheResp(h),this.end=c.curTimeInMilli(),this.cost=this.end-this.start;var m={httpcode:e.status,cost:this.cost,host:this.loadCore.servers[this.loadCore.serverIndex],response:c.base64encode(e.responseText)};this.event.dispatchEvent(M.Create.resource(At.Event.DP_RESULT,{resp:h,content:m}))}else this.event.dispatchEvent(M.Create.resource(At.Event.DP_EMPTY))}},{key:"load",value:function(e,t){if(!e)return this.event.dispatchEvent(M.Create.resource(At.Event.DP_FAIL,g(g.CODE.CHUANG_APPID_NULL)));if(!t)return this.event.dispatchEvent(M.Create.resource(At.Event.DP_FAIL,g(g.CODE.CHUANG_USERID_NULL)));this.appkey==e&&this.uid==t||(this.loadCore.respCache=null),this.uid=t,this.appkey=e;var r;if(null===(r=this.loadCore.getCacheResp()))this.loadCore.resetServer(),this.reload();else{var n={httpcode:this.res.status,cost:this.cost,host:this.loadCore.servers[this.loadCore.serverIndex],response:c.base64encode(this.res.responseText)};this.event.dispatchEvent(M.Create.resource(At.Event.DP_RESULT,{resp:r,content:n}))}}},{key:"reload",value:function(){var e=c.curTimeInMilli(),t="/?uid="+this.uid+"&device="+this.device+"&appid="+this.appkey+"&ts="+e;this.start=c.curTimeInMilli(),this.loadCore.get(t)}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),St=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.loadCore.serverIndex=0,this.loadCore.servers=R.UIDServer,this.loadCore.maxRetry=R.UID_Reconn_Retry,this.loadCore.cache_time=R.UID_Cache_Time,this.loadCore.conn_timeout=R.UID_Conn_Timeout,this.loadCore.onSuccess=function(e){var t=e.responseText.replace(/\r|\n/g,"");r.loadCore.cacheResp(t),r.event.dispatchEvent(M.Create.resource(At.Event.UID_RESULT,t))},this.loadCore.onFailure=function(e){r.event.dispatchEvent(M.Create.resource(At.Event.UID_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.uid_string="",this.appid="",this.event=t}return ft(e,[{key:"load",value:function(e,t){if(!e)return this.event.dispatchEvent(M.Create.resource(At.Event.UID_FAIL,g(g.CODE.CHUANG_APPID_NULL)));if(!t)return this.event.dispatchEvent(M.Create.resource(At.Event.UID_FAIL,g(g.CODE.CHUANG_USERID_NULL)));this.appid==e&&this.uid_string==t||(this.loadCore.respCache=null),this.appid=e,this.uid_string=t;var r;if(null!==(r=this.loadCore.getCacheResp()))return this.event.dispatchEvent(M.Create.resource(At.Event.UID_RESULT,r));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){var e=c.curTime(),t="/uid?app="+this.appid+"&uid="+this.uid_string+"&ts="+e;this.loadCore.get(t)}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),Ct=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.loadCore.serverIndex=0,this.loadCore.servers=R.KEYServer,this.loadCore.maxRetry=R.KEY_Reconn_Retry,this.loadCore.cache_time=R.KEY_Cache_Time,this.loadCore.conn_timeout=R.KEY_Conn_Timeout,this.loadCore.onSuccess=function(e){r.end=c.curTimeInMilli();var t=e.responseText.replace(/\r|\n/g,"");r.loadCore.cacheResp(t),r.event.dispatchEvent(M.Create.resource(At.Event.KEY_RESULT,{res:t,cost:r.end}))},this.loadCore.onFailure=function(e){r.event.dispatchEvent(M.Create.resource(At.Event.KEY_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.appid="",this.event=t}return ft(e,[{key:"load",value:function(e){if(!e)return this.event.dispatchEvent(M.Create.resource(At.Event.KEY_FAIL,g(g.CODE.CHUANG_APPID_NULL)));this.appid!=e&&(this.loadCore.respCache=null),this.appid=e;var t;if(null!==(t=this.loadCore.getCacheResp()))return this.event.dispatchEvent(M.Create.resource(At.Event.KEY_RESULT,t));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){var e="/app?app="+this.appid;this.loadCore.get(e)}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),Tt=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.loadCore.serverIndex=0,this.loadCore.servers=R.TOKENServer,this.loadCore.maxRetry=R.TOKEN_Reconn_Retry,this.loadCore.cache_time=R.TOKEN_Cache_Time,this.loadCore.conn_timeout=R.TOKEN_Conn_Timeout,this.loadCore.onSuccess=function(e){var t=null;try{t=JSON.parse(e)}catch(e){}if(t){if(1!=t.status)return r.loadCore.cacheResp(t),void r.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_FAIL,g(g.CODE.CHUANG_TOKEN_AUTH_ERROR,null,{reason:t.info})));var n=t.data;if(c.is.isObject(n)){var i={};for(var a in n)i[a]=c.xxteaDecryptFromBase64(n[a],r.encrypt);i.appId&&i.appKey?(t.data=i,r.loadCore.cacheResp(t),r.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_RESULT,i))):r.loadCore.nextServer()}else r.loadCore.nextServer()}else r.loadCore.nextServer()},this.loadCore.onFailure=function(e){r.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.tokenkey="",this.encrypt="",this.event=t}return ft(e,[{key:"load",value:function(e){if(!e)return this.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_FAIL,g(g.CODE.CHUANG_APPKEY_NULL)));this.tokenkey!=e&&(this.loadCore.respCache=null),this.tokenkey=e;var t;if(null===(t=this.loadCore.getCacheResp()))this.loadCore.resetServer(),this.reload();else{var r=t;1!=r.status?this.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_FAIL,g(g.CODE.CHUANG_TOKEN_AUTH_ERROR,null,{reason:r.info}))):this.event.dispatchEvent(M.Create.resource(At.Event.TOKEN_RESULT,r.data))}}},{key:"reload",value:function(){this.encrypt=c.randomString(32);return this.loadCore.post("/token/checkToken",{token:this.tokenkey,encrypt:this.encrypt})}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),gt=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.loadCore.serverIndex=0,this.loadCore.servers=R.CONFIGServer,this.loadCore.maxRetry=R.CONFIG_Reconn_Retry,this.loadCore.cache_time=R.CONFIG_Cache_Time,this.loadCore.conn_timeout=R.CONFIG_Conn_Timeout,this.start=0,this.end=0,this.serverConfig={},this.loadCore.onSuccess=function(e){r.loadCore.cacheResp(e.responseText),r.end=c.curTimeInMilli();var t=r.end-r.start;r.serverConfig.cost=t,r.serverConfig.httpcode=e.status,r.serverConfig.response=e.responseText,r.event.dispatchEvent(M.Create.resource(At.Event.CONFIG_RESULT,r.serverConfig))},this.loadCore.onFailure=function(e){r.end=c.curTimeInMilli(),r.event.dispatchEvent(M.Create.resource(At.Event.CONFIG_NET_FAIL,r.serverConfig))},this.loadCore.onRetry=function(){r.reload()},this.appid="",this.event=t}return ft(e,[{key:"load",value:function(){if(null!==this.loadCore.getCacheResp())return this.event.dispatchEvent(M.Create.resource(At.Event.CONFIG_RESULT,this.serverConfig));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){this.start=c.curTimeInMilli(),this.loadCore.get("/web/livevideoconfig.php")}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),Rt=function(){function e(t){var r=this;mt(this,e),this.loadCore=new vt,this.loadCore.serverIndex=0,this.loadCore.servers=R.FOLLOWServer,this.loadCore.maxRetry=R.FOLLOW_Reconn_Retry,this.loadCore.cache_time=R.FOLLOW_Cache_Time,this.loadCore.conn_timeout=R.FOLLOW_Conn_Timeout,this.start=0,this.end=0,this.serverConfig={},this.urlTail="",this.loadCore.onSuccess=function(e){if(console.log(e),e){var t=JSON.parse(e.responseText);t&&1e3==t.error_code?t.addr.length?r.event.dispatchEvent(M.Create.resource(At.Event.FOLLOW_RESULT,t)):r.reload(r.streamType,r.urlTail):setTimeout((function(){return r.reload(r.streamType,r.urlTail)}),500)}else setTimeout((function(){return r.reload(r.streamType,r.urlTail)}),500)},this.loadCore.onFailure=function(e){r.end=c.curTimeInMilli(),r.event.dispatchEvent(M.Create.resource(At.Event.FOLLOW_FAIL,r.serverConfig))},this.loadCore.onRetry=function(){r.reload(r.streamType,r.urlTail)},this.appid="",this.event=t}return ft(e,[{key:"load",value:function(e,t){this.streamType=e,this.urlTail=t,this.loadCore.resetServer(),this.reload(e,t)}},{key:"reload",value:function(e,t){this.urlTail=t||this.urlTail;var r=R.FOLLOWServer[0].split(":"),n=r[0],i=r[1],a=c.curTimeInMilli();if(e){if(e)o="/redirect?"+t+"&ts="+a}else var o="/redirect?"+this.urlTail+"&publish_ip="+n+"&publish_port="+i+"&ts="+a;this.start=c.curTimeInMilli(),this.loadCore.get(o,1)}},{key:"close",value:function(){At.follow.forEach((function(e){e.loadCore.onSuccess=null}))}}]),e}(),At={follow:[],newDPLoader:function(e){return new Et(e)},newUIDLoader:function(e){return new St(e)},newKEYLoader:function(e){return new Ct(e)},newTokenLoader:function(e){return new Tt(e)},newConfigLoader:function(e){return new gt(e)},newFollowLoader:function(e){return new Rt(e)},Event:{DP_FAIL:"dp-fail",DP_NET_FAIL:"dp-net-fail",DP_RESULT:"dp-result",DP_EMPTY:"dp-empty",UID_FAIL:"uid-fail",UID_NET_FAIL:"uid-net-fail",UID_RESULT:"uid-result",KEY_FAIL:"key-fail",KEY_NET_FAIL:"key-net-fail",KEY_RESULT:"key-result",TOKEN_FAIL:"token-fail",TOKEN_NET_FAIL:"token-net-fail",TOKEN_RESULT:"token-result",CONFIG_FAIL:"config-fail",CONFIG_NET_FAIL:"config-net-fail",CONFIG_RESULT:"config-result",FOLLOW_FAIL:"follow-fail",FOLLOW_NET_FAIL:"follow-net-fail",FOLLOW_RESULT:"follow-result"}};const Ot=At;function It(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Pt=function(){function e(t,r,n,i,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.queues={},this.url=t,this.paramsCallback=r,this.timeout=n||R.AjaxTimeout,this.delay=i||500,this.workingTimeoutId=0,this.netfailtime=0,this.ajaxs=new Array(a||1).fill(0),this.itemNum=o||1}var t,r,n;return t=e,(r=[{key:"addItem",value:function(e,t){!this.queues[e]&&(this.queues[e]=[]),this.queues[e].length>100?U.warning("report queue maxed out."):(this.queues[e].push(t),this.startWorking())}},{key:"startWorking",value:function(){var e=this;this.workingTimeoutId||(this.workingTimeoutId=setTimeout((function(){e.workingTimeoutId=0,e.working()}),this.delay+(this.netfailtime?100*Math.pow(10,Math.min(this.netfailtime,2)):0)))}},{key:"working",value:function(){var e=this.ajaxs.indexOf(0);if(!(e<0)){var t=null,r=null;for(var r in this.queues)if(this.queues[r].length>0){t=this.queues[r];break}if(t){var n=t.splice(0,this.itemNum),i=this.paramsCallback(n);this.ajaxs[e]=1;var a=this;z.post(this.url,i,this.timeout,(function(t){a.ajaxs[e]=0,a.netfailtime=0,a.startWorking()}),(function(i){a.queues[r]=n.concat(t),a.ajaxs[e]=0,a.netfailtime++,a.startWorking()}))}}}}])&&It(t.prototype,r),n&&It(t,n),e}(),yt={core:null,itoken:null,init:function(){return this.core=this.core||new Pt(R.EventUploadServer+"/rt/client_event",this.getParams.bind(this),null,500,3,10),this.itoken=this.itoken||c.base64encode(R.EventUploadKeys[0]+"-"+c.md5String(c.md5String(R.EventUploadKeys[0])+c.md5String(R.EventUploadKeys[1]))),this},getParams:function(e){return{itoken:this.itoken,appKey:e[0].Aid,events:e,version:v.SDKVERSION}},_common:function(e,t,r,n,i){e.Aid=t.Aid||kr.appId,e.deviceType=v.DEVICE_TYPE,e.roomName=t.roomname_string,e.uid=t.uid,e.cuid=t.uid_string,e.timeStamp=c.curTime(),e.event=r,e.value=n,yt.VALUES.FAILED==e.value&&(e.reason=i&&i.msg),this.core.addItem("evt",e)},room:function(e,t,r,n){},push:function(e,t,r,n,i){},pull:function(e,t,r,n,i){},mix:function(e,t,r,n,i){},CODES:{LOGIN:"room.login",LOGOUT:"room.logout",PUSH:"push.start",UNPUSH:"push.stop",PULL:"pull.start",UNPULL:"pull.stop",MIX:"mix.start",UNMIX:"mix.stop",UPMIX:"mix.layout",VOLOFF:"volume.off",VOLON:"volume.on",CAMERAOFF:"webcam.off",CAMERAON:"webcam.on",CAMERA_FRONT:"webcam.front",CAMERA_BACK:"webcam.rear",CAMERA_OTHER:"webcam.other",WIFI:"network.WIFI",FG:"network.4G",VERSION:"sdk.version"},VALUES:{INIT:"init",SUCCESS:"success",FAILED:"failed"},STMTYPE:{PUSH:"push",PULL:"pull",MIX:"mix"}}.init(),Nt={core:null,itoken:null,init:function(){return this.core=this.core||new Pt(R.LogUploadServer+"/log/upload",this.getParams.bind(this),null,3e3,3,12),this.itoken=this.itoken||c.base64encode(R.EventUploadKeys[0]+"-"+c.md5String(c.md5String(R.EventUploadKeys[0])+c.md5String(R.EventUploadKeys[1]))),this},getParams:function(e){return{itoken:this.itoken,appKey:e[0].Aid,content:e,version:v.SDKVERSION}},report:function(e,t,r,n,i){n=n||{}},LOGTYPE_UE:"userError",ACTION:{INIT:"init",INITROOM:"initroom",LOGIN:"login",LOGIN_RECONN:"login-reconn",LOGOUT:"logout",ON:"on",OFF:"off",PUBLISH:"publish",PUBLISH_RECONN:"publish-reconn",UNPUBLISH:"unpublish",PLAY:"play",PLAY_RECONN:"play-reconn",UNPLAY:"unplay",PLAY_ROOM_STREAM:"playroom",UNPLAY_ROOM_STREAM:"unplayroom",MIX:"mix",UNMIX:"unmix",UPMIX:"upmix",MUTE:"mute",UNMUTE:"unmute"}}.init();function bt(e){return(bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Dt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ut(e,t){return(Ut=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Lt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=wt(e);if(t){var i=wt(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return kt(this,r)}}function kt(e,t){return!t||"object"!==bt(t)&&"function"!=typeof t?Mt(e):t}function Mt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function wt(e){return(wt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}window.RepCore={name:"Reporter",version:"0.1.0",evt:yt,err:Nt};var Ht={onmessage_preparing:function(e){this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},onmessage_slow_link:function(e){this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},onmessage_recording:function(e){this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},onmessage_publish:function(e){this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},onmessage_videostat:function(e){this.ccstream&&this.ccstream.onPoooolStat(e),this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},onlocalstream:function(e){U.info(this.connectName+" ::: Got a local stream :::"),U.debug(e);var t=!this.ccstream.getPluginHandle();this.ccstream.savePluginHandle(this.pluginHandle),t&&this.ccstream.onStream(e),this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)},consentDialog:function(e,t,r){void 0!==e?(U.debug(this.connectName+" Consent dialog should be "+(e?"on":"off")+" now"),this.isAskingAuth=e,e&&this.ccstream.savePluginHandle(this.pluginHandle)):U.debug(this.connectName+" on "+t,r)},webrtcState:function(e,t){U.info(this.connectName+" webrtc state is "+(e?"up":"down")+" now"),e?(this.connact.finished(v.ACT_PROC.STM_PUSH_PUSH),this.event.timerRemove(Gt.TimerEvent.CHECK_CONN),this.event.timerAdd(Gt.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)):ee.room("",ee.CODES.REPORT_TYPE_RECV_CLOSE_PACKET,this.rparam)}},Gt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ut(e,t)}(a,e);var t,r,n,i=Lt(a);function a(e,t){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),r=i.call(this,e,t);var n=e.getStreamId();for(var o in r.connectName="[push-"+n+"@"+t.innerid+"]",r.bandwidth=r.ccstream.getStreamConfig().initBandwidth,r.pluginCallback.opaqueId="push-"+n,Ht)r.pluginCallback[o]=Ht[o].bind(Mt(r));return r.isAskingAuth=!1,r.connectHash=0,r.connectStatus=!1,r.createAct("push-"+n+"-"+t.innerid,Ft,Vt).record(),r.event=(new M).timerEnable((function(e){return r.onTimer(e)})),r.event.on("resource",(function(e){r.onResourceEvent(e)})),r}return t=a,(r=[{key:"uninit",value:function(){Ze.remove(this.connact.uid),this.connact=Ze.dummy,this.ccstream=null}},{key:"getStreamParam",value:function(){var e={};e.streamtype=this.ccstream.getStreamConfig().streamtype.toString(),e.uid=this.rparam.uid,e.uid_string=this.rparam.uid_string,e.streamstat=this.ccstream.getStreamConfig().streamstat.toString(),e.roomid=this.ccstream.getroomid(),e.streamname=this.ccstream.getStreamId(),e.width=this.ccstream.getStreamConfig().videoWidth.toString(),e.height=this.ccstream.getStreamConfig().videoHeight.toString(),e.fps=this.ccstream.getStreamConfig().frameRate.toString(),e.audiofmt="opus",e.samplerate="48000",e.channel="2",e.enclen="3840",e.starttime=Math.ceil(this.startTime/1e3).toString();var t=c.parseUrl(this.wssUrl);return e.pushaddr=t.host,e.pushport=t.port.toString(),e.bytes=this.ccstream.getBytes(),e.mixv=this.ccstream.getStreamConfig().mixv.toString(),e.bitrate=this.getBitrate().toString()||this.ccstream.getStreamConfig().initBandwidth.toString(),e}},{key:"getBitrate",value:function(){return this.pluginHandle?this.pluginHandle.getSendBitrate():0}},{key:"getVolume",value:function(){if(this.pluginHandle){var e=this.pluginHandle.getId(),t=this.pluginHandle.getLocalVolume(e);return Math.round(10*t)}}},{key:"getResolution",value:function(){if(this.pluginHandle){var e=this.pluginHandle.getId();return this.pluginHandle.getPushResolution(e)}}},{key:"getStreamStat",value:function(){return sparam.streamstat}},{key:"isAudioMuted",value:function(){if(this.pluginHandle)return this.pluginHandle.isAudioMuted()}},{key:"isVideoMuted",value:function(){if(this.pluginHandle)return this.pluginHandle.isVideoMuted()}},{key:"getStreamStatus",value:function(){if(this.pluginHandle){this.pluginHandle.getSendBitrate();var e=this.pluginHandle.getSendInfo();return e||this.ondisconnect("publish hanve no pluginHandle streamInfo to ondisconnect"),e}}},{key:"getVideoStreamStatus",value:function(){return this.pluginHandle?(this.pluginHandle.getSendBitrate(),lt.filterStatus(this.pluginHandle.getSendInfo().videosendinfo)):null}},{key:"getAudioStreamStatus",value:function(){return this.pluginHandle?(this.pluginHandle.getSendBitrate(),lt.filterStatus(this.pluginHandle.getSendInfo().audiosendinfo)):null}},{key:"close",value:function(){this.connectStatus=!1,U.info("onclose send rtclib destroy"),this.rtclib&&this.rtclib.destroy({cleanupHandles:this.ccstream.getPluginHandle()!=this.pluginHandle}),this.rtclib=null}},{key:"muteAudio",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.muteAudio();return this.pluginHandle.send({message:{request:"configure",muteaudio:!0}}),e}},{key:"unmuteAudio",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.unmuteAudio();return this.pluginHandle.send({message:{request:"configure",muteaudio:!1}}),e}},{key:"mutevideo",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.muteVideo();return this.pluginHandle.send({message:{request:"configure",mutevideo:!0}}),e}},{key:"unmutevideo",value:function(){if(!this.pluginHandle)return!1;var e=this.pluginHandle.unmuteVideo();return this.pluginHandle.send({message:{request:"configure",mutevideo:!1}}),e}},{key:"push",value:function(e){this.needReconnect=!0,U.info("pusher start push"),this.connact.start(v.ACT_PHASE.STM_PUSH,null,e)}},{key:"unpush",value:function(e){this.event.timerRemove(a.TimerEvent.CHECK_CONN),this.needReconnect=!1,this.connact.start(v.ACT_PHASE.STM_UNPUSH,null,e)}},{key:"onconnect",value:function(){this.connectStatus=!0,U.info("onconn add CHECK-CON"),this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.PUBLISH_CONNECTED,this.ccstream.streamId,{errCode:g.ErrorCode.CHUANG_PUBLISH_STREAM_RECONNECTED})),this.event.timerAdd(a.TimerEvent.RTT,R.Stream_Rtt_Interval),this.event.timerAdd(a.TimerEvent.CHECK_CONN,R.Stream_CheckConn_Timeout)}},{key:"ondisconnect",value:function(e){var t=this;this.connectStatus=!1,this.event.timerRemove(a.TimerEvent.CHECK_CONN);var r=kr.getroom(this.rparam.innerid);r.pushDis=1,r&&r.rtcPusher.onDisconnect(),U.info("push-disconn remove CHECK-CON"),this.event.timerRemove(a.TimerEvent.RTT),this.event.timerRemove(a.TimerEvent.CHECK_CONN),this.ccstream&&this.ccstream.event&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.PUBLISH_CONNECTING,{errCode:g.ErrorCode.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK})),this.needReconnect&&(this.connectHash=c.randomnumExcept(6,this.connectHash),this.rtclib&&(U.info("rtclib destroy"),this.rtclib.destroy({cleanupHandles:this.ccstream.getPluginHandle()!=this.pluginHandle})),this.connact.isActive()?this.connact.jump(v.ACT_PHASE.STM_ASK_SERVER):this.connact.start(v.ACT_PHASE.STM_PUSH,null,(function(e,r){null!==r?r&&Nt.report(r,Nt.ACTION.PUBLISH_RECONN,null,t.rparam,t.ccstream.getStreamId()):(console.log(t.pluginHandle.webrtcStuff.myStream.getTracks()),U.info(t.connectName+g.MSG.CHUANG_PUBLISH_STREAM_RECONNECTED))})))}},{key:"onResourceEvent",value:function(e){switch(e.type){case Ot.Event.FOLLOW_RESULT:this.wssUrl="wss://"+e.data.addr[0].ip,this.ccstream.streaminConfig.puship=e.data.puship,this.ccstream.streaminConfig.pushport=e.data.pushport,this.connact.finished(v.ACT_PROC.STM_ASK_SERVER);case Ot.Event.FOLLOW_FAIL:this.connact.finished(v.ACT_PROC.STM_ASK_SERVER,v.ACT_NET_FAIL)}}},{key:"onTimer",value:function(e){switch(e.type){case a.TimerEvent.RTT:var t=kr.getroom(this.rparam.innerid),r="";if(t){t.mix_status==v.MIX_STATUS.START||t.mix_status==v.MIX_STATUS.UPDATE?(r=JSON.stringify(t.mergeinfo.userlist),this.pluginHandle.send({message:{request:"configure",merge_layout:r}})):this.pluginHandle.send({message:{request:"configure"}});break}case a.TimerEvent.CHECK_CONN:U.warning("event back timeout"),this.ondisconnect()}}}])&&Dt(t.prototype,r),n&&Dt(t,n),a}(lt);Gt.TimerEvent={RTT:"rtt",CHECK_CONN:"check-conn"};const xt=Gt;function Ft(e,t,r){switch(e){case v.ACT_PHASE.STM_PUSH:return v.ACT_PHASE.STM_ASK_SERVER;case v.ACT_PHASE.STM_ASK_SERVER:return r.process(v.ACT_PROC.STM_ASK_SERVER,null,R.Stream_Ask_Server_Timeout),v.ACT_PHASE.STM_CONNECT;case v.ACT_PHASE.STM_CONNECT:if(U.info("pusher connectStatus",this.connectStatus),this.connectStatus)return Ze.DONE;kr.getroom(this.rparam.innerid);ee.push("",ee.CODES.REPORT_TYPE_PUBLISH_START,this.rparam,this.ccstream.streamId,this.ccstream.getStreamConfig().videoWidth,this.ccstream.getStreamConfig().videoHeight);var n=this.wssUrl;return n?(this.rparam.pubUdpConStart=c.curTimeInMilli(),r.process(v.ACT_PROC.STM_CONNECT,n,null,R.Stream_Push_Conn_Timeout),v.ACT_PHASE.STM_PUSH_PUSH):(r.process(v.ACT_PROC.STM_ASK_SERVER,null,R.Stream_Ask_Server_Timeout),v.ACT_PHASE.STM_CONNECT);case v.ACT_PHASE.STM_PUSH_PUSH:return this.rparam.pubUdpConEnd=c.curTimeInMilli(),this.rparam.pubwebrtcsocket=this.rparam.pubUdpConEnd-this.rparam.pubUdpConStart,this.isAskingAuth?(r.process(v.ACT_PROC.STM_PUSH_ASK_AUTH),v.ACT_PHASE.STM_PUSH_PUSH):(r.process(v.ACT_PROC.STM_PUSH_PUSH),Ze.DONE);case Ze.$.UN+v.ACT_PHASE.STM_PUSH:return this.needReconnect=!1,Ze.DONE;case v.ACT_PHASE.STM_UNPUSH:return this.rtclib&&r.process(v.ACT_PROC.STM_CLOSE,null,null,R.Stream_Close_Timeout),Ze.DONE}}function Vt(e,t,r){var n=this,i=Ot.newFollowLoader(this.event);switch(Ot.follow.push(i),e){case v.ACT_PROC.LOAD_DP:var a=kr.getroom(this.rparam.innerid);a.dpservact.start(v.ACT_PHASE.LOAD,null,(function(e,t){var n;null===t?(n=e[v.DPKEYS.PUBLISH])&&(a.rtcPusher.setServers(n),r.finished(v.ACT_PROC.LOAD_DP)):(ee.room("",ee.CODES.REPORT_TYPE_SERVER_NO_RESPONSE,{}),r.failed(v.ACT_PROC.LOAD_DP,t))}));break;case v.ACT_PROC.STM_ASK_SERVER:var o="act=0&appid="+this.rparam.appid+"&streamname="+this.ccstream.streamId+"&roomname="+this.rparam.roomId+"&roomid="+this.rparam.roomid+"&uidstring="+this.rparam.uid_string+"&uid="+this.rparam.uid+"&bitrate="+this.ccstream.streaminConfig.initBandwidth+"&clienttype=webrtc&";i.load(0,o);break;case Ze.$.FIN+v.ACT_PROC.STM_ASK_SERVER:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.LOAD_DP);break;case v.ACT_PROC.STM_CONNECT:(s=t)&&(this.connect(s),U.info("connect to",s));break;case Ze.$.TO+v.ACT_PROC.STM_CONNECT:var s=t;U.warning(this.connectName+" connect timeout."),ee.room("",ee.CODES.REPORT_TYPE_SERVER_TIMEOUT,this.rparam);var u=g(g.CODE.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK);this.ondisconnect(u);break;case v.ACT_PROC.STM_PUSH_PUSH:this.rparam.pubWebrtcconnect=c.curTimeInMilli();var d=this.ccstream.getStreamConfig().toMediaSpec();this.bandwidth=this.ccstream.getStreamConfig().initBandwidth,this.pluginHandle.send({message:{request:"configure","video-bitrate-max":this.bandwidth,"video-keyframe-interval":this.ccstream.getStreamConfig().keyframeInterval}});var l=this.connectHash;this.pluginHandle.createOffer({media:d,stream:this.ccstream.getMediaStream(),simulcast:!1,success:function(e){if(U.info(n.connectName+" Got SDP!"),U.debug(e),l!=n.connectHash)return U.warning(n.connectName+" abort create offer"),void n.connact.finished(v.ACT_PROC.STM_PUSH_ASK_AUTH);var t={request:"record",name:n.ccstream.getStreamId(),rtmpaddr:n.ccstream.getStreamConfig().getRtmpAddr(n.rparam.uid,n.rparam.expass,n.ccstream.getStreamId()),uid:parseInt(n.rparam.uid),cuid:n.rparam.uid_string,appid:n.rparam.appid,roomname:n.rparam.roomname,framerate:n.ccstream.getStreamConfig().frameRate,streammode:R.Stream_PushMode,sdkversion:kr.getSDKVersion(),capture_width:n.ccstream.getStreamConfig().videoWidth,capture_height:n.ccstream.getStreamConfig().videoHeight,puship:n.ccstream.getStreamConfig().puship,pushport:n.ccstream.getStreamConfig().pushport};n.pluginHandle.send({message:t,jsep:e})},error:function(e){if("Invalid handle"!=e){U.error(n.connectName+" createOffer error",e),n.pluginHandle.hangup(),n.needReconnect=!1;var t=He.wrapCreateOfferError(e);n.connact.failed(v.ACT_PROC.STM_PUSH_PUSH,t)}}});break;case v.ACT_PROC.STM_PUSH_ASK_AUTH:break;case v.ACT_PROC.STM_CLOSE:U.info("stmclose remove rtt"),this.event.timerRemove(Gt.TimerEvent.RTT),this.close(),i.close();break;case Ze.$.TO+v.ACT_PROC.STM_CLOSE:U.warning(this.connectName+" close timeout."),this.connact.finished(v.ACT_PROC.STM_CLOSE)}}function Bt(e){return(Bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function jt(e,t){return(jt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Yt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=qt(e);if(t){var i=qt(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Kt(this,r)}}function Kt(e,t){return!t||"object"!==Bt(t)&&"function"!=typeof t?Xt(e):t}function Xt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function qt(e){return(qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Ze.onQueue(/push-.*/,(function(e,t){t.phase0==v.ACT_PHASE.STM_UNPUSH&&(Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.STM_PUSH&&this.cancel())}));var $t={onmessage_preparing:function(e,t){var r=this;U.info(this.connectName+" Preparing the recording playout"),this.pluginHandle.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1},success:function(e){U.info(r.connectName+" Got SDP!"),U.debug(e);r.pluginHandle.send({message:{request:"start"},jsep:e})},error:function(e){if(U.error(r.connectName+" createAnswer error",e),"Invalid handle"!=e){var t=lt.errorToMessage(e),n=g(g.CODE.CHUANG_WEBRTC_PULL_EXCEPTION,null,{err:t});r.connact.failed(v.ACT_PROC.STM_PULL_PULL,n)}}}),e.warning&&U.warning(this.connectName+" WebRTC warning:",e)},onremotestream:function(e,t,r){"mute"==t?(this.ccstream&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.AUDIO_STUCK,this.ccstream.streamId)),this.ccstream&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.VIDEO_STUCK,this.ccstream.streamId)),U.warning(this.connectName+" ::: Remote stream stucks :::")):"unmute"==t?U.info(this.connectName+" ::: Remote stream playing :::"):(U.info(this.connectName+" ::: Got a remote stream :::",t),U.debug(e),"track"==t&&this.ccstream.onStream(e))},onmessage_playing:function(e){U.info(this.connectName+" Playout has started!"),this.ccstream.onStartplay(),this.connact.finished(v.ACT_PROC.STM_PULL_PULL),this.vimu&&this.muteVideo(this.ccstream.getStreamId(),this.vimu),this.aumu&&this.muteAudio(this.ccstream.getStreamId(),this.aumu)},onmessage_publish:function(e){this.event.timerRemove(Qt.TimerEvent.GET_PULL_EVENT),this.event.timerAdd(Qt.TimerEvent.GET_PULL_EVENT,R.Pull_Event_Interval),this.ccstream&&this.ccstream.onPoooolStat({loss:e.loss,rtt:e.rtt});var t=e.content&&e.content.muteaudio||0,r=e.content&&e.content.mutevideo||0;this.ccstream&&(this.ccstream&&this.ccstream.audio_mute!=t&&(U.info(this.connectName+(t?" mute":" unmute")+" audio"),this.ccstream.onAudioMute(t)),this.ccstream&&this.ccstream.video_mute!=r&&(U.info(this.connectName+(r?" mute":" unmute")+" video"),this.ccstream.onVideoMute(r)))},onmessage_message:function(e){var t=e.content||"";t&&(U.info(this.connectName+"get a attachMessage"+t),this.ccstream.onReceiveStreamAttachedMessage(t))}},Qt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&jt(e,t)}(a,e);var t,r,n,i=Yt(a);function a(e,t){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),r=i.call(this,e,t);var n=e.getStreamId();for(var o in r.connectName="[pull-"+n+"@"+t.innerid+"]",r.pluginCallback.opaqueId="pull-"+n,$t)r.pluginCallback[o]=$t[o].bind(Xt(r));return r.createAct("pull-"+n+"-"+t.innerid,Jt,Zt),r.event=(new M).timerEnable((function(e){return r.onTimer(e)})),r.event.on("resource",(function(e){r.onResourceEvent(e)})),r.aumu=0,r.vimu=0,r.playRoomName="",r}return t=a,(r=[{key:"uninit",value:function(){var e=this;this.unpull((function(){Ze.remove(e.connact.uid),e.connact=Ze.dummy,e.ccstream=null}))}},{key:"setStreamParam",value:function(e){this.sparam=e}},{key:"getStream",value:function(){return this.pluginHandle?this.pluginHandle.webrtcStuff.remoteStream:null}},{key:"getBitrate",value:function(){return this.pluginHandle?this.pluginHandle.getBitrate():0}},{key:"getVolume",value:function(){if(this.pluginHandle){var e=this.pluginHandle.getId(),t=this.pluginHandle.getRemoteVolume(e);return Math.round(10*t)}}},{key:"getResolution",value:function(){if(this.pluginHandle){var e=this.pluginHandle.getId();return this.pluginHandle.getPullResolution(e)}}},{key:"getStreamStatus",value:function(){if(this.pluginHandle){this.pluginHandle.getBitrate();var e=this.pluginHandle.getRecvInfo();return e||(U.warning("pull have no pluginHandle streamInfo to ondisconnect"),this.ondisconnect()),e}}},{key:"getVideoStreamStatus",value:function(){return this.pluginHandle?(this.pluginHandle.getBitrate(),lt.filterStatus(this.pluginHandle.getRecvInfo().videorecvinfo)):null}},{key:"getAudioStreamStatus",value:function(){return this.pluginHandle?(this.pluginHandle.getBitrate(),lt.filterStatus(this.pluginHandle.getRecvInfo().audiorecvinfo)):null}},{key:"muteAudio",value:function(e,t){this.aumu=t;var r=this.getStream().getAudioTracks();t?0!=r.length?r[0].enabled=!1:U.info("have no audioTrack,please wait some minutes try again"):0!=r.length?r[0].enabled=!0:U.info("have no audioTrack,please wait some minutes try again")}},{key:"muteVideo",value:function(e,t){this.vimu=t;var r=this.getStream().getVideoTracks();t?r?r[0].enabled=!1:U.info("have no Video Track,please wait some minutes try again"):r?r[0].enabled=!0:U.info("have no Video Track,please wait some minutes try again")}},{key:"pull",value:function(e,t){this.pullRoomName=e,this.connact.start(v.ACT_PHASE.STM_PULL,null,t)}},{key:"unpull",value:function(e){this.needReconnect=!1,this.connact.start(v.ACT_PHASE.STM_UNPULL,null,e)}},{key:"onconnect",value:function(){this.event.timerAdd(a.TimerEvent.GET_PULL_EVENT,R.Pull_Event_Interval),this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.PLAY_CONNECTED,this.ccstream.streamId,{errCode:g.ErrorCode.CHUANG_PLAY_STREAM_RECONNECTED})),this.ccstream.savePluginHandle(this.pluginHandle)}},{key:"ondisconnect",value:function(e){var t=this;U.info("pull disconn"),this.event.timerRemove(a.TimerEvent.GET_PULL_EVENT),this.ccstream&&this.ccstream.event&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.AUDIO_DISCONNECTED,this.ccstream.streamId)),this.ccstream&&this.ccstream.event&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.VIDEO_DISCONNECTED,this.ccstream.streamId)),this.ccstream&&this.ccstream.event&&this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.PLAY_CONNECTING,this.ccstream.streamId,{errCode:g.ErrorCode.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK}));var r=kr.getroom(this.rparam.innerid);r.pullDis=1,this.ccstream&&this.ccstream.streamId&&r.roomusers[this.ccstream.streamId]&&(r.rtcPuller.onDisconnect(),this.needReconnect&&(this.rtclib&&this.rtclib.destroy({cleanupHandles:!0}),this.connact.isActive()?this.connact.jump(v.ACT_PHASE.STM_ASK_SERVER):this.connact.start(v.ACT_PHASE.STM_PULL,null,(function(e,r){if(null!==r)r&&Nt.report(r,Nt.ACTION.PLAY_RECONN,null,t.rparam,t.ccstream.getStreamId());else{var n=t.ccstream.getStreamId();t.aumu&&t.muteAudio(n,t.aumu),t.vimu&&t.muteVideo(n,t.vimu),U.info(t.connectName+g.MSG.CHUANG_PLAY_STREAM_RECONNECTED)}}))))}},{key:"onResourceEvent",value:function(e){switch(e.type){case Ot.Event.FOLLOW_RESULT:this.wssUrl="wss://"+e.data.addr[0].ip,this.ccstream.sparam.pullip=e.data.pullip,this.ccstream.sparam.pullport=e.data.pullport,this.connact.finished(v.ACT_PROC.STM_ASK_SERVER);break;case Ot.Event.FOLLOW_FAIL:this.connact.finished(v.ACT_PROC.STM_ASK_SERVER,v.ACT_NET_FAIL)}}},{key:"onTimer",value:function(e){switch(e.type){case a.TimerEvent.FIRST_AUDIO:var t=this.getAudioStreamStatus();if(t&&t.packetsReceived&&0!=t.packetsReceived){var r=c.curTimeInMilli()-e.data.time;ee.pull({timecost:{firstaudio:r}},ee.CODES.REPORT_TYPE_RECV_FIRST_AUDIO,this.rparam,e.data.streamId,this.ccstream.sparam.width,this.ccstream.sparam.height),this.event.timerRemove(a.TimerEvent.FIRST_AUDIO),this.ccstream.firstAudio(e.data.streamId)}break;case a.TimerEvent.FIRST_VIDEO:var n=this.getVideoStreamStatus();n&&n.framesDecoded&&0!=n.framesDecoded&&(r=c.curTimeInMilli()-e.data.time,ee.pull({timecost:{firstvideo:r}},ee.CODES.REPORT_TYPE_RECV_FIRST_VIDEO,this.rparam,e.data.streamId,this.ccstream.sparam.width,this.ccstream.sparam.height),this.event.timerRemove(a.TimerEvent.FIRST_VIDEO),this.ccstream.firstVideo(e.data));break;case a.TimerEvent.GET_PULL_EVENT:this.ondisconnect()}}}])&&Wt(t.prototype,r),n&&Wt(t,n),a}(lt);Qt.TimerEvent={FIRST_VIDEO:"first-video",FIRST_AUDIO:"first-audio",GET_PULL_EVENT:"get-pull-event"};const zt=Qt;function Jt(e,t,r){switch(e){case v.ACT_PHASE.STM_PULL:return v.ACT_PHASE.STM_ASK_SERVER;case v.ACT_PHASE.STM_ASK_SERVER:return r.process(v.ACT_PROC.STM_ASK_SERVER,null,R.Stream_Ask_Server_Timeout),v.ACT_PHASE.STM_CONNECT;case v.ACT_PHASE.STM_CONNECT:var n=this.wssUrl;return n?(ee.pull("",ee.CODES.REPORT_TYPE_PLAY_START,this.rparam,this.ccstream.streamId,this.ccstream.sparam.width,this.ccstream.sparam.height),this.rparam.pullUdpConStart=c.curTimeInMilli(),r.process(v.ACT_PROC.STM_CONNECT,n,null,R.Stream_Pull_Conn_Timeout),v.ACT_PHASE.STM_PULL_PULL):v.ACT_PHASE.STM_ASK_SERVER;case v.ACT_PHASE.STM_PULL_PULL:return this.rparam.pullUdpConEnd=c.curTimeInMilli(),this.rparam.pullwebrtcsocket=this.rparam.pullUdpConEnd-this.rparam.pullUdpConStart,r.process(v.ACT_PROC.STM_PULL_PULL),Ze.DONE;case Ze.$.UN+v.ACT_PHASE.STM_PULL:return this.needReconnect=!1,Ze.DONE;case v.ACT_PHASE.STM_UNPULL:return this.rtclib&&r.process(v.ACT_PROC.STM_CLOSE,null,null,R.Stream_Close_Timeout),Ze.DONE}}function Zt(e,t,r){var n=Ot.newFollowLoader(this.event);switch(Ot.follow.push(n),e){case v.ACT_PROC.LOAD_DP:var i=kr.getroom(this.rparam.innerid);i.dpservact.start(v.ACT_PHASE.LOAD,null,(function(e,t){var n;null===t?(n=e[v.DPKEYS.WATCH])&&(i.rtcPuller.setServers(n),r.finished(v.ACT_PROC.LOAD_DP)):r.failed(v.ACT_PROC.LOAD_DP,t)}));break;case v.ACT_PROC.STM_ASK_SERVER:var a="act=1&appid="+this.rparam.appid+"&streamname="+this.ccstream.streamId+"&roomname="+this.rparam.roomId+"&roomid="+this.ccstream.sparam.roomid+"&uidstring="+this.rparam.uid_string+"&uid="+this.rparam.uid+"&publish_ip="+this.ccstream.sparam.pushaddr+"&publish_port="+this.ccstream.sparam.pushport+"&bitrate="+this.ccstream.sparam.bitrate+"&clienttype=webrtc&";n.load(1,a);break;case Ze.$.FIN+v.ACT_PROC.STM_ASK_SERVER:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.LOAD_DP);break;case v.ACT_PROC.STM_CONNECT:var o=t;if(o){this.connect(o),U.info("connect to "+o);var s=c.curTimeInMilli();this.event.timerAdd(Qt.TimerEvent.FIRST_AUDIO,1e3,{streamId:this.ccstream.getStreamId(),time:s}),this.event.timerAdd(Qt.TimerEvent.FIRST_VIDEO,1e3,{streamId:this.ccstream.getStreamId(),time:s})}break;case Ze.$.TO+v.ACT_PROC.STM_CONNECT:U.warning(this.connectName+" connect timeout."),ee.room("",ee.CODES.REPORT_TYPE_SERVER_TIMEOUT,this.rparam);var u=g(g.CODE.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK);this.ondisconnect(u);break;case v.ACT_PROC.STM_PULL_PULL:var d={request:"play",id:c.randomnum(16),streamname:this.ccstream.getStreamId(),roomname:this.pullRoomName||this.rparam.roomname,appid:this.rparam.appid,uid:this.rparam.uid,cuid:this.rparam.uid_string,srcuid:parseInt(this.ccstream.getSparam().uid),streamstat:parseInt(this.ccstream.getSparam().streamstat),sdkversion:kr.getSDKVersion(),pullip:this.ccstream.getSparam().pullip,pullport:this.ccstream.getSparam().pullport};U.info(this.connectName+" start play."),U.debug(d),this.pluginHandle.send({message:d}),this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.AUDIO_DECODING,this.ccstream.getStreamId())),this.ccstream.event.dispatchEvent(M.Create.stream(He.Event.VIDEO_DECODING,this.ccstream.getStreamId()));break;case v.ACT_PROC.STM_CLOSE:this.close(),n.close();break;case Ze.$.TO+v.ACT_PROC.STM_CLOSE:U.warning(this.connectName+" close timeout."),this.connact.finished(v.ACT_PROC.STM_CLOSE)}}function er(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Ze.onQueue(/pull-.*/,(function(e,t){t.phase0==v.ACT_PHASE.STM_UNPULL&&(Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.STM_PULL&&this.cancel())})),Qt.Event={GET_VOLUME:"get-volume"};const tr=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rparam=t,this.connectors={},this.servers=null,this.serverIndex=0,this.reconnTry=0,this.reconnMax=R.Stream_Default_Retry,this.lastReconn=0,this.lastRecover=0,this.needRenew=!0}var t,r,n;return t=e,(r=[{key:"setServers",value:function(e){this.needRenew&&(this.needRenew=!1,this.serverIndex=0,this.reconnTry=0,this.servers=e)}},{key:"clearServers",value:function(){this.serverIndex=0,this.reconnTry=0,this.servers=null}},{key:"getCurServer",value:function(){return this.servers&&this.serverIndex<this.servers.length?this.servers[this.serverIndex]:null}},{key:"onDisconnect",value:function(){this.neq++;var e=Date.now();if(e-this.lastRecover>R.Stream_Disconn_Recover&&(this.lastRecover=e,this.lastReconn=0,this.reconnTry=0),this.reconnTry++>=this.reconnMax){if(this.reconnTry=0,this.serverIndex,this.servers.length,this.serverIndex+1>this.servers.length)return this.serverIndex=0,void U.warning("serverIndex lagger");this.serverIndex++,this.serverIndex>=this.servers.length&&(this.needRenew=!0)}}},{key:"newPusher",value:function(e){var t=e.getStreamId(),r=e.getoption();if(r.streamType=1,r.video=e.streaminConfig.video,r.muted=r.muted||!0,this.connectors[t])return null;e.initDomplayer(r),e.linkEvent(M.Name.room(this.rparam.innerid));var n=new xt(e,this.rparam);return this.connectors[t]=n,n}},{key:"newPuller",value:function(e){var t=e.getStreamId();if(this.connectors[t])return null;var r=e.getoption();r.streamType=0,e.initDomplayer(r),e.linkEvent(M.Name.room(this.rparam.innerid)),e.event.dispatchEvent(M.Create.stream(He.Event.VIDEO_INITIALIZE,t)),e.event.dispatchEvent(M.Create.stream(He.Event.AUDIO_INITIALIZE,t));var n=new zt(e,this.rparam);return this.connectors[t]=n,n}},{key:"getPusher",value:function(e){return this.connectors[e]}},{key:"getPuller",value:function(e){return this.connectors[e]}},{key:"connectorExists",value:function(e){return!!this.connectors[e]}},{key:"removeConnector",value:function(e){this.connectors[e]&&(this.connectors[e].ccstream.uninit(),this.connectors[e].uninit(),delete this.connectors[e])}},{key:"startPreview",value:function(e){this.connectors[e]&&this.connectors[e].ccstream.startPreview()}},{key:"stopPreview",value:function(e){this.connectors[e]&&this.connectors[e].ccstream.stopPreview()}},{key:"getAllStreamIds",value:function(){var e=[];for(var t in this.connectors)e.push(t);return e}}])&&er(t.prototype,r),n&&er(t,n),e}();const rr={REGEX_ROOMNAME:/^[a-zA-Z0-9\-\_]+$/,roomnameFilter:function(e,t){return this.REGEX_ROOMNAME.test(e)?e:c.md5String(t+e)},checkStreamChannel:function(e,t){for(var r=e.getAllStreamIds(),n=!1,i=!1,a=0,o=r.length;a<o;a++){var s=e.getPusher(r[a]);s.ccstream.isMain()?n=!0:s.ccstream.isAux()&&(i=!0)}return(!t.isMain()||!n)&&(!t.isAux()||!i)},isValidString:function(e,t,r,n){var i=c.is;return t||(t=0),r||(r=Number.MAX_SAFE_INTEGER),i.isEmpty(n)&&(n=0),i.isString(e)&&n&&i.isASCII(e)&&e.length>=t&&e.length<=r},isValidInteger:function(e,t,r){return c.is.isInteger(e)&&e>=t&&e<=r},isValidNumber:function(e,t,r){return c.is.isNumber(e)&&e>=t&&e<=r}};function nr(e){return function(e){if(Array.isArray(e))return ir(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return ir(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ir(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ir(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ar(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var or=r(508),sr="0";function cr(e){return{streamId:e.streamname,width:parseInt(e.width),height:parseInt(e.height),uid:e.uid,streamstat:e.streamstat,streamtype:e.streamtype,reason:e.reason}}var ur="_idnkey",dr="_push",lr="_unpush",hr="_pull",mr="_unpull",pr="_getPushAct",fr="_getPullAct",vr="_getConnector",_r="_getStreamMixItems",Er=function(){function e(t,r){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.onpage=0,this.rparam={},this.rparam.Aid=null,this.rparam.appid=null,this.rparam.appkey=null,this.rparam.roomtoken=null,this._idnkey(t),this.rparam.roomid=sr,this.rparam.innerid=r,this.rparam.roomId="",this.rparam.playName="",this.rparam.code=0,this.rparam.servelist=0,this.rparam.getconfig=0,this.rparam.messconnect=0,this.rparam.messlogin=0,this.rparam.pubwebrtcsocket=0,this.rparam.pullwebrtcsocket=0,this.rparam.messauthpublish=0,this.rparam.messauthPull=0,this.rparam.pubTotal=0,this.rparam.pullTotal=0,this.rparam.loginStart=0,this.rparam.loginEnd=0,this.rparam.loginConnStart=0,this.rparam.loginConnEnd=0,this.rparam.url=0,this.rparam.reconnect=0,this.room_status=v.ROOM_STATUS.PRELOGIN,this.connect_status=v.ChuangRoomState.DISCONNECTED,this.publish_status=v.ChuangPublishState.DISCONNECTED,this.play_status=v.ChuangPlayState.DISCONNECTED,this.roomact=Ze.create("room-"+this.rparam.innerid,"room-"+this.rparam.innerid),this.roomact.bind(this).defMachine(Cr).defProcess(Tr).record(),this.dpservact=Ze.create("serv-"+this.rparam.innerid,"serv-"+this.rparam.innerid),this.dpservact.bind(this).defMachine(gr).defProcess(Rr),this.mix_status=v.MIX_STATUS.PRESTART,this.mixact=Ze.create("mix-"+this.rparam.innerid,"mix-"+this.rparam.innerid),this.mixact.bind(this).defMachine(yr).defProcess(Nr),this.mixinact=Ze.create("mixin-"+this.rparam.innerid,"mixin-"+this.rparam.innerid),this.mixinact.bind(this).defMachine(br).defProcess(Dr),this.emitter=new or,this.event=(new M).linkOpen(M.Name.room(this.rparam.innerid)).timerEnable((function(e){return n.onTimer(e)})),this.dpEmpty=!1,this.dpLoader=Ot.newDPLoader(this.event),this.uidLoader=Ot.newUIDLoader(this.event),this.keyLoader=Ot.newKEYLoader(this.event),this.tokenLoader=Ot.newTokenLoader(this.event),this.configLoader=Ot.newConfigLoader(this.event),this.event.on("resource",(function(e){n.onResourceEvent(e)})),kr.event.on("app",(function(e){n.onAppEvent(e)})),this.dpservact.start(v.ACT_PHASE.LOAD,Ze.setFlow(null,v.ACT_FLOW.PRE_LOAD),null),this.rtcSignal=new be(this.rparam),this.rtcSignal.on("signal",(function(e){n.onSignalEvent(e)})),this.rtcSignal.on("signal-stream",(function(e){n.onSignalStreamEvent(e)})),this.rtcPusher=new tr(this.rparam),this.rtcPuller=new tr(this.rparam),this.mi_lastCerrcode="999",this.startTime=0,this.event.on("stream",(function(e){n.onStreamEvent(e)})),this.roomusers={},this.lastroomusers={},this.watchInfoFlag=!1,this.swiStreamId=null,this.mixStreamConfig=null,this.mergeinfo={},this.mixWidth=800,this.mixHeight=600,this.mi_lastCCount=0,this.mixpub=0,this.preSound=0,this.isRemoteTestResolution=0,this.pushDis=0,this.pullDis=0,this.allUsers=[]}var t,r,n;return t=e,(r=[{key:"uninit",value:function(){this.emitter.removeEvent(/.*/),this.event.uninit()}},{key:"on",value:function(e,t){return this.emitter.on(e,t),this}},{key:"off",value:function(e,t){return t?this.emitter.off(e,t):this.emitter.removeEvent(e),this}},{key:"emitsafe",value:function(e,t){try{var r;(r=this.emitter).emit.apply(r,[e].concat(nr(t)))}catch(e){console.log(e)}}},{key:"getMixSize",value:function(e){var t={};switch(e){case 0:t.mixWidth=800,t.mixHeight=600;break;case 1:t.mixWidth=432,t.mixHeight=768;break;case 2:t.mixWidth=768,t.mixHeight=432;break;case 3:t.mixWidth=1280,t.mixHeight=720;break;case 4:t.mixWidth=720,t.mixHeight=1280;break;default:t.mixWidth=800,t.mixHeight=600}return t}},{key:ur,value:function(e){var t=e.appid,r=e.appkey;-1!=t.indexOf("-")?(this.rparam.Aid=t,r.length>64?(this.rparam.roomtoken=r,this.rparam.appid=null):this.rparam.appid=r):(this.rparam.Aid=r,this.rparam.appid=t,this.rparam.appkey=r)}},{key:"loadpage",value:function(e){this.onpage=e}},{key:"loginRoom",value:function(t,r,n,i){var a=this;if(this.rparam.loginStart=c.curTimeInMilli(),!t){var o=g(g.CODE.CHUANG_ROOMID_NULL);return U.error(o.msg),i&&i(o),!1}return r?(t=t.toString(),r=r.toString(),t.length>255?(o=g(g.CODE.CHUANG_ROOMID_TOO_LONG),U.error(o.msg),i&&i(o),!1):t.match(/[^\w-]/)?(o=g(g.CODE.CHUANG_ROOMID_INVALID),U.error(o.msg),i&&i(o),!1):r.length>255?(o=g(g.CODE.CHUANG_USERID_TOO_LONG),U.error(o.msg),i&&i(o),!1):r.match(/[^\w-]/)?(o=g(g.CODE.CHUANG_USERID_INVALID),U.error(o.msg),i&&i(o),!1):1!=n&&2!=n&&3!=n?(o=g(g.CODE.CHUANG_ROLE_PERMISSION_ERROR),U.error(o.msg),i&&i(o),!1):(ee.room({appid:this.rparam.appid,uidstring:r,roomname:t},ee.CODES.REPORT_TYPE_LOGIN_CALLED_FROM_USER,{uid_string:r,uid:this.rparam?this.rparam.uid:r}),yt.room(yt.VALUES.INIT,yt.CODES.LOGIN,{roomname_string:t,uid_string:r,uid:this.rparam?this.rparam.uid:r}),void(v.ROOM_STATUS.LOGIN!==this.room_status&&v.ROOM_STATUS.LOGIN_PROC!==this.room_status&&(this.connect_status=v.ChuangRoomState.CONNECTING,this.rparam.roomId=t,this.emitsafe(e.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_SUCCESS]),this.roomact.start(v.ACT_PHASE.LOGIN,[t,r,n],(function(n,o){if(a.rparam.loginEnd=c.curTimeInMilli(),null===o){a.rparam.reconnect=1;var s={appid:a.rparam.appid,uidstring:r,roomname:t,errcode:0,messageserver:a.rparam.url,timecost:a.rparam.loginEnd-a.rparam.loginStart,connect:a.rparam.loginConnEnd-a.rparam.loginConnStart,serverlist:a.rparam.servelist};yt.room(yt.VALUES.SUCCESS,yt.CODES.LOGIN,a.rparam),a.rtcSignal.startReqlist(a.sparam),a.room_status=v.ROOM_STATUS.LOGIN,a.rparam.userlist.length>0&&a.onUserlist(a.rparam.userlist),a.connect_status=v.ChuangRoomState.CONNECTED,a.emitsafe(e.Event.RoomStateUpdate,[a.rparam.roomId,a.connect_status,g.ErrorCode.CHUANG_SUCCESS,a.rparam]),ee.room(s,ee.CODES.REPORT_TYPE_USER_LOGIN_RESULT,a.rparam)}else o&&(s={appid:a.rparam.appid,uidstring:r,roomname:t,errcode:-1,messageserver:a.rparam.url,timecost:a.rparam.loginEnd-a.rparam.loginStart,connect:a.rparam.loginConnEnd-a.rparam.loginConnStart,serverlist:a.rparam.servelist},ee.room(s,ee.CODES.REPORT_TYPE_USER_LOGIN_RESULT,a.rparam),a.room_status=v.ROOM_STATUS.PRELOGIN,yt.room(yt.VALUES.FAILED,yt.CODES.LOGIN,a.rparam,o),Nt.report(o,Nt.ACTION.LOGIN,null,a.rparam),i&&i(o))})))))):(o=g(g.CODE.CHUANG_USERID_NULL),U.error(o.msg),i&&i(o),!1)}},{key:"logoutRoom",value:function(t){var r=this;this.isLocalTestResolution=0,this.stopStreamQualityTest(),this.stopSoundLevelMonitor(),this.stopStreamResolutionTest(),yt.room(yt.VALUES.INIT,yt.CODES.LOGOUT,this.rparam),ee.room("",ee.CODES.REPORT_TYPE_LOGOUT_CALLED_FROM_USER,this.rparam),this.roomact.start(v.ACT_PHASE.LOGOUT,null,(function(n,i){r.room_status=v.ROOM_STATUS.PRELOGIN,r.rparam.roomid=sr,null===i?(r.reconnect=0,r.event.timerRemove(e.TimerEvent.FRAMES_ENCODED),yt.room(yt.VALUES.SUCCESS,yt.CODES.LOGOUT,r.rparam),ee.room({mess:{roomid:r.rparam.roomname}},ee.CODES.REPORT_TYPE_MESS_LOGOUT_ROOM,r.rparam),r.connect_status=v.ChuangRoomState.DISCONNECTED,r.emitsafe(e.Event.RoomStateUpdate,[r.rparam.roomId,r.connect_status,g.ErrorCode.CHUANG_SUCCESS]),window.sessionStorage.clear()):i&&(yt.room(yt.VALUES.FAILED,yt.CODES.LOGOUT,r.rparam,i),Nt.report(i,Nt.ACTION.LOGOUT,null,r.rparam),t&&t(i))}))}},{key:"getRoomConnectState",value:function(){return this.connect_status}},{key:"onUserlist",value:function(t){if(this.lastroomusers=Object.assign(this.lastroomusers,this.roomusers),this.rparam.act!=v.ChuangUserRole.ANCHOR){var r=[];if(t.list)r=t.list;else{if(!t.length)return;r=t}U.info("preRoomusers",this.roomusers),U.info("onuserlist",t);for(var n,i=[],a=[],o={},s=0,c=r.length;s<c;s++)if(u=(d=r[s]).streamname){if(this.roomusers[u])delete this.roomusers[u];else{if(this.rtcPusher.connectorExists(u))continue;i.push({streamId:(n=d).streamname,width:parseInt(n.width),height:parseInt(n.height),uid:n.uid,streamstat:n.streamstat,streamtype:n.streamtype})}o[u]=d}for(var u in U.info("for del this.roomusers",this.roomusers),U.info("mewroomusers",o),this.roomusers){var d=this.roomusers[u];if(t.remove_list)for(var l=0;l<t.remove_list.length;l++)d.streamname==t.remove_list[l].streamname&&(d.reason=t.remove_list[l].reason);else d.reason=3;a.push(cr(d)),delete this.roomusers[u]}this.roomusers=o,U.info("newRoomusers",this.roomusers,i,a),i.length&&(U.info("addUsers",i),this.emitsafe(e.Event.RoomStreamUpdate,[this.rparam.roomId,v.ChuangStreamUpdateType.ADD,i])),a.length&&(U.info("delUsers",a),this.emitsafe(e.Event.RoomStreamUpdate,[this.rparam.roomId,v.ChuangStreamUpdateType.DELETE,a]))}}},{key:"startPreview",value:function(e,t){this.rtcPusher.startPreview(e)}},{key:"startPreview1",value:function(t,r){var n=this,i=new x(v.ChuangPublishChannel.MAIN);i.setVideoConfigPreset(v.ChuangVideoConfigPreset.CHUANG_VIDEO_CONFIG_PRESET_720P),i.setRenderMode(r);var a=new He("",i).setDomId(t);this.rtcPusher.newPusher(a),He.createHackedLocalstream(a,(function(t,r){n.rtcPusher.connectorExists("")||He.closeMstream(t),U.info("预览成功"),n.emitter.emit(e.Event.PREVIEW_SUCCEED)}),(function(e){U.error("预览失败")}))}},{key:"stopPreview1",value:function(t){this.rtcPusher.removeConnector(""),this.emitter.emit(e.Event.UNPREVIEW_SUCCEED)}},{key:"stopPreview",value:function(e){this.rtcPusher.stopPreview(e)}},{key:"publishStream",value:function(t,r,n,i){var a=this;this.pushDis=0,this.rparam.mediaConf=n,this.rparam.mediaConf.video==v.VIDEO_SOURCE.CAMERA&&this.testResolution({width:n.encodeWidth,height:n.encodeHeight});var o=c.curTimeInMilli();if(t)if((t=t.toString()).length>255)d=g(g.CODE.CHUANG_STREAMID_TOO_LONG),i&&i(d);else if(t.match(/[^\w-]/))d=g(g.CODE.CHUANG_STREAMID_INVALID),i&&i(d);else{if(!document.getElementById(r))return d=g(g.CODE.CHUANG_WEBRTC_DOM_NOT_FOUND,null,{domId:r}),Nt.report(d,Nt.ACTION.PUBLISH,null,this.rparam,t),void(i&&i(d));if(v.ROOM_STATUS.LOGIN!==this.room_status)return d=g(g.CODE.CHUANG_NOT_LOGIN),Nt.report(d,Nt.ACTION.PUBLISH,null,this.rparam,t),void(i&&i(d));if(this.roomusers[t]&&this.roomusers[t].uid!=this.rparam.uid)return d=g(g.CODE.CHUANG_STREAMID_EXIST,null,{sname:t}),Nt.report(d,Nt.ACTION.PUBLISH,null,this.rparam,t),void(i&&i(d));if(n.rtmpAddress.length>=1024)d=g(g.CODE.CHUANG_RTMP_ADDRESS_TOO_LONG),i&&i(d);else{if(0!=n.rtmpAddress.length){var s=c.parseUrl(n.rtmpAddress);if(!s||!s.host||!s.path)return d=g(g.CODE.CHUANG_RTMP_ADDRESS_INVALID),void(i&&i(d))}var u=new He(t,n).setDomId(r);ee.push(n,ee.CODES.REPORT_TYPE_PUBLISH_CONFIG,this.rparam,t,u.streaminConfig.videoWidth,u.streaminConfig.videoHeight),yt.push(yt.VALUES.INIT,yt.CODES.PUBLISH,this.rparam,t),this._push(u,(function(t,r,n){var s=n.exdata,u=s.getStreamId(),d=a;if(null===r){a.isLocalTestResolution||(a.event.timerAdd(e.TimerEvent.LOCAL_STREAM_RESOLUTION,1e3),a.isLocalTestResolution=1);var l=c.curTimeInMilli();a.rparam.pubTotal=l-o;var h=l-a.rparam.pubUdpConEnd,m=a.onpage-a.rparam.reqKeyCost,p={timecost:{servelist:a.rparam.servelist,getconfig:a.rparam.getconfig,messconnect:a.rparam.messconnect,messlogin:a.rparam.messlogin,webrtcsocket:a.rparam.pubwebrtcsocket,webrtcconnect:h,opencamera:a.rparam.opencamera,loadpage:m,messauthpublish:a.rparam.messauthpublish,total:a.rparam.pubTotal}};a.event.timerAdd(e.TimerEvent.FRAMES_ENCODED,1e3,u),yt.push(yt.VALUES.SUCCESS,yt.CODES.PUBLISH,a.rparam,u),ee.push(p,ee.CODES.REPORT_TYPE_PUBLISH_SUCCEED,a.rparam,u,s.streaminConfig.videoWidth,s.streaminConfig.videoHeight),setTimeout((function(){var e=d.getVideoStreamStatus(u);e&&e.packetsSent&&e.packetsSent>0&&ee.push({error:{streamid:u}},ee.CODES.REPORT_TYPE_PUBLISH_VIDEO_FRAME_TIMEOUT,d.rparam,s.streaminConfig.videoHeight,s.streaminConfig.videoHeight)}),1e4),a.publish_status=v.ChuangPublishState.CONNECTED,a.emitter.emit(e.Event.PublishStreamStateUpdate,u,a.publish_status,g.ErrorCode.CHUANG_SUCCESS)}else r&&(yt.push(yt.VALUES.FAILED,yt.CODES.PUBLISH,a.rparam,u,r),Nt.report(r,Nt.ACTION.PUBLISH,null,a.rparam,u),i&&i(r))}))}}else{var d=g(g.CODE.CHUANG_STREAMID_NULL);i&&i(d)}}},{key:"unpublishStream",value:function(t,r){var n=this;if(t=t.toString(),yt.push(yt.VALUES.INIT,yt.CODES.UNPUBLISH,this.rparam,t),!this.rtcPusher.connectorExists(t)){var i=g(g.CODE.CHUANG_INVALID_PARAMETERS,null,{sname:t});return Nt.report(i,Nt.ACTION.UNPUBLISH,null,this.rparam,t),void(r&&r(i))}this._unpush(t,(function(t,i,a){var o=a.exdata,s=o.getStreamId();ee.push("",ee.CODES.REPORT_TYPE_CLOSE_NORMAL,n.rparam,s,o.streaminConfig.videoWidth||0,o.streaminConfig.videoHeight||0),null===i?(yt.push(yt.VALUES.SUCCESS,yt.CODES.UNPUBLISH,n.rparam,s),n.publish_status=v.ChuangPublishState.DISCONNECTED,n.emitter.emit(e.Event.PublishStreamStateUpdate,s,n.publish_status,g.ErrorCode.CHUANG_SUCCESS)):i&&(yt.push(yt.VALUES.FAILED,yt.CODES.UNPUBLISH,n.rparam,s,i),Nt.report(i,Nt.ACTION.UNPUBLISH,null,n.rparam,s),r&&r(i))}))}},{key:"startMixStream",value:function(t,r){var n=this,i=0,a=0;switch(t.outputVideoResolution){case 0:i=800,a=600;break;case 1:i=432,a=768;break;case 2:i=768,a=432;break;case 3:i=1280,a=720;break;case 4:i=720,a=1280;break;default:i=800,a=600}var o=t.outputStremId;if(yt.mix(yt.VALUES.INIT,yt.CODES.MIX,this.rparam,o),ee.mix({rtmp:t.rtmpAddress,width:i,height:a,videobitrate:t.outputVideoBitrate},ee.CODES.REPORT_TYPE_MESS_MERGE_START,this.rparam,o,i,a),!o){var s=g(g.CODE.CHUANG_MIX_STREAMID_NULL);return Nt.report(s,Nt.ACTION.MIX,null,this.rparam),void(r&&r(s))}if(o.length>=256)return s=g(g.CODE.CHUANG_MIX_STREAMID_TOO_LONG),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));if(o.match(/[^\w-]/)&&(s=g(g.CODE.CHUANG_MIX_STREAMID_INVALID),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),r&&r(s)),v.ROOM_STATUS.LOGIN!==this.room_status)return s=g(g.CODE.CHUANG_NOT_LOGIN),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));if(!t.mixStreams||!t.mixStreams.length)return s=g(g.CODE.CHUANG_MIX_STREAM_CONFIG_ERROR,null,{sname:"*"}),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));if(t.mixStreams.length>9)return s=g(g.CODE.CHUANG_MIX_STREAM_TOO_MUCH),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));if(!this.allUsers.length)return s=g(g.CODE.CHUANG_MIX_NO_STREAM),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));if(!t.rtmpAddress)return s=g(g.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID),Nt.report(s,Nt.CODES.MIX,null,this.rparam,o),void(r&&r());if(t.rtmpAddress.length>=1024)return s=g(g.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID),Nt.report(s,Nt.ACTION.MIX,null,this.rparam,o),void(r&&r(s));var c=0;for(t.mixStreams.length;c++;){var u=t.mixStreams[c].videoWidth%16,d=t.mixStreams[c].videoHeight%16;0==u&&0==d||(t.mixStreams[c].videoWidth-=u,t.mixStreams[c].videoHeight-=d)}this.mix_status=v.MIX_STATUS.START,this.mixact.start(v.ACT_PHASE.MIX_START,t,(function(i,a,o){var s=t.outputStremId;null===a?(yt.mix(yt.VALUES.SUCCESS,yt.CODES.MIX,n.rparam,s),n.emitter.emit(e.Event.MixStreamResult,g.ErrorCode.CHUANG_SUCCESS)):a&&(n.mixStreamConfig=null,yt.mix(yt.VALUES.FAILED,yt.CODES.MIX,n.rparam,s,a),Nt.report(a,Nt.ACTION.MIX,null,n.rparam,s),r&&r(a))}))}},{key:"updateMixStream",value:function(e,t){var r=this;if(v.ROOM_STATUS.LOGIN!==this.room_status){var n=g(g.CODE.CHUANG_NOT_LOGIN);return Nt.report(n,Nt.ACTION.MIX,null,this.rparam),void(t&&t(n))}if(this.mix_status!=v.MIX_STATUS.START)return n=g(g.CODE.CHUANG_MIX_NO_STREAM),Nt.report(n,Nt.ACTION.MIX,null,this.rparam),void(t&&t(n));yt.mix(yt.VALUES.INIT,yt.CODES.UPMIX,this.rparam,""),this.mixact.start(v.ACT_PHASE.MIX_UPDATE,e,(function(e,n,i){null==n?(r.mix_status=v.MIX_STATUS.UPDATE,yt.mix(yt.VALUES.SUCCESS,yt.CODES.UPMIX,r.rparam,"")):n&&(yt.mix(yt.VALUES.FAILED,yt.CODES.UPMIX,r.rparam,"",n),Nt.report(n,Nt.ACTION.UPMIX,null,r.rparam,""),t&&t(n))}))}},{key:"stopMixStream",value:function(e){var t=this;yt.mix(yt.VALUES.INIT,yt.CODES.UNMIX,this.rparam,""),ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_STOP,this.rparam,"",0,0),this.mixact.start(v.ACT_PHASE.MIX_STOP,null,(function(r,n,i){t.mixStreamConfig=null,null==n?(Ze.remove(t.mixinact),Ze.remove(t.mixinact),yt.mix(yt.VALUES.SUCCESS,yt.CODES.UNMIX,t.rparam,"")):n&&(yt.mix(yt.VALUES.FAILED,yt.CODES.UNMIX,t.rparam,"",n),Nt.report(n,Nt.ACTION.UNMIX,null,t.rparam),e&&e(n))}))}},{key:"playStream",value:function(t,r,n,i){var a=this;this.pullDis=0,this.rparam.playName="string"==typeof n?n:"";var o=c.curTimeInMilli();if(t)if((t=t.toString()).length>256)u=g(g.CODE.CHUANG_STREAMID_TOO_LONG),i&&i(u);else if(t.match(/[^\w-]/))u=g(g.CODE.CHUANG_STREAMID_INVALID),i&&i(u);else{if(yt.pull(yt.VALUES.INIT,yt.CODES.PULL,this.rparam,t),!document.getElementById(r.domId))return u=g(g.CODE.CHUANG_WEBRTC_DOM_NOT_FOUND,null,{domId:r.domId}),Nt.report(u,Nt.ACTION.PLAY,null,this.rparam,t),void(i&&i(u));if(v.ROOM_STATUS.LOGIN!==this.room_status)return u=g(g.CODE.CHUANG_NOT_LOGIN),Nt.report(u,Nt.ACTION.PLAY,null,this.rparam,t),void(i&&i(u));var s=new He(t,"",r).setDomId(r.domId);this._pull(s,(function(t,r,n){var s=n.exdata,u=s.getStreamId();if(null===r){a.isRemoteTestResolution||(a.event.timerAdd(e.TimerEvent.REMOTE_STREAM_RESOLUTION,1e3),a.isRemoteTestResolution=1);var d=c.curTimeInMilli();a.rparam.pullTotal=d-o;var l=d-a.rparam.pullUdpConEnd,h=a.onpage,m={timecost:{servelist:a.rparam.servelist,getconfig:a.rparam.getconfig,messconnect:a.rparam.messconnect,messlogin:a.rparam.messlogin,webrtcsocket:a.rparam.pullwebrtcsocket,webrtcconnect:l,loadpage:h,messauthpublish:a.rparam.messauthpublish,total:a.rparam.pullTotal}};yt.pull(yt.VALUES.SUCCESS,yt.CODES.PULL,a.rparam,u),ee.push(m,ee.CODES.REPORT_TYPE_PLAY_SUCCEED,a.rparam,u,s.sparam.width,s.sparam.height),a.play_status=v.ChuangPlayState.CONNECTED,a.emitter.emit(e.Event.PlayStreamStateUpdate,u,a.play_status,g.ErrorCode.CHUANG_SUCCESS)}else r&&(yt.pull(yt.VALUES.FAILED,yt.CODES.PULL,a.rparam,u,r),Nt.report(r,Nt.ACTION.PLAY,null,a.rparam,u),i&&i(r))}))}else{var u=g(g.CODE.CHUANG_STREAMID_NULL);i&&i(u)}}},{key:"playRoomStream",value:function(e,t,r,n){}},{key:"unplayRoomStream",value:function(e,t,r){}},{key:"unplayStream",value:function(t,r){var n=this;if(t=t.toString(),yt.pull(yt.VALUES.INIT,yt.CODES.UNPULL,this.rparam,t),this.rtcPuller.connectorExists(t))this._unpull(t,(function(t,i,a){var o=a.exdata,s=o.getStreamId();ee.pull("",ee.CODES.REPORT_TYPE_CLOSE_NORMAL,n.rparam,s,o.sparam.width,o.sparam.height),null===i?(yt.pull(yt.VALUES.SUCCESS,yt.CODES.UNPULL,n.rparam,s),n.play_status=v.ChuangPlayState.DISCONNECTED,n.emitter.emit(e.Event.PlayStreamStateUpdate,s,n.play_status,g.ErrorCode.CHUANG_SUCCESS)):i&&(yt.pull(yt.VALUES.FAILED,yt.CODES.UNPULL,n.rparam,s,i),Nt.report(i,Nt.ACTION.UNPLAY,null,n.rparam,s),r&&r(i))}));else{var i=g(g.CODE.CHUANG_INVALID_PARAMETERS,null,{sname:t});Nt.report(i,Nt.ACTION.UNPLAY,null,this.rparam,t)}}},{key:"getVideoStreamStatus",value:function(e){if(e){e=e.toString();var t=this._getConnector(e);return t?t.getVideoStreamStatus():null}}},{key:"startStreamQualityTest",value:function(){var t=this.rtcPusher.getAllStreamIds(),r=this.rtcPuller.getAllStreamIds();t&&this.event.timerAdd(e.TimerEvent.LOCAL_STREAM_QUALITY,1e3),r&&this.event.timerAdd(e.TimerEvent.REMOTE_STREAM_QUALITY,1e3)}},{key:"stopStreamQualityTest",value:function(){var t=this.rtcPusher.getAllStreamIds(),r=this.rtcPuller.getAllStreamIds();t&&this.event.timerRemove(e.TimerEvent.LOCAL_STREAM_QUALITY,1e3),r&&this.event.timerRemove(e.TimerEvent.REMOTE_STREAM_QUALITY,1e3)}},{key:"stopStreamResolutionTest",value:function(){this.isLocalTestResolution=0,this.isRemoteTestResolution=0,this.event.timerRemove(e.TimerEvent.LOCAL_STREAM_RESOLUTION),this.event.timerRemove(e.TimerEvent.REMOTE_STREAM_RESOLUTION)}},{key:"getStreamStatus",value:function(e){if(e){e=e.toString();var t=this._getConnector(e);return t?t.getStreamStatus():null}}},{key:"getResolution",value:function(e){if(e){e=e.toString();var t=this._getConnector(e);return t?t.getResolution():null}}},{key:"getVolume",value:function(e){if(e){e=e.toString();var t=this._getConnector(e);return t?t.getVolume():null}}},{key:"setSoundLevelMonitorInterval",value:function(e){return e}},{key:"startSoundLevelMonitor",value:function(){this.event.timerAdd(e.TimerEvent.GET_VOLUME,this.setSoundLevelMonitorInterval()||200)}},{key:"stopSoundLevelMonitor",value:function(){this.event.timerRemove(e.TimerEvent.GET_VOLUME)}},{key:"getStreamBitrate",value:function(){streamId=streamId.toString();var e=this._getConnector(streamId);return e?e.getBitrate():null}},{key:"muteAudio",value:function(e,t){e=e.toString();var r=t?yt.CODES.VOLOFF:yt.CODES.VOLON;yt.push(yt.VALUES.INIT,r,this.rparam,e);var n=this._getConnector(e),i=!!n&&(t?n.muteAudio():n.unmuteAudio());return i?yt.push(yt.VALUES.SUCCESS,r,this.rparam,e):yt.push(yt.VALUES.FAILED,r,this.rparam,e,g(g.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR)),i}},{key:"muteVideo",value:function(e,t){e=e.toString();var r=t?yt.CODES.CAMERAOFF:yt.CODES.CAMERAON;yt.push(yt.VALUES.INIT,r,this.rparam,e);var n=this._getConnector(e),i=!!n&&(t?n.mutevideo():n.unmutevideo());return i?yt.push(yt.VALUES.SUCCESS,r,this.rparam,e):yt.push(yt.VALUES.FAILED,r,this.rparam,e,g(g.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR)),i}},{key:"muteRemoteAudio",value:function(e,t){e=e.toString();var r=this.rtcPuller.getPuller(e);r?r.muteAudio(e,t):U.info("muteRemoteAudio failure have no",e)}},{key:"muteRemoteVideo",value:function(e,t){var r=this.rtcPuller.getPuller(e);r?r.muteVideo(e,t):U.info("muteRemoteAudio failure have no",e)}},{key:"sendStreamAttachedMessage",value:function(e,t,r){if(e)if((e=e.toString()).length>255)i=g(g.CODE.CHUANG_STREAMID_TOO_LONG),r&&r(i);else if(e.match(/[^\w-]/))i=g(g.CODE.CHUANG_STREAMID_INVALID),r&&r(i);else if(this.rtcPusher.getPusher(e)){t=t.toString();var n=this._getConnector(e);n&&n.sendStreamAttachedMessage(t)}else i=g(g.CODE.CHUANG_PUBLISH_MESSAGE_BEFORE_PUBLISH),r&&r(i);else{var i=g(g.CODE.CHUANG_STREAMID_NULL);r&&r(i)}}},{key:"resume",value:function(e){e=e.toString();var t=null;(t=this.rtcPuller.getPuller(e))&&(t.ccstream?t.ccstream.resume():this.roomusers[streamIds[i]]?this.roomusers[streamIds[i]].resume():this.lastroomusers[streamIds[i]]?this.lastroomusers[streamIds[i]].resume():U.warning("没有找到该流",e))}},{key:"resumeAll",value:function(){for(var e=this.rtcPuller.getAllStreamIds(),t=null,r=0,n=e.length;r<n;r++)(t=this.rtcPuller.getPuller(e[r])).ccstream?t.ccstream.resume():this.roomusers[e[r]]?this.roomusers[e[r]].resume():this.lastroomusers[e[r]]?this.lastroomusers[e[r]].resume():U.warning("没有找到该流",e[r])}},{key:"onSignalEvent",value:function(t){var r=this;switch(t.type){case be.Event.CONNECT:this.rparam.messconnect=t.data.messConEnd-this.rparam.messConStart;var n=t.data.url;this.rparam.url=n.substring(6,n.length-5),this.roomact.finished(v.ACT_PROC.LOGIN_CONN);break;case be.Event.DISCONNECT:U.warning("room disconnect"),this.rparam.code=1,ee.room({mess:{error:-1}},ee.CODES.REPORT_TYPE_MESS_DISCONNECT,this.rparam),c.curTime(),this.connect_status=v.ChuangRoomState.DISCONNECTED,this.emitsafe(e.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_ROOM_DISCONNECTED_BAD_NETWORK]),this.roomact.isActive()?this.roomact.jump(v.ACT_PHASE.RELOGIN,{}):this.roomact.start(v.ACT_PHASE.RELOGIN,null,(function(t,n){if(null===n){U.info(g.MSG.CHUANG_ROOM_RECONNECTED),r.connect_status=v.ChuangRoomState.CONNECTED,r.emitsafe(e.Event.RoomStateUpdate,[r.rparam.roomId,r.connect_status,g.ErrorCode.CHUANG_ROOM_RECONNECTED]),r.rtcSignal.startReqlist(r.sparam);var i=r.rtcPusher.getAllStreamIds();if(i.length>0)for(var a=0,o=i.length;a<o;a++){var s=r._getPushAct(i[a]),u=r,d=i[a];s.start(v.ACT_PHASE.REPUSH,null,(function(t,r,n){r?U.warning("republish failid:"):(U.info("republish succeed",a),u.publish_status=v.ChuangPublishState.CONNECTED,u.emitter.emit(e.Event.PublishStreamStateUpdate,d,u.publish_status,g.ErrorCode.CHUANG_PUBLISH_STREAM_RECONNECTED))}))}}else c.curTime(),U.warning("reconn failed: ",n),n&&Nt.report(n,Nt.ACTION.LOGIN_RECONN,null,r.rparam,r.ccstream.getStreamId())}));break;case be.Event.LOGINROOM:ee.room({mess:{code:this.rparam.code,msg:this.rparam.loginContent.msg,roomname:this.rparam.roomname_string}},ee.CODES.REPORT_TYPE_MESS_LOGIN_SUCCEED,this.rparam),v.ROOM_STATUS.LOGIN_PROC==this.room_status&&(this.room_status=v.ROOM_STATUS.LOGIN)," banned_by_app"==this.rparam.loginContent.msg&&ee.room({mess:{code:this.rparam.code,msg:this.rparam.loginContent.msg}},ee.CODES.REPORT_TYPE_MESS_BANNED_BY_APP,this.rparam),this.roomact.finished(v.ACT_PROC.SIG_LOGIN);break;case be.Event.LOGINFAIL:ee.room({mess:{code:this.rparam.errcode,msg:this.rparam.loginContent.msg,roomname:this.rparam.roomname_string}},ee.CODES.REPORT_TYPE_MESS_LOGIN_FAILED,this.rparam),this.connect_status=v.ChuangRoomState.DISCONNECTED,"-201"==this.rparam.errcode?(this.roomact.failed(v.ACT_PROC.SIG_LOGIN,g(g.CODE.CHUANG_LOGIN_FAILED_APPID,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_LOGIN_FAILED_APPID)):"-312"==this.rparam.errcode?(this.roomact.failed(v.ACT_PROC.SIG_LOGIN,g(g.CODE.CHUANG_LOGIN_FAILED_BANNED,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_LOGIN_FAILED_BANNED)):"-202"==this.rparam.errcode?(this.roomact.failed(v.ACT_PROC.SIG_LOGIN,g(g.CODE.CHUANG_LOGIN_FAILED_PARAM_ERROR,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_LOGIN_FAILED_PARAM_ERROR)):(this.roomact.failed(v.ACT_PROC.SIG_LOGIN,g(g.CODE.CHUANG_LOGIN_FAILED,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_LOGIN_FAILED));break;case be.Event.LOGOUTROOM:this.roomact.finished(v.ACT_PROC.LOGOUT);break;case be.Event.USERLIST:var i=t.data;this.onUserlist(i),this.allUsers=i.list;break;case be.Event.SET_WATCHINFO:t.streamId=this.swiStreamId,this.onSignalStreamEvent(t),this.swiStreamId=null;break;case be.Event.REQMERGE:var a=(o=!t.data.errcode)?null:t.data.errcode;o||"101"==a?(this.mixinact.finished(v.ACT_PROC.SIG_REQMERGE),this.event.timerAdd(e.TimerEvent.MIX_REQMERGESTAT,3e4)):"100"==a?(ee.mix("",ee.CODES.MESS_MERGE_CB_INVALID_PARAMETERS_FROM_SERVER,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY)):"213"==a?(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_FAILED_ERROR_RESOLUTION,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.failed(v.ACT_PROC.SIG_REQMERGE,g(g.CODE.CHUANG_MIX_STREAM_TOO_MUCH))):"102"==a?this.mixinact.failed(v.ACT_PROC.SIG_REQMERGE,g(g.CODE.CHUANG_MIX_STREAM_TOO_MUCH)):this.mixinact.failed(v.ACT_PROC.SIG_REQMERGE,g(g.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR));break;case be.Event.REQMERGESTAT:a=(o=!t.data.errcode)?null:t.data.errcode;var o,s=this.mi_lastCerrcode=t.data.error;if(o){var u=this.mi_lastCCount,d=this.mi_lastCCount=t.data.connect_count;0==u&&0==d?this.mixinact.finished(v.ACT_PROC.SIG_REQMERGESTAT,1e3):0==u&&0!=d?(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_SUCCESS,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.event.timerRemove(e.TimerEvent.MIX_REQMERGESTAT),this.mixact.finished(v.ACT_PROC.MIX_STARTIN),this.mixinact.finished(v.ACT_PROC.SIG_REQMERGESTAT,1e4)):0!=u&&0==d?(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ERROR,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY)):this.mixinact.finished(v.ACT_PROC.SIG_REQMERGESTAT,1e4)}else"900"==a?(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY)):"999"==d?this.mixinact.finished(v.ACT_PROC.SIG_REQMERGESTAT,15e3):0==s=="999"?(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY)):(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),U.warning("req merge errcode: "+a),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY));break;case be.Event.STOPMERGE:this.mixact.finished(v.ACT_PROC.MIX_STOPIN),this.mixinact.finished(v.ACT_PROC.SIG_STOPMERGE),this.event.timerRemove(e.TimerEvent.MIX_REQMERGESTAT)}}},{key:"onSignalStreamEvent",value:function(e){var t=e.streamId,r=!e.data.errcode,n=r?null:e.data.errcode,i=null;switch(e.type){case be.Event.AUTH_PUBLISH:i=this._getPushAct(t);var a=e.data.roomid;if(sr==this.rparam.roomid&&0!=a&&(this.rparam.roomid=a.toString()),(c=i.exdata).roomid=a.toString(),r){var o={mess:{roomname:this.rparam.roomname_string,streamname:t,roomid:this.rparam.roomid,status:e.data.status}};ee.push(o,ee.CODES.REPORT_TYPE_MESS_AUTH_PUBLISH_SUCCEED,this.rparam,t,c.streaminConfig.videoWidth,c.streaminConfig.videoHeight),i.finished(v.ACT_PROC.SIG_AUTH_PUB),U.info("auth finished")}else{U.warning("signal start Publish failed to unauthpublish",e.data.errcode+e.data.status);var s={mess:{roomname:this.rparam.roomname_string,streamname:t,roomid:this.rparam.roomid,status:e.data.status,errcode:e.data.errcode}};ee.push(s,ee.CODES.REPORT_TYPE_MESS_AUTH_PUBLISH_FAILED,this.rparam,t,c.streaminConfig.videoWidth||0,c.streaminConfig.videoHeight||0),i.failed(v.ACT_PROC.SIG_AUTH_PUB,g(g.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"ap",errcode:n}))}break;case be.Event.START_PUBLISH:var c=(i=this._getPushAct(t)).exdata;r?i.finished(v.ACT_PROC.SIG_START_PUB):(U.warning("signal start Publish failed to unpublish",e.data.errcode+e.data.status),ee.push({error:{streamid:t}},ee.CODES.REPORT_TYPE_MESS_START_PUBLISH_FAILED,this.rparam,t,c.streaminConfig.videoWidth||0,c.streaminConfig.videoHeight||0),i.jump(v.ACT_PHASE.SIG_START_PUB_FAIL,n));break;case be.Event.SET_WATCHINFO:i=this._getPushAct(t),r?(this.watchInfoFlag=!0,i.finished(v.ACT_PROC.SIG_SET_WATCH_INFO)):i.failed(v.ACT_PROC.SIG_SET_WATCH_INFO,g(g.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"swi",errcode:n}));break;case be.Event.STOP_PUBLISH:i=this._getPushAct(t),r?i.finished(v.ACT_PROC.SIG_STOP_PUB):i.failed(v.ACT_PROC.SIG_STOP_PUB,g(g.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"np",errcode:n}));break;case be.Event.START_PLAY:i=this._getPullAct(t),r?i.finished(v.ACT_PROC.SIG_START_PULL):i.failed(v.ACT_PROC.SIG_START_PULL,g(g.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"sw",errcode:n}));break;case be.Event.STOP_PLAY:i=this._getPullAct(t),r?i.finished(v.ACT_PROC.SIG_STOP_PULL):i.failed(v.ACT_PROC.SIG_STOP_PULL,g(g.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"nw",errcode:n}))}}},{key:"onStreamEvent",value:function(t){var r=t.streamId,n=t.data;switch(t.type){case He.Event.POOL_STAT:var i=t.data;i.streamId=r;var a=this.rtcPusher.getPusher(r),o=this.rtcPuller.getPusher(r);if(a)(s=a.getStreamParam()).streamstatus=i,a.getStream().setSparam(s);else if(o){var s;(s=o.ccstream.sparam).streamstatus=i,o.ccstream.setSparam(s)}this.emitter.emit(e.Event.STREAM_NETSTAT,i);break;case He.Event.VIDEO_REVOKE:var c=n;ee.room({errcode:123,msg:c},ee.CODES.REPORT_TYPE_PUBLISH_DISCONNECTED,this.rparam),this.emitter.emit(e.Event.STREAM_VIDEO_REVOKED,{streamId:r,reason:c});break;case He.Event.AUDIO_REVOKE:c=n,ee.room({errcode:123,msg:c},ee.CODES.REPORT_TYPE_PUBLISH_DISCONNECTED,this.rparam),this.emitter.emit(e.Event.STREAM_AUDIO_REVOKED,{streamId:r,reason:c});break;case He.Event.ON_STREAM:n.attachStream();break;case He.Event.ON_STARTPLAY:n.play();break;case He.Event.VIDEO_INITIALIZE:var u=v.ChuangPlayStreamEvent.VIDEO_INITIALIZE;this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.AUDIO_INITIALIZE:u=v.ChuangPlayStreamEvent.AUDIO_INITIALIZE,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.AUDIO_MUTE:var d=v.ChuangStreamState.AUDIO_MUTE;this.emitter.emit(e.Event.PlayStreamStateChanged,r,d);break;case He.Event.AUDIO_UNMUTE:d=v.ChuangStreamState.AUDIO_UNMUTE,this.emitter.emit(e.Event.PlayStreamStateChanged,r,d);break;case He.Event.VIDEO_MUTE:d=v.ChuangStreamState.VIDEO_MUTE,this.emitter.emit(e.Event.PlayStreamStateChanged,r,d);break;case He.Event.VIDEO_UNMUTE:d=v.ChuangStreamState.VIDEO_UNMUTE,this.emitter.emit(e.Event.PlayStreamStateChanged,r,d);break;case He.Event.VIDEO_RECEIVE_FIRST_FRAME:u=v.ChuangPlayStreamEvent.VIDEO_RECEIVE_FIRST_FRAME,this.emitsafe(e.PlayStreamFirstVideo,r),this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.AUDIO_RECEIVE_FIRST_FRAME:u=v.ChuangPlayStreamEvent.AUDIO_RECEIVE_FIRST_FRAME,this.emitsafe(e.PlayStreamFirstAudio,r),this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.VIDEO_STUCK:u=v.ChuangPlayStreamEvent.VIDEO_STUCK,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.AUDIO_STUCK:u=v.ChuangPlayStreamEvent.AUDIO_STUCK,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case B.Event.NOT_AUTO_PLAY:U.warning("Stream autoplay failed. streamId: "+r),this.emitter.emit(e.Event.STREAM_NOT_AUTOPLAY,r);break;case He.Event.PUBLISH_CONNECTING:this.publish_status=v.ChuangPublishState.CONNECTING,this.emitter.emit(e.Event.PublishStreamStateUpdate,r,this.publish_status,n.errCode);break;case He.Event.PUBLISH_CONNECTED:this.publish_status=v.ChuangPublishState.CONNECTED,this.pushDis&&this.emitter.emit(e.Event.PublishStreamStateUpdate,r,this.publish_status,n.errCode);break;case He.Event.PLAY_CONNECTING:this.play_status=v.ChuangPlayState.CONNECTING,this.emitter.emit(e.Event.PlayStreamStateUpdate,r,this.play_status,n.errCode);break;case He.Event.PLAY_CONNECTED:this.play_status=v.ChuangPlayState.CONNECTED,this.pullDis&&this.emitter.emit(e.Event.PlayStreamStateUpdate,r,this.play_status,n.errCode);break;case He.Event.AUDIO_DISCONNECTED:u=v.ChuangPlayStreamEvent.AUDIO_DISCONNECTED,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.VIDEO_DISCONNECTED:u=v.ChuangPlayStreamEvent.VIDEO_DISCONNECTED,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.AUDIO_DECODING:u=v.ChuangPlayStreamEvent.AUDIO_DECODING,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.VIDEO_DECODING:u=v.ChuangPlayStreamEvent.VIDEO_DECODING,this.emitter.emit(e.Event.PlayStreamEvent,r,u);break;case He.Event.RECEIVE_STREAM_ATTACHED_MESSAGE:this.emitter.emit(e.Event.ReceiveStreamAttchedMessage,t.data.msg)}}},{key:"onResourceEvent",value:function(t){switch(t.type){case Ot.Event.TOKEN_RESULT:this.rparam.appid=t.data.appKey,this.dpservact.finished(v.ACT_PROC.TOKEN);break;case Ot.Event.TOKEN_NET_FAIL:this.connect_status=v.ChuangRoomState.DISCONNECTED,this.emitsafe(e.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_TOKEN_AUTH_ERROR]),this.dpservact.finished(v.ACT_PROC.TOKEN,v.ACT_NET_FAIL);break;case Ot.Event.TOKEN_FAIL:this.dpservact.failed(v.ACT_PROC.TOKEN,t.data);break;case Ot.Event.KEY_RESULT:this.rparam.appkey=t.data.res,this.rparam.reqKeyCost=t.data.cost-this.rparam.reqKeystart,this.dpservact.finished(v.ACT_PROC.KEY);break;case Ot.Event.KEY_NET_FAIL:this.dpservact.finished(v.ACT_PROC.KEY,v.ACT_NET_FAIL);break;case Ot.Event.KEY_FAIL:this.dpservact.failed(v.ACT_PROC.KEY,t.data);break;case Ot.Event.UID_RESULT:this.rparam.uid=t.data,this.dpservact.finished(v.ACT_PROC.UID);break;case Ot.Event.UID_NET_FAIL:this.dpservact.finished(v.ACT_PROC.UID,v.ACT_NET_FAIL);break;case Ot.Event.UID_FAIL:this.dpservact.failed(v.ACT_PROC.UID,t.data);break;case Ot.Event.DP_RESULT:this.rparam.servelist=t.data.content.cost,this.dpEmpty=!1,R.FOLLOWServer=t.data.resp[v.DPKEYS.PUBLISH],this.dpservact.finished(v.ACT_PROC.DP,t.data.resp),ee.room(t.data.content,ee.CODES.REPORT_TYPE_GET_SERVER_LIST_SUCCEED,this.rparam);break;case Ot.Event.DP_EMPTY:if(this.dpEmpty)return void this.dpservact.failed(v.ACT_PROC.DP,g(g.CODE.CHUANG_LOGIN_FAILED));this.dpEmpty=!0,this.dpservact.jump(v.ACT_PHASE.LOAD_DP);break;case Ot.Event.DP_NET_FAIL:this.dpservact.finished(v.ACT_PROC.DP,v.ACT_NET_FAIL);break;case Ot.Event.DP_FAIL:this.dpservact.failed(v.ACT_PROC.DP,t.data);break;case Ot.Event.CONFIG_RESULT:this.rparam.getconfig=t.data.cost,ee.room(t.data,ee.CODES.REPORT_TYPE_GET_CONFIG_SUCCEED,this.rparam),this.dpservact.finished(v.ACT_PROC.LOAD_CONFIG);break;case Ot.Event.CONFIG_FAIL:ee.room(t.data,ee.CODES.REPORT_TYPE_GET_CONFIG_FAILED,this.rparam),this.dpservact.failed(v.ACT_PROC.LOAD_CONFIG)}}},{key:"onAppEvent",value:function(e){switch(e.type){case kr.Event.NET_TYPE:this.emitter.emit(kr.Event.NetworkTypeChanged,e.data)}}},{key:"onTimer",value:function(t){var r=this;switch(t.type){case e.TimerEvent.PUSH_HEARTBEAT:var n=t.data,i=this.rtcPusher.getPusher(n.streamId),a=i&&i.getDuration()||Math.ceil((Date.now()-this.startTime)/1e3);this.rtcSignal.sendStreamHeartBeat(n.streamId,a);break;case e.TimerEvent.MIX_REQMERGESTAT:ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ZERO,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(v.ACT_PHASE.MIXIN_RESTART_DELAY);break;case e.TimerEvent.SIGNAL_CONNECT:ee.room("",ee.CODES.REPORT_TYPE_MESS_CONNECT_PROCESS_TIMEOUT,this.rparam);break;case e.TimerEvent.FRAMES_ENCODED:var o=this.getVideoStreamStatus(t.data),s=o&&1e3*o.totalEncodeTime/o.framesEncoded;s>=33.3&&ee.push({timecost:s},ee.CODES.REPORT_TYPE_VIDEO_ENCODE_TIME_TOO_LONG,this.rparam,t.data,0,0),this.event.timerRemove(e.TimerEvent.FRAMES_ENCODED);break;case e.TimerEvent.GET_VOLUME:var c=this.rtcPusher.getAllStreamIds(),u=this.rtcPuller.getAllStreamIds();c.forEach((function(t){var n=r.getVolume(t);if(n!=r.preSound){var i={streamId:t,val:!!n,soundLevel:n};r.emitter.emit(e.Event.CaptureSoundLevelUpdate,i)}r.preSound=n})),u.forEach((function(t){var n=r.getVolume(t);if(n!=r.preSound){var i={streamId:t,val:!!n,soundLevel:n};r.emitter.emit(e.Event.RemoteSoundLevelUpdate,i)}r.preSound=n}));break;case e.TimerEvent.LOCAL_STREAM_QUALITY:(c=this.rtcPusher.getAllStreamIds()).forEach((function(t){var n=r.rtcPusher.getPusher(t).getStream();if(n&&n.sparam&&n.sparam.streamstatus){var i=n.sparam.streamstatus,a=r.getStreamStatus(t),o={};(a.videosendinfo&&a.videosendinfo.packetsSent||a.audiosendinfo&&a.audiosendinfo.packetsSent)&&(o.videoFps=a.videosendinfo.framesPerSecond,o.videoBirateKpbs=a.videosendinfo.kbitsPerSecond,o.audioBirateKbps=a.audiosendinfo.kbitsPerSecond,o.packetLostRate=i&&i.loss&&void 0!==i.loss?i.loss:0,o.rtt=i&&i.rtt&&void 0!==i.rtt?i.rtt:0,o.uploadSpeed=a.bytesSent-n.sparam.bytes.sent,o.downloadSpeed=a.bytesReceived-n.sparam.bytes.rev,o.uploadBytes=a.bytesSent||0,o.downloadBytes=a.bytesReceived||0,n.sparam.bytes.sent=a.bytesSent,n.sparam.bytes.rev=a.bytesReceived),o&&r.emitter.emit(e.Event.PublishStreamQualityUpdate,t,o)}}));break;case e.TimerEvent.REMOTE_STREAM_QUALITY:(u=this.rtcPuller.getAllStreamIds()).forEach((function(t){var n=r.rtcPuller.connectors[t],i=n.ccstream;if(i&&i.sparam&&i.sparam.streamstatus){var a=i.sparam,o=r.getStreamStatus(t),s={};(o.videorecvinfo&&o.videorecvinfo.packetsReceived||o.audiorecvinfo&&o.audiorecvinfo.packetsReceived)&&(s.videoFps=o.videorecvinfo.framesPerSecond,s.videoBirateKpbs=o.videorecvinfo.kbitsPerSecond,s.audioBirateKbps=o.audiorecvinfo.kbitsPerSecond,s.packetLostRate=a&&a.loss&&void 0!==a.loss?a.loss:0,s.rtt=a&&a.rtt&&void 0!==a.rtt?a.rtt:0,s.uploadSpeed=o.bytesSent-n.ccstream.bytesSent,s.downloadSpeed=o.bytesReceived-n.ccstream.bytesReceived,s.uploadBytes=o.bytesSent||0,s.downloadBytes=o.bytesReceived||0,n.ccstream.bytesSent=o.bytesSent,n.ccstream.bytesReceived=o.bytesReceived),s&&r.emitter.emit(e.Event.PlayStreamQualityUpdate,t,s)}}));break;case e.TimerEvent.LOCAL_STREAM_RESOLUTION:(c=this.rtcPusher.getAllStreamIds()).forEach((function(t){var n=r.rtcPusher.getPusher(t).getStream(),i=n.width,a=n.height,o=r.getResolution(t);(o&&void 0!==o.width&&i!=o.width||o&&void 0!==o.height&&a!=o.height)&&(r.emitter.emit(e.Event.PublishStreamVideoSizeChanged,t,o.width,o.height),n.width=o.width,n.height=o.height),o&&void 0!==o.width&&i>o.width&&o&&void 0!==o.height&&a>o.height?ee.push({resolution:{from:i.toString()+a.toString(),to:o.width.toString()+o.height.toString()}},ee.CODES.REPORT_TYPE_PUBLISH_RESOLUTION_DOWN,r.rparam,t):o&&void 0!==o.width&&i<o.width&&o&&void 0!==o.height&&a<o.height&&ee.push({resolution:{from:i.toString()+a.toString(),to:o.width.toString()+o.height.toString()}},ee.CODES.REPORT_TYPE_PUBLISH_RESOLUTION_UP,r.rparam,t)}));break;case e.TimerEvent.REMOTE_STREAM_RESOLUTION:(u=this.rtcPuller.getAllStreamIds()).forEach((function(t){var n=r.rtcPuller.connectors[t].ccstream,i=n.width,a=n.height,o=r.getResolution(t);(o&&void 0!==o.width&&i!=o.width||o&&void 0!==o.height&&a!=o.height)&&(r.emitter.emit(e.Event.PlayStreamVideoSizeChanged,t,o.width,o.height),n.width=o.width,n.height=o.height)}))}}},{key:dr,value:function(e,t){var r="pushx-"+e.getStreamId()+"-"+this.rparam.innerid,n=Ze.find(r);n||(n=Ze.create(r,r)).bindData(e).defMachine(Ar).defProcess(Or).record(),n.bind(this),n.start(v.ACT_PHASE.PUSH,null,(function(e,r,n){r&&Ze.remove(n.uid),t(e,r,n)}))}},{key:lr,value:function(e,t){this._getPushAct(e).start(v.ACT_PHASE.UNPUSH,null,(function(e,r,n){Ze.remove(n.uid),t(e,r,n)}))}},{key:hr,value:function(e,t){var r="pullx-"+e.getStreamId()+"-"+this.rparam.innerid,n=Ze.find(r);n||(n=Ze.create(r,r)).bindData(e).defMachine(Ir).defProcess(Pr),n.bind(this),n.start(v.ACT_PHASE.PULL,e,(function(e,r,n){r&&Ze.remove(n.uid),t(e,r,n)}))}},{key:mr,value:function(e,t){U.info("get unpull act",e);var r=this._getPullAct(e);U.info("start unpull act"),r.start(v.ACT_PHASE.UNPULL,null,(function(e,r,n){Ze.remove(n.uid),t(e,r,n)}))}},{key:pr,value:function(e){var t="pushx-"+e+"-"+this.rparam.innerid;return Ze.find(t)||Ze.dummy}},{key:fr,value:function(e){var t="pullx-"+e+"-"+this.rparam.innerid;return Ze.find(t)||Ze.dummy}},{key:vr,value:function(e){var t,r;return(r=this.rtcPuller.getPuller(e))?r:(t=this.rtcPusher.getPusher(e))?t:null}},{key:_r,value:function(){for(var e=this.mixStreamConfig.mixStreams,t=[],r=[],n=0,i=0,a=e.length;i<a;i++){var o=function(){var e=0,t=0,r=u.width/u.height,n=(u.dstRect.right-u.dstRect.left)/(u.dstRect.bottom-u.dstRect.top);return r/n>1?(e=u.height,t=u.height*n):(t=u.width,e=1*u.width/n),u.srcRect={left:(parseInt(u.width)/2-parseInt(t/2)).toString(),top:(parseInt(u.height)/2-parseInt(e/2)).toString(),right:(parseInt(u.width)/2+parseInt(t/2)).toString(),bottom:(parseInt(u.height)/2+parseInt(e/2)).toString()}},s=e[i].streamId,u={srcRect:{},dstRect:{}};u.mixa=R.Mix_Stream_Mixa,u.zlevel=n.toString();var d=this.rtcPusher.getPusher(s);if(d){var l=c.parseUrl(d.wssUrl),h=d.getStream();if(!l){ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_FAILED_INVALID_PUBLISH_ADDRESS,this.rparam,s,h.getStreamConfig().videoWidth.toString()||0,h.getStreamConfig().videoHeight.toString()||0);continue}u.pushaddr=l.host,u.pushport=l.port.toString(),u.uid=this.rparam.uid,u.roomid=h.getroomid(),u.width=h.getStreamConfig().videoWidth.toString(),u.height=h.getStreamConfig().videoHeight.toString(),u.mixv=h.streaminConfig.mixv,u.dstRect={left:(n>4?160*(n-5):160*n).toString(),right:n>4?(160*(n-4)).toString():(160*(n+1)).toString(),top:n>4?"130":"0",bottom:n>4?"250":"120"},u.srcRect=o(),t.push(u)}else{var m=this.roomusers[s];if(!m)continue;u.pushaddr=m.pushaddr,u.pushport=m.pushport,u.roomid=m.roomid,u.uid=m.uid,u.width=m.width.toString(),u.height=m.height.toString(),u.mixv=m.mixv,u.dstRect={left:(n>4?160*(n-5):160*n).toString(),right:n>4?(160*(n-4)).toString():(160*(n+1)).toString(),top:n>4?"130":"0",bottom:n>4?"250":"120"},u.srcRect=o(),r.push(u)}n++}return 0==t.length?void 0:t.concat(r)}},{key:"testResolution",value:function(t){var r=this,n={audio:!1,video:{width:{exact:t.width},height:{exact:t.height}}};setTimeout((function(){navigator.mediaDevices.getUserMedia(n).then((function(e){U.info("分辨率设置成功 "+t.width+"x"+t.height),e.getTracks()[0].stop()})).catch((function(n){U.warning("摄像头不支持设置的分辨率，webrtc已根据分辨率进行自动调整"),r.emitter.emit(e.Event.TEST_RESOLUTION,t)}))}),window.stream?200:0)}}])&&ar(t.prototype,r),n&&ar(t,n),e}();Er.TimerEvent={PUSH_HEARTBEAT:"push-hb",MIX_REQMERGESTAT:"mix-reqmer",FRAMES_ENCODED:"frames-encoded",SIGNAL_CONNECT:"signal-connect",GET_VOLUME:"get-volume",LOCAL_STREAM_QUALITY:"local-stream-quality",REMOTE_STREAM_QUALITY:"remote-stream-quality",LOCAL_STREAM_RESOLUTION:"local-stream-resolution",REMOTE_STREAM_RESOLUTION:"remote-stream-resolution"},Er.Event={RoomStateUpdate:"RoomStateUpdate",RoomStreamUpdate:"RoomStreamUpdate",MixStreamResult:"MixStreamResult",STREAM_AUDIO_REVOKED:"stream-Audio-revoked",STREAM_VIDEO_REVOKED:"stream-video-revoked",STREAM_NOT_AUTOPLAY:"stream-not-autoplay",STREAM_NETSTAT:"stream-netstat",PublishStreamQualityUpdate:"PublishStreamQualityUpdate",PlayStreamQualityUpdate:"PlayStreamQualityUpdate",PublishStreamVideoSizeChanged:"PublishStreamVideoSizeChanged",PlayStreamVideoSizeChanged:"PlayStreamVideoSizeChanged",PlayStreamStateChanged:"PlayStreamStateChanged",CaptureSoundLevelUpdate:"CaptureSoundLevelUpdate",RemoteSoundLevelUpdate:"RemoteSoundLevelUpdate",PublishStreamStateUpdate:"PublishStreamStateUpdate",PlayStreamStateUpdate:"PlayStreamStateUpdate",SDK_ERROR:"sdk-error",PlayStreamEvent:"PlayStreamEvent",PlayStreamFirstAudio:"PlayStreamFirstAudio",PlayStreamFirstVideo:"PlayStreamFirstVideo",ReceiveStreamAttchedMessage:"ReceiveStreamAttchedMessage",NetworkTypeChanged:"NetworkTypeChanged",PREVIEW_SUCCEED:"preview-succeed",UNPREVIEW_SUCCEED:"unpreview-succeed",TEST_RESOLUTION:"test-resolution"};const Sr=Er;function Cr(e,t){switch(e){case v.ACT_PHASE.LOGIN:if(v.ROOM_STATUS.LOGIN===this.room_status||v.ROOM_STATUS.LOGIN_PROC===this.room_status)return Ze.SKIP;var r=t[0],n=t[1],i=t[2];return r=r.toString(),n=n.toString(),this.rparam.appid&&this.rparam.uid_string==n||(this.rtcSignal.clearServers(),this.rtcPusher.clearServers(),this.rtcPuller.clearServers(),this.rparam.uid=""),this.rparam.appid&&(this.rparam.roomname=rr.roomnameFilter(r,this.rparam.appid)),this.rparam.roomname_string=r,this.rparam.uid_string=n,this.rparam.nickname=n,this.rparam.act=i.toString(),this.rparam.expass=n,this.rparam.roomid=sr,this.watchInfoFlag=!1,v.ACT_PHASE.LOGIN_CONN;case v.ACT_PHASE.RELOGIN:return v.ACT_PHASE.LOGIN_CONN;case v.ACT_PHASE.LOGIN_CONN:var a=null;return this.rtcSignal.getCurServer()?(this.roomact.process(v.ACT_PROC.LOGIN_CONN,null),v.ACT_PHASE.SIG_LOGIN):(a=t[v.ACT_PROC.LOAD_DP])?(this.roomact.process(v.ACT_PROC.LOGIN_CONN,a),v.ACT_PHASE.SIG_LOGIN):(this.roomact.process(v.ACT_PROC.LOAD_DP),v.ACT_PHASE.LOGIN_CONN);case v.ACT_PHASE.SIG_LOGIN:return this.roomact.process(v.ACT_PROC.SIG_LOGIN,null,null,R.Signal_login_Timeout),Ze.DONE;case Ze.$.UN+v.ACT_PHASE.LOGIN:case Ze.$.UN+v.ACT_PHASE.RELOGIN:return Ze.DONE;case v.ACT_PHASE.LOGOUT:return v.ROOM_STATUS.PRELOGIN===this.room_status||v.ROOM_STATUS.LOGOUT_PROC===this.room_status?Ze.DONE:(this.room_status=v.ROOM_STATUS.LOGOUT_PROC,this.dpservact.stop(),v.ACT_PHASE.LOGOUT_STREAMS);case v.ACT_PHASE.LOGOUT_STREAMS:return this.roomact.process(v.ACT_PROC.LOGOUT_STREAMS),v.ACT_PHASE.LOGOUT_LOGOUT;case v.ACT_PHASE.LOGOUT_LOGOUT:return this.roomact.process(v.ACT_PROC.LOGOUT,null,null,R.Signal_logout_Timeout),Ze.DONE;case Ze.$.FIN+v.ACT_PHASE.LOGOUT_LOGOUT:return this.rtcSignal.close(),Ze.NULL}}function Tr(e,t){var r=this;switch(e){case v.ACT_PROC.LOGIN_CONN:this.rparam.loginConnStart=c.curTimeInMilli(),this.room_status=v.ROOM_STATUS.LOGIN_PROC,this.rparam.messConStart=c.curTimeInMilli(),this.rtcSignal.connect(t),this.event.timerAdd(Er.TimerEvent.SIGNAL_CONNECT,1e4);break;case v.ACT_PROC.SIG_LOGIN:this.rparam.loginConnEnd=c.curTimeInMilli(),this.event.timerRemove(Er.TimerEvent.SIGNAL_CONNECT),this.rtcSignal.sendLogin();break;case Ze.$.TO+v.ACT_PROC.SIG_LOGIN:ee.room({mess:{command:1024}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),this.roomact.repeat(v.ACT_PROC.SIG_LOGIN);break;case v.ACT_PROC.LOAD_DP:this.dpservact.start(v.ACT_PHASE.LOAD,null,(function(e,t){if(null===t){var n=null;null!=(n=e[v.DPKEYS.PUBLISH])&&r.rtcPusher.setServers(n),null!=(n=e[v.DPKEYS.WATCH])&&r.rtcPuller.setServers(n),null!=(n=e[v.DPKEYS.MESSAGE])&&r.roomact.finished(v.ACT_PROC.LOAD_DP,n)}else r.roomact.failed(v.ACT_PROC.LOAD_DP,t)}));break;case v.ACT_PROC.LOGOUT_STREAMS:U.info("start logout streams");var n,i,a,o,s=this.rtcPusher.getAllStreamIds(),u=this.rtcPuller.getAllStreamIds(),d=this,l=function(e,t,r){var n,i=r.exdata.getStreamId();U.info("unpull or unpush succeed",i),(n=s.indexOf(i))>=0&&s.splice(n,1),(n=u.indexOf(i))>=0&&u.splice(n,1),U.info("logout prepare to finish have streams",s.length,u.length),0==s.length&&0==u.length&&d.roomact.finished(v.ACT_PROC.LOGOUT_STREAMS)};for(i=0,o=s.length;i<o;i++)n=s[i],U.info("unpush",n),this._unpush(n,l);for(a=0,o=u.length;a<o;a++)n=u[a],U.info("unpull",n),this._unpull(n,l);0==i&&0==a&&(U.info("logout prepare to finish have no streams",i,a),this.roomact.finished(v.ACT_PROC.LOGOUT_STREAMS));break;case Ze.$.FIN+v.ACT_PROC.LOGOUT_STREAMS:this.onUserlist([]),this.roomusers={};break;case v.ACT_PROC.LOGOUT:this.rtcSignal.sendLogout();break;case Ze.$.TO+v.ACT_PROC.LOGOUT:ee.room({mess:{command:128}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),U.warning(this.rparam.innerid+" logout timeout."),this.roomact.finished(v.ACT_PROC.LOGOUT)}}function gr(e,t,r){var n=v.ACT_FLOW.PRE_LOAD==Ze.getFlow(r);switch(this.rparam.reqKeystart=c.curTimeInMilli(),e){case v.ACT_PHASE.LOAD:return v.ACT_PHASE.LOAD_TOKEN;case v.ACT_PHASE.LOAD_TOKEN:return this.rparam.appid||this.dpservact.process(v.ACT_PROC.TOKEN),v.ACT_PHASE.LOAD_KEY_N_UID;case v.ACT_PHASE.LOAD_KEY_N_UID:return this.rparam.appid?(n||(this.rparam.roomname=rr.roomnameFilter(this.rparam.roomname_string,this.rparam.appid),""===this.rparam.uid&&this.dpservact.process(v.ACT_PROC.UID,this.rparam.uid_string)),this.rparam.appkey||this.dpservact.process(v.ACT_PROC.KEY),v.ACT_PHASE.LOAD_DP):v.ACT_PHASE.LOAD_TOKEN;case v.ACT_PHASE.LOAD_CONFIG:return n||this.dpservact.process(v.ACT_PROC.LOAD_CONFIG),Ze.DONE;case v.ACT_PHASE.LOAD_DP:if(!n){if(!this.rparam.appkey||""===this.rparam.uid)return v.ACT_PHASE.LOAD_KEY_N_UID;this.dpservact.process(v.ACT_PROC.DP,this.rparam.uid)}return Ze.DONE;case Ze.$.FIN+v.ACT_PHASE.LOAD_DP:return delete t[v.ACT_PROC.DP_RETRY],Ze.NULL;case Ze.$.UN+v.ACT_PHASE.LOAD:return this.tokenLoader.close(),this.dpLoader.close(),this.uidLoader.close(),this.keyLoader.close(),Ze.DONE}}function Rr(e,t,r){switch(e){case v.ACT_PROC.TOKEN:this.tokenLoader.load(this.rparam.roomtoken);break;case Ze.$.FIN+v.ACT_PROC.TOKEN:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.TOKEN_RETRY,null,null,R.Room_tk_Timeout);break;case v.ACT_PROC.TOKEN_RETRY:break;case Ze.$.TO+v.ACT_PROC.TOKEN_RETRY:this.connect_status=v.ChuangRoomState.DISCONNECTED,U.warning(g.MSG.CHUANG_TOKEN_AUTH_FAILED),this.emitsafe(Er.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,g.ErrorCode.CHUANG_TOKEN_AUTH_FAILED]),r.process(v.ACT_PROC.TOKEN),r.finished(v.ACT_PROC.TOKEN_RETRY);break;case v.ACT_PROC.UID:var n=t;this.uidLoader.load(this.rparam.appid,n);break;case Ze.$.FIN+v.ACT_PROC.UID:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.UID_RETRY,null,null,R.Room_uid_Timeout);break;case v.ACT_PROC.UID_RETRY:break;case Ze.$.TO+v.ACT_PROC.UID_RETRY:r.process(v.ACT_PROC.UID,this.rparam.uid_string),r.finished(v.ACT_PROC.UID_RETRY);break;case v.ACT_PROC.KEY:this.keyLoader.load(this.rparam.appid);break;case Ze.$.FIN+v.ACT_PROC.KEY:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.KEY_RETRY,null,null,R.Room_key_Timeout);break;case v.ACT_PROC.KEY_RETRY:break;case Ze.$.TO+v.ACT_PROC.KEY_RETRY:r.process(v.ACT_PROC.KEY),r.finished(v.ACT_PROC.KEY_RETRY);break;case v.ACT_PROC.LOAD_CONFIG:this.configLoader.load();break;case Ze.$.FIN+v.ACT_PROC.LOAD_CONFIG:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.CONFIG_RETRY,null,null,R.Room_tk_Timeout);break;case v.ACT_PROC.CONFIG_RETRY:break;case Ze.$.TO+v.ACT_PROC.LOAD_CONFIG:r.process(v.ACT_PROC.CONFIG),r.finished(v.ACT_PROC.CONFIG_RETRY);break;case v.ACT_PROC.DP:var i=t;this.dpLoader.load(this.rparam.appkey,i);break;case Ze.$.FIN+v.ACT_PROC.DP:v.ACT_NET_FAIL==t&&r.process(v.ACT_PROC.DP_RETRY,null,null,R.Room_dp_Timeout);break;case v.ACT_PROC.DP_RETRY:break;case Ze.$.TO+v.ACT_PROC.DP_RETRY:r.process(v.ACT_PROC.DP,this.rparam.uid),r.finished(v.ACT_PROC.DP_RETRY)}}function Ar(e,t,r){var n=r.exdata,i=n.getStreamId();switch(e){case v.ACT_PHASE.PUSH:return this.rtcPusher.connectorExists(i)?Ze.SKIP:(this.rtcPusher.newPusher(n),n.getPluginHandle()?v.ACT_PHASE.LOAD_CONFIG:v.ACT_PHASE.STM_ASK_AUTH);case v.ACT_PHASE.LOAD_CONFIG:return r.process(v.ACT_PROC.LOAD_CONFIG),v.ACT_PHASE.SIG_AUTH_PUB;case v.ACT_PHASE.STM_ASK_AUTH:return r.process(v.ACT_PROC.STM_ASK_AUTH),v.ACT_PHASE.LOAD_CONFIG;case v.ACT_PHASE.SIG_AUTH_PUB:return r.process(v.ACT_PROC.SIG_AUTH_PUB,null,null,R.Signal_authpublish_Timeout),v.ACT_PHASE.STM_PUSH;case v.ACT_PHASE.REPUSH:return v.ACT_PHASE.STM_PUSH;case v.ACT_PHASE.STM_PUSH:return r.process(v.ACT_PROC.STM_PUSH),v.ACT_PHASE.SIG_START_PUB;case v.ACT_PHASE.SIG_START_PUB:return r.process(v.ACT_PROC.SIG_START_PUB,null,null,R.Signal_startpublish_Timeout),v.ACT_PHASE.SIG_SET_WATCH_INFO;case v.ACT_PHASE.SIG_START_PUB_FAIL:return r.process(v.ACT_PROC.STM_UNPUSH,!1),v.ACT_PHASE.SIG_AUTH_PUB;case v.ACT_PHASE.SIG_SET_WATCH_INFO:var a;return(a=this.rtcPuller.getCurServer())?(r.process(v.ACT_PROC.SIG_SET_WATCH_INFO,a,v.ACT_PROC.SIG_SET_WATCH_INFO,R.Signal_setwatchinfo_Timeout),v.ACT_PHASE.PUSH_FIN):(r.process(v.ACT_PROC.LOAD_DP),v.ACT_PHASE.SIG_SET_WATCH_INFO);case v.ACT_PHASE.PUSH_FIN:var o={streamId:i};return this.event.timerAdd(Er.TimerEvent.PUSH_HEARTBEAT,-R.Signal_Stream_Heartbeat_Interval,o,Er.TimerEvent.PUSH_HEARTBEAT+"-"+i),Ze.DONE;case Ze.$.UN+v.ACT_PHASE.PUSH:return r.process(v.ACT_PROC.STM_UNPUSH,!0),Ze.DONE;case v.ACT_PHASE.UNPUSH:return this.rtcPusher.connectorExists(i)&&(r.process(v.ACT_PROC.STM_UNPUSH,!0),r.process(v.ACT_PROC.SIG_STOP_PUB,null,null,R.Signal_stoppublish_Timeout)),Ze.DONE;case Ze.$.FIN+v.ACT_PHASE.UNPUSH:return 0==this.rtcPusher.getAllStreamIds().length&&(this.watchInfoFlag=!1),this.event.timerRemove(Er.TimerEvent.PUSH_HEARTBEAT+"-"+i),Ze.NULL}}function Or(e,t,r){var n=this,i=r.exdata,a=i.getStreamId();switch(e){case v.ACT_PROC.LOAD_CONFIG:this.dpservact.start(v.ACT_PHASE.LOAD_CONFIG,null,(function(e,t){null===t?r.finished(v.ACT_PROC.LOAD_CONFIG):r.failed(v.ACT_PROC.LOAD_CONFIG)}));break;case v.ACT_PROC.STM_ASK_AUTH:var o=c.curTimeInMilli();He.createHackedLocalstream(i,(function(e,t){var i=c.curTimeInMilli();n.rparam.opencamera=i-o,n.rtcPusher.connectorExists(a)||He.closeMstream(e),r.finished(v.ACT_PROC.STM_ASK_AUTH)}),(function(e){r.failed(v.ACT_PROC.STM_ASK_AUTH,e)}));break;case v.ACT_PROC.SIG_AUTH_PUB:this.rtcSignal.sendAuthpublish(a);break;case Ze.$.TO+v.ACT_PROC.SIG_AUTH_PUB:ee.push({mess:{command:1}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,i.streaminConfig.videoWidth||0,i.streaminConfig.videoHeight||0),r.repeat(v.ACT_PROC.SIG_AUTH_PUB);break;case v.ACT_PROC.STM_PUSH:U.info("start proc stm publish");var s=this.rtcPusher.getPusher(a);U.info("pusher",s),s.push((function(e,t){null===t?r.finished(v.ACT_PROC.STM_PUSH):r.failed(v.ACT_PROC.STM_PUSH,t)}));break;case v.ACT_PROC.SIG_START_PUB:var u=(s=this.rtcPusher.getPusher(a)).getStreamParam();this.rtcSignal.sendStartpublish(a,u);break;case Ze.$.TO+v.ACT_PROC.SIG_START_PUB:U.warning("sig start publish timeout 10s"),ee.push({mess:{command:2}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,i.streaminConfig.videoWidth||0,i.streaminConfig.videoHeight||0),r.repeat(v.ACT_PROC.SIG_START_PUB);break;case v.ACT_PROC.SIG_SET_WATCH_INFO:if(this.watchInfoFlag)r.finished(v.ACT_PROC.SIG_SET_WATCH_INFO);else{var d=t,l=c.parseUrl(d);this.swiStreamId=a,this.rtcSignal.sendSetwatchinfo(l)}break;case Ze.$.TO+v.ACT_PROC.SIG_SET_WATCH_INFO:r.repeat(v.ACT_PROC.SIG_SET_WATCH_INFO);break;case v.ACT_PROC.LOAD_DP:this.dpservact.start(v.ACT_PHASE.LOAD,null,(function(e,t){var i;null===t?(i=e[v.DPKEYS.WATCH])&&(n.rtcPuller.setServers(i),r.finished(v.ACT_PROC.LOAD_DP)):r.failed(v.ACT_PROC.LOAD_DP,t)}));break;case v.ACT_PROC.SIG_STOP_PUB:u=(s=this.rtcPusher.getPusher(a)).getStreamParam();this.rtcSignal.sendStoppublish(a,u);break;case Ze.$.TO+v.ACT_PROC.SIG_STOP_PUB:ee.push({mess:{command:4}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,i.streaminConfig.videoWidth||0,i.streaminConfig.videoHeight||0),U.warning(this.rparam.innerid+" stop pub timeout."),r.finished(v.ACT_PROC.SIG_STOP_PUB);break;case v.ACT_PROC.STM_UNPUSH:if(!(s=this.rtcPusher.getPusher(a)))return void r.failed(v.ACT_PROC.STM_UNPUSH,!1);var h=t;s.unpush((function(e,t){h&&n.rtcPusher.removeConnector(a),null===t?r.finished(v.ACT_PROC.STM_UNPUSH):r.failed(v.ACT_PROC.STM_UNPUSH,t)}))}}function Ir(e,t,r){var n=r.exdata,i=n.getStreamId()||n.streamId;switch(e){case v.ACT_PHASE.REPULL:return v.ACT_PHASE.PULL;case v.ACT_PHASE.PULL:if(this.rtcPuller.connectorExists(i))return Ze.SKIP;var a=this.roomusers[i];return a||(a={streamid:i,roomname:this.rparam.playName,streamstat:t.streamstat}),n.setSparam(a),this.rtcPuller.newPuller(n),r.process(v.ACT_PROC.SIG_START_PULL,a,null,R.Signal_startplay_Timeout),r.process(v.ACT_PROC.STM_PULL),Ze.DONE;case Ze.$.UN+v.ACT_PHASE.PULL:return r.process(v.ACT_PROC.STM_UNPULL),Ze.DONE;case v.ACT_PHASE.UNPULL:var o=this.rtcPuller.getPuller(i);return o&&(r.process(v.ACT_PROC.SIG_STOP_PULL,o,null,R.Signal_stopplay_Timeout),r.process(v.ACT_PROC.STM_UNPULL)),Ze.DONE}}function Pr(e,t,r){var n=this,i=(o=r.exdata).getStreamId();switch(e){case v.ACT_PROC.SIG_START_PULL:var a=t;this.rparam.playName?this.rtcSignal.sendStartplay(i,a,this.rparam.playName):this.rtcSignal.sendStartplay(i,a);break;case Ze.$.TO+v.ACT_PROC.SIG_START_PULL:ee.push({mess:{command:256}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,i,o.streaminConfig.videoWidth||0,o.streaminConfig.videoHeight||0),r.repeat(v.ACT_PROC.SIG_START_PULL);break;case v.ACT_PROC.STM_PULL:(s=this.rtcPuller.getPuller(i)).pull(this.rparam.playName,(function(e,t){null===t?r.finished(v.ACT_PROC.STM_PULL):r.failed(v.ACT_PROC.STM_PULL,t)}));break;case v.ACT_PROC.SIG_STOP_PULL:var o=(s=t).getStream()?s.getStream():this.lastroomusers[i];this.rtcSignal.sendStopplay(i,o,s.getDuration());break;case Ze.$.TO+v.ACT_PROC.SIG_STOP_PULL:ee.push({mess:{command:512}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,i,0,0),U.warning(this.rparam.innerid+" stop play timeout."),r.finished(v.ACT_PROC.SIG_STOP_PULL);break;case v.ACT_PROC.STM_UNPULL:var s;if(!(s=this.rtcPuller.getPuller(i)))return void r.failed(v.ACT_PROC.STM_UNPULL,!1);s.unpull((function(e,t){n.rtcPuller.removeConnector(i),null===t?r.finished(v.ACT_PROC.STM_UNPULL):r.failed(v.ACT_PROC.STM_UNPULL,t)}))}}function yr(e,t){switch(e){case v.ACT_PHASE.MIX_START:this.mixStreamConfig=t,this.mergeinfo.userlist=this._getStreamMixItems(),this.mergeinfo.streamcount=this.mergeinfo.userlist&&this.mergeinfo.userlist.length.toString();var r=c.parseUrl(this.mixStreamConfig.rtmpAddress);return r&&r.host&&r.path?(this.mergeinfo.rtmpaddr=r.host,this.mergeinfo.rtmpport=r.port?r.port.toString:"1935",this.mergeinfo.appname=r.path.substr(1),this.mergeinfo.mergestreamid=this.mixStreamConfig.outputStremId,this.mergeinfo.gain=R.Mix_Stream_Gain,this.mergeinfo.backid=R.Mix_Stream_Back,this.mergeinfo.resolution=this.mixStreamConfig.outputVideoResolution,this.mergeinfo.bitrate=this.mixStreamConfig.outputVideoBitrate,this.mergeinfo.roomname=this.rparam.roomname,this.mergeinfo.masterroomid=this.mergeinfo.userlist[0].roomid,this.mergeinfo.merge_uid=this.rparam.uid,this.mergeinfo.expass=this.rparam.uid,this.mergeinfo.curtime=c.curTime().toString(),this.mergeinfo.appid=this.rparam.appid,v.ACT_PHASE.MIX_STARTIN):(ee.mix("",ee.CODES.REPORT_TYPE_MESS_MERGE_FAILED_INVALID_RTMP_ADDR,this.rparam,this.mixStreamConfig.outputStremId,this.getMixSize(this.mixStreamConfig).mixWidth,this.getMixSize(this.mixStreamConfig).mixHeight),this.mixact.setError(g(g.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID)),Ze.DONE);case Ze.$.UN+v.ACT_PHASE.MIX_START:return Ze.DONE;case v.ACT_PHASE.MIX_STARTIN:return this.mixact.process(v.ACT_PROC.MIX_STARTIN),Ze.DONE;case v.ACT_PHASE.MIX_UPDATE:return this.mix_status!=v.MIX_STATUS.PRESTART&&this.mix_status!=v.MIX_STATUS.STOP&&this.mixStreamConfig?(this.mixStreamConfig.mixStreams=t,this.mergeinfo.userlist=this._getStreamMixItems(),Ze.DONE):Ze.SKIP;case v.ACT_PHASE.MIX_STOP:return v.ACT_PHASE.MIX_STOPIN;case v.ACT_PHASE.MIX_STOPIN:return this.mixact.process(v.ACT_PROC.MIX_STOPIN),Ze.DONE}}function Nr(e){var t=this;switch(e){case v.ACT_PROC.MIX_STARTIN:this.mixinact.start(v.ACT_PHASE.MIXIN_START,null,(function(e,r,n){null===r||t.mixact.failed(v.ACT_PROC.MIX_STARTIN,r)}));break;case v.ACT_PROC.MIX_STOPIN:this.mixinact.start(v.ACT_PHASE.MIXIN_STOP,null,(function(e,r,n){null==r?t.mix_status=v.MIX_STATUS.STOP:t.mixact.failed(v.ACT_PROC.MIX_STOPIN,r)}))}}function br(e,t){switch(e){case v.ACT_PHASE.MIXIN_START:return v.ACT_PHASE.SIG_REQMERGE;case Ze.$.UN+v.ACT_PHASE.MIXIN_START:return this.event.timerRemove(Er.TimerEvent.MIX_REQMERGESTAT),Ze.DONE;case v.ACT_PHASE.SIG_REQMERGE:var r;if(r=this.rtcPusher.getCurServer()){var n=c.parseUrl(r);return this.mergeinfo.pushaddr=n.host,this.mergeinfo.pushport=n.port.toString(),this.mixinact.process(v.ACT_PROC.SIG_REQMERGE,null,null,R.Signal_reqmerge_Timeout),v.ACT_PHASE.SIG_REQMERGESTAT}return this.mixinact.process(v.ACT_PROC.LOAD_DP),v.ACT_PHASE.SIG_REQMERGE;case v.ACT_PHASE.SIG_REQMERGESTAT:return this.mixinact.process(v.ACT_PROC.SIG_REQMERGESTAT),v.ACT_PHASE.SIG_REQMERGESTAT_DELAY;case v.ACT_PHASE.SIG_REQMERGESTAT_DELAY:var i=t[v.ACT_PROC.SIG_REQMERGESTAT];return i&&this.mixinact.process(v.ACT_PROC.SIG_REQMERGESTAT_DELAY,null,null,i),v.ACT_PHASE.SIG_REQMERGESTAT;case v.ACT_PHASE.MIXIN_RESTART_DELAY:return this.mixinact.process(v.ACT_PROC.MIXIN_RESTART_DELAY,null,null,1e3),v.ACT_PHASE.MIXIN_RESTART;case v.ACT_PHASE.MIXIN_RESTART:return this.mixinact.process(v.ACT_PROC.SIG_STOPMERGE,null,null,R.Signal_stopmerge_Timeout),v.ACT_PHASE.SIG_REQMERGE;case v.ACT_PHASE.MIXIN_STOP:return this.mixinact.process(v.ACT_PROC.SIG_STOPMERGE,null,null,1e3),Ze.DONE}}function Dr(e,t){var r=this;switch(e){case v.ACT_PROC.SIG_REQMERGE:this.rtcSignal.sendReqMerge(this.mergeinfo);break;case Ze.$.TO+v.ACT_PROC.SIG_REQMERGE:ee.mix({mess:{command:16}},ee.CODES.REPORT_TYPE_MESS_MERGE_RESTART_PROGRESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.repeat(v.ACT_PROC.SIG_REQMERGE);break;case v.ACT_PROC.SIG_REQMERGESTAT:this.rtcSignal.sendReqmergeStat(this.mergeinfo);break;case Ze.$.TO+v.ACT_PROC.SIG_REQMERGESTAT:ee.mix({mess:{command:16}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.repeat(v.ACT_PROC.SIG_REQMERGESTAT);break;case v.ACT_PROC.SIG_REQMERGESTAT_DELAY:break;case Ze.$.TO+v.ACT_PROC.SIG_REQMERGESTAT_DELAY:this.mixinact.finished(v.ACT_PROC.SIG_REQMERGESTAT_DELAY);break;case v.ACT_PROC.MIXIN_RESTART_DELAY:break;case Ze.$.TO+v.ACT_PROC.MIXIN_RESTART_DELAY:this.mixinact.finished(v.ACT_PROC.MIXIN_RESTART_DELAY);break;case v.ACT_PROC.LOAD_DP:this.dpservact.start(v.ACT_PHASE.LOAD,null,(function(e,t){var n;null===t?(n=e[v.DPKEYS.PUBLISH])&&(r.rtcPusher.setServers(n),r.mixinact.finished(v.ACT_PROC.LOAD_DP)):r.mixinact.failed(v.ACT_PROC.LOAD_DP,t)}));break;case v.ACT_PROC.SIG_STOPMERGE:this.rtcSignal.sendStopMerge(this.mergeinfo);break;case Ze.$.TO+v.ACT_PROC.SIG_STOPMERGE:ee.mix({mess:{command:32}},ee.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,0,0),this.mixinact.isPhase(v.ACT_PHASE.MIXIN_RESTART)?this.mixact.repeat(v.ACT_PROC.SIG_STOPMERGE):this.mixact.finished(v.ACT_PROC.SIG_STOPMERGE)}}Ze.onQueue(/room.*/,(function(e,t){t.phase==v.ACT_PHASE.LOAD&&(Ze.cutail(t.actTag),(e[0].phase0==v.ACT_PHASE.LOGIN||e[0].phase0==v.ACT_PHASE.RELOGIN)&&this.cancel()),t.phase0==v.ACT_PHASE.LOGOUT&&(Ze.cutail(t.actTag),(e[0].phase0==v.ACT_PHASE.LOGIN||v.ACT_PHASE.RELOGIN)&&this.cancel())})),Ze.setProcKey(v.ACT_PROC.SIG_SET_WATCH_INFO),Ze.onQueue(/pushx-.*/,(function(e,t){t.phase0==v.ACT_PHASE.UNPUSH&&(Ze.cutail(t.actTag),e[0].phase0!=v.ACT_PHASE.PUSH&&e[0].phase0!=v.ACT_PHASE.REPUSH||this.cancel()),t.phase0==v.ACT_PHASE.REPUSH&&(e[0].phase0==v.ACT_PHASE.PUSH&&Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.UNPUSH&&(U.info("when unpublish go republish"),this.cancel())),t.phase0==v.ACT_PHASE.PUSH&&(Ze.cutail(e[0].actTag),e[0].phase0==v.ACT_PHASE.UNPUSH&&(U.info("when unpublish go publish"),this.cancel()))})),Ze.onQueue(/pullx-.*/,(function(e,t){t.phase0==v.ACT_PHASE.UNPULL&&(Ze.cutail(t.actTag),e[0].phase0!=v.ACT_PHASE.PULL&&e[0].phase0!=v.ACT_PHASE.REPULL||this.cancel()),t.phase0==v.ACT_PHASE.REPULL&&(e[0].phase0==v.ACT_PHASE.PULL&&Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.UNPULL&&Ze.cutail(e[0].actTag)),t.phase0==v.ACT_PHASE.PULL&&e[0].phase0==v.ACT_PHASE.UNPULL&&Ze.cutail(e[0].actTag)})),Ze.onQueue(/mix-.*/,(function(e,t){t.phase0==v.ACT_PHASE.MIX_STOP?(Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.MIX_START&&this.cancel()):t.phase0==v.ACT_PHASE.MIX_START&&(Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.MIX_STOP&&this.cancel())})),Ze.onQueue(/mixin-.*/,(function(e,t){t.phase0==v.ACT_PHASE.MIXIN_STOP&&(Ze.cutail(t.actTag),e[0].phase0==v.ACT_PHASE.MIXIN_START&&this.cancel())}));var Ur=R.RTCLibDebug;f.init({debug:!1}),f.trace=Ur?U.trace:U.noop,f.debug=Ur?U.debug:U.noop,f.vdebug=Ur?U.debug:U.noop,f.log=Ur?U.info:U.noop,f.warn=Ur?U.warning:U.noop,f.error=Ur?U.error:U.noop;var Lr={inited:!1,uuid:c.uuid(),clientId:c.randomString(6),startTime:0,appId:"",isIOS:!1,sysver:"",devmodel:"",defroom:null,rooms:{},roomId:100,Event:{NET_TYPE:"net-type"},isActive:!0,event:new M,init:function(e,t){if(!e||!e.appid){var r=g(g.CODE.CHUANG_APPID_NULL);return U.error(r.msg),t&&t(r),!1}if(!e.appkey){r=g(g.CODE.CHUANG_APPKEY_NULL);return U.error(r.msg),t&&t(r),!1}if(e.appid.match(/[^\w-]/)){r=g(g.CODE.CHUANG_APPID_INVALID);return t&&t(r),!1}if(e.appkey.match(/[^\w-]/)){r=g(g.CODE.CHUANG_APPKEY_INVALID);return t&&t(r),!1}-1!=e.appid.indexOf("-")?this.appId=e.appkey:this.appId=e.appid;var n,i=window.location.protocol.toLowerCase(),a=window.location.host.toLowerCase();if(i.indexOf("https")<0&&i.indexOf("file:")<0&&"localhost"!=a&&a.indexOf(".local")<0){r=g(g.CODE.CHUANG_WEBRTC_ADDRESS_INVALID);return Nt.report(r,Nt.ACTION.INIT,this.appId),t&&t(r),!1}if(!f.isWebrtcSupported()||!f.isGetUserMediaAvailable()){r=g(g.CODE.CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED);return Nt.report(r,Nt.ACTION.INIT,this.appId),t&&t(r),!1}if(this.inited)return U.warning("SDK has been inited!"),!0;this.inited=!0,setInterval((function(){n=S._getNettype(),setInterval((function(){var e=S._getNettype();n!==e&&(ee.room("",ee.CODES.REPORT_TYPE_NETWORK_CHANGE,{}),o.event.dispatchEvent(M.Create.app(o.Event.NET_TYPE,{netType:e})))}),1e3)}),1e3);var o=this;return this.startTime=Date.now(),this.sysver=S.getBrowserInfo().os+" "+S.getBrowserInfo().osversion,this.devmodel=S.getBrowserInfo().name+" "+S.getBrowserInfo().version,this.time=c.curTimeFtt(),this.netType=S._getNettype(),!0},initroom:function(e,t){if(!e.appid){var r=g(g.CODE.CHUANG_APPID_NULL);return Nt.report(r,Nt.ACTION.INITROOM,this.appId),void(t&&t(r))}if(!e.appkey){r=g(g.CODE.CHUANG_APPKEY_NULL);return Nt.report(r,Nt.ACTION.INITROOM,this.appId),void(t&&t(r))}var n=new Sr(e,this.roomId);return!this.defroom&&(this.defroom=n),this.rooms[this.roomId++]=n,n},getroom:function(e){return this.rooms[e]},delroom:function(e){var t=this.rooms[e];t&&t.uninit(),delete this.rooms[e]},uninit:function(e){for(var t in this.inited=!1,this.rooms)e&&this.rooms[t].rtcSignal.socket.stopReconnect(),this.rooms[t].logoutRoom(),this.rooms[t].uninit(),Ze.remove(this.rooms[t].mixinact.uid),Ze.remove(this.rooms[t].mixact.uid),Ze.remove(this.rooms[t].roomact.uid),delete this.rooms[t];this.defroom=null},getRTClib:function(){return f},getSDKVersion:function(){return"Web-"+v.SDKVERSION+"-202110111846"}};Lr.isIOS=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0,window.addEventListener(Lr.isIOS?"pagehide":"beforeunload",(function(e){Lr.isActive=!1,Lr.uninit(!0)}));const kr=Lr;function Mr(e){return function(t){e&&e(t.no)}}var wr={VERSION:v.SDKVERSION,BUILD:v.BUILD,ChuangUserRole:v.ChuangUserRole,ChuangPublishChannel:v.ChuangPublishChannel,ChuangStreamMode:v.ChuangStreamMode,ChuangRoomState:v.ChuangRoomState,ChuangMixResolutions:v.ChuangMixResolutions,ChuangEvent:Sr.Event,ChuangErrorCode:g.ErrorCode,ChuangPublishState:v.ChuangPublishState,ChuangPlayState:v.ChuangPlayState,ChuangStreamUpdateType:v.ChuangStreamUpdateType,ChuangStreamState:v.ChuangStreamState,ChuangPlayStreamEvent:v.ChuangPlayStreamEvent,ChuangVideoConfigPreset:v.ChuangVideoConfigPreset,ChuangLogLevel:v.ChuangLogLevel,SCREEN_LEVEL:v.SCREEN_LEVEL,initEngine:function(e,t,r){var n=Mr(r),i={appid:e,appkey:t};return!!kr.init(i,n)&&(kr.initroom(i,n),U.info("ChuangLiveEngine SDK inited. clientId is: ["+kr.clientId+"]"),!0)},uninitEngine:function(){kr.uninit()},getDevices:function(e){kr.getRTClib().listDevices(e)},setLogLevel:function(e){U.setLogLevel(e)},on:function(e,t){return kr.defroom&&kr.defroom.on(e,t),wr},off:function(e,t){return kr.defroom&&kr.defroom.off(e,t),wr},getPreRoomState:function(){return v.ChuangRoomState.DISCONNECTED},getRoomConnectState:function(){return kr.defroom?kr.defroom.getRoomConnectState():this.getPreRoomState()},loginRoom:function(e,t,r,n){var i=Mr(n);kr.defroom?kr.defroom.loginRoom(e,t,r,i):kr.isActive&&i(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},loadpage:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.loadpage(e):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},logoutRoom:function(e){var t=Mr(e);kr.defroom?kr.defroom.logoutRoom(t):kr.isActive&&t(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},newStreamConfig:function(e){return new x(e)},startPreview:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.startPreview(e,t):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopPreview:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.stopPreview(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startPublishStream:function(e,t,r,n){var i=Mr(n);kr.defroom?kr.defroom.publishStream(e,t,r,i):kr.isActive&&i(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startPreview1:function(e,t,r){var n=Mr(r);kr.defroom?kr.defroom.startPreview1(e,t,n):kr.isActive&&n(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopPreview1:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.stopPreview1(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopPublishStream:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.unpublishStream(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startMixStream:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.startMixStream(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},updateMixStream:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.updateMixStream(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopMixStream:function(e){var t=Mr(e);kr.defroom?kr.defroom.stopMixStream(t):kr.isActive&&t(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startPlayStream:function(e,t,r){var n=Mr(r);kr.defroom?kr.defroom.playStream(e,t,"",n):kr.isActive&&n(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopPlayStream:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.unplayStream(e,r):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startPlayRoomStream:function(e,t,r,n){var i=Mr(n);kr.defroom?kr.defroom.playStream(e,t,r,i):kr.isActive&&i(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},startStreamQualityTest:function(e){var t=Mr(e);kr.defroom?kr.defroom.startStreamQualityTest(t):kr.isActive&&t(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},stopStreamQualityTest:function(e){var t=Mr(e);kr.defroom?kr.defroom.stopStreamQualityTest(t):kr.isActive&&t(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},getVideoStreamStatus:function(e){return kr.defroom?kr.defroom.getVideoStreamStatus(e):null},startSoundLevelMonitor:function(e){return kr.defroom?kr.defroom.startSoundLevelMonitor(e):null},stopSoundLevelMonitor:function(e){return kr.defroom?kr.defroom.stopSoundLevelMonitor(e):null},setSoundLevelMonitorInterval:function(e){return kr.defroom?kr.defroom.setSoundLevelMonitorInterval(e):null},getStreamBitrate:function(e){return kr.defroom?kr.defroom.getStreamBitrate(e):null},getSDKVersion:function(){return kr.getSDKVersion()},muteLocalAudio:function(e,t){return kr.defroom?kr.defroom.muteAudio(e,t):null},muteLocalVideo:function(e,t){return kr.defroom?kr.defroom.muteVideo(e,t):null},muteRemoteAudio:function(e,t){return kr.defroom?kr.defroom.muteRemoteAudio(e,t):null},muteRemoteVideo:function(e,t){return kr.defroom?kr.defroom.muteRemoteVideo(e,t):null},testResolution:function(e,t){var r=Mr(t);kr.defroom?kr.defroom.testResolution(e):kr.isActive&&r(g(g.CODE.CHUANG_ENGINE_NOT_INIT))},resume:function(e){return kr.defroom?kr.defroom.resume(e):null},resumeAll:function(){return kr.defroom?kr.defroom.resumeAll():null}};const Hr=wr})(),n})()}));