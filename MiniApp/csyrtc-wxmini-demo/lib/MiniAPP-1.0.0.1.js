!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}(self,(function(){return(()=>{var e={788:e=>{var t,r=[],i=!1,s="".concat(parseInt(1e6*Math.random())),n=function(e){var t=e.getFullYear(),r=e.getMonth()+1,i=e.getDate(),s=e.getHours(),n=e.getMinutes(),o=e.getSeconds(),c=e.getMilliseconds();return[t,r,i].map(a).join("/")+" "+[s,n,o,c].map(a).join(":")},a=function(e){return(e=e.toString())[1]?e:"0"+e},o=function(e,t){var i=n(new Date);r.push("".concat(i,": ").concat(e)),"error"===t?console.error("".concat(i,": ").concat(e)):"warn"===t?console.warn("".concat(i,": ").concat(e)):console.log("".concat(i,": ").concat(e))};e.exports={getUid:function(){return s},checkSystemInfo:function(e){i||(i=!0,wx.getSystemInfo({success:function(t){o("".concat(JSON.stringify(t)));var r=t.SDKVersion.split("."),i=parseInt(r[0]),s=parseInt(r[1]);e.globalData.systemInfo=t,i<=1&&s<7&&wx.showModal({title:"版本过低",content:"微信版本过低，部分功能可能无法工作",success:function(e){e.confirm?console.log("用户点击确定"):e.cancel&&console.log("用户点击取消")}})}}))},formatTime:n,requestPermission:function(e,t){wx.getSetting({success:function(r){r.authSetting[e]?t&&t():wx.authorize({scope:e,success:function(){t&&t()}})}})},log:o,clearLogs:function(){r=[]},getLogs:function(){return r},mashupUrl:function(e,t){return e},debounce:function(e,r){return function(){var i=this,s=arguments;clearTimeout(t),t=setTimeout((function(){e.apply(i,s)}),r)}}}},930:function(e,t,r){var i;function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}
/*!
 * EventEmitter v5.2.8 - git.io/ee
 * Unlicense - http://unlicense.org/
 * Oliver Caldwell - https://oli.me.uk/
 * @preserve
 */!function(t){"use strict";function n(){}var a=n.prototype,o=t.EventEmitter;function c(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function u(e){return function(){return this[e].apply(this,arguments)}}function _(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!==s(e))&&_(e.listener)}a.getListeners=function(e){var t,r,i=this._getEvents();if(e instanceof RegExp)for(r in t={},i)i.hasOwnProperty(r)&&e.test(r)&&(t[r]=i[r]);else t=i[e]||(i[e]=[]);return t},a.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},a.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&((t={})[e]=r),t||r},a.addListener=function(e,t){if(!_(t))throw new TypeError("listener must be a function");var r,i=this.getListenersAsObject(e),n="object"===s(t);for(r in i)i.hasOwnProperty(r)&&-1===c(i[r],t)&&i[r].push(n?t:{listener:t,once:!1});return this},a.on=u("addListener"),a.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},a.once=u("addOnceListener"),a.defineEvent=function(e){return this.getListeners(e),this},a.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},a.removeListener=function(e,t){var r,i,s=this.getListenersAsObject(e);for(i in s)s.hasOwnProperty(i)&&-1!==(r=c(s[i],t))&&s[i].splice(r,1);return this},a.off=u("removeListener"),a.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},a.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},a.manipulateListeners=function(e,t,r){var i,n,a=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!==s(t)||t instanceof RegExp)for(i=r.length;i--;)a.call(this,t,r[i]);else for(i in t)t.hasOwnProperty(i)&&(n=t[i])&&("function"==typeof n?a.call(this,i,n):o.call(this,i,n));return this},a.removeEvent=function(e){var t,r=s(e),i=this._getEvents();if("string"===r)delete i[e];else if(e instanceof RegExp)for(t in i)i.hasOwnProperty(t)&&e.test(t)&&delete i[t];else delete this._events;return this},a.removeAllListeners=u("removeEvent"),a.emitEvent=function(e,t){var r,i,s,n,a=this.getListenersAsObject(e);for(n in a)if(a.hasOwnProperty(n))for(r=a[n].slice(0),s=0;s<r.length;s++)!0===(i=r[s]).once&&this.removeListener(e,i.listener),i.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,i.listener);return this},a.trigger=u("emitEvent"),a.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},a.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},a._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},a._getEvents=function(){return this._events||(this._events={})},n.noConflict=function(){return t.EventEmitter=o,n},void 0===(i=function(){return n}.call(t,r,t,e))||(e.exports=i)}("undefined"!=typeof window?window:this||{})},878:function(e,t){var r,i,s,n;function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n=function(e){"use strict";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1),e.encode=function(e){var r,i,s,n,a,o;if(e){for(s=e.length,i=0,r="";i<s;){if(n=255&e.charCodeAt(i++),i==s){r+=t.charAt(n>>2),r+=t.charAt((3&n)<<4),r+="==";break}if(a=e.charCodeAt(i++),i==s){r+=t.charAt(n>>2),r+=t.charAt((3&n)<<4|(240&a)>>4),r+=t.charAt((15&a)<<2),r+="=";break}o=e.charCodeAt(i++),r+=t.charAt(n>>2),r+=t.charAt((3&n)<<4|(240&a)>>4),r+=t.charAt((15&a)<<2|(192&o)>>6),r+=t.charAt(63&o)}return r}},Object.defineProperty(e,"__esModule",{value:!0})},"object"===a(t)?n(t):(i=[t],void 0===(s="function"==typeof(r=n)?r.apply(t,i):r)||(e.exports=s))},393:function(e,t){var r,i,s,n;function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}
/*!
 * md5js v1.0.7
 * (c) 2017-2018 penyuying
 * Released under the MIT License.
 */n=function(e){"use strict";e.md5=function(e,t){var r=e;function i(e,t){return e<<t|e>>>32-t}function s(e,t){var r,i,s,n,a;return s=2147483648&e,n=2147483648&t,a=(1073741823&e)+(1073741823&t),(r=1073741824&e)&(i=1073741824&t)?2147483648^a^s^n:r|i?1073741824&a?3221225472^a^s^n:1073741824^a^s^n:a^s^n}function n(e,t,r,n,a,o,c){return e=s(e,s(s(function(e,t,r){return e&t|~e&r}(t,r,n),a),c)),s(i(e,o),t)}function a(e,t,r,n,a,o,c){return e=s(e,s(s(function(e,t,r){return e&r|t&~r}(t,r,n),a),c)),s(i(e,o),t)}function o(e,t,r,n,a,o,c){return e=s(e,s(s(function(e,t,r){return e^t^r}(t,r,n),a),c)),s(i(e,o),t)}function c(e,t,r,n,a,o,c){return e=s(e,s(s(function(e,t,r){return t^(e|~r)}(t,r,n),a),c)),s(i(e,o),t)}function u(e){var t,r="",i="";for(t=0;t<=3;t++)r+=(i="0"+(e>>>8*t&255).toString(16)).substr(i.length-2,2);return r}var _,h,l,m,E,d,T,S,p,C=Array();for(C=function(e){for(var t,r=e.length,i=r+8,s=16*((i-i%64)/64+1),n=Array(s-1),a=0,o=0;o<r;)a=o%4*8,n[t=(o-o%4)/4]=n[t]|e.charCodeAt(o)<<a,o++;return a=o%4*8,n[t=(o-o%4)/4]=n[t]|128<<a,n[s-2]=r<<3,n[s-1]=r>>>29,n}(r),d=1732584193,T=4023233417,S=2562383102,p=271733878,_=0;_<C.length;_+=16)h=d,l=T,m=S,E=p,d=n(d,T,S,p,C[_+0],7,3614090360),p=n(p,d,T,S,C[_+1],12,3905402710),S=n(S,p,d,T,C[_+2],17,606105819),T=n(T,S,p,d,C[_+3],22,3250441966),d=n(d,T,S,p,C[_+4],7,4118548399),p=n(p,d,T,S,C[_+5],12,1200080426),S=n(S,p,d,T,C[_+6],17,2821735955),T=n(T,S,p,d,C[_+7],22,4249261313),d=n(d,T,S,p,C[_+8],7,1770035416),p=n(p,d,T,S,C[_+9],12,2336552879),S=n(S,p,d,T,C[_+10],17,4294925233),T=n(T,S,p,d,C[_+11],22,2304563134),d=n(d,T,S,p,C[_+12],7,1804603682),p=n(p,d,T,S,C[_+13],12,4254626195),S=n(S,p,d,T,C[_+14],17,2792965006),d=a(d,T=n(T,S,p,d,C[_+15],22,1236535329),S,p,C[_+1],5,4129170786),p=a(p,d,T,S,C[_+6],9,3225465664),S=a(S,p,d,T,C[_+11],14,643717713),T=a(T,S,p,d,C[_+0],20,3921069994),d=a(d,T,S,p,C[_+5],5,3593408605),p=a(p,d,T,S,C[_+10],9,38016083),S=a(S,p,d,T,C[_+15],14,3634488961),T=a(T,S,p,d,C[_+4],20,3889429448),d=a(d,T,S,p,C[_+9],5,568446438),p=a(p,d,T,S,C[_+14],9,3275163606),S=a(S,p,d,T,C[_+3],14,4107603335),T=a(T,S,p,d,C[_+8],20,1163531501),d=a(d,T,S,p,C[_+13],5,2850285829),p=a(p,d,T,S,C[_+2],9,4243563512),S=a(S,p,d,T,C[_+7],14,1735328473),d=o(d,T=a(T,S,p,d,C[_+12],20,2368359562),S,p,C[_+5],4,4294588738),p=o(p,d,T,S,C[_+8],11,2272392833),S=o(S,p,d,T,C[_+11],16,1839030562),T=o(T,S,p,d,C[_+14],23,4259657740),d=o(d,T,S,p,C[_+1],4,2763975236),p=o(p,d,T,S,C[_+4],11,1272893353),S=o(S,p,d,T,C[_+7],16,4139469664),T=o(T,S,p,d,C[_+10],23,3200236656),d=o(d,T,S,p,C[_+13],4,681279174),p=o(p,d,T,S,C[_+0],11,3936430074),S=o(S,p,d,T,C[_+3],16,3572445317),T=o(T,S,p,d,C[_+6],23,76029189),d=o(d,T,S,p,C[_+9],4,3654602809),p=o(p,d,T,S,C[_+12],11,3873151461),S=o(S,p,d,T,C[_+15],16,530742520),d=c(d,T=o(T,S,p,d,C[_+2],23,3299628645),S,p,C[_+0],6,4096336452),p=c(p,d,T,S,C[_+7],10,1126891415),S=c(S,p,d,T,C[_+14],15,2878612391),T=c(T,S,p,d,C[_+5],21,4237533241),d=c(d,T,S,p,C[_+12],6,1700485571),p=c(p,d,T,S,C[_+3],10,2399980690),S=c(S,p,d,T,C[_+10],15,4293915773),T=c(T,S,p,d,C[_+1],21,2240044497),d=c(d,T,S,p,C[_+8],6,1873313359),p=c(p,d,T,S,C[_+15],10,4264355552),S=c(S,p,d,T,C[_+6],15,2734768916),T=c(T,S,p,d,C[_+13],21,1309151649),d=c(d,T,S,p,C[_+4],6,4149444226),p=c(p,d,T,S,C[_+11],10,3174756917),S=c(S,p,d,T,C[_+2],15,718787259),T=c(T,S,p,d,C[_+9],21,3951481745),d=s(d,h),T=s(T,l),S=s(S,m),p=s(p,E);return 32==t?u(d)+u(T)+u(S)+u(p):u(T)+u(S)},Object.defineProperty(e,"__esModule",{value:!0})},"object"===a(t)?n(t):(i=[t],void 0===(s="function"==typeof(r=n)?r.apply(t,i):r)||(e.exports=s))},218:()=>{}},t={};function r(i){if(t[i])return t[i].exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{"use strict";r.r(i),r.d(i,{default:()=>Kt});var e;function t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const s={BUILD:"20201019-1526",SDKVERSION:"1.0.0.1",SIGVERSION:"1.0.0",DEVICE_TYPE:"MiniProgram",DPKEYS:{MESSAGE:"DPM",PUBLISH:"DPP",WATCH:"DPW"},ACT_PHASE:{LOGIN:"login",LOGIN_CONN:"login-conn",SIG_LOGIN:"sig-login",RELOGIN:"relogin",LOAD:"load",LOAD_TOKEN:"load-tk",LOAD_KEY_N_UID:"load-key",LOAD_DP:"load-dp",LOAD_CONFIG:"load-config",PUSH:"push",PUSH_FIN:"push-fin",UNPUSH:"unpush",REPUSH:"repush",PULL:"pull",UNPULL:"unpull",REPULL:"repull",SIG_AUTH_PUB:"sig-ap",SIG_START_PUB:"sig-spub",SIG_START_PUB_FAIL:"sig-spub-fail",SIG_SET_WATCH_INFO:"sig-swi",STM_ASK_AUTH:"stm-ask-auth",STM_CONNECT:"stm-conn",STM_PUSH:"stm-push",STM_ASK_SERVER:"stm-ask-server",STM_PUSH_PUSH:"stm-push-p",STM_PULL:"stm-pull",STM_PULL_PULL:"stm-pull-p",STM_UNPUSH:"stm-npush",STM_UNPULL:"stm-npull",LOGOUT_MIX:"logout-mix",LOGOUT_STREAMS:"logout-stms",LOGOUT_LOGOUT:"logout-logout",LOGOUT:"logout",MIX_START:"mix-start",MIX_UPDATE:"mix-update",MIX_STOP:"mix-stop",MIX_STARTIN:"mix-start-in",MIX_STOPIN:"mix-stop-in",MIXIN_RESTART_DELAY:"mixin_restart_delay",MIXIN_START:"mixin-start",MIXIN_STOP:"mixin-stop",MIXIN_RESTART:"mixin_restart",SIG_REQMERGE:"sig-reqm",SIG_REQMERGESTAT:"sig-reqmstat",SIG_REQMERGESTAT_DELAY:"sig-reqm-d",SIG_RESTART:"sig-restart"},ACT_PROC:{LOGIN_CONN:"login-conn",SIG_LOGIN:"sig-login",LOAD_DP:"load-dp",LOAD_CONFIG:"load-config",DP:"dp",UID:"uid",KEY:"key",TOKEN:"tk",DP_RETRY:"dp-r",UID_RETRY:"uid-r",KEY_RETRY:"key-r",TOKEN_RETRY:"tk-r",CONFIG_RETRY:"config-r",SIG_AUTH_PUB:"sig-ap",SIG_START_PUB:"sig-spub",SIG_SET_WATCH_INFO:"sig-swi",SIG_STOP_PUB:"sig-npub",SIG_START_PULL:"sig-spull",SIG_STOP_PULL:"sig-npull",STM_ASK_AUTH:"stm-ask-auth",STM_CONNECT:"stm-conn",STM_PUSH:"stm-push",STM_PUSH_PUSH:"stm-push-p",STM_ASK_SERVER:"stm-ask-server",STM_PULL:"stm-pull",STM_PULL_PULL:"stm-pull-p",STM_UNPUSH:"stm-npush",STM_UNPULL:"stm_npull",STM_CLOSE:"stm-close",LOGOUT_MIX:"logout-mix",LOGOUT_STREAMS:"logout-stms",LOGOUT:"logout",MIX_UPDATE:"mix-update",MIX_STARTIN:"mix-startin",MIX_STOPIN:"mix_stopin",MIXIN_RESTART_DELAY:"mixin_restart_delay",SIG_REQMERGE:"sig-reqm",SIG_REQMERGESTAT:"sig-reqmstat",SIG_REQMERGESTAT_DELAY:"sig-reqm-d",SIG_STOPMERGE:"sig-nm"},ACT_FLOW:{PRE_LOAD:"pload"},ACT_NET_FAIL:"net-fail",ROOM_STATUS:{PRELOGIN:1,LOGIN_PROC:2,LOGIN:3,LOGOUT_PROC:4},ChuangRoomState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangPublishState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangPlayState:{DISCONNECTED:0,CONNECTING:1,CONNECTED:2},ChuangStreamUpdateType:{ADD:"add",DELETE:"delete"},ChuangStreamState:{AUDIO_MUTE:"audio-mute",AUDIO_UNMUTE:"audio-unmute",VIDEO_MUTE:"video-mute",VIDEO_UNMUTE:"video-unmute"},ChuangPlayStreamEvent:{AUDIO_INITIALIZE:"audio-initialize",VIDEO_INITIALIZE:"video-initialize",AUDIO_DISCONNECTED:"auido-disconnected",VIDEO_DISCONNECTED:"video-disconnected",AUDIO_RECEIVE_FIRST_FRAME:"audio-receive-first-frame",VIDEO_RECEIVE_FIRST_FRAME:"video-receive-first-frame",AUDIO_DECODING:"audio-encoding",VIDEO_DECODING:"video-encoding",AUDIO_STUCK:"audio-stuck",VIDEO_STUCK:"video-stuck"},CONN_STATUS:{OFFLINE:3,ONLINE:1,CONNECTING:0,CLOSING:2},STREAM_STATUS:{CLOSED:1,CONNECTING:2,CONNECTED:4},ICS_STATUS:{FAILED:"failed",DISCONNECTED:"disconnected"},MIX_STATUS:{PRESTART:1,START:2,UPDATE:3,STOP:4},ChuangUserRole:{ANCHOR:1,AUDIENCE:2,INTER_ACTION:3},ChuangPublishChannel:{MAIN:0,AUX:1,SAUX:2},STREAM_TYPE:{RTC:0,MERGE:1},LEAVE_REASON:{NORMAL:0,BAD_NETWORK:1,BANNED_BY_SERVER:2},ChuangStreamMode:{BOTH:0,AUDIO:1,VIDEO:2},ChuangStreamType:{RTC:0,MIX:1},STREAM_REVOKE:{CAMERA:"camera",MICROPHONE:"microphone",SCREEN:"screen"},VIDEO_SOURCE:{CAMERA:1,SCREEN:2},AUDIO_SOURCE:{MICROPHONE:1,DESKTOP:2},SCREEN_LEVEL:{DEFAULT:1,LOW:2,MIDDLE:3,HIGH:4},ChuangVideoConfigPreset:{CHUANG_VIDEO_CONFIG_PRESET_180P:"320 * 180_15_300",CHUANG_VIDEO_CONFIG_PRESET_270P:"480 * 270_15_400",CHUANG_VIDEO_CONFIG_PRESET_360P:"640*360_15_600",CHUANG_VIDEO_CONFIG_PRESET_540P:"960*540_15_1200",CHUANG_VIDEO_CONFIG_PRESET_720P:"1280*720_15_1500",CHUANG_VIDEO_CONFIG_PRESET_1080P:"1920*1080_15_3000"},ChuangLogLevel:{LEVEL_VERBOSE:0,LEVEL_DEBUG:1,LEVEL_INFO:2,LEVEL_WARN:3,LEVEL_ERROR:4,LEVEL_NONE:5},VIDEO_CONFIG_PRESET:{P1920X1080_30_1024:"1920*1080_30_1024",P1920X1080_30_512:"1920*1080_30_512",P1920X1080_30_256:"1920*1080_30_256",P1280X960_30_1024:"1280*960_30_1024",P1280X960_30_512:"1280*960_30_512",P1280X960_30_256:"1280*960_30_256",P960X720_30_1024:"960*720_30_1024",P960X720_30_512:"960*720_30_512",P960X720_30_256:"960*720_30_256",P640X480_30_1024:"640*480_30_1024",P640X480_30_512:"640*480_30_512",P640X480_30_256:"640*480_30_256",P320X240_30_1024:"320*240_30_1024",P320X240_30_512:"320*240_30_512",P320X240_30_256:"320*240_30_256"},SCREEN_CONFIG_PRESET:{P1280X960_30_1024:"1280*960_30_1024",P1280X960_30_2048:"1280*960_30_2048",P1280X960_30_3072:"1280*960_30_3072",P960X720_30_1024:"960*720_30_1024",P960X720_30_2048:"960*720_30_2048",P960X720_30_3072:"960*720_30_3072",P640X480_30_1024:"640*480_30_1024",P640X480_30_2048:"640*480_30_2048",P640X480_30_3072:"640*480_30_3072",P320X240_30_1024:"320*240_30_1024",P320X240_30_2048:"320*240_30_2048",P320X240_30_3072:"320*240_30_3072",P1280X960_15_1024:"1280*960_15_1024",P1280X960_15_2048:"1280*960_15_2048",P1280X960_15_3072:"1280*960_15_3072",P960X720_15_1024:"960*720_15_1024",P960X720_15_2048:"960*720_15_2048",P960X720_15_3072:"960*720_15_3072",P640X480_15_1024:"640*480_15_1024",P640X480_15_2048:"640*480_15_2048",P640X480_15_3072:"640*480_15_3072",P320X240_15_1024:"320*240_15_1024",P320X240_15_2048:"320*240_15_2048",P320X240_15_3072:"320*240_15_3072",P1280X960_10_1024:"1280*960_10_1024",P1280X960_10_2048:"1280*960_10_2048",P1280X960_10_3072:"1280*960_10_3072",P960X720_10_1024:"960*720_10_1024",P960X720_10_2048:"960*720_10_2048",P960X720_10_3072:"960*720_10_3072",P640X480_10_1024:"640*480_10_1024",P640X480_10_2048:"640*480_10_2048",P640X480_10_3072:"640*480_10_3072",P320X240_10_1024:"320*240_10_1024",P320X240_10_2048:"320*240_10_2048",P320X240_10_3072:"320*240_10_3072",P1280X960_5_1024:"1280*960_5_1024",P1280X960_5_2048:"1280*960_5_2048",P1280X960_5_3072:"1280*960_5_3072",P960X720_5_1024:"960*720_5_1024",P960X720_5_2048:"960*720_5_2048",P960X720_5_3072:"960*720_5_3072",P640X480_5_1024:"640*480_5_1024",P640X480_5_2048:"640*480_5_2048",P640X480_5_3072:"640*480_5_3072",P320X240_5_1024:"320*240_5_1024",P320X240_5_2048:"320*240_5_2048",P320X240_5_3072:"320*240_5_3072"},ChuangMixResolutions:{R800_600:"0",R432_768:"1",R768_432:"2",R1280_720:"3",R720_1280:"4"},ChuangNoticeCode:(e={PUBLISH_SERVER_CONNECTED:1001,PUBLISH_STREAM_START:1002,PUBLISH_FIRST_VIDEO:1007,PUBLISH_CODE_START:1008,CAMERA_OPEN_FAIL:-1301,MICRO_OPEN_FAIL:-1302,VIDEO_CODE_FAIL:-1303,VOICE_CODE_FAIL:-1304,RESOLUTION_UNREPORT:-1305,SAMPLE_UNREPORT:-1306,PUBLISH_RETRY:-1307,PUBLISH_NETDIS:1101,PUBLISH_CODE_FAIL:1104,RTMPSERVER_DISCONN:3004,PULL_SERVER_CONNECTED:2001,PULL_STREAM_START:2002},t(e,"PUBLISH_FIRST_VIDEO",2003),t(e,"VIDEO_PLAY_START",2004),t(e,"PULL_ENCODE_START",2008),t(e,"RESOLUTION_CHANGE",2009),t(e,"PULL_RETRY",-2301),t(e,"VIDEO_ENCODE_FAIL",2101),t(e,"VOICE_ENCODE_FAIL",2102),t(e,"PULL_NETDIS",2103),t(e,"RTMPSERVER_CONN_FAIL",3002),e)};var n=r(393),a=r(878),o=r(218),c=new RegExp(/(?:(\w+):\/\/)?([^/:]+)(?::(\d*))?(?:([\/\w]+))?/),u="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");const _={is:{isFunction:function(e){return"[object Function]"==Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"==Object.prototype.toString.call(e)},isArray:function(e){return Array.isArray?Array.isArray(e):"[object Array]"==Object.prototype.toString.call(e)},isString:function(e){return"[object String]"==Object.prototype.toString.call(e)},isRegex:function(e){return"[object RegExp]"==Object.prototype.toString.call(e)},isInteger:function(e){return"number"==typeof e&&e%1==0},isNumber:function(e){return"number"==typeof e},isBoolean:function(e){return"boolean"==typeof e},isEmpty:function(e){return!e||this.isString(e)&&/^\s*$/.test(e)},isASCII:function(e){return this.isString(e)&&/[\x00-\xff]+/g.test(e)},isLegal:function(e){return!/^\w\-/.test(e)}},dateFtt:function(e,t){var r={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var i in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length))),r)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?r[i]:("00"+r[i]).substr((""+r[i]).length)));return e},curTime:function(){return 0|Date.now()/1e3},curTimeInMilli:function(){return Date.now()},curTimeInUTC:function(){return(new Date).toISOString()},curTimeFtt:function(){var e=new Date;return this.dateFtt("yyyy-MM-dd hh:mm:ss",e)},uuid:function(e,t){var r,i,s=u,n=[];if(t=t||s.length,e)for(r=0;r<e;r++)n[r]=s[0|Math.random()*t];else for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",r=0;r<36;r++)n[r]||(i=0|16*Math.random(),n[r]=s[19==r?3&i|8:i]);return n.join("")},uuidFast:function(){for(var e,t=u,r=new Array(36),i=0,s=0;s<36;s++)8==s||13==s||18==s||23==s?r[s]="-":14==s?r[s]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,r[s]=t[19==s?3&e|8:e]);return r.join("")},randomnum:function(e){var t=Math.pow(10,e-1);return Math.floor(9*Math.random()*t)+t},randomnumExcept:function(e,t){for(var r=Math.pow(10,e-1),i=t;i==t;)i=Math.floor(9*Math.random()*r)+r;return i},randomString:function(e){var t=u,r=t.length,i=[];i[0]=t[0|Math.random()*(r-10)+10];for(var s=1,n=e;s<n;s++)i[s]=t[0|Math.random()*r];return i.join("")},randomChar:function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",r=t.length,i=[];i[0]=t[0|Math.random()*(r-10)+10];for(var s=1,n=e;s<n;s++)i[s]=t[0|Math.random()*r];return i.join("")},lengthInUtf8Bytes:function(e){var t=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(t?t.length:0)},md5String:function(e){return n.md5(e,32)},base64encode:function(e){return a.encode(e)},xxteaDecryptFromBase64:function(e,t){return o.decryptFromBase64(e,t)},copyCCRect:function(e,t){t.left=e.left,t.top=e.top,t.right=e.right,t.bottom=e.bottom},count:function(e){var t=0;for(var r in e)t++;return t},keys:function(e){var t=[];for(var r in e)t.push(r);return t},toHump:function(e){return e.replace(/(?:\_|\.)(\w)/g,(function(e,t){return t.toUpperCase()}))},toLine:function(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()},parseUrl:function(e){if(!e)return null;var t=e.match(c);return t?{scheme:t[1],host:t[2],port:parseInt(t[3])||0,path:t[4]}:null},appendUrl:function(e,t){if(e.match(c)){var r=[],i=e.indexOf("?");for(var s in t)!1!==i?(i<0?r.push("?"):i<e.length-1&&r.push("&"),i=!1):r.push("&"),r.push(s),r.push("="),r.push(encodeURIComponent(t[s]));return e+r.join("")}return""},toStringfy:function(e){return JSON.stringify(e)}};function h(e,t){for(var r in t){var i=t[r];e=e.replace(new RegExp("\\$\\{"+r+"\\}","gm"),i)}return e}function l(e,t,r){if(e){var i,s=e.replace(/-/g,"_"),n={code:e,no:0};return l.CODE.CHUANG_LOGIN_FAILED_APPID===e||l.CODE.CHUANG_WEBRTC_SIGNAL_ERROR===e?n.no=r&&r.errcode?r.errcode:-1:n.no=l.ErrorCode[s]||-1,t?n.msg=r?h(t,r):t:(i=l.MSG[s])&&(n.msg=r?h(i,r):i),n}}l.CODE={CHUANG_ENGINE_NOT_INIT:"CHUANG_ENGINE_NOT_INIT",CHUANG_APPID_NULL:"CHUANG_APPID_NULL",CHUANG_APPID_INVALID:"CHUANG_APPID_INVALID",CHUANG_APPKEY_NULL:"CHUANG_APPKEY_NULL",CHUANG_APPKEY_INVALID:"CHUANG_APPKEY_INVALID",CHUANG_INVALID_PARAMETERS:"CHUANG_INVALID_PARAMETERS",CHUANG_ROLE_PERMISSION_ERROR:"CHUANG_ROLE_PERMISSION_ERROR",CHUANG_NOT_LOGIN:"CHUANG_NOT_LOGIN",CHUANG_PUBLISH_STREMID_AUTH_FAILED:"CHUANG_PUBLISH_STREMID_AUTH_FAILED",CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:"CHUANG_STREAM_DISCONNECTED_BAD_NETWORK",CHUANG_WEBRTC_CHANNEL_EXISTS:"CHUANG_WEBRTC_CHANNEL_EXISTS",CHUANG_USERID_NULL:"CHUANG_USERID_NULL",CHUANG_USERID_TOO_LONG:"CHUANG_USERID_TOO_LONG",CHUANG_USERID_INVALID:"CHUANG_USERID_INVALID",CHUANG_ROOMID_NULL:"CHUANG_ROOMID_NULL",CHUANG_ROOMID_TOO_LONG:"CHUANG_ROOMID_TOO_LONG",CHUANG_ROOMID_INVALID:"CHUANG_ROOMID_INVALID",CHUANG_MIX_STREAMID_NULL:"CHUANG_MIX_STREAMID_NULL",CHUANG_MIX_STREAMID_TOO_LONG:"CHUANG_MIX_STREAMID_TOO_LONG",CHUANG_MIX_STREAMID_INVALID:"CHUANG_MIX_STREAMID_INVALID",CHUANG_MIX_STREAM_PARAMETER_INVALID:"CHUANG_MIX_STREAM_PARAMETER_INVALID",CHUANG_MIX_STREAM_ADDRESS_INVALID:"CHUANG_MIX_STREAM_ADDRESS_INVALID",CHUANG_MIX_STREAM_CONFIG_ERROR:"CHUANG_MIX_STREAM_CONFIG_ERROR",CHUANG_STREAMID_EXIST:"CHUANG_STREAMID_EXIST",CHUANG_MIX_STREAM_TOO_MUCH:"CHUANG_MIX_STREAM_TOO_MUCH",CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:"CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED",CHUANG_TOKEN_AUTH_ERROR:"CHUANG_TOKEN_AUTH_ERROR",CHUANG_TOKEN_AUTH_FAILED:"CHUANG_TOKEN_AUTH_FAILED",CHUANG_MIX_STREAM_BEFORE_PUBLISH:"CHUANG_MIX_STREAM_BEFORE_PUBLISH",CHUANG_LOGIN_FAILED_APPID:"CHUANG_LOGIN_FAILED_APPID",CHUANG_LOGIN_FAILED_BANNED:"CHUANG_LOGIN_FAILED_BANNED",CHUANG_LOGIN_FAILED:"CHUANG_LOGIN_FAILED",CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:"CHUANG_ROOM_DISCONNECTED_BAD_NETWORK",CHUANG_LOGIN_FAILED_PARAM_ERROR:"CHUANG_LOGIN_FAILED_PARAM_ERROR",CHUANG_ROOM_RECONNECTED:"CHUANG_ROOM_RECONNECTED",CHUANG_STREAMID_NULL:"CHUANG_STREAMID_NULL",CHUANG_STREAMID_TOO_LONG:"CHUANG_STREAMID_TOO_LONG",CHUANG_STREAMID_INVALID:"CHUANG_STREAMID_INVALID",CHUANG_PUBLISH_STREAM_RECONNECTED:"CHUANG_PUBLISH_STREAM_RECONNECTED",CHUANG_PLAY_STREAM_RECONNECTED:"CHUANG_PLAY_STREAM_RECONNECTED",CHUANG_WEBRTC_UNKNOWN_ERROR:"CHUANG_WEBRTC_UNKNOWN_ERROR",CHUANG_WEBRTC_SIGNAL_ERROR:"CHUANG_WEBRTC_SIGNAL_ERROR"},l.ErrorCode={CHUANG_SUCCESS:0,CHUANG_ENGINE_NOT_INIT:10001,CHUANG_APPID_NULL:10002,CHUANG_APPID_INVALID:10003,CHUANG_APPKEY_NULL:10004,CHUANG_APPKEY_INVALID:10005,CHUANG_INVALID_PARAMETERS:10008,CHUANG_ROLE_PERMISSION_ERROR:10009,CHUANG_USERID_NULL:11001,CHUANG_USERID_TOO_LONG:11002,CHUANG_USERID_INVALID:11003,CHUANG_ROOMID_NULL:11004,CHUANG_ROOMID_TOO_LONG:11005,CHUANG_ROOMID_INVALID:11006,CHUANG_TOKEN_AUTH_ERROR:11007,CHUANG_TOKEN_AUTH_FAILED:11008,CHUANG_LOGIN_FAILED_APPID:11009,CHUANG_LOGIN_FAILED_BANNED:11010,CHUANG_LOGIN_FAILED:11011,CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:11012,CHUANG_LOGIN_FAILED_PARAM_ERROR:11013,CHUANG_ROOM_RECONNECTED:11014,CHUANG_STREAMID_NULL:12001,CHUANG_STREAMID_TOO_LONG:12002,CHUANG_STREAMID_INVALID:12003,CHUANG_STREAMID_EXIST:12007,CHUANG_NOT_LOGIN:12008,CHUANG_PUBLISH_STREMID_AUTH_FAILED:12012,CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:12013,CHUANG_PUBLISH_STREAM_RECONNECTED:12025,CHUANG_PLAY_STREAM_RECONNECTED:12026,CHUANG_MIX_STREAM_ADDRESS_INVALID:13001,CHUANG_MIX_STREAMID_TOO_LONG:13002,CHUANG_MIX_STREAM_TOO_MUCH:13003,CHUANG_MIX_STREAM_BEFORE_PUBLISH:13004,CHUANG_MIX_STREAM_CONFIG_ERROR:13005,CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:13006,CHUANG_MIX_STREAM_PARAMETER_INVALID:13007,CHUANG_MIX_STREAMID_NULL:13008,CHUANG_MIX_STREAMID_INVALID:13009,CHUANG_WEBRTC_ADDRESS_INVALID:100002,CHUANG_WEBRTC_BROWSER_NOT_SUPPORTED:100003,CHUANG_WEBRTC_VIDEO_DEVICE_PERMISSION_DENINED:100004,CHUANG_WEBRTC_MEDIA_DEVICE_OPEN_FAILED:100005,CHUANG_WEBRTC_CHANNEL_EXISTS:100009,CHUANG_WEBRTC_UNKNOWN_ERROR:100011,CHUANG_WEBRTC_SIGNAL_ERROR:100012},l.MSG={CHUANG_ENGINE_NOT_INIT:"sdk未初始化，就调用非静态方法",CHUANG_APPID_NULL:"appId为空",CHUANG_APPID_INVALID:"appId包含非法字符",CHUANG_APPKEY_NULL:"appKey传空",CHUANG_APPKEY_INVALID:"appKey 包含非法字符",CHUANG_INVALID_PARAMETERS:"参数错误",CHUANG_ROLE_PERMISSION_ERROR:"操作与角色不符",CHUANG_NOT_LOGIN:"未登录房间或登录房间未成功，调用推流、拉流前必须登录房间成功",CHUANG_PUBLISH_STREMID_AUTH_FAILED:"推流ID非法，可能已经被占用",CHUANG_STREAM_DISCONNECTED_BAD_NETWORK:"网络原因导致推流或播流中断重连",CHUANG_USERID_NULL:"用户ID为空",CHUANG_USERID_TOO_LONG:"用户ID过长，长度应小于256字节，最长为255字节",CHUANG_USERID_INVALID:"用户ID非法",CHUANG_ROOMID_NULL:"房间ID为空",CHUANG_ROOMID_TOO_LONG:"房间ID过长，长度应小于256字节，最长为255字节",CHUANG_ROOMID_INVALID:"用户ID非法",CHUANG_MIX_STREAMID_NULL:"混流ID为空",CHUANG_MIX_STREAMID_TOO_LONG:"混流ID过⻓ ⻓度应⼩于256字节，最长为255字节",CHUANG_MIX_STREAMID_INVALID:"混流ID包含非法字符",CHUANG_MIX_STREAM_PARAMETER_INVALID:"混流参数错误",CHUANG_MIX_STREAM_ADDRESS_INVALID:"RTMP地址非法",CHUANG_MIX_STREAM_CONFIG_ERROR:"混流配置设置错误",CHUANG_STREAMID_EXIST:"流ID已经存在",CHUANG_WEBRTC_CHANNEL_EXISTS:"已经存在一个主流或副流",CHUANG_MIX_STREAM_TOO_MUCH:"混入输入流数量过多，最多允许混9路流",CHUANG_MIX_STREAM_RESOLUTION_NO_SUPPORTED:"混流输出分辨率不支持",CHUANG_MIX_STREAM_BEFORE_PUBLISH:"未推流成功就发起混流",CHUANG_TOKEN_AUTH_ERROR:"token 校验出错，可能是token过期或者token传错",CHUANG_TOKEN_AUTH_FAILED:"token校验失败，可能是网络异常导致校验超时",CHUANG_LOGIN_FAILED_APPID:"登录失败,一般是AppId/AppKey错误导致",CHUANG_LOGIN_FAILED_BANNED:"由于被封禁导致登录失败",CHUANG_LOGIN_FAILED:"其他原因导致登录失败",CHUANG_ROOM_DISCONNECTED_BAD_NETWORK:"网络原因导致房间链接断开",CHUANG_LOGIN_FAILED_PARAM_ERROR:"参数错误导致登录失败，login.ack中errcode 为-202时",CHUANG_ROOM_RECONNECTED:"房间重连成功",CHUANG_STREAMID_NULL:"流ID为空",CHUANG_STREAMID_TOO_LONG:"流ID过长，长度应小于256字符，最长为255字符",CHUANG_STREAMID_INVALID:"流ID包含非法字符",CHUANG_PUBLISH_STREAM_RECONNECTED:"推流重连成功",CHUANG_PLAY_STREAM_RECONNECTED:"播流重连成功",CHUANG_WEBRTC_UNKNOWN_ERROR:"未知错误",CHUANG_WEBRTC_SIGNAL_ERROR:"信令服务错误"};const m=l;const E={DPServer:["https://glb.aocrtcr.com"],DP_Reconn_Retry:1,DP_Conn_Timeout:5e3,DP_Cache_Time:1e4,UIDServer:["https://config.aocrtcr.com"],UID_Reconn_Retry:2,UID_Conn_Timeout:5e3,UID_Cache_Time:864e5,KEYServer:["https://config.aocrtcr.com"],KEY_Reconn_Retry:2,KEY_Conn_Timeout:5e3,KEY_Cache_Time:864e5,TOKENServer:["https://api-rtc.chuangcache.com"],TOKEN_Reconn_Retry:2,TOKEN_Conn_Timeout:5e3,TOKEN_Cache_Time:36e5,CONFIGServer:["https://config.aocrtcr.com"],CONFIG_Reconn_Retry:2,CONFIG_Conn_Timeout:5e3,CONFIG_Cache_Time:1e4,FOLLOWServer:["39-107-92-147-wsm.aocrtcr.com:7801"],FOLLOW_Reconn_Retry:3,FOLLOW_Conn_Timeout:5e3,RTCConfig:{client:{device:"unknown",ip:"124.202.169.82",uid:0},message_server:{retry_count:3},udp:{publish_retry_count_normal:1,publish_retry_count_nat:3,watch_retry_count_normal:1,watch_retry_count_nat:3}},StunServer:["stun:config.aocrtcr.com:3688"],SerUploadServer:"https://report.aocrtcr.com:8190",LogUpload:!1,LogUploadServer:"https://api-rtc.chuangcache.com",LogUploadItvl:6e5,LogUploadKeys:["crtc","dyf8c4HhBsciG31iSRFYKlHwpAGfyeVn"],EventUploadServer:"https://api-rtc.chuangcache.com",EventUploadKeys:["crtc","dyf8c4HhBsciG31iSRFYKlHwpAGfyeVn"],AjaxTimeout:6e3,Signal_Conn_Timeout:6e3,Signal_Reconn_Delay:1e3,Signal_Reconn_Retry:3,Signal_Ping_Interval:1e4,Signal_Pong_Timeout:3e4,Signal_login_Timeout:5e3,Signal_authpublish_Timeout:1e4,Signal_startpublish_Timeout:1e4,Signal_stoppublish_Timeout:1e4,Signal_startplay_Timeout:1e4,Signal_stopplay_Timeout:1e4,Signal_logout_Timeout:1e4,Signal_reqlist_Timeout:1e4,Signal_reqmerge_Timeout:1e4,Signal_stopmerge_Timeout:1e4,Signal_reqmergestat_Timeout:1e4,Signal_setwatchinfo_Timeout:5e3,Signal_Stream_Heartbeat_Interval:5e3,Signal_mergestat_Timeout:3e4,Room_uid_Timeout:3e3,Room_dp_Timeout:3e3,Room_key_Timeout:3e3,Room_tk_Timeout:1e3,Mix_Stream_Gain:"1.0",Mix_Stream_Back:"1",Mix_Stream_Mixa:"255",Mix_Stream_Mixv:"1"};function d(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var T=r(788);var S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._listeners={},this.on=this.addEventListener,this.off=this.removeEventListener,this._linkers=null,this.linkname=null,this.linktag=null,this.timerId=null,this.timerFunc=null,this.timerFlag=!0}var t,r,i;return t=e,i=[{key:"changeTimerCore",value:function(e){e&&(R=e)}},{key:"getTimerCore",value:function(){return R}},{key:"createEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i={};return i.type=e,i.intransit=!1,i.event={type:t},r&&(i.event.data=r),i}}],(r=[{key:"uninit",value:function(){for(var e in this._listeners)delete this._listeners[e];this.linkClose(),this.timerDisable()}},{key:"addEventListener",value:function(e,t){return void 0===this._listeners[e]&&(this._listeners[e]=[]),"function"==typeof t&&this._listeners[e].push(t),this}},{key:"hasListeners",value:function(e){return!(!this._listeners[e]||!this._listeners[e].length)}},{key:"removeEventListener",value:function(e,t){var r;return this._listeners[e]&&-1!==(r=this._listeners[e].indexOf(t))&&this._listeners[e].splice(r,1),this}},{key:"removeEvent",value:function(e){return this._listeners[e]&&delete this._listeners[e],this}},{key:"dispatchEvent",value:function(e){var t;for(t in this._listeners[e.type])if(this._listeners[e.type]&&this._listeners[e.type].hasOwnProperty(t)&&"function"==typeof this._listeners[e.type][t])try{this._listeners[e.type][t](e.event)}catch(r){console.debug("[".concat(e.type,"] Error ").concat(t," event"),r)}if(this._linkers)for(var r=0,i=this._linkers.length;r<i;r++){var s=this._linkers[r];C.transmit(s,e,this)}}},{key:"linkOpen",value:function(e){if(e)return this.linkname=e,C.regist(e,this),this}},{key:"linkClose",value:function(){this.linkname&&C.unregist(this.linkname)}},{key:"linkTag",value:function(e){return this.linktag=e,this}},{key:"linkAdd",value:function(e){this._linkers||(this._linkers=[]),this._linkers.push(e)}},{key:"linkRemove",value:function(e){if(this._linkers){var t=this._linkers.indexOf(e);t>-1&&this._linkers.splice(t,1)}}},{key:"timerEnable",value:function(e){return e&&(this.timerFunc=e,!this.timerId&&(this.timerId=R.regist(this))),this}},{key:"timerDisable",value:function(){this.timerId&&R.unregist(this.timerId),this.timerId=null,this.timerFunc=null}},{key:"timerAdd",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;i=i||e;var s={type:e,data:r};R.commit(this.timerId,i,s,t)}},{key:"timerRemove",value:function(e){R.uncommit(this.timerId,e)}},{key:"timerStart",value:function(){this.timerFlag=!0}},{key:"timerStop",value:function(){this.timerFlag=!1}}])&&d(t.prototype,r),i&&d(t,i),e}();S.Type={SOCKET:"socket",HEARTBEAT:"heartbeat",WATCHER:"watcher",SIGNAL:"signal",SIGNAL_STM:"signal-stream",STREAM:"stream",RESOURCE:"resource",TIMER:"timer"},S.Create={socket:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return S.createEvent("socket",e,t)},heartbeat:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return S.createEvent("heartbeat",e,t)},signal:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return S.createEvent("signal",e,t)},signal_stream:function(e,t){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(r=S.createEvent("signal-stream",e,i)).event.streamId=t,r},stream:function(e,t){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(r=S.createEvent("stream",e,i)).event.streamId=t,r},resource:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return S.createEvent("resource",e,t)}},S.Name={room:function(e){return"room#"+e}};const p=S;var C={_ebevents:{},_eventInterceptor:null,regist:function(e,t){if(this._ebevents[e])throw new Error("duplicate event: "+e);this._ebevents[e]=t},unregist:function(e){delete this._ebevents[e]},transmit:function(e,t,r){var i=null;return!!(i=this._ebevents[e])&&(!t.intransit&&(t.intransit=!0,i.dispatchEvent(t),t.intransit=!1,!0))}},R={itvl:null,curtick:0,curticktime:0,timerIndex:100,embEvents:{},timerobjss:{},timerobjcount:0,regist:function(e){return this.embEvents[this.timerIndex]=e,this.timerobjss[this.timerIndex]={},this.timerIndex++},unregist:function(e){var t=this.timerobjss[e];if(t){var r=0;for(var i in t)r++;this.timerobjcount-=r,delete this.timerobjss[e]}delete this.embEvents[e]},commit:function(e,t,r,i){var s=this;if(this.embEvents[e])if(this.timerobjss[e][t])T.log("Timer add duplicate hashkey: "+t);else{var n=i<0;i<0&&(i=-i);var a={data:r,interval:i,lasttick:Date.now()-(n?i:0)};this.timerobjss[e][t]=a,this.timerobjcount++,this.itvl||(this.curtick=Date.now(),this.itvl=setInterval((function(){for(var e in s.timerobjss){var t=s.embEvents[e];if(t.timerFlag){var r=s.timerobjss[e];for(var i in r){var n=r[i];n.lasttick+n.interval<=s.curtick&&(n.lasttick=s.curtick,t.timerFunc(n.data))}}}s.curtick+=200,s.curticktime++,s.curticktime>300&&(s.curticktime=0,s.curtick=Date.now())}),200))}},uncommit:function(e,t){this.embEvents[e]&&this.timerobjss[e][t]&&(delete this.timerobjss[e][t],this.timerobjcount--,0==this.timerobjcount&&(clearInterval(this.itvl),this.itvl=null))}};function A(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}const O=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.streamstat=Kt.ChuangStreamMode.BOTH,this.video=s.VIDEO_SOURCE.CAMERA,this.audio=s.AUDIO_SOURCE.MICROPHONE,this.cameraId=null,this.microphoneId=null,this.rtmpAddress="",this.mediaWidth=null,this.mediaHeight=null,this.fps=null,this.maxBitrateInKbps=500}var t,r,i;return t=e,(r=[{key:"useCamera",value:function(){return this.video=s.VIDEO_SOURCE.CAMERA,this}},{key:"isCamera",value:function(){return this.video==s.VIDEO_SOURCE.CAMERA}},{key:"useScreen",value:function(){return this.video=s.VIDEO_SOURCE.SCREEN,this}},{key:"isScreen",value:function(){return this.video==s.VIDEO_SOURCE.SCREEN}},{key:"useMicrophone",value:function(){return this.audio=s.AUDIO_SOURCE.MICROPHONE,this}},{key:"useDesktopAudio",value:function(){return this.audio=s.AUDIO_SOURCE.DESKTOP,this}},{key:"setStreamstat",value:function(e){return this.streamstat=e,this}},{key:"setCameraId",value:function(e){return this.cameraId=e,this}},{key:"setMicrophoneId",value:function(e){return this.microphoneId=e,this}},{key:"setRtmpAddress",value:function(e){return this.rtmpAddress=e,this}},{key:"setVideoConfigPreset",value:function(e){var t=e.split(/[*_]/);return this.setVideoResolution(t[0],t[1]),this.setVideoFps(t[2]),this.setVideoBitrate(t[3]),this}},{key:"setVideoResolution",value:function(e,t){return e=parseInt(e),t=parseInt(t),!e||e<240||!t||t<180||(this.mediaWidth=e,this.mediaHeight=t),this}},{key:"setVideoFps",value:function(e){return!(e=parseInt(e))||e<5||(this.fps=e),this}},{key:"setVideoBitrate",value:function(e){return!(e=parseInt(e))||e<32||(this.maxBitrateInKbps=e),this}}])&&A(t.prototype,r),i&&A(t,i),e}();function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function P(e,t,r){return t&&f(e.prototype,t),r&&f(e,r),e}const v=function(){function e(t,r){I(this,e),this.streamId=t,this.islocal=!!r,this.streaminConfig=this.islocal?new N(r):null,this.roomid=null,this.sparam=null,this.domId=null,this.video_mute=!1,this.audio_mute=!1,this.bitrate=r.maxBitrateInKbps||500,this.pluginHandle=null,this.event=new p}return P(e,[{key:"linkEvent",value:function(e){this.event.linkAdd(e)}},{key:"unlinkEvent",value:function(e){this.event.linkRemove(e)}},{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"getStreamId",value:function(){return this.streamId}},{key:"getroomid",value:function(){return this.roomid}},{key:"setSparam",value:function(e){return this.sparam=e,this}},{key:"getSparam",value:function(){return this.islocal?null:this.sparam}},{key:"setDomId",value:function(e){return this.domId=e,this}},{key:"getStreamConfig",value:function(){return this.islocal?this.streaminConfig:null}},{key:"isMain",value:function(){return!this.islocal||s.ChuangPublishChannel.MAIN==this.streaminConfig.channel}},{key:"isAux",value:function(){return!this.islocal||s.ChuangPublishChannel.AUX==this.streaminConfig.channel}},{key:"isCamera",value:function(){return!this.islocal||s.VIDEO_SOURCE.CAMERA==this.streaminConfig.video}},{key:"isScreen",value:function(){return!!this.islocal&&s.VIDEO_SOURCE.SCREEN==this.streaminConfig.video}}],[{key:"wrapCreateOfferError",value:function(t){if(t){if("No capture device found"==t)return m(m.Code.WEBRTC_NOT_FOUND);if("NotAllowedError"==t.name)return m(m.CODE.WEBRTC_NOT_ALLOW);if("NotReadableError"==t.name)return m(m.CODE.WEBRTC_NOT_READABLE);if("NotFoundError"===t.name)return m(m.CODE.WEBRTC_NOT_FOUND)}var r=e.errorToMessage(t);return m(m.CODE.WEBRTC_CREATE_OFFER,null,{err:r})}},{key:"errorToMessage",value:function(e){return _.is.isObject(e)?e.message?e.message:JSON.stringify(e):_.is.isString(e)?e:null}}]),e}();var g={WIDTH:320,HEIGHT:240,FRAMERATE:30},N=function(){function e(t){I(this,e),this.streamstat=t.streamstat,this.video=t.video,this.audio=t.audio,this.cameraId=t.cameraId,this.microphoneId=t.microphoneId,this.rtmpAddr=t.rtmpAddress;var r=s.VIDEO_SOURCE.CAMERA==this.video?g:DEFAULT_SCREEN;this.frameRate=s.VIDEO_SOURCE.CAMERA==this.video?r.FRAMERATE:t.fps?t.fps:r.FRAMERATE,this.videoWidth=t.mediaWidth?t.mediaWidth:r.WIDTH,this.videoHeight=t.mediaHeight?t.mediaHeight:r.HEIGHT,this.initBandwidth=t.maxBitrateInKbps?t.maxBitrateInKbps<<10:1048576,this.keyframeInterval=2e3,this.maxBitrateInKbps=t.maxBitrateInKbps,this.resolution=307200,this.puship="",this.pushport="",this.pullip="",this.pullport="",this.pushUrl="",this.pullUrl="",this.pushStatus=""}return P(e,[{key:"getRtmpAddr",value:function(e,t,r){var i=_.appendUrl(this.rtmpAddr,{uid:e,expass:t});return""!=i?i+"/"+r:""}}]),e}(),U=r(788),L=r.n(U);function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function M(e,t,r){return t&&y(e.prototype,t),r&&y(e,r),e}var G=1,k=9,H={},b={},x={},w=[],F={},Y={},K=function(){function e(t,r){D(this,e),this.uid=t,this.tag=r,this.bindTarget=null,this.data=null,this.exdata=null,this.machineFunc=null,this.inFinPhase=!1,this.processFunc=null,this.inFinProcess=!1,this.curPhaseItem=null,this.nextPhase=e.DONE,this.curProcItems={},this.curProcRes=null,this.dest=[],this.mstat=k,this.error=null,this.autoremove=!1,this.startTime=0,this.endTime=0,this.records=null,this.recording=!1}return M(e,[{key:"summary",value:function(){var e=this.bind;this.bind=null;var t=JSON.stringify(this);return this.bind=e,t}},{key:"record",value:function(){return this.recording=!0,this.records=[],this}},{key:"bind",value:function(e){return this.bindTarget=e,this}},{key:"bindData",value:function(e){return this.data=e,this.exdata=e,this}},{key:"defMachine",value:function(e){return this.machineFunc=e,this}},{key:"start",value:function(e,t,r){if(this.machineFunc){var i={actTag:this.tag,actUId:this.uid,phase0:e,phase:e,params:t,dest:r};V.queueAct(this,i)}}},{key:"cancel",value:function(e){this.mstat==G&&V.unphase0(this,e||!1)}},{key:"setError",value:function(e){this.error=e}},{key:"isActive",value:function(){return this.mstat==G}},{key:"isPhase",value:function(e){return this.curPhaseItem&&this.curPhaseItem==e}},{key:"jump",value:function(e,t){if(this.mstat===G){for(var r in this.curProcItems){var i=this.curProcItems[r];V.clearProcess(i)}this.curProcItems={},this.curProcRes=t,this.nextPhase=e,V.nextPhase(this)}}},{key:"stop",value:function(){e.cutail(this.tag),this.cancel(!1)}},{key:"defProcess",value:function(e){return this.processFunc=e,this}},{key:"process",value:function(e,t,r,i){if(this.inFinPhase)L().log("process in fin$ phase: "+this.curPhaseItem.phase);else{var s=this.curProcItems[e];if(s)return L().log("process "+e+" exists at phase: "+this.curPhaseItem.phase),void L().log("hint: use process#1...n as your process instead.");s={procTag:r,actUId:this.uid,process:e,params:t,timeout:i&&_.is.isInteger(i)?i:null,timeoutId:null},this.curProcItems[e]=s,V.queueProcess(s),this.recording&&this.inFinProcess&&V.recordProcess(this,e)}}},{key:"finished",value:function(t,r){if(!this.curProcItems[t])return!1;var i=this.curProcItems[t];if(!V.shiftProcess(i))return!1;if(delete this.curProcItems[t],this.processFunc&&(this.inFinProcess=!0,this.processFunc.call(this.bindTarget,e.$.FIN+t,r,this),this.inFinProcess=!1),this.curProcRes[t]=r,0===_.count(this.curProcItems)){this.inFinPhase=!0;var s=this.machineFunc.call(this.bindTarget,e.$.FIN+this.curPhaseItem.phase,this.curProcRes,this);s&&e.NULL!==s&&(this.nextPhase=s),this.inFinPhase=!1,V.nextPhase(this)}return!0}},{key:"failed",value:function(e,t){if(!this.curProcItems[e])return!1;var r=this.curProcItems[e];return!!V.shiftProcess(r)&&(delete this.curProcItems[e],this.mstat==G?V.unphase0(this,t):V.clearup(this),!0)}},{key:"repeat",value:function(e){if(!this.curProcItems[e])return!1;var t=this.curProcItems[e];return!!V.isProcessing(t)&&(j.uncommit(t),q.commit(t),!0)}},{key:"result",value:function(e,t){this.curProcRes[e]=t}}],[{key:"onQueue",value:function(e,t){_.is.isRegex(e)?w.push({regex:e,func:t}):x[e]=t}},{key:"cutail",value:function(e){var t=b[e];!t||t.length<=1||t.splice(1,t.length-1)}},{key:"create",value:function(t,r){if(!t)return null;if(!r)return null;if(H[t])throw new Error("duplicate act: "+t);var i;return i=new e(t,r),H[t]=i,i}},{key:"find",value:function(e){var t;return(t=H[e])?t:null}},{key:"remove",value:function(e){var t=H[e];if(t){t.mstat==G&&V.unphase0(t,!1);var r=t.tag,i=b[r];i&&0!=i.length?i[0]==t.curPhaseItem&&(t.autoremove=!0):V.deleteAct(t)}}},{key:"finish",value:function(e,t){for(var r in H){if(H[r].finished(e,t))break}}},{key:"fail",value:function(e,t){for(var r in H){if(H[r].failed(e,t))break}}},{key:"setProcKey",value:function(e){Y[e]=1}},{key:"unsetProcKey",value:function(e){delete Y[e]}},{key:"changeItemDriveCore",value:function(e,t){e&&t&&(W.setDriveCore(e),q.setDriveCore(t))}},{key:"changeTimeoutDriveCore",value:function(e){e&&j.setDriveCore(e)}},{key:"setFlow",value:function(e,t){return _.is.isObject(e)?(e.flow=t,e):{flow:t}}},{key:"getFlow",value:function(e){return e&&e.curPhaseItem&&e.curPhaseItem.params&&e.curPhaseItem.params.flow}}]),e}();K.$={UN:"un$",FIN:"fin$",TO:"to$"},K.DONE="$done",K.SKIP="$skip",K.NULL="$null",K.dummy=K.create("dummy","dummy"),K.dummy.defMachine((function(){return K.DONE})).defProcess((function(){}));var V={unphase0:function(e,t){e.mstat=k,e.error=t;var r=e.curProcItems;e.curProcItems={};var i=null;try{i=e.machineFunc.call(e.bindTarget,K.$.UN+e.curPhaseItem.phase0,void 0,e)}catch(e){}if(i){for(var s in r)V.clearProcess(r[s]);r=null,e.curPhaseItem.phase=K.$.UN+e.curPhaseItem.phase0,e.nextPhase=i,e.recording&&V.record(e),0==_.count(e.curProcItems)&&V.nextPhase(e)}else e.curProcItems=r,!1!==t?V.clearup(e):(e.mstat=G,e.error=null)},clearup:function(e){for(var t in e.curProcItems){var r=e.curProcItems[t];V.clearProcess(r)}e.curProcItems={},e.curProcRes=null,e.nextPhase=K.DONE,V.callDest(e),V.shiftPhase(e)},callDest:function(e){e.endTime=Date.now(),e.curPhaseItem.phase=K.DONE,e.mstat=k;var t=null;if(null===e.error){var r=0;for(var i in e.curProcRes)t=e.curProcRes[i],r++;1!=r&&(t=e.curProcRes)}for(var s=e.dest,n=0,a=s.length;n<a;n++)try{s[n]&&s[n](t,e.error,e)}catch(e){L().log("calldest error"+e,"error")}e.dest.splice(0,a),e.error=null},deleteAct:function(e){e.bindTarget=null,e.data=null,e.exdata=null,e.dest=null,delete H[e.uid]},queueAct:function(e,t){var r=t.actTag,i=b[r];if(i||(i=[],b[r]=i),i.length>=1){var s=x[r];if(s)s.call(e,i,t);else for(var n=0,a=w.length;n<a;n++)if(w[n].regex.test(r)){w[n].func.call(e,i,t);break}}i.push(t),1==i.length&&W.commit(t)},shiftPhase:function(e){var t=e.tag,r=b[t];r.length&&r.shift(),r.length?(e.autoremove=!1,W.commit(r[0])):e.autoremove&&V.deleteAct(e)},nextPhase:function(e){e.curPhaseItem.phase=e.nextPhase,W.commit(e.curPhaseItem)},queueProcess:function(e){var t=e.procTag;if(null!=t&&Y[t]){var r=F[t];r||(r=[],F[t]=r),r.push(e),1==r.length&&q.commit(e)}else q.commit(e)},shiftProcess:function(e){var t=e.procTag;if(j.uncommit(e),null==t||!Y[t])return!0;var r=F[t];return!(!r.length||r[0]!==e)&&(r.shift(),r.length&&q.commit(r[0]),!0)},clearProcess:function(e){var t=e.procTag;if(j.uncommit(e),null!=t&&Y[t]){for(var r=F[t],i=!1,s=0,n=r.length;s<n;s++)r[s]==e&&(0==s&&(i=!0),r.splice(s,1),s--,n--);r.length&&i&&q.commit(r[0])}},isProcessing:function(e){var t=e.procTag;if(null==t||!Y[t])return!0;var r=F[t];return!(!r.length||r[0]!==e)},resetRecord:function(e){e.records.splice(0,e.records.length)},record:function(e){var t={phase:e.curPhaseItem.phase,processes:V.listProcItem(e.curProcItems)};e.records.push(t)},recordProcess:function(e,t){e.records.length&&e.records[e.records.length-1].processes.push(t)},listProcItem:function(e){var t=[];for(var r in e)t.push(r);return t},reset:function(){var e;for(var t in b={},F={},H)(e=H[t]).mstat==G&&V.clearup(e)}},B=function(){function e(t,r){D(this,e),this.driveFunc=r,this.driveCore=t,this.driveId=this.driveCore.regist(this)}return M(e,[{key:"setDriveCore",value:function(e){this.driveCore.unregist(this),this.driveCore=e,this.driveId=this.driveCore.regist(this)}},{key:"commit",value:function(e){this.driveCore.commit(this.driveId,e)}},{key:"uncommit",value:function(e){this.driveCore.uncommit(this.driveId,e)}},{key:"drive",value:function(e){for(var t,r=0,i=e.length;r<i;r++)t=this.driveFunc(e[r]);if(t)throw t}}]),e}(),X={driveMax:156,driveTime:0,itvl:0,drives:[],itemss:[],regist:function(e){return this.drives.push(e),this.itemss.push([]),this.drives.length-1},unregist:function(e){var t=this.drives.indexOf(e);t>=0&&(this.drives.splice(t,1),this.itemss.splice(t,1))},commit:function(e,t){var r=this;e>=this.drives.length||(this.itemss[e].push(t),this.itvl||(this.itvl=setInterval((function(){for(var e=0,t=r.drives.length;e<t;e++){var i=r.itemss[e];i.length&&r.drives[e].drive(i.splice(0,i.length))}var s=!0;for(e=0,t=r.drives.length;e<t;e++)if(r.itemss[e].length>0){s=!1;break}s&&r.driveTime++,r.driveTime>=r.driveMax&&(clearInterval(r.itvl),r.itvl=0,r.driveTime=0)}),64)))}},W=new B(X,(function(e){var t=e.actTag;if(e===(b[t]&&b[t].length?b[t][0]:null)){var r=e.actUId,i=H[r],s=null;if(i)for(;;){if(e.phase==K.DONE)return V.callDest(i),void V.shiftPhase(i);e.phase==e.phase0?(i.recording&&V.resetRecord(i),i.curPhaseItem!=e&&(i.curPhaseItem=e,i.startTime=Date.now(),i.dest.splice(0,i.dest.length),i.dest.push(e.dest),delete e.dest,i.mstat=G),s=e.params):s=i.curProcRes,i.curProcItems={},i.curProcRes={};try{i.nextPhase=i.machineFunc.call(i.bindTarget,e.phase,s,i)}catch(e){return L().log(e+"---"+r),void(i.mstat==G?V.unphase0(i,m(m.CODE.UNKNOWN_ERROR,null,{err:e.message})):V.clearup(i))}if(!i.nextPhase)return new Error("machine returns empty("+e.phase0+"/"+e.phase+")");if(i.nextPhase===K.SKIP){for(var n in i.curProcRes=null,i.curProcItems)V.clearProcess(i.curProcItems[n]);i.curProcItems={},i.error=!1,i.nextPhase=K.DONE}else if(i.nextPhase==e.phase0){for(var n in i.curProcItems)V.clearProcess(i.curProcItems[n]);return i.curProcItems={},new Error("phase back to 0("+e.phase0+")")}if(i.recording&&V.record(i),0!=_.count(i.curProcItems))return;i.curPhaseItem.phase=i.nextPhase}}})),q=new B(X,(function(e){var t=e.actUId,r=e.process,i=H[t];if(i&&i.curProcItems[r]===e)try{if(!i.processFunc)return void i.finished(r,null);i.processFunc.call(i.bindTarget,r,e.params,i),e.timeout&&j.commit(e)}catch(e){L().log("".concat(e,", ").concat(t,", ").concat(r)),i.failed(r,m(m.CODE.UNKNOWN_ERROR,null,{err:e.message}))}})),j=new B({drive:null,items:{},regist:function(e){return this.drive=e,0},unregist:function(e){this.drive=null},commit:function(e,t){var r=this;if(!t.timeout)return!1;t.timeoutId&&clearTimeout(t.timeoutId),t.timeoutId=setTimeout((function(){delete r.items[t.timeoutId],t.timeoutId=null,r.drive.drive([t])}),t.timeout),this.items[t.timeoutId]=t},uncommit:function(e,t){delete this.items[t.timeoutId],t.timeoutId&&clearTimeout(t.timeoutId),t.timeoutId=null}},(function(e){var t=e.actUId,r=e.process,i=H[t];i&&i.curProcItems[r]===e&&i.processFunc&&i.processFunc.call(i.bindTarget,K.$.TO+r,null,i)}));function Q(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}const $=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.connectName=null,this.rparam=r,this.ccstream=t,this.startTime=Date.now(),this.needReconnect=!0,this.wssUrl=null,this.recordingId=null,this.pcstate=null}var t,r,i;return t=e,i=[{key:"errorToMessage",value:function(e){return _.is.isObject(e)?e.message?e.message:JSON.stringify(e):_.is.isString(e)?e:null}},{key:"filterStatus",value:function(e){var t={};for(var r in e&&e.ssrc&&(t.ssrc=e.ssrc),e)"number"==typeof e[r]&&"timestamp"!=r&&"ssrc"!=r&&(t[r]=e[r]);return t}}],(r=[{key:"uninit",value:function(){}},{key:"createAct",value:function(e,t,r){var i=K.find(e);return i||(i=K.create(e,e)).defMachine(t).defProcess(r),i.bind(this),this.connact=i,i}},{key:"getDuration",value:function(){return Math.ceil((Date.now()-this.startTime)/1e3)}},{key:"muteAudio",value:function(){}},{key:"unmuteAudio",value:function(){}},{key:"mutevideo",value:function(){}},{key:"unmutevideo",value:function(){}},{key:"getStream",value:function(){return this.ccstream}},{key:"getBitrate",value:function(){}},{key:"getVideoStreamStatus",value:function(){}},{key:"getAudioStreamStatus",value:function(){}},{key:"onconnect",value:function(){}},{key:"ondisconnect",value:function(e){}}])&&Q(t.prototype,r),i&&Q(t,i),e}();function z(e){return(z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function J(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t){return(Z=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ee(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=re(e);if(t){var s=re(this).constructor;r=Reflect.construct(i,arguments,s)}else r=i.apply(this,arguments);return te(this,r)}}function te(e,t){return!t||"object"!==z(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function re(e){return(re=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}const ie=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Z(e,t)}(n,e);var t,r,i,s=ee(n);function n(e,t){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),r=s.call(this,e,t);var i=e.getStreamId();return r.connectName="[push-"+i+"@"+t.innerid+"]",r.bandwidth=r.ccstream.getStreamConfig().initBandwidth,r.isAskingAuth=!1,r.connectHash=0,r.event=(new p).timerEnable((function(e){return r.onTimer(e)})),r}return t=n,(r=[{key:"uninit",value:function(){this.ccstream=null}},{key:"getStreamParam",value:function(e){var t={};t.uid=this.rparam.uid,t.uid_string=this.rparam.uid_string,t.seq=0,t.streamstat=this.ccstream.getStreamConfig().streamstat.toString(),t.roomid=this.ccstream.getroomid(),t.streamname=this.ccstream.getStreamId(),t.width=this.ccstream.getStreamConfig().videoWidth.toString(),t.height=this.ccstream.getStreamConfig().videoHeight.toString(),t.fps=this.ccstream.getStreamConfig().frameRate.toString(),t.audiofmt="opus",t.samplerate="48000",t.channel="2",t.enclen="3840",t.starttime=Math.ceil(this.startTime/1e3).toString();var r=e&&_.parseUrl(e);return t.pushaddr=e&&r.host,t.pushport=e&&r.port.toString(),t.platform="miniprogram",t.bitrate=this.ccstream.getStreamConfig().maxBitrateInKbps,t}}])&&J(t.prototype,r),i&&J(t,i),n}($);function se(e){return(se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ne(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ae(e,t){return(ae=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=ue(e);if(t){var s=ue(this).constructor;r=Reflect.construct(i,arguments,s)}else r=i.apply(this,arguments);return ce(this,r)}}function ce(e,t){return!t||"object"!==se(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ue(e){return(ue=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}const _e=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ae(e,t)}(n,e);var t,r,i,s=oe(n);function n(e,t){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),s.call(this,e,t)}return t=n,(r=[{key:"uninit",value:function(){this.ccstream=null}},{key:"setStreamParam",value:function(e){this.sparam=e}}])&&ne(t.prototype,r),i&&ne(t,i),n}($);function he(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}const le=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rparam=t,this.connectors={},this.mservers=null,this.mserverIndex=0,this.mreconnTry=0,this.mneedRenew=!0,this.servers=null,this.serverIndex=0,this.reconnTry=0,this.reconnMax=E.Stream_Default_Retry,this.lastReconn=0,this.lastRecover=0,this.needRenew=!0,this.status=""}var t,r,i;return t=e,(r=[{key:"setServers",value:function(e){this.needRenew&&(this.needRenew=!1,this.serverIndex=0,this.reconnTry=0,this.servers=e)}},{key:"setMServers",value:function(e){this.mneedRenew&&(this.mneedRenew=!1,this.mserverIndex=0,this.mreconnTry=0,this.mservers=e)}},{key:"clearServers",value:function(){this.serverIndex=0,this.reconnTry=0,this.servers=null,this.mservers=null,this.mserverIndex=0,this.mreconnTry=0}},{key:"getCurServer",value:function(){return this.servers&&this.serverIndex<this.servers.length?this.servers[this.serverIndex]:null}},{key:"getMCurServer",value:function(){return this.mservers&&this.mserverIndex<this.mservers.length?this.mservers[this.mserverIndex]:null}},{key:"setAuthsta",value:function(e){this.status=e}},{key:"getAuthsta",value:function(){return this.status?this.status:""}},{key:"onDisconnect",value:function(){this.serverIndex++,this.serverIndex>=this.servers.length&&(this.needRenew=!0,this.serverIndex=0)}},{key:"onMDisconnect",value:function(){this.mserverIndex++,this.mserverIndex>=this.mservers.length&&(this.mneedRenew=!0),this.mserverIndex=0}},{key:"newPusher",value:function(e){var t=e.getStreamId();if(this.connectors[t])return null;e.linkEvent(p.Name.room(this.rparam.innerid));var r=new ie(e,this.rparam);return this.connectors[t]=r,r}},{key:"newPuller",value:function(e){var t=e.getStreamId();if(this.connectors[t])return null;e.linkEvent(p.Name.room(this.rparam.innerid));var r=new _e(e,this.rparam);return this.connectors[t]=r,r}},{key:"getPusher",value:function(e){return this.connectors[e]}},{key:"getPuller",value:function(e){return this.connectors[e]}},{key:"connectorExists",value:function(e){return!!this.connectors[e]}},{key:"removeConnector",value:function(e){this.connectors[e]&&(this.connectors[e].uninit(),delete this.connectors[e])}},{key:"getAllStreamIds",value:function(){var e=[];for(var t in this.connectors)e.push(t);return e}}])&&he(t.prototype,r),i&&he(t,i),e}();const me={REGEX_ROOMNAME:/^[a-zA-Z0-9\-\_]+$/,roomnameFilter:function(e,t){return this.REGEX_ROOMNAME.test(e)?e:_.md5String(t+e)},checkStreamChannel:function(e,t){for(var r=e.getAllStreamIds(),i=!1,s=!1,n=0,a=r.length;n<a;n++){var o=e.getPusher(r[n]);o.ccstream.isMain()?i=!0:o.ccstream.isAux()&&(s=!0)}return(!t.isMain()||!i)&&(!t.isAux()||!s)},isValidString:function(e,t,r,i){var s=_.is;return t||(t=0),r||(r=Number.MAX_SAFE_INTEGER),s.isEmpty(i)&&(i=0),s.isString(e)&&i&&s.isASCII(e)&&e.length>=t&&e.length<=r},isValidInteger:function(e,t,r){return _.is.isInteger(e)&&e>=t&&e<=r},isValidNumber:function(e,t,r){return _.is.isNumber(e)&&e>=t&&e<=r}};function Ee(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var de=function(){function e(t,r,i,s,n,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.len=0,this.waitUid=[],this.seq=0,this.storage=null,this.url=t,this.paramsCallback=r,this.timeout=i||E.AjaxTimeout,this.delay=s||500,this.workingTimeoutId=0,this.netfailtime=0,this.ajaxs=new Array(n||1).fill(0),this.itemNum=a||1,this.nettype="unknown",this.startWork=0}var t,r,i;return t=e,(r=[{key:"addSessionStorage",value:function(e,t){var r="ChuangMiniBuriedpoint"+e;try{wx.setStorageSync(r,t)}catch(e){return void L().log("add to storage get error"+e,"error")}}},{key:"delSessionStorage",value:function(e){try{wx.removeStorageSync(e)}catch(e){L().log("del from storage get error"+e,"error")}}},{key:"addItem",value:function(e){if(e.nettype=this.nettype,0===e.uid)this.waitUid.push(e);else{if(this.waitUid.length){this.waitUid.forEach((function(t){t.uid=e.uid})),this.storage=wx.getStorageInfoSync();for(var t=0,r=this.waitUid.length;t<r;t++){if(this.storage.keys.length>=100){var i=[];for(var s in this.storage.keys)i.push({seq:s,value:wx.getStorageSync(s)});for(var n=0,a=i.length-98;n<a;n++)i[n].seq.includes("ChuangMiniBuriedpoint")&&this.delSessionStorage(i[n].seq)}this.addSessionStorage(this.waitUid[0].seq,JSON.stringify(this.waitUid[0])),this.waitUid.shift()}this.addSessionStorage(e.seq,JSON.stringify(e))}else{if(this.storage=wx.getStorageInfoSync(),this.storage.keys.length>=200){for(var s in i=[],L().log("report queue maxed out.","warn"),this.storage.keys)i.push({seq:s,value:wx.getStorageSync(s)});for(t=0,r=i.length-199;t<r;t++)i[t].seq.includes("ChuangMiniBuriedpoint")&&this.delSessionStorage(i[t].seq)}this.addSessionStorage(e.seq,JSON.stringify(e))}this.startWorking()}}},{key:"startWorking",value:function(){var e=this;this.startWork=1,this.workingTimeoutId||(this.workingTimeoutId=setTimeout((function(){e.workingTimeoutId=0,e.working()}),this.delay+(this.netfailtime?100*Math.pow(10,Math.min(this.netfailtime,2)):0)))}},{key:"working",value:function(){this.storage=wx.getStorageInfoSync();var e=this.ajaxs.indexOf(0);if(!(e<0)&&this.storage.keys.length){this.lastLen=this.len,this.len=this.storage.keys.length>4?4:this.storage.keys.length;for(var t=[],r=0;r<this.len;r++)if(this.storage.keys[r].includes("ChuangMiniBuriedpoint"))try{var i=wx.getStorageSync(this.storage.keys[r]);i&&t.push(JSON.parse(i))}catch(e){L().log(e,"error")}if(t.length){var s=this.paramsCallback(t);i="value="+encodeURIComponent(_.base64encode(JSON.stringify(s))),this.ajaxs[e]=1;var n=this;wx.request({url:encodeURI(this.url),data:i,timeout:this.timeout,method:"POST",success:function(t){if(0==t.data.code){for(var r=[],i=0;i<n.len;i++){var s=n.storage.keys[i];s&&s.includes("ChuangMiniBuriedpoint")&&r.push(s)}0!=r.length&&r.forEach((function(e){var t=wx.getStorageSync(e);_.curTimeInMilli(),t&&JSON.parse(t)&&(wx.removeStorageSync(e),302==JSON.parse(t).reporttype&&wx.clearStorage())})),n.netfailtime=0,n.storage=wx.getStorageInfoSync(),n.storage.keys.length?n.working():clearInterval()}else L().log("respons=======",t.data.code),setInterval((function(){n.storage.length?n.working():clearInterval()}),2e3),n.netfailtime>2&&L().log("serverReport is failed 3 times","warn"),n.netfailtime++;n.ajaxs[e]=0},fail:function(t){L().log("report failed=============",t),n.ajaxs[e]=0,n.netfailtime++,n.startWorking()}})}}}}])&&Ee(t.prototype,r),i&&Ee(t,i),e}(),Te={core:null,init:function(){return this.core=this.core||new de(E.SerUploadServer+"/rpt/",this.getParams.bind(this),null,500,3,10),this},getParams:function(e){return{info:e}},_common:function(e,t,r,i){var n=this;wx.getNetworkType({success:function(e){n.core.nettype=e.networkType}}),wx.getSystemInfo({success:function(t){e.devicetype=t.model,e.osbuild=t.system}}),e.appid=t.appid||wt.appId,e.build=s.SDKVERSION,e.platform=s.DEVICE_TYPE,e.signalstrength=0,e.ctime=_.curTimeFtt(),e.seq=this.core.seq++,e.uid=t.uid||0,e.uidstring=t.uid_string||"",e.streamname=e.streamname||"",e.ip=e.ip||"0.0.0.0",e.port=e.port||0,e.width=e.width||0,e.height=e.height||0,e.time=0,e.reporttype=r,e.content=JSON.stringify(i);try{if(!wx.getStorageSync("uuid"))try{wx.setStorageSync("uuid",_.uuid())}catch(e){}}catch(e){}e.uuid=wx.getStorageSync("uuid"),this.core.addItem(e)},room:function(e,t,r){var i={};i.ip=r.ip,i.port=r.port,this._common(i,r,t,e)},push:function(e,t,r,i,s,n){var a={};a.streamname=i,a.ip=this.getpushIp(r),a.port=this.getpushPort(r),a.width=s,a.height=n,this._common(a,r,t,e)},pull:function(e,t,r,i,s,n,a){var o={};o.streamname=i,o.ip=a?a.split("/")[2].split(":")[0]:this.getpullIp(r),o.port=a?a.split("/")[2].split(":")[1]:this.getpullPort(r),o.width=s,o.height=n,this._common(o,r,t,e)},mix:function(e,t,r,i,s,n){var a={};a.streamname=i,a.ip=this.getpushIp(r),a.port=this.getpushPort(r),a.width=s,a.height=n,this._common(a,r,t,e)},getpushIp:function(e){var t=wt.getroom(e.innerid),r=t&&t.rtcPusher?t.rtcPusher.getCurServer():null;if(!r)return"0.0.0.0";var i=_.parseUrl(r).host.split("-");return i.pop(),i.join(".")},getpullIp:function(e){var t=wt.getroom(e.innerid),r=t&&t.rtcPuller?t.rtcPuller.getCurServer():null;if(!r)return"0.0.0.0";var i=_.parseUrl(r).host.split("-");return i.pop(),i.join(".")},getpushPort:function(e){var t=wt.getroom(e.innerid),r=t&&t.rtcPusher?t.rtcPusher.getCurServer():null;return r?_.parseUrl(r).port:0},getpullPort:function(e){var t=wt.getroom(e.innerid),r=t&&t.rtcPuller?t.rtcPuller.getCurServer():null;return r?_.parseUrl(r).port:0},CODES:{REPORT_TYPE_NORMAL:0,REPORT_TYPE_INITIALIZE_FAILED:1,REPORT_TYPE_NETWORK_CHANGE:3,REPORT_TYPE_SERVER_NO_RESPONSE:4,REPORT_TYPE_SERVER_TIMEOUT:5,REPORT_TYPE_RECV_ERROR_AUDIO_CONFIG:8,REPORT_TYPE_PUBLISH_START:9,REPORT_TYPE_PLAY_START:10,REPORT_TYPE_PUBLISH_SUCCEED:11,REPORT_TYPE_PLAY_SUCCEED:12,REPORT_TYPE_CLOSE_NORMAL:13,REPORT_TYPE_PUBLISH_DISCONNECTED:14,REPORT_TYPE_VIDEO_ENCODE_TIME_TOO_LONG:15,REPORT_TYPE_PLAY_STREAM_NOT_FOUND:16,REPORT_TYPE_RECV_CLOSE_PACKET:17,REPORT_TYPE_RECV_SERVER_ERROR:18,REPORT_TYPE_RECV_FIRST_AUDIO:19,REPORT_TYPE_RECV_FIRST_VIDEO:20,REPORT_TYPE_PUBLISH_RESOLUTION_UP:21,REPORT_TYPE_PUBLISH_RESOLUTION_DOWN:22,REPORT_TYPE_BWE_NO_CALLBACK:23,REPORT_TYPE_BWE_CHANGE_INFO:24,REPORT_TYPE_PUBLISH_VIDEO_ENCODER_START_EXCEPTION:26,REPORT_TYPE_PUBLISH_VIDEO_FRAME_TIMEOUT:27,REPORT_TYPE_SERVER_NO_RESPONSE_WITH_INTERNAL_RETRY:28,REPORT_TYPE_RTMP_BAD_NETWORK:100,REPORT_TYPE_RTMP_CONNECT_FAILED:101,REPORT_TYPE_GET_SERVER_LIST_SUCCEED:201,REPORT_TYPE_GET_SERVER_LIST_FAILED:202,REPORT_TYPE_GET_CONFIG_SUCCEED:203,REPORT_TYPE_GET_CONFIG_FAILED:204,REPORT_TYPE_PUBLISH_CONFIG:205,REPORT_TYPE_PARSE_SERVER_LIST_JSON_FAILED:206,REPORT_TYPE_PARSE_SERVER_LIST_JSON_WRONG_CLIENT_INFO:207,REPORT_TYPE_LOGIN_CALLED_FROM_USER:208,REPORT_TYPE_LOGOUT_CALLED_FROM_USER:209,REPORT_TYPE_USER_LOGIN_RESULT:210,REPORT_TYPE_MESS_LOGIN_SUCCEED:300,REPORT_TYPE_MESS_LOGIN_FAILED:301,REPORT_TYPE_MESS_LOGOUT_ROOM:302,REPORT_TYPE_MESS_AUTH_PUBLISH_SUCCEED:303,REPORT_TYPE_MESS_AUTH_PUBLISH_FAILED:304,REPORT_TYPE_MESS_DISCONNECT:305,REPORT_TYPE_MESS_CONNECT_PROCESS_TIMEOUT:306,REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT:307,REPORT_TYPE_MESS_MERGE_START:308,REPORT_TYPE_MESS_MERGE_STOP:309,REPORT_TYPE_MESS_MERGE_SUCCESS:310,REPORT_TYPE_MESS_MERGE_RESTART_PARSE_ACK_FAILED:311,REPORT_TYPE_MESS_MERGE_RESTART_PROGRESS_TIMEOUT:312,REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ERROR:313,REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ZERO:314,REPORT_TYPE_MESS_MERGE_RESTART_CHECK_INTERNAL_ERROR:315,REPORT_TYPE_MESS_MERGE_RESTART_REQ_INTERNAL_ERROR:316,REPORT_TYPE_MESS_MERGE_RESTART_UNKNOWN_REASON:317,REPORT_TYPE_MESS_START_PUBLISH_FAILED:318,REPORT_TYPE_MESS_BANNED_BY_APP:319,REPORT_TYPE_MESS_MERGE_FAILED_ERROR_RESOLUTION:320,REPORT_TYPE_MESS_MERGE_FAILED_INVALID_RTMP_ADDR:321,MESS_MERGE_CB_INVALID_PARAMETERS_FROM_SERVER:322,REPORT_TYPE_MESS_MERGE_FAILED_INVALID_PUBLISH_ADDRESS:323,REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD:324,REPORT_TYPE_SYSTEM_CAMERA_PERMISSION_DENIED:400,REPORT_TYPE_APP_BECOME_BACKGROUND:401,REPORT_TYPE_APP_BECOME_FOREGROUND:402,REPORT_TYPE_PING_STATUS:501,REPORT_TYPE_LOG_INFO:502,REPORT_TYPE_MINIPROGRAM_EVENT:601}}.init();function Se(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function pe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ce(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Re(e,t,r){return t&&Ce(e.prototype,t),r&&Ce(e,r),e}var Ae=function(){function e(){pe(this,e),this.servers=null,this.serverIndex=0,this.servers_lastfail=null,this.fail_cooldown=0,this.retry=0,this.maxRetry=0,this.conn_timeout=0,this.cache_time=0,this.respCache=null,this.respCacheTime=0,this.onSuccess=null,this.onFailure=null,this.onRetry=null,this.reqKey=8357,this.cost=0}return Re(e,[{key:"get",value:function(e,t){if(t)e="https://"+this.servers[this.serverIndex]+e;else e=this.servers[this.serverIndex]+e;var r=this;this.reqKey;wx.request({header:{"Cache-Control":"no-Cache"},url:e,timeout:this.conn_timeout,success:function(e){r.onSuccess(e)},fai:function(t){L().log("get failed["+e+"]"+t,"error"),r.nextServer()}})}},{key:"post",value:function(e,t){var r=this.servers[this.serverIndex],i=this;this.reqKey;wx.request({url:r+e,data:t,timeout:this.conn_timeout,success:function(e){i.onSuccess(e)},fai:function(t){L().log("post failed["+e+"]"+t,"error"),i.nextServer}})}},{key:"cacheResp",value:function(e){this.cache_time>0&&(this.respCache=e,this.respCacheTime=_.curTimeInMilli())}},{key:"getCacheResp",value:function(){return this.cache_time>0&&this.respCache&&this.respCacheTime+this.cache_time>_.curTimeInMilli()?this.respCache:null}},{key:"nextServer",value:function(){this.serverIndex++,this.serverIndex>=this.servers.length&&(this.serverIndex=0,this.retry++,this.retry>=this.maxRetry||!this.maxRetry)?this.onFailure&&this.onFailure():this.onRetry&&this.onRetry()}},{key:"resetServer",value:function(){this.serverIndex=0,this.retry=0}},{key:"close",value:function(){this.reqKey=_.randomnum(6),this.onSuccess=null,this.onFailure=null,this.onRetry=null}}]),e}();function Oe(e,t,r,i){e&&(e.r&&e.r[0]&&(t.push(e.r[0].ip),r.push(e.r[0].ip)),e.m&&e.m[0]&&i.push("wss://"+e.m[0].ip+"/conn"))}var Ie=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.start=_.curTimeInMilli(),this.end=_.curTimeInMilli(),this.loadCore.serverIndex=0,this.loadCore.servers=E.DPServer,this.loadCore.maxRetry=E.DP_Reconn_Retry,this.loadCore.cache_time=E.DP_Cache_Time,this.loadCore.conn_timeout=E.DP_Conn_Timeout,this.loadCore.onSuccess=function(e){r.onSuccess(e)},this.loadCore.onFailure=function(e,t,i){L().log("dploader back failed ".concat(e," ").concat(i),"error"),r.end=_.curTimeInMilli(),r.cost=r.end-r.start;var s={serverlist:{httpcode:t,cost:r.cost,host:r.loadCore.servers[r.loadCore.serverIndex],response:_.base64encode(i)}};Te.room(s,Te.CODES.REPORT_TYPE_GET_SERVER_LIST_FAILED,{}),r.event.dispatchEvent(p.Create.resource(Ue.Event.DP_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.uid="",this.appkey="",this.device=s.DEVICE_TYPE.toLocaleLowerCase(),this.event=t}return Re(e,[{key:"onSuccess",value:function(e){var t;L().log("dploader back succeed");var r=null;try{r=e.data}catch(e){}if(!r||"{}"==r.client||!r.server||!r.server.r.length)return this.loadCore.nextServer(),void Te.room({error:{code:201,msg:"parse failed"}},Te.CODES.REPORT_TYPE_PARSE_SERVER_LIST_JSON_FAILED,{});var i=r.client,n=this.start.toString();if(i.appid!=this.appkey&&i.device!=this.device&&i.uid!=this.uid)return Te.room({error:{msg:"wrong client info",uid:this.uid+"|"+i.uid,device:this.device+"|"+i.device,appid:this.appkey+"|"+i.appid,ts:n+"|"+i.ts}},Te.CODES.REPORT_TYPE_PARSE_SERVER_LIST_JSON_WRONG_CLIENT_INFO,{}),void this.loadCore.nextServer();var a=r.server,o=[],c=[],u=[];if(_.is.isArray(a))for(var h=0,l=a.length;h<l;h++)Oe(a[h],o,c,u);else{if(!_.is.isObject(a))return void this.loadCore.nextServer();Oe(a,o,c,u)}if(0!=o.length&&0!=c.length&&0!=u.length){var m=(Se(t={},s.DPKEYS.PUBLISH,o),Se(t,s.DPKEYS.WATCH,c),Se(t,s.DPKEYS.MESSAGE,u),t);this.loadCore.cacheResp(m),this.end=_.curTimeInMilli(),this.cost=this.end-this.start;var E={httpcode:e.status,cost:this.cost,host:this.loadCore.servers[this.loadCore.serverIndex],response:_.base64encode(e.responseText)};this.event.dispatchEvent(p.Create.resource(Ue.Event.DP_RESULT,{resp:m,content:E}))}else this.event.dispatchEvent(p.Create.resource(Ue.Event.DP_EMPTY))}},{key:"load",value:function(e,t){if(!e)return this.event.dispatchEvent(p.Create.resource(Ue.Event.DP_FAIL,m(m.CODE.CHUANG_APPID_NULL)));if(!t)return this.event.dispatchEvent(p.Create.resource(Ue.Event.DP_FAIL,m(m.CODE.CHUANG_USERID_NULL)));this.appkey==e&&this.uid==t||(this.loadCore.respCache=null),this.uid=t,this.appkey=e;this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){L().log("dploader Connect Start");var e=_.curTimeInMilli(),t="/?uid="+this.uid+"&device="+this.device+"&appid="+this.appkey+"&ts="+e;this.start=_.curTimeInMilli(),this.loadCore.get(t)}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),fe=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.loadCore.serverIndex=0,this.loadCore.servers=E.UIDServer,this.loadCore.maxRetry=E.UID_Reconn_Retry,this.loadCore.cache_time=E.UID_Cache_Time,this.loadCore.conn_timeout=E.UID_Conn_Timeout,this.loadCore.onSuccess=function(e){L().log("uidback succeed");var t=e.data.toString().replace(/\r|\n/g,"");r.loadCore.cacheResp(t),r.event.dispatchEvent(p.Create.resource(Ue.Event.UID_RESULT,t))},this.loadCore.onFailure=function(e){L().log("uidbacd failed ".concat(res),"error"),r.event.dispatchEvent(p.Create.resource(Ue.Event.UID_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.uid_string="",this.appid="",this.event=t}return Re(e,[{key:"load",value:function(e,t){if(!e)return this.event.dispatchEvent(p.Create.resource(Ue.Event.UID_FAIL,m(m.CODE.CHUANG_APPID_NULL)));if(!t)return this.event.dispatchEvent(p.Create.resource(Ue.Event.UID_FAIL,m(m.CODE.CHUANG_USERID_NULL)));this.appid==e&&this.uid_string==t||(this.loadCore.respCache=null),this.appid=e,this.uid_string=t;var r;if(null!==(r=this.loadCore.getCacheResp()))return this.event.dispatchEvent(p.Create.resource(Ue.Event.UID_RESULT,r));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){var e=_.curTime(),t="/uid?app="+this.appid+"&uid="+this.uid_string+"&ts="+e;this.loadCore.get(t),L().log("uid")}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),Pe=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.loadCore.serverIndex=0,this.loadCore.servers=E.KEYServer,this.loadCore.maxRetry=E.KEY_Reconn_Retry,this.loadCore.cache_time=E.KEY_Cache_Time,this.loadCore.conn_timeout=E.KEY_Conn_Timeout,this.loadCore.onSuccess=function(e){L().log("keyback"),r.end=_.curTimeInMilli();var t=e.data.replace(/\r|\n/g,"");r.loadCore.cacheResp(t),r.event.dispatchEvent(p.Create.resource(Ue.Event.KEY_RESULT,{res:t,cost:r.end}))},this.loadCore.onFailure=function(e){r.event.dispatchEvent(p.Create.resource(Ue.Event.KEY_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.appid="",this.event=t}return Re(e,[{key:"load",value:function(e){if(!e)return this.event.dispatchEvent(p.Create.resource(Ue.Event.KEY_FAIL,m(m.CODE.CHUANG_APPID_NULL)));this.appid!=e&&(this.loadCore.respCache=null),this.appid=e;var t;if(null!==(t=this.loadCore.getCacheResp()))return this.event.dispatchEvent(p.Create.resource(Ue.Event.KEY_RESULT,t));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){var e="/app?app="+this.appid;this.loadCore.get(e),L().log("key")}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),ve=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.loadCore.serverIndex=0,this.loadCore.servers=E.TOKENServer,this.loadCore.maxRetry=E.TOKEN_Reconn_Retry,this.loadCore.cache_time=E.TOKEN_Cache_Time,this.loadCore.conn_timeout=E.TOKEN_Conn_Timeout,this.loadCore.onSuccess=function(e){L().log("tokenback");var t=null;try{t=JSON.parse(e)}catch(e){r.loadCore.nextServer()}if(t){if(1!=t.status)return r.loadCore.cacheResp(t),void r.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_FAIL,m(m.CODE.CHUANG_TOKEN_AUTH_ERROR,null,{reason:t.info})));var i=t.data;if(_.is.isObject(i)){var s={};for(var n in i)s[n]=_.xxteaDecryptFromBase64(i[n],r.encrypt);s.appId&&s.appKey?(t.data=s,r.loadCore.cacheResp(t),r.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_RESULT,s))):r.loadCore.nextServer()}else r.loadCore.nextServer()}else r.loadCore.nextServer()},this.loadCore.onFailure=function(e){r.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_NET_FAIL))},this.loadCore.onRetry=function(){r.reload()},this.tokenkey="",this.encrypt="",this.event=t}return Re(e,[{key:"load",value:function(e){if(!e)return this.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_FAIL,m(m.CODE.CHUANG_APPKEY_NULL)));this.tokenkey!=e&&(this.loadCore.respCache=null),this.tokenkey=e;var t;if(null===(t=this.loadCore.getCacheResp()))this.loadCore.resetServer(),this.reload();else{var r=t;1!=r.status?this.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_FAIL,m(m.CODE.CHUANG_TOKEN_AUTH_ERROR,null,{reason:r.info}))):this.event.dispatchEvent(p.Create.resource(Ue.Event.TOKEN_RESULT,r.data))}}},{key:"reload",value:function(){this.encrypt=_.randomString(32);return L().log("token"),this.loadCore.post("/token/checkToken",{token:this.tokenkey,encrypt:this.encrypt})}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),ge=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.loadCore.serverIndex=0,this.loadCore.servers=E.CONFIGServer,this.loadCore.maxRetry=E.CONFIG_Reconn_Retry,this.loadCore.cache_time=E.CONFIG_Cache_Time,this.loadCore.conn_timeout=E.CONFIG_Conn_Timeout,this.start=0,this.end=0,this.serverConfig={},this.loadCore.onSuccess=function(e){r.loadCore.cacheResp(e.responseText),r.end=_.curTimeInMilli();var t=r.end-r.start;r.serverConfig.cost=t,r.serverConfig.httpcode=e.status,r.serverConfig.response=e.responseText,r.event.dispatchEvent(p.Create.resource(Ue.Event.CONFIG_RESULT,r.serverConfig))},this.loadCore.onFailure=function(e){r.end=_.curTimeInMilli(),r.event.dispatchEvent(p.Create.resource(Ue.Event.CONFIG_NET_FAIL,r.serverConfig))},this.loadCore.onRetry=function(){r.reload()},this.appid="",this.event=t}return Re(e,[{key:"load",value:function(){var e;if(null!==(e=this.loadCore.getCacheResp()))return this.event.dispatchEvent(p.Create.resource(Ue.Event.CONFIG_RESULT,e));this.loadCore.resetServer(),this.reload()}},{key:"reload",value:function(){this.start=_.curTimeInMilli(),this.loadCore.get("/web/livevideoconfig.php")}},{key:"close",value:function(){this.loadCore.close()}}]),e}(),Ne=function(){function e(t){var r=this;pe(this,e),this.loadCore=new Ae,this.loadCore.serverIndex=0,this.loadCore.servers=E.FOLLOWServer,this.loadCore.maxRetry=E.FOLLOW_Reconn_Retry,this.loadCore.cache_time=E.FOLLOW_Cache_Time,this.loadCore.conn_timeout=E.FOLLOW_Conn_Timeout,this.start=0,this.end=0,this.serverConfig={},this.urlTail="",this.loadCore.onSuccess=function(e){if(L().log("follow back succeed"),e){var t=e.data;t&&1e3==t.error_code?t.addr.length?r.event.dispatchEvent(p.Create.resource(Ue.Event.FOLLOW_RESULT,t)):r.reload(r.streamType,r.urlTail):setTimeout((function(){return r.reload(r.streamType,r.urlTail)}),500)}else setTimeout((function(){return r.reload(r.streamType,r.urlTail)}),500)},this.loadCore.onFailure=function(e){r.end=_.curTimeInMilli(),r.event.dispatchEvent(p.Create.resource(Ue.Event.FOLLOW_FAIL,r.serverConfig))},this.loadCore.onRetry=function(){r.reload(r.streamType,r.urlTail)},this.appid="",this.event=t}return Re(e,[{key:"load",value:function(e,t){this.streamType=e,this.urlTail=t,this.loadCore.resetServer(),this.reload(e,t)}},{key:"reload",value:function(e,t){L().log("follow connect start"),this.urlTail=t||this.urlTail;var r=E.FOLLOWServer[0].split(":"),i=r[0],s=r[1],n=_.curTimeInMilli();if(e){if(e)a="/redirect?"+t+"&ts="+n}else var a="/redirect?"+this.urlTail+"&publish_ip="+i+"&publish_port="+s+"&ts="+n;this.start=_.curTimeInMilli(),this.loadCore.get(a,1)}},{key:"close",value:function(){Ue.follow.forEach((function(e){e.loadCore.onSuccess=null}))}}]),e}(),Ue={follow:[],newDPLoader:function(e){return new Ie(e)},newUIDLoader:function(e){return new fe(e)},newKEYLoader:function(e){return new Pe(e)},newTokenLoader:function(e){return new ve(e)},newConfigLoader:function(e){return new ge(e)},newFollowLoader:function(e){return new Ne(e)},Event:{DP_FAIL:"dp-fail",DP_NET_FAIL:"dp-net-fail",DP_RESULT:"dp-result",DP_EMPTY:"dp-empty",UID_FAIL:"uid-fail",UID_NET_FAIL:"uid-net-fail",UID_RESULT:"uid-result",KEY_FAIL:"key-fail",KEY_NET_FAIL:"key-net-fail",KEY_RESULT:"key-result",TOKEN_FAIL:"token-fail",TOKEN_NET_FAIL:"token-net-fail",TOKEN_RESULT:"token-result",CONFIG_FAIL:"config-fail",CONFIG_NET_FAIL:"config-net-fail",CONFIG_RESULT:"config-result",FOLLOW_FAIL:"follow-fail",FOLLOW_NET_FAIL:"follow-net-fail",FOLLOW_RESULT:"follow-result"}};const Le=Ue;function De(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ye=r(788),Me="_connect",Ge="_connectNext",ke="_connectRetry",He=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.event=r||new p,this.sockAddr=[],this.addrIndex=0,this.needReconnect=!1,this.reconnTry=0,this.reconnTryMax=3,this.connTimeout=5e3,this.connTimeoutId=0,this.isInit=!0,this.sendbytes=0,this.recvbytes=0,this.startTime=Date.now(),this.lastSendTime=null,this.lastRecvTime=null,this.lts=0,this.socketId=t,this.SocketTask=null}var t,r,i;return t=e,(r=[{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"setConnTimeout",value:function(e){return this.connTimeout=e,this}},{key:"setReconnTryMax",value:function(e){return this.reconnTryMax=e,this}},{key:"getSendBytes",value:function(){return this.sendbytes}},{key:"getRecvBytes",value:function(){return this.recvbytes}},{key:"getDuration",value:function(){return Math.ceil((Date.now()-this.startTime)/1e3)}},{key:"getCurServer",value:function(){return this.sockAddr&&this.addrIndex<this.sockAddr.length?this.sockAddr[this.addrIndex]:null}},{key:"clearServers",value:function(){this.sockAddr=[],this.addrIndex=0,this.reconnTry=0}},{key:"open",value:function(e){this.sockAddr=e?e instanceof Array?e:[e]:this.sockAddr,this.reconnTry=0,this.addrIndex=0,this.close(),this._connect()}},{key:"reopen",value:function(){this._connect()}},{key:Me,value:function(){var t=this;this.isInit=!0,this.needReconnect=!0,ye.log("["+this.socketId+"] start connect: "+this.sockAddr[this.addrIndex]+" "+this.reconnTry+"/"+this.reconnTryMax),this.lts=(new Date).getTime(),this.SocketTask=wx.connectSocket({url:this.sockAddr[this.addrIndex],success:function(){}}),this.SocketTask.onOpen((function(r){console.log("["+t.socketId+"] socket opened: "+t.sockAddr[t.addrIndex]),t.needReconnect=!0,t.isInit=!1,t.sendbytes=0,t.recvbytes=0,t.startTime=Date.now(),t.lastSendTime=null,t.lastRecvTime=null,clearTimeout(t.connTimeoutId),t.event.dispatchEvent(p.Create.socket(e.Event.CONNECT,r))})),this.SocketTask.onMessage((function(r){if(t.reconnTry=0,r.data instanceof ArrayBuffer)t.event.dispatchEvent(p.Create.socket(e.Event.BINARY,r.data));else{var i=JSON.parse(r.data);t.lastRecvTime=Date.now(),t.event.dispatchEvent(p.Create.socket(e.Event.MESSAGE,i))}})),this.SocketTask.onClose((function(r){t.needReconnect?t.isInit?(ye.log("["+t.socketId+"] socket connect error/timeout","warn"),t._connectNext()):(t._connectRetry(r),t.event.dispatchEvent(p.Create.socket(e.Event.DISCONNECT,r))):(ye.log("["+t.socketId+"] socket closed"),clearTimeout(t.connTimeoutId),t.SocketTask.onOpen=void 0,t.SocketTask.onClose=void 0,t.SocketTask.onError=void 0,t.SocketTask.onMessage=void 0)})),this.SocketTask.onError((function(r){ye.log("["+t.socketId+"] connect error.","error"),t.event.dispatchEvent(p.Create.socket(e.Event.ERROR,r))}))}},{key:ke,value:function(){++this.reconnTry,this.reconnTry>this.reconnTryMax&&(this.reconnTry=0,this.addrIndex++)}},{key:Ge,value:function(){this.reconnTry=0,++this.addrIndex,this.addrIndex>=this.sockAddr.length?this.event.dispatchEvent(p.Create.socket(e.Event.DISCONNECT)):this._connect()}},{key:"close",value:function(){this.needReconnect=!1,clearTimeout(this.connTimeoutId),this.SocketTask&&this.SocketTask.close({success:function(e){},fail:function(e){}})}},{key:"stopReconnect",value:function(){this.needReconnect=!1}},{key:"sendMessage",value:function(e){if(this.SocketTask){var t=JSON.stringify(e);this.sendbytes+=_.lengthInUtf8Bytes(t),this.lastSendTime=Date.now(),this.SocketTask.send({data:t,success:function(e){},complete:function(e){}})}}}])&&De(t.prototype,r),i&&De(t,i),e}();He.Event={CONNECT:"connect",DISCONNECT:"disconnect",BINARY:"binary",MESSAGE:"SocketMessage",ERROR:"error"};const be=He;function xe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function we(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Fe(e,t,r){return t&&we(e.prototype,t),r&&we(e,r),e}var Ye="login",Ke="authpublish",Ve="startpublish",Be="stoppublish",Xe="heartbeat",We="reqlist",qe="reqmerge",je="stopmerge",Qe="reqmergestat",$e="setwatchinfo",ze="streamheartbeat",Je="startplay",Ze="stopplay",et="logout",tt="success",rt=2,it=function(){function e(t){xe(this,e),this.pingIntervalId=0,this.pongTimeoutId=0,this.event=t}return Fe(e,[{key:"start",value:function(){var t=this;this.pingIntervalId=setInterval((function(){t.event.dispatchEvent(p.Create.heartbeat(e.Event.BEAT)),!t.pongTimeoutId&&(t.pongTimeoutId=setTimeout((function(){t.event.dispatchEvent(p.Create.heartbeat(e.Event.TIMEOUT,{reason:"pong timeout"}))}),E.Signal_Pong_Timeout))}),E.Signal_Ping_Interval)}},{key:"onPong",value:function(){clearTimeout(this.pongTimeoutId),this.pongTimeoutId=0}},{key:"stop",value:function(){clearInterval(this.pingIntervalId),clearTimeout(this.pongTimeoutId),this.pongTimeoutId=0,this.pingIntervalId=0,this.onPing=null,this.onTimeout=null}}]),e}();it.Event={BEAT:"beat",TIMEOUT:"timeout"};var st=function(){function e(){xe(this,e)}return Fe(e,[{key:"stepup",value:function(e,t,r){this._step(e,t,r,0)}},{key:"stepdown",value:function(e,t,r){this._step(e,t,r,1)}},{key:"_step",value:function(e,t,r,i){var s=t?e+"#"+t:e;if(!this[s])return this[s+"#s"]=i,void(this[s]=r);this[s+"#s"]!=i&&(this[s+"#s"]=i,this[s]=this[s]>=r?this[s]+1:r)}},{key:"filter",value:function(e,t,r){var i=t?e+"#"+t:e;return!!this[i]&&this[i]>r}},{key:"reset",value:function(){for(var e in this)delete this[e]}}]),e}();st.KEY={LOGIN:"login",PUSH:"push",PULL:"pull",MIX:"mix"};var nt=function(){function e(t){var r=this;xe(this,e),this.seq=0,this.sessionid="",this.rparam=t,this.event=(new p).timerEnable((function(e){return r.onTimer(e)})),this.socket=new be("SK-"+_.randomString(4),this.event).setConnTimeout(E.Signal_Conn_Timeout).setReconnTryMax(E.Signal_Reconn_Retry),this.event.on("socket",(function(e){r.onSocketEvent(e)})),this.messConStart=_.curTimeInMilli(),this.heartBeat=new it(this.event),this.event.on("heartbeat",(function(e){r.onHeartEvent(e)})),this.seqFilter=new st}return Fe(e,[{key:"on",value:function(e,t){return this.event.on(e,t),this}},{key:"nextseq",value:function(){return this.seq++,this.seq.toString()}},{key:"curtime",value:function(){return parseInt(Date.now()/1e3).toString()}},{key:"getMisc",value:function(){return wx.getSystemInfoSync().system}},{key:"getConnState",value:function(){return this.socket.SocketTask?this.socket.SocketTask.readyState:s.CONN_STATUS.OFFLINE}},{key:"connect",value:function(e){e?this.socket.open(e):this.socket.reopen()}},{key:"getCurServer",value:function(){return this.socket.getCurServer()}},{key:"clearServers",value:function(){this.socket.clearServers()}},{key:"close",value:function(){this.seq=0,this.seqFilter.reset(),this.socket&&this.socket.close(),this.heartBeat.stop(),this.event.timerStop()}},{key:"onSocketEvent",value:function(t){switch(t.type){case be.Event.CONNECT:this.messConEnd=_.curTimeInMilli(),this.event.dispatchEvent(p.Create.signal(e.Event.CONNECT,this.messConEnd));break;case be.Event.DISCONNECT:this.heartBeat.stop(),this.event.timerStop(),this.event.dispatchEvent(p.Create.signal(e.Event.DISCONNECT));break;case be.Event.MESSAGE:var r=t.data;L().log(" socket message".concat(r.command));var i=_.toHump("recv."+r.command);_.is.isFunction(this[i])?(r.seq&&(r.seq=parseInt(r.seq)),this[i](r)):L().log("[recv] unknown cmd: "+r.command)}}},{key:"onHeartEvent",value:function(e){switch(e.type){case it.Event.BEAT:this.sendHeartBeat();break;case it.Event.TIMEOUT:L().log("HeartBeat timeout.","warn"),this.socket&&this.socket.close(),this.connect()}}},{key:"onTimer",value:function(t){switch(t.type){case e.TimerEvent.REQLIST:Te.room({mess:{command:8}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),this.sendReqlist()}}},{key:"sendLogin",value:function(){L().log("sendLogin"),this.messLoginStart=_.curTimeInMilli(),this.socket.sendMessage({command:Ye,uid:this.rparam.uid,uid_string:this.rparam.uid_string,expass:this.rparam.expass,roomname:this.rparam.roomname,roomname_string:this.rparam.roomname_string,seq:this.nextseq(),sessionid:"",version:s.SIGVERSION,appid:this.rparam.appid,nickname:this.rparam.nickname,act:this.rparam.act,misc:this.getMisc(),platform:s.DEVICE_TYPE,sysver:wt.sysver,devmodel:wt.devmodel,reconnect:this.rparam.reconnect}),this.seqFilter.stepup(st.KEY.LOGIN,null,this.seq)}},{key:"recvLoginAck",value:function(t){if(!this.seqFilter.filter(st.KEY.LOGIN,null,t.seq)){L().log("sendLoginBack"),this.sessionid=t.sessionid,this.heartBeat.start(),this.rparam.userlist=t.userlist;var r={};if(r.msg=t.status,this.rparam.loginContent=r,tt!=t.status)return this.rparam.errcode=t.errcode,void this.event.dispatchEvent(p.Create.signal(e.Event.LOGINFAIL,rt));this.messLoginEnd=_.curTimeInMilli(),this.rparam.messlogin=this.messLoginEnd-this.messLoginStart;var i=wt.getDeviceInfo();this.event.dispatchEvent(p.Create.signal(e.Event.LOGINROOM,{userlist:this.rparam.userlist,loginContent:this.rparam.loginContent,deviceInfo:i}))}}},{key:"startReqlist",value:function(){this.sendReqlist(),this.event.timerStart(),this.event.timerAdd(e.TimerEvent.REQLIST,E.Signal_reqlist_Timeout)}},{key:"sendReqlist",value:function(){this.socket.sendMessage({command:We,uid:this.rparam.uid,roomname:this.rparam.roomname,curtime:this.curtime(),seq:this.nextseq(),sessionid:this.sessionid})}},{key:"recvUserlist",value:function(t){this.event.timerRemove(e.TimerEvent.REQLIST),t.list?this.event.dispatchEvent(p.Create.signal(e.Event.USERLIST,t)):L().log("no list entry for userlist")}},{key:"sendHeartBeat",value:function(){this.socket.sendMessage({command:Xe,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,duration:this.socket.getDuration().toString(),seq:this.nextseq(),sessionid:this.sessionid})}},{key:"recvHeatbeatAck",value:function(e){this.heartBeat.onPong()}},{key:"sendStreamHeartBeat",value:function(e,t){this.socket.sendMessage({command:ze,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,duration:t.toString(),seq:this.nextseq(),sessionid:this.sessionid,streamname:e})}},{key:"recvStreamheartbeatAck",value:function(e){}},{key:"sendAuthpublish",value:function(e){this.messAuthStart=_.curTimeInMilli(),L().log(" authpublish"),this.socket.sendMessage({command:Ke,uid:this.rparam.uid,streamname:e,expass:this.rparam.expass,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,version:s.SIGVERSION,appid:this.rparam.appid,nickname:this.rparam.nickname,misc:this.getMisc()}),L().log("sendauth"),this.seqFilter.stepup(st.KEY.PUSH,e,this.seq)}},{key:"recvAuthpublishAck",value:function(t){if(!this.seqFilter.filter(st.KEY.PUSH,r,t.seq)){var r=t.streamname;L().log("recvauth--".concat(t.status));var i={roomid:t.roomid,status:t.status};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] get roomid: "+t.roomid):i.errcode=t.errcode,this.messAuthEnd=_.curTimeInMilli(),this.rparam.messauthpublish=this.messAuthEnd-this.messAuthStart,this.event.dispatchEvent(p.Create.signal_stream(e.Event.AUTH_PUBLISH,r,i))}}},{key:"sendStartpublish",value:function(e,t){L().log("startpublishsignal ".concat(t.streamstat)),this.socket.sendMessage({command:Ve,roomname:this.rparam.roomname,uid:this.rparam.uid,pushaddr:t.pushaddr,pushport:t.pushport,streaminfo:t,seq:this.nextseq(),sessionid:this.sessionid}),this.seqFilter.stepup(st.KEY.PUSH,e,this.seq)}},{key:"recvStartpublishAck",value:function(t){L().log("startpublishsignalBack");var r=t.streamname;if(!this.seqFilter.filter(st.KEY.PUSH,r,t.seq)){var i={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : start publish"):i.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal_stream(e.Event.START_PUBLISH,r,i))}}},{key:"sendStoppublish",value:function(e,t){this.socket.sendMessage({command:Be,uid:this.rparam.uid,roomid:t.roomid,roomname:this.rparam.roomname,stoptime:this.curtime(),seq:this.nextseq(),sessionid:this.sessionid,streamname:e}),this.seqFilter.stepdown(st.KEY.PUSH,e,this.seq)}},{key:"recvStoppublishAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(st.KEY.PUSH,r,t.seq)){var i={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : stop publish"):i.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal_stream(e.Event.STOP_PUBLISH,r,i))}}},{key:"sendReqMerge",value:function(e){this.socket.sendMessage({command:qe,uid:this.rparam.uid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,mergeinfo:e}),this.seqFilter.stepup(st.KEY.MIX,null,this.seq)}},{key:"recvReqmergeAck",value:function(t){if(!this.seqFilter.filter(st.KEY.MIX,null,t.seq)){var r={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : req merge"):r.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal(e.Event.REQMERGE,r))}}},{key:"sendReqmergeStat",value:function(e){this.socket.sendMessage({command:Qe,uid:this.rparam.uid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,pushaddr:e.pushaddr,pushport:e.pushport,rtmpaddr:e.rtmpaddr,mergestreamid:e.mergestreamid})}},{key:"recvReqmergestatAck",value:function(t){this.seqFilter.stepdown(st.KEY.MIX,streamId,this.seq);var r={};e.noError(t.errcode)?r.connect_count=parseInt(t.connected_count)||0:r.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal(e.Event.REQMERGESTAT,r))}},{key:"sendStopMerge",value:function(e){this.socket.sendMessage({command:je,uid:this.rparam.uid,roomid:this.rparam.roomid,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,pushaddr:e.pushaddr,pushport:e.pushport,rtmpaddr:e.rtmpaddr,mergestreamid:e.mergestreamid}),this.seqFilter.stepdown(st.KEY.MIX,null,this.seq)}},{key:"recvStopmergeAck",value:function(t){if(!this.seqFilter.filter(st.KEY.MIX,null,t.seq)){var r={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : stop merge"):r.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal(e.Event.STOPMERGE,r))}}},{key:"sendSetwatchinfo",value:function(e){this.socket.sendMessage({command:$e,uid:this.rparam.uid,watchaddr:e.host,watchport:e.port.toString(),roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid})}},{key:"recvSetwatchinfoAck",value:function(t){var r={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : set watch info"):r.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal(e.Event.SET_WATCHINFO,r))}},{key:"sendStartplay",value:function(e,t){this.socket.sendMessage({command:Je,playaddr:t.pushaddr+":"+t.pushport,sessionid:this.sessionid,uid:this.rparam.uid,roomname:this.rparam.roomname,roomid:t.roomid,seq:this.nextseq(),streamname:e,streamstat:t.streamstat}),this.seqFilter.stepup(st.KEY.PULL,e,this.seq),L().log("startPlay send signal")}},{key:"recvStartplayAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(st.KEY.PULL,r,t.seq)){var i={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : start play"):i.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal_stream(e.Event.START_PLAY,r,i))}}},{key:"sendStopplay",value:function(e,t,r){this.socket.sendMessage({command:Ze,roomname:this.rparam.roomname,seq:this.nextseq(),streamname:e,sessionid:this.sessionid,uid:this.rparam.uid,roomid:t.roomid,duration:r.toString()}),this.seqFilter.stepdown(st.KEY.PULL,e,this.seq)}},{key:"recvStopplayAck",value:function(t){var r=t.streamname;if(!this.seqFilter.filter(st.KEY.PULL,r,t.seq)){var i={};e.noError(t.errcode)?L().log("client ["+wt.clientId+"] : stop play"):i.errcode=t.errcode,this.event.dispatchEvent(p.Create.signal_stream(e.Event.STOP_PLAY,r,i))}}},{key:"sendLogout",value:function(){this.heartBeat.stop(),this.socket.stopReconnect(),this.socket.sendMessage({command:et,uid:this.rparam.uid,expass:this.rparam.expass,roomname:this.rparam.roomname,seq:this.nextseq(),sessionid:this.sessionid,appid:this.rparam.appid}),this.seqFilter.stepdown(st.KEY.LOGIN,null,this.seq),this.getConnState()!==s.CONN_STATUS.ONLINE&&this.recvLogoutAck()}},{key:"recvLogoutAck",value:function(t){this.close();var r={};r.msg=t&&t.status?t.status:"",this.rparam.loginContent=r,this.event.dispatchEvent(p.Create.signal(e.Event.LOGOUTROOM,this.rparam.loginContent))}}],[{key:"noError",value:function(e){return"0"==e}}]),e}();nt.TimerEvent={REQLIST:"reqlist"},nt.Event={CONNECT:"connect",DISCONNECT:"diconnect",LOGINROOM:"loginroom",USERLIST:"userlist",LOGINFAIL:"loginfail",LOGOUTROOM:"logoutroom",SET_WATCHINFO:"setwatchinfo",AUTH_PUBLISH:"authpublish",START_PUBLISH:"startpublish",STOP_PUBLISH:"stoppublish",START_PLAY:"startplay",STOP_PLAY:"stopplay",REQMERGE:"reqmerge",REQMERGESTAT:"reqmergestat",STOPMERGE:"stopmerge"};const at=nt;function ot(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ct=function(){function e(t,r,i,s,n,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.queues={},this.url=t,this.paramsCallback=r,this.timeout=i||E.AjaxTimeout,this.delay=s||500,this.workingTimeoutId=0,this.netfailtime=0,this.ajaxs=new Array(n||1).fill(0),this.itemNum=a||1}var t,r,i;return t=e,(r=[{key:"addItem",value:function(e,t){!this.queues[e]&&(this.queues[e]=[]),this.queues[e].length>100?L().log("report queue maxed out.","warn"):(this.queues[e].push(t),this.startWorking())}},{key:"startWorking",value:function(){var e=this;this.workingTimeoutId||(this.workingTimeoutId=setTimeout((function(){e.workingTimeoutId=0,e.working()}),this.delay+(this.netfailtime?100*Math.pow(10,Math.min(this.netfailtime,2)):0)))}},{key:"working",value:function(){var e=this.ajaxs.indexOf(0);if(!(e<0)){var t=null,r=null;for(var r in this.queues)if(this.queues[r].length>0){t=this.queues[r];break}if(t){var i=t.splice(0,this.itemNum),s=this.paramsCallback(i);this.ajaxs[e]=1;var n=this;wx.request({url:this.url,dat:s,timeout:this.timeout,success:function(t){n.ajaxs[e]=0,n.netfailtime=0,n.startWorking()},fail:function(s){n.queues[r]=i.concat(t),n.ajaxs[e]=0,n.netfailtime++,n.startWorking()}})}}}}])&&ot(t.prototype,r),i&&ot(t,i),e}(),ut={core:null,itoken:null,init:function(){return this.core=this.core||new ct(E.EventUploadServer+"/rt/client_event",this.getParams.bind(this),null,500,3,10),this.itoken=this.itoken||_.base64encode(E.EventUploadKeys[0]+"-"+_.md5String(_.md5String(E.EventUploadKeys[0])+_.md5String(E.EventUploadKeys[1]))),this},getParams:function(e){return{itoken:this.itoken,appKey:e[0].Aid,events:e,version:s.SDKVERSION}},_common:function(e,t,r,i,n){e.Aid=t.Aid||wt.appId,e.deviceType=s.DEVICE_TYPE,e.roomName=t.roomname_string,e.uid=t.uid,e.cuid=t.uid_string,e.timeStamp=_.curTime(),e.event=r,e.value=i,ut.VALUES.FAILED==e.value&&(e.reason=n&&n.msg),this.core.addItem("evt",e)},room:function(e,t,r,i){},push:function(e,t,r,i,s){},pull:function(e,t,r,i,s){},mix:function(e,t,r,i,s){},CODES:{LOGIN:"room.login",LOGOUT:"room.logout",PUSH:"push.start",UNPUSH:"push.stop",PULL:"pull.start",UNPULL:"pull.stop",MIX:"mix.start",UNMIX:"mix.stop",UPMIX:"mix.layout",VOLOFF:"volume.off",VOLON:"volume.on",CAMERAOFF:"webcam.off",CAMERAON:"webcam.on",CAMERA_FRONT:"webcam.front",CAMERA_BACK:"webcam.rear",CAMERA_OTHER:"webcam.other",WIFI:"network.WIFI",FG:"network.4G",VERSION:"sdk.version"},VALUES:{INIT:"init",SUCCESS:"success",FAILED:"failed"},STMTYPE:{PUSH:"push",PULL:"pull",MIX:"mix"}}.init(),_t={core:null,itoken:null,init:function(){return this.core=this.core||new ct(E.LogUploadServer+"/log/upload",this.getParams.bind(this),null,3e3,3,12),this.itoken=this.itoken||_.base64encode(E.EventUploadKeys[0]+"-"+_.md5String(_.md5String(E.EventUploadKeys[0])+_.md5String(E.EventUploadKeys[1]))),this},getParams:function(e){return{itoken:this.itoken,appKey:e[0].Aid,content:e,version:s.SDKVERSION}},report:function(e,t,r,i,s){i=i||{}},LOGTYPE_UE:"userError",ACTION:{INIT:"init",INITROOM:"initroom",LOGIN:"login",LOGIN_RECONN:"login-reconn",LOGOUT:"logout",ON:"on",OFF:"off",PUBLISH:"publish",PUBLISH_RECONN:"publish-reconn",UNPUBLISH:"unpublish",PLAY:"play",PLAY_RECONN:"play-reconn",UNPLAY:"unplay",PLAY_ROOM_STREAM:"playroom",UNPLAY_ROOM_STREAM:"unplayroom",MIX:"mix",UNMIX:"unmix",UPMIX:"upmix",MUTE:"mute",UNMUTE:"unmute"}}.init();function ht(e){return function(e){if(Array.isArray(e))return lt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return lt(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return lt(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function lt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function mt(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Et=r(930),dt="0";function Tt(e){return{streamId:e.streamname,width:parseInt(e.width),height:parseInt(e.height),uid:e.uid,streamstat:e.streamstat,streamtype:e.streamtype,reason:e.reason}}var St="_idnkey",pt="_push",Ct="_unpush",Rt="_pull",At="_unpull",Ot="_getPushAct",It="_getPullAct",ft="_getStreamMixItems",Pt=function(){function e(t,r){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.onpage=0,this.rparam={},this.rparam.Aid=null,this.rparam.appid=null,this.rparam.appkey=null,this.rparam.roomtoken=null,this._idnkey(t),this.rparam.roomid=dt,this.rparam.innerid=r,this.rparam.roomId="",this.rparam.code=0,this.rparam.servelist=0,this.rparam.getconfig=0,this.rparam.messconnect=0,this.rparam.messlogin=0,this.rparam.messauthpublish=0,this.rparam.messauthPull=0,this.rparam.pubTotal=0,this.rparam.pullTotal=0,this.rparam.ip="",this.rparam.port="",this.rparam.loginStart=0,this.rparam.loginEnd=0,this.rparam.loginConnStart=0,this.rparam.loginConnEnd=0,this.rparam.url=0,this.rparam.reconnect=0,this.room_status=s.ROOM_STATUS.PRELOGIN,this.connect_status=s.ChuangRoomState.DISCONNECTED,this.publish_status=s.ChuangPublishState.DISCONNECTED,this.play_status=s.ChuangPlayState.DISCONNECTED,this.roomact=K.create("room-"+this.rparam.innerid,"room-"+this.rparam.innerid),this.roomact.bind(this).defMachine(gt).defProcess(Nt).record(),this.dpservact=K.create("serv-"+this.rparam.innerid,"serv-"+this.rparam.innerid),this.dpservact.bind(this).defMachine(Ut).defProcess(Lt),this.mix_status=s.MIX_STATUS.PRESTART,this.mixact=K.create("mix-"+this.rparam.innerid,"mix-"+this.rparam.innerid),this.mixact.bind(this).defMachine(kt).defProcess(Ht),this.mixinact=K.create("mixin-"+this.rparam.innerid,"mixin-"+this.rparam.innerid),this.mixinact.bind(this).defMachine(bt).defProcess(xt),this.emitter=new Et,this.event=(new p).linkOpen(p.Name.room(this.rparam.innerid)).timerEnable((function(e){return i.onTimer(e)})),this.dpEmpty=!1,this.dpLoader=Le.newDPLoader(this.event),this.uidLoader=Le.newUIDLoader(this.event),this.keyLoader=Le.newKEYLoader(this.event),this.tokenLoader=Le.newTokenLoader(this.event),this.configLoader=Le.newConfigLoader(this.event),this.followLoader=Le.newFollowLoader(this.event),this.event.on("resource",(function(e){i.onResourceEvent(e)})),this.dpservact.start(s.ACT_PHASE.LOAD,K.setFlow(null,s.ACT_FLOW.PRE_LOAD),null),this.rtcSignal=new at(this.rparam),this.rtcSignal.on("signal",(function(e){i.onSignalEvent(e)})),this.rtcSignal.on("signal-stream",(function(e){i.onSignalStreamEvent(e)})),this.rtcPusher=new le(this.rparam),this.rtcPuller=new le(this.rparam),this.mi_lastCerrcode="999",this.startTime=0,this.roomusers={},this.lastroomusers={},this.watchInfoFlag=!1,this.swiStreamId=null,this.mixStreamConfig=null,this.mergeinfo={},this.mixWidth=800,this.mixHeight=600,this.mi_lastCCount=0,this.mixpub=0,this.deviceInfo="",this.environ="online",this.pushreportId=null,this.pullreportId=null}var t,r,i;return t=e,(r=[{key:"uninit",value:function(){this.emitter.removeEvent(/.*/),this.event.uninit()}},{key:"on",value:function(e,t){return this.emitter.on(e,t),this}},{key:"off",value:function(e,t){return t?this.emitter.off(e,t):this.emitter.removeEvent(e),this}},{key:"emitsafe",value:function(e,t){try{var r;(r=this.emitter).emit.apply(r,[e].concat(ht(t)))}catch(e){console.log(e)}}},{key:"getMixSize",value:function(e){var t={};switch(e){case 0:t.mixWidth=800,t.mixHeight=600;break;case 1:t.mixWidth=432,t.mixHeight=768;break;case 2:t.mixWidth=768,t.mixHeight=432;break;case 3:t.mixWidth=1280,t.mixHeight=720;break;case 4:t.mixWidth=720,t.mixHeight=1280;break;default:t.mixWidth=800,t.mixHeight=600}return t}},{key:St,value:function(e){var t=e.appid,r=e.appkey;-1!=t.indexOf("-")?(this.rparam.Aid=t,r.length>64?(this.rparam.roomtoken=r,this.rparam.appid=null):this.rparam.appid=r):(this.rparam.Aid=r,this.rparam.appid=t,this.rparam.appkey=r)}},{key:"loadpage",value:function(e){this.onpage=e}},{key:"loginRoom",value:function(t,r,i,n){var a=this;if(L().log("sdkloginroom ".concat(t," ").concat(r)),this.rparam.loginStart=_.curTimeInMilli(),!t){var o=m(m.CODE.CHUANG_ROOMID_NULL);return L().log(o.msg,"error"),n&&n(o),!1}return r?(t=t.toString(),r=r.toString(),t.length>255&&(t=t.substr(0,255)),t.match(/[^\w-]/)?(o=m(m.CODE.CHUANG_ROOMID_INVALID),L().log(o.msg,"error"),n&&n(o),!1):(r.length>255&&(r=r.substr(0,255)),r.match(/[^\w-]/)?(o=m(m.CODE.CHUANG_USERID_INVALID),L().log(o.msg,"error"),n&&n(o),!1):1!=i&&2!=i&&3!=i?(o=m(m.CODE.CHUANG_ROLE_PERMISSION_ERROR),L().log(o.msg,"error"),n&&n(o),!1):(Te.room({appid:this.rparam.appid,uidstring:r,roomname:t},Te.CODES.REPORT_TYPE_LOGIN_CALLED_FROM_USER,{uid_string:r,uid:this.rparam&&this.rparam.uid?this.rparam.uid:0,appid:this.rparam.appid}),ut.room(ut.VALUES.INIT,ut.CODES.LOGIN,{roomname_string:t,uid_string:r,uid:this.rparam?this.rparam.uid:r}),void(s.ROOM_STATUS.LOGIN!==this.room_status&&s.ROOM_STATUS.LOGIN_PROC!==this.room_status&&(this.connect_status=s.ChuangRoomState.CONNECTING,this.rparam.roomId=t,this.emitsafe(e.Event.RoomStateUpdate,[t,this.connect_status,m.ErrorCode.CHUANG_SUCCESS]),this.roomact.start(s.ACT_PHASE.LOGIN,[t,r,i],(function(i,o){if(a.rparam.loginEnd=_.curTimeInMilli(),null===o){a.rparam.reconnect=1,L().log("loginAct succeed");var c={appid:a.rparam.appid,uidstring:r,roomname:t,timecost:a.rparam.loginEnd-a.rparam.loginStart,connect:a.rparam.loginConnEnd-a.rparam.loginConnStart,serverlist:a.rparam.servelist,errcode:0};ut.room(ut.VALUES.SUCCESS,ut.CODES.LOGIN,a.rparam),a.rtcSignal.startReqlist(),a.room_status=s.ROOM_STATUS.LOGIN,a.connect_status=s.ChuangRoomState.CONNECTED,a.emitsafe(e.Event.RoomStateUpdate,[a.rparam.roomId,a.connect_status,m.ErrorCode.CHUANG_SUCCESS,a.rparam]),Te.room(c,Te.CODES.REPORT_TYPE_USER_LOGIN_RESULT,a.rparam),a.deviceInfo=a.rparam.deviceInfo,a.deviceInfo.qid=a.rparam.appid,a.deviceInfo.sdkver=a.SDKVERSION,a.deviceInfo.memory=0,a.deviceInfo.mac=0,a.deviceInfo.roomname=a.rparam.roomname,a.deviceInfo.srcuid=a.rparam.uid_string,a.deviceInfo.devtype=9,a.deviceInfo.cuid=a.rparam.uid}else o&&(c={appid:a.rparam.appid,uidstring:r,roomname:t,timecost:a.rparam.loginEnd-a.rparam.loginStart,connect:a.rparam.loginConnEnd-a.rparam.loginConnStart,serverlist:a.rparam.servelist,errcode:-1},Te.room(c,Te.CODES.REPORT_TYPE_USER_LOGIN_RESULT,a.rparam),a.room_status=s.ROOM_STATUS.PRELOGIN,ut.room(ut.VALUES.FAILED,ut.CODES.LOGIN,a.rparam,o),_t.report(o,_t.ACTION.LOGIN,null,a.rparam),n&&n(o))}))))))):(o=m(m.CODE.CHUANG_USERID_NULL),L().log(o.msg,"error"),n&&n(o),!1)}},{key:"logoutRoom",value:function(t){var r=this;ut.room(ut.VALUES.INIT,ut.CODES.LOGOUT,this.rparam),console.log("logout"),Te.room({mess:{roomid:this.rparam.roomname}},Te.CODES.REPORT_TYPE_LOGOUT_CALLED_FROM_USER,this.rparam),s.ROOM_STATUS.PRELOGIN!==this.room_status&&s.ROOM_STATUS.LOGOUT_PROC!==this.room_status&&this.roomact.start(s.ACT_PHASE.LOGOUT,null,(function(i,n){L().log("logout success"),r.followLoader.close(),r.room_status=s.ROOM_STATUS.PRELOGIN,r.rparam.roomid=dt,null===n?(clearInterval(r.pushreportId),clearInterval(r.pullreportId),ut.room(ut.VALUES.SUCCESS,ut.CODES.LOGOUT,r.rparam),Te.room({mess:{roomid:r.rparam.roomname}},Te.CODES.REPORT_TYPE_MESS_LOGOUT_ROOM,r.rparam),r.connect_status=s.ChuangRoomState.DISCONNECTED,r.emitsafe(e.Event.RoomStateUpdate,[r.rparam.roomId,r.connect_status,m.ErrorCode.CHUANG_SUCCESS])):n&&(ut.room(ut.VALUES.FAILED,ut.CODES.LOGOUT,r.rparam,n),_t.report(n,_t.ACTION.LOGOUT,null,r.rparam),t&&t(n))}))}},{key:"getRoomConnectState",value:function(){return this.connect_status}},{key:"onUserlist",value:function(t){if(this.lastroomusers=Object.assign(this.lastroomusers,this.roomusers),this.rparam.act!=s.ChuangUserRole.ANCHOR){var r=[];if(t.list)r=t.list;else{if(!t.length)return;r=t}for(var i,n=[],a=[],o={},c=0,u=r.length;c<u;c++)if(_=(h=r[c]).streamname){if(this.roomusers[_])delete this.roomusers[_];else{if(this.rtcPusher.connectorExists(_))continue;n.push({streamId:(i=h).streamname,width:parseInt(i.width),height:parseInt(i.height),uid:i.uid,streamstat:i.streamstat})}o[_]=h}for(var _ in this.roomusers){var h=this.roomusers[_];if(t.remove_list)for(var l=0;l<t.remove_list.length;l++)h.streamname==t.remove_list[l].streamname&&(h.reason=t.remove_list[l].reason);else h.reason=3;a.push(Tt(h)),delete this.roomusers[_]}this.roomusers=o,this.roomusers=o,n.length&&this.emitsafe(e.Event.RoomStreamUpdate,[this.rparam.roomId,s.ChuangStreamUpdateType.ADD,n]),a.length&&this.emitsafe(e.Event.RoomStreamUpdate,[this.rparam.roomId,s.ChuangStreamUpdateType.DELETE,a])}}},{key:"publishStream",value:function(t,r,i){var n=this;if(this.rparam.mediaConf=r,r.startTime=_.curTimeInMilli(),t)if((t=t.toString()).length>255)o=m(m.CODE.CHUANG_STREAMID_TOO_LONG),i&&i(o);else if(t.match(/[^\w-]/))o=m(m.CODE.CHUANG_STREAMID_INVALID),i&&i(o);else{if(s.ROOM_STATUS.LOGIN!==this.room_status)return o=m(m.CODE.CHUANG_NOT_LOGIN),_t.report(o,_t.ACTION.PUBLISH,null,this.rparam,t),void(i&&i(o));if(this.roomusers[t]&&this.roomusers[t].uid!=this.rparam.uid)return o=m(m.CODE.CHUANG_STREAMID_EXIST,null,{sname:t}),_t.report(o,_t.ACTION.PUBLISH,null,this.rparam,t),void(i&&i(o));var a=new v(t,r);a.streaminConfig.seq=0,Te.push(r,Te.CODES.REPORT_TYPE_PUBLISH_CONFIG,this.rparam,t,a.streaminConfig.videoWidth||0,a.streaminConfig.videoHeight||0),ut.push(ut.VALUES.INIT,ut.CODES.PUBLISH,this.rparam,t),this._push(a,(function(t,r,a){var o=a.exdata,c=o.getStreamId(),u=n;n.deviceInfo.streamname=c,n.deviceInfo.rttinterval=0,n.deviceInfo.keyinterval=0;var h=JSON.stringify(n.deviceInfo).replace(/\"/g,"|"),l=encodeURI(h),E=n.rtcPusher.connectors[c].ccstream.streaminConfig.pushUrl,d=n.rtcPusher.connectors[c].ccstream.streaminConfig.appname,T=n.rtcPusher.connectors[c].ccstream.streaminConfig.puship,S=n.rtcPusher.connectors[c].ccstream.streaminConfig.pushport,p=o.streaminConfig.pushStatus,C=E+"/"+d+"/"+c+"?uid="+n.rparam.uid+"&qid="+n.rparam.appid+"&roomname="+n.rparam.roomname+"&uid_string="+n.rparam.uid_string+"&bitrate="+o.streaminConfig.maxBitrateInKbps+"&puship="+T+"&pushport="+S+"&sdkversion="+u.SDKVERSION+"&key="+p+"&deviceinfo="+l+"&platform=miniprogram&onlyaudio=";console.log("push urlurlurl",C),null===r?(n.event.timerRemove(e.TimerEvent.REPORT_NORMAL+"-"+c),n.rparam.pubUdpConStart=_.curTimeInMilli(),n.publish_status=s.ChuangPublishState.CONNECTED,n.emitter.emit(e.Event.PublishStreamStateUpdate,{streamId:c,servelist:n.rparam.servelist,url:C,status:p},n.publish_status,m.ErrorCode.CHUANG_SUCCESS)):r&&(ut.push(ut.VALUES.FAILED,ut.CODES.PUBLISH,n.rparam,c,r),_t.report(r,_t.ACTION.PUBLISH,null,n.rparam,c),i&&i(r))}))}else{var o=m(m.CODE.CHUANG_STREAMID_NULL);i&&i(o)}}},{key:"rePublish",value:function(t){var r=this.rtcPusher.connectors[t]||{};if("{}"!=JSON.stringify(r)){this.deviceInfo.streamname=t,this.deviceInfo.rttinterval=0,this.deviceInfo.keyinterval=0;var i=JSON.stringify(this.deviceInfo).replace(/\"/g,"|"),n=encodeURI(i),a=r.ccstream.streaminConfig.pushUrl,o=this.rtcPusher.connectors[t].ccstream.streaminConfig.appname,c=this.rtcPusher.connectors[t].ccstream.streaminConfig.puship,u=this.rtcPusher.connectors[t].ccstream.streaminConfig.pushport,_=r.ccstream.streaminConfig.pushStatus,h=a+"/"+o+"/"+t+"?uid="+this.rparam.uid+"&qid="+this.rparam.appid+"&roomname="+this.rparam.roomname+"&uid_string="+this.rparam.uid_string+"&bitrate="+r.ccstream.streaminConfig.maxBitrateInKbps+"&puship="+c+"&pushport="+u+"&sdkversion="+this.SDKVERSION+"&key="+_+"&deviceinfo="+n+"&platform=miniprogram&onlyaudio=";this.publish_status=s.ChuangPublishState.CONNECTED,L().log("republishurl======= ".concat(h)),this.emitter.emit(e.Event.PublishStreamStateUpdate,{streamId:t,url:h,status:"republish"+_},this.publish_status,m.ErrorCode.CHUANG_SUCCESS)}}},{key:"sendStartPublishSignal",value:function(e){L().log("sendStartPublishSignal start"),this._getPushAct(e).start(s.ACT_PHASE.SIG_START_PUB,null,(function(e,t,r){null===t&&L().log("sendStartPublishSignal success")}))}},{key:"sendStartPlaySingal",value:function(e){this._getPushAct(e).start(s.ACT_PHASE.SIG_START_PULL,null,(function(e,t,r){null===t&&L().log("sendStartPlaySignal success")}))}},{key:"unpublishStream",value:function(t,r){var i=this;if(t=t.toString(),ut.push(ut.VALUES.INIT,ut.CODES.UNPUBLISH,this.rparam,t),!this.rtcPusher.connectorExists(t)){var n=m(m.CODE.CHUANG_INVALID_PARAMETERS,null,{sname:t});return _t.report(n,_t.ACTION.UNPUBLISH,null,this.rparam,t),void(r&&r(n))}this._unpush(t,(function(t,n,a){var o=a.exdata,c=o.getStreamId();Te.push({},Te.CODES.REPORT_TYPE_CLOSE_NORMAL,i.rparam,c,o.streaminConfig.videoWidth||0,o.streaminConfig.videoHeight||0),null===n?(ut.push(ut.VALUES.SUCCESS,ut.CODES.UNPUSH,i.rparam,c),i.publish_status=s.ChuangPublishState.DISCONNECTED,i.emitter.emit(e.Event.PublishStreamStateUpdate,{streamId:c},i.publish_status,m.ErrorCode.CHUANG_SUCCESS)):n&&(ut.push(ut.VALUES.FAILED,ut.CODES.UNPUBLISH,i.rparam,c,n),_t.report(n,_t.ACTION.UNPUBLISH,null,i.rparam,c),r&&r(n))}))}},{key:"startMixStream",value:function(t,r){var i=this,n=0,a=0;switch(t.outputVideoResolution){case 0:n=800,a=600;break;case 1:n=432,a=768;break;case 2:n=768,a=432;break;case 3:n=1280,a=720;break;case 4:n=720,a=1280;break;default:n=800,a=600}var o=t.outputStremId;if(ut.mix(ut.VALUES.INIT,ut.CODES.MIX,this.rparam,o),Te.mix({rtmp:t.rtmpAddress,width:n,height:a,videobitrate:t.outputVideoBitrate},Te.CODES.REPORT_TYPE_MESS_MERGE_START,this.rparam,o,n,a),!o){var c=m(m.CODE.CHUANG_MIX_STREAMID_NULL);return _t.report(c,_t.ACTION.MIX,null,this.rparam),void(r&&r(c))}if(o.length>256)return c=m(m.CODE.CHUANG_MIX_STREAMID_TOO_LONG),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),void(r&&r(c));if(o.match(/[^\w-]/)&&(c=m(m.CODE.CHUANG_MIX_STREAMID_INVALID),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),r&&r(c)),s.ROOM_STATUS.LOGIN!==this.room_status)return c=m(m.CODE.CHUANG_NOT_LOGIN),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),void(r&&r(c));if(!t.mixStreams||!t.mixStreams.length)return c=m(CHUANG_MIX_STREAM_CONFIG_ERROR,null,{sname:"*"}),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),void(r&&r(c));if(t.mixStreams.length>9)return c=m(m.CODE.CHUANG_MIX_STREAM_TOO_MUCH),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),void(r&&r(c));if(!t.rtmpAddress)return c=m(m.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID),_t.report(c,_t.CODES.MIX,null,this.rparam,o),void(r&&r());if(t.rtmpAddress.length>1024)return c=m(m.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID),_t.report(c,_t.ACTION.MIX,null,this.rparam,o),void(r&&r(c));var u=0;for(t.mixStreams.length;u++;){var _=t.mixStreams[u].videoWidth%16,h=t.mixStreams[u].videoHeight%16;0==_&&0==h||(t.mixStreams[u].videoWidth-=_,t.mixStreams[u].videoHeight-=h)}this.mixact.start(s.ACT_PHASE.MIX_START,t,(function(n,a,o){var c=t.outputStremId;null===a?(i.mix_status=s.MIX_STATUS.START,ut.mix(ut.VALUES.SUCCESS,ut.CODES.MIX,i.rparam,c),i.emitter.emit(e.Event.MixStreamResult,m.ErrorCode.CHUANG_SUCCESS)):a&&(i.mixStreamConfig=null,ut.mix(ut.VALUES.FAILED,ut.CODES.MIX,i.rparam,c,a),_t.report(a,_t.ACTION.MIX,null,i.rparam,c),r&&r(a))}))}},{key:"updateMixStream",value:function(e,t){var r=this;ut.mix(ut.VALUES.INIT,ut.CODES.UPMIX,this.rparam,""),this.mixact.start(s.ACT_PHASE.MIX_UPDATE,e,(function(e,i,n){null==i?(r.mix_status=s.MIX_STATUS.UPDATE,ut.mix(ut.VALUES.SUCCESS,ut.CODES.UPMIX,r.rparam,"")):i&&(ut.mix(ut.VALUES.FAILED,ut.CODES.UPMIX,r.rparam,"",i),_t.report(i,_t.ACTION.UPMIX,null,r.rparam,""),t&&t(i))}))}},{key:"stopMixStream",value:function(e){var t=this;ut.mix(ut.VALUES.INIT,ut.CODES.UNMIX,this.rparam,""),Te.mix("",Te.CODES.REPORT_TYPE_MESS_MERGE_STOP,this.rparam,"",0,0),this.mixact.start(s.ACT_PHASE.MIX_STOP,null,(function(r,i,s){t.mixStreamConfig=null,null==i?(K.remove(t.mixinact),K.remove(t.mixinact),ut.mix(ut.VALUES.SUCCESS,ut.CODES.UNMIX,t.rparam,"")):i&&(ut.mix(ut.VALUES.FAILED,ut.CODES.UNMIX,t.rparam,"",i),_t.report(i,_t.ACTION.UNMIX,null,t.rparam),e&&e(i))}))}},{key:"playStream",value:function(t,r){var i=this,n=_.curTimeInMilli();if(t)if((t=t.toString()).length>256)o=m(m.CODE.CHUANG_STREAMID_TOO_LONG),r&&r(o);else if(t.match(/[^\w-]/))o=m(m.CODE.CHUANG_STREAMID_INVALID),r&&r(o);else{if(ut.pull(ut.VALUES.INIT,ut.CODES.PULL,this.rparam,t),s.ROOM_STATUS.LOGIN!==this.room_status)return o=m(m.CODE.CHUANG_NOT_LOGIN),_t.report(o,_t.ACTION.PLAY,null,this.rparam,t),void(r&&r(o));var a=new v(t,"");this._pull(a,(function(t,a,o){var c=o.exdata,u=c.getStreamId();if(c.sparam.seq=0,null===a){i.event.timerRemove(e.TimerEvent.REPORT_NORMAL+"-"+u),L().log("".concat(i.rtcPuller.connectors[u]," pull success startTime")),i.rtcPuller.connectors[u].startTime=n,L().log("".concat(i.rtcPuller.connectors[u].startTime," pull success startTime")),i.deviceInfo.streamname=u,i.deviceInfo.proomname=i.rparam.roomname;var h=JSON.stringify(i.deviceInfo).replace(/\"/g,"|"),l=encodeURI(h),E=i.rtcPuller.connectors[u].ccstream.sparam.pullUrl,d=i.rtcPuller.connectors[u].ccstream.sparam.appname,T=i.rtcPuller.connectors[u].ccstream.sparam.puship,S=i.rtcPuller.connectors[u].ccstream.sparam.pushport,p=E+"/"+d+"/"+u+"?uid="+i.rparam.uid+"&qid="+i.rparam.appid+"&roomname="+i.rparam.roomname+"&uid_string="+i.rparam.uid_string+"&pullip="+T+"&pullport="+S+"&playerinfo="+l+"&platform=miniprogram";ut.pull(ut.VALUES.SUCCESS,ut.CODES.PULL,i.rparam,u),i.play_status=s.ChuangPlayState.CONNECTED,L().log("sdk get playurl"),i.emitter.emit(e.Event.PlayStreamStateUpdate,{streamId:u,streamstat:c.sparam.streamstat,streamType:c.sparam.streamtype,url:p},i.play_status,m.ErrorCode.CHUANG_SUCCESS),i.rparam.pullUdpConStart=_.curTimeInMilli()}else a&&(ut.pull(ut.VALUES.FAILED,ut.CODES.PULL,i.rparam,u,a),_t.report(a,_t.ACTION.PLAY,null,i.rparam,u),r&&r(a))}))}else{var o=m(m.CODE.CHUANG_STREAMID_NULL);r&&r(o)}}},{key:"playRoomStream",value:function(e,t,r,i){}},{key:"unplayRoomStream",value:function(e,t,r){}},{key:"unplayStream",value:function(t,r){var i=this;if(t=t.toString(),ut.pull(ut.VALUES.INIT,ut.CODES.UNPULL,this.rparam,t),this.rtcPuller.connectorExists(t))this._unpull(t,(function(t,n,a){var o=a.exdata,c=o.getStreamId();Te.pull({},Te.CODES.REPORT_TYPE_CLOSE_NORMAL,i.rparam,c,o.sparam.width,o.sparam.height),null===n?(ut.pull(ut.VALUES.SUCCESS,ut.CODES.UNPULL,i.rparam,c),i.play_status=s.ChuangPlayState.DISCONNECTED,i.emitter.emit(e.Event.PlayStreamStateUpdate,{streamId:c,streamType:o.sparam.streamtype},i.play_status,m.ErrorCode.CHUANG_SUCCESS)):n&&(ut.pull(ut.VALUES.FAILED,ut.CODES.UNPULL,i.rparam,c,n),_t.report(n,_t.ACTION.UNPLAY,null,i.rparam,c),r&&r(n))}));else{var n=m(m.CODE.CHUANG_INVALID_PARAMETERS,null,{sname:t});_t.report(n,_t.ACTION.UNPLAY,null,this.rparam,t)}}},{key:"reportNormal",value:function(e,t){var r=this,i="",s="";if(wx.getLocation({altitude:"altitude",success:function(e){i=e.latitude,s=e.longitude}}),r.rtcPusher.connectors[e]){var n=r.rtcPusher.connectors[e];Te.push({location:{latitude:i,longitude:s}},Te.CODES.REPORT_TYPE_NORMAL,r.rparam,e,n.ccstream.streaminConfig.videoWidth||0,n.ccstream.streaminConfig.videoHeight||0,t)}else{if(!r.rtcPuller.connectors[e])return;n=r.rtcPuller.connectors[e],Te.pull({location:{latitude:i,longitude:s}},Te.CODES.REPORT_TYPE_NORMAL,r.rparam,e,n.ccstream.sparam.width,n.ccstream.sparam.height,t)}}},{key:"statusNotification",value:function(t,r,i){if(t){var s=this.rtcPuller.connectors[t]?this.rtcPuller.connectors[t]:this.rtcPusher.connectors[t];if(s)switch(i&&i.width&&i.height&&(s.ccstream.sparam?(s.sparam.width=i.width,s.sparam.height=i.height):(s.ccstream.streaminConfig.videoWidth=i.width,s.ccstream.streaminConfig.videoHeight=i.height)),r){case 401:Te.room({},Te.CODES.REPORT_TYPE_APP_BECOME_BACKGROUND,this.rparam);break;case 402:Te.room({},Te.CODES.REPORT_TYPE_APP_BECOME_FOREGROUND,this.rparam);break;case 2001:this.rparam.pullUdpConEnd=_.curTimeInMilli(),this.rparam.pullwebrtcsocket=this.rparam.pullUdpConEnd-this.rparam.pullUdpConStart;break;case 2002:var n={streamId:t,url:i.url};this.event.timerAdd(e.TimerEvent.REPORT_NORMAL,-3e5,n,e.TimerEvent.REPORT_NORMAL+"-"+t);var a=_.curTimeInMilli();this.rparam.pullTotal=a-u;var o=a-this.rparam.pullUdpConEnd,c={timecost:{servelist:this.rparam.servelist,getconfig:this.rparam.getconfig,messconnect:this.rparam.messconnect,messlogin:this.rparam.messlogin,webrtcsocket:this.rparam.pubwebrtcsocket,webrtcconnect:o,total:this.rparam.pubTotal}};Te.pull({},Te.CODES.REPORT_TYPE_PLAY_START,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2003:s.ccstream.sparam.fitVideoTime=Date.now(),Te.pull({timecost:{firstvideo:i.time}},Te.CODES.REPORT_TYPE_RECV_FIRST_VIDEO,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url),Te.pull({timecost:{firstaudio:i.time}},Te.CODES.REPORT_TYPE_RECV_FIRST_AUDIO,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2004:a=_.curTimeInMilli(),L().log("2004 get startTime");var u=s.startTime;L().log("2004 get startTime"),this.rparam.pullTotal=a-u,o=a-this.rparam.pullUdpConEnd,c={timecost:{servelist:this.rparam.servelist,messconnect:this.rparam.messconnect,messlogin:this.rparam.messlogin,webrtcsocket:this.rparam.pullwebrtcsocket,webrtcconnect:o,total:this.rparam.pullTotal}},Te.pull(c,Te.CODES.REPORT_TYPE_PLAY_SUCCEED,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2008:break;case 2009:Te.pull({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case-2301:Te.pull({},Te.CODES.REPORT_TYPE_SERVER_TIMEOUT,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url),this.playNextConn(t);break;case-2302:Te.pull({error:{code:r,msg:i.msg}},Te.CODES.REPORT_TYPE_INITIALIZE_FAILED,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2101:Te.pull({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2102:Te.pull({},Te.CODES.REPORT_TYPE_RECV_ERROR_AUDIO_CONFIG,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2103:this.playNextConn(t),Te.pull({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 2104:case 2105:case 2106:case 2107:case 2108:Te.pull({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.sparam.width,s.ccstream.sparam.height,i.url);break;case 3001:if(Te.pull({error:{type:3,code:r,rtmpaddr:i.url}},Te.CODES.REPORT_TYPE_RECV_SERVER_ERROR,this.rparam,t,i.width||s.ccstream.sparam.width,i.height||s.ccstream.sparam.height,i.url),this.rtcPusher.connectorExists(t))this.pushNextConn(t);else{if(!this.rtcPuller.connectorExists(t))return void L().log("".concat(t,"触发 3001  流不存在"));this.playNextConn(t)}break;case 3002:if(Te.pull({},Te.CODES.REPORT_TYPE_RTMP_CONNECT_FAILED,this.rparam,t,i.width||s.ccstream.sparam.width,i.height||s.ccstream.sparam.height,i.url),this.rtcPusher.connectorExists(t))this.pushNextConn(t);else{if(!this.rtcPuller.connectorExists(t))return void L().log("".concat(t,"触发 3002  流不存在"));this.playNextConn(t)}break;case 3003:if(Te.pull({error:{type:3,code:r,rtmpaddr:i.url}},Te.CODES.REPORT_TYPE_RECV_SERVER_ERROR,this.rparam,t,i.width||s.ccstream.sparam.width,i.height||s.ccstream.sparam.height,i.url),this.rtcPusher.connectorExists(t))this.pushNextConn(t);else{if(!this.rtcPuller.connectorExists(t))return void L().log("".concat(t,"触发 3003  流不存在"));this.playNextConn(t)}break;case 3004:this.pushNextConn(t),Te.push({},Te.CODES.REPORT_TYPE_RECV_CLOSE_PACKET,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 3005:var h=Date.now();if(Te.pull({error:{type:3,code:r,rtmpaddr:i.url}},Te.CODES.REPORT_TYPE_RECV_SERVER_ERROR,this.rparam,t,i.width||s.ccstream.sparam.width,i.height||s.ccstream.sparam.height,i.url),this.rtcPuller.getPuller(t))this.playNextConn(t);else{if(!this.rtcPusher.getPusher(t))return;s.ccstream.streaminConfig.seq++,(h-s.ccstream.streaminConfig.firstVideoTime>30||s.ccstream.streaminConfig.seq>3)&&this.pushNextConn(t)}break;case 1001:var l="",m="";wx.getLocation({altitude:"altitude",success:function(e){l=e.latitude,m=e.longitude}}),this.rparam.pubUdpConEnd=_.curTimeInMilli(),this.rparam.pubwebrtcsocket=this.rparam.pubUdpConEnd-this.rparam.pubUdpConStart,Te.push({location:{latitude:l,longitude:m}},Te.CODES.REPORT_TYPE_PUBLISH_START,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1002:n={streamId:t,url:i.url},this.event.timerAdd(e.TimerEvent.REPORT_NORMAL,-3e5,n,e.TimerEvent.REPORT_NORMAL+"-"+t),L().log("1002 get startTime");var E=s.startTime;L().log("1002 get startTime");var d=_.curTimeInMilli();this.rparam.pubTotal=d-E,o=d-this.rparam.pubUdpConEnd,c={timecost:{servelist:this.rparam.servelist,getconfig:this.rparam.getconfig,messconnect:this.rparam.messconnect,messlogin:this.rparam.messlogin,webrtcsocket:this.rparam.pubwebrtcsocket,webrtcconnect:o,messauthpublish:this.rparam.messauthpublish,total:this.rparam.pubTotal}},Te.push(c,Te.CODES.REPORT_TYPE_PUBLISH_SUCCEED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1005:var T=parseInt(i.width)*parseInt(i.height),S=s.ccstream.streaminConfig.resolution;if(T>S)Te.push({resolution:{from:S,to:T}},Te.CODES.REPORT_TYPE_PUBLISH_RESOLUTION_UP,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0),s.ccstream.streaminConfig.resolution=T;else{if(!(T<S))return;Te.push({resolution:{from:S,to:T}},Te.CODES.REPORT_TYPE_PUBLISH_RESOLUTION_DOWN,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0),s.ccstream.streaminConfig.resolution=T}break;case 1006:Te.push({bweinfo:[]},Te.CODES.REPORT_TYPE_BWE_CHANGE_INFO,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1007:s.ccstream.streaminConfig.fitVideoTime=Date.now();break;case-1301:this.pushNextConn(t),Te.push({},Te.CODES.REPORT_TYPE_INITIALIZE_FAILED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0),Te.push({},Te.CODES.REPORT_TYPE_SYSTEM_CAMERA_PERMISSION_DENIED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case-1302:this.pushNextConn(t),Te.push({},Te.CODES.REPORT_TYPE_INITIALIZE_FAILED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case-1303:this.pushNextConn(t),Te.push({error:{streamid:t}},Te.CODES.REPORT_TYPE_PUBLISH_VIDEO_FRAME_TIMEOUT,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case-1304:this.pushNextConn(t),Te.push({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case-1305:case-1306:this.pushNextConn(t),Te.push({error:{code:r,msg:i}},Te.CODES.REPORT_TYPE_INITIALIZE_FAILED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case-1307:Te.push({errcode:r,msg:i},Te.CODES.REPORT_TYPE_PUBLISH_DISCONNECTED,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0),this.pushNextConn(t);break;case-1311:this.pushNextConn(t),Te.push({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1101:Te.push({},Te.CODES.REPORT_TYPE_RTMP_BAD_NETWORK,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1102:this.pushNextConn(t),Te.push({ip:i,application:2,streamname:t},Te.CODES.REPORT_TYPE_SERVER_NO_RESPONSE_WITH_INTERNAL_RETRY,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1103:Te.push(i,Te.CODES.REPORT_TYPE_PUBLISH_VIDEO_ENCODER_START_EXCEPTION,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1104:this.pushNextConn(t),Te.push({error:{streamid:t}},Te.CODES.REPORT_TYPE_PUBLISH_VIDEO_FRAME_TIMEOUT,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0);break;case 1105:case 1106:Te.push({streamid:t,code:r},Te.CODES.REPORT_TYPE_MINIPROGRAM_EVENT,this.rparam,t,s.ccstream.streaminConfig.videoWidth||0,s.ccstream.streaminConfig.videoHeight||0)}}}},{key:"playNextConn",value:function(t){this.play_status=s.ChuangPlayState.CONNECTING;var r=this.rtcPuller.connectors[t]||{};if("{}"!=JSON.stringify(r)){var i=r.ccstream.sparam.streamstat,n=r.ccstream.sparam.platform;this.emitter.emit(e.Event.PlayStreamStateUpdate,{streamId:t,streamstat:i,streamType:n},this.play_status,m.ErrorCode.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK);var a=this._getPullAct(t);a.stop();var o=this;a.start(s.ACT_PHASE.UNPULL,null,(function(e,r){null===r&&o.playStream(t)}))}}},{key:"pushNextConn",value:function(t){this.rtcPusher.onDisconnect();var r=this._getPushAct(t),i=this.rtcPusher.connectors[t]||{};if("{}"!=JSON.stringify(i)){this.publish_status=s.ChuangPublishState.CONNECTING;var n=i.ccstream.streaminConfig.pushStatus;this.emitter.emit(e.Event.PublishStreamStateUpdate,{streamId:t,streamstat:i.ccstream.streaminConfig.streamstat,status:n},this.publish_status,m.ErrorCode.CHUANG_STREAM_DISCONNECTED_BAD_NETWORK),r.stop();var a=this;r.start(s.ACT_PHASE.SIG_AUTH_PUB,null,(function(e,r){null===r&&a.rePublish(t)}))}}},{key:"onSignalEvent",value:function(t){var r=this;switch(t.type){case at.Event.CONNECT:this.rparam.messconnect=t.data-this.rparam.messConStart,this.roomact.finished(s.ACT_PROC.LOGIN_CONN);break;case at.Event.DISCONNECT:this.rparam.code=1,Te.room({mess:{error:-1}},Te.CODES.REPORT_TYPE_MESS_DISCONNECT,this.rparam),_.curTime(),this.connect_status=s.ChuangRoomState.DISCONNECTED,this.emitsafe(e.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_ROOM_DISCONNECTED_BAD_NETWORK]),this.roomact.isActive()?this.roomact.jump(s.ACT_PHASE.RELOGIN,{}):this.roomact.start(s.ACT_PHASE.RELOGIN,null,(function(t,i){if(null===i){r.connect_status=s.ChuangRoomState.CONNECTED,r.emitsafe(e.Event.RoomStateUpdate,[r.rparam.roomId,r.connect_status,m.ErrorCode.CHUANG_ROOM_RECONNECTED]),r.rtcSignal.startReqlist();var n=r.rtcPusher.getAllStreamIds();if(n.length>0){r.emitter.emit(e.Event.STREAM_REPUBLISH,n);for(var a=0,o=n.length;a<o;a++){var c=r._getPushAct(n[a]),u=r;c.start(s.ACT_PHASE.REPUSH,null,(function(t,r,i){r||(u.publish_status=s.ChuangPublishState.CONNECTED,u.emitter.emit(e.Event.PublishStreamStateUpdate,streamId,u.publish_status,m.ErrorCode.CHUANG_PUBLISH_STREAM_RECONNECTED))}))}}}else i&&_t.report(i,_t.ACTION.LOGIN_RECONN,null,r.rparam,r.ccstream.getStreamId())}));break;case at.Event.LOGINROOM:this.rparam.loginContent=t.data.loginContent,this.rparam.userlist=t.data.userlist,this.rparam.deviceInfo=t.data.deviceInfo,Te.room({mess:{code:this.rparam.code,msg:this.rparam.loginContent.msg,roomname:this.rparam.roomname_string}},Te.CODES.REPORT_TYPE_MESS_LOGIN_SUCCEED,this.rparam),s.ROOM_STATUS.LOGIN_PROC==this.room_status&&(this.room_status=s.ROOM_STATUS.LOGIN)," banned_by_app"==this.rparam.loginContent.msg&&Te.room({mess:{code:this.rparam.code,msg:this.rparam.loginContent.msg}},Te.CODES.REPORT_TYPE_MESS_BANNED_BY_APP,this.rparam),this.roomact.finished(s.ACT_PROC.SIG_LOGIN);break;case at.Event.LOGINFAIL:Te.room({mess:{code:this.rparam.errcode,msg:this.rparam.loginContent.msg,roomname:this.rparam.roomname_string}},Te.CODES.REPORT_TYPE_MESS_LOGIN_FAILED,this.rparam),this.connect_status=s.ChuangRoomState.DISCONNECTED,"-201"==this.rparam.errcode?(this.roomact.failed(s.ACT_PROC.SIG_LOGIN,m(m.CODE.CHUANG_LOGIN_FAILED_APPID,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_LOGIN_FAILED_APPID)):"-312"==this.rparam.errcode?(this.roomact.failed(s.ACT_PROC.SIG_LOGIN,m(m.CODE.CHUANG_LOGIN_FAILED_BANNED,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_LOGIN_FAILED_BANNED)):"-202"==this.rparam.errcode?(this.roomact.failed(s.ACT_PROC.SIG_LOGIN,m(m.CODE.CHUANG_LOGIN_FAILED_PARAM_ERROR,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_LOGIN_FAILED_PARAM_ERROR)):(this.roomact.failed(s.ACT_PROC.SIG_LOGIN,m(m.CODE.CHUANG_LOGIN_FAILED,null,{errcode:t.data})),this.emitter.emit(e.Event.RoomStateUpdate,this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_LOGIN_FAILED));break;case at.Event.LOGOUTROOM:this.roomact.finished(s.ACT_PROC.LOGOUT);break;case at.Event.USERLIST:var i=t.data;this.onUserlist(i);break;case at.Event.SET_WATCHINFO:t.streamId=this.swiStreamId,this.onSignalStreamEvent(t),this.swiStreamId=null;break;case at.Event.REQMERGE:var n=(a=!t.data.errcode)?null:t.data.errcode;a||"101"==n?(this.mixinact.finished(s.ACT_PROC.SIG_REQMERGE),this.event.timerAdd(e.TimerEvent.MIX_REQMERGESTAT,3e4)):"100"==n?(Te.mix({},Te.CODES.MESS_MERGE_CB_INVALID_PARAMETERS_FROM_SERVER,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(s.ACT_PHASE.MIXIN_RESTART_DELAY)):"213"==n?(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_FAILED_ERROR_RESOLUTION,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.failed(s.ACT_PROC.SIG_REQMERGE,m(m.CODE.CHUANG_MIX_STREAM_TOO_MUCH))):"102"==n?this.mixinact.failed(s.ACT_PROC.SIG_REQMERGE,m(m.CODE.CHUANG_MIX_STREAM_TOO_MUCH)):this.mixinact.failed(s.ACT_PROC.SIG_REQMERGE,m(m.CODE.CHUANG_WEBRTC_UNKNOWN_ERROR));break;case at.Event.REQMERGESTAT:var a;if(n=(a=!t.data.errcode)?null:t.data.errcode,this.mi_lastCerrcode=t.data.error,a){var o=this.mi_lastCCount,c=this.mi_lastCCount=t.data.connect_count;0==o&&0==c?this.mixinact.finished(s.ACT_PROC.SIG_REQMERGESTAT,1e3):0==o&&0!=c?(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_SUCCESS,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.event.timerRemove(e.TimerEvent.MIX_REQMERGESTAT),this.mixact.finished(s.ACT_PROC.MIX_STARTIN),this.mixinact.finished(s.ACT_PROC.SIG_REQMERGESTAT,1e4)):0!=o&&0==c?(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ERROR,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(s.ACT_PHASE.MIXIN_RESTART_DELAY)):this.mixinact.finished(s.ACT_PROC.SIG_REQMERGESTAT,1e4)}else"900"==n?(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(s.ACT_PHASE.MIXIN_RESTART_DELAY)):"999"==c?this.mixinact.finished(s.ACT_PROC.SIG_REQMERGESTAT,15e3):(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_RESTART_NO_RECORD,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(s.ACT_PHASE.MIXIN_RESTART_DELAY));break;case at.Event.STOPMERGE:this.mixact.finished(s.ACT_PROC.MIX_STOPIN),this.mixinact.finished(s.ACT_PROC.SIG_STOPMERGE),this.event.timerRemove(e.TimerEvent.MIX_REQMERGESTAT)}}},{key:"onSignalStreamEvent",value:function(e){var t=e.streamId,r=!e.data.errcode,i=r?null:e.data.errcode,n=null;switch(e.type){case at.Event.AUTH_PUBLISH:n=this._getPushAct(t);var a=e.data.roomid;if(dt==this.rparam.roomid&&0!=a&&(this.rparam.roomid=a.toString()),(u=n.exdata).roomid=a.toString(),r){this.rtcPusher.setAuthsta(e.data.status),u.streaminConfig.pushStatus=e.data.status;var o={mess:{roomname:this.rparam.roomname_string,streamname:t,roomid:this.rparam.roomid,status:e.data.status}};Te.push(o,Te.CODES.REPORT_TYPE_MESS_AUTH_PUBLISH_SUCCEED,this.rparam,t,u.streaminConfig.videoWidth||0,u.streaminConfig.videoHeight||0),n.finished(s.ACT_PROC.SIG_AUTH_PUB)}else{var c={mess:{roomname:this.rparam.roomname_string,streamname:t,roomid:this.rparam.roomid,status:e.data.status,errcode:e.data.errcode}};Te.push(c,Te.CODES.REPORT_TYPE_MESS_AUTH_PUBLISH_FAILED,this.rparam,t,u.streaminConfig.videoWidth||0,u.streaminConfig.videoHeight||0),n.failed(s.ACT_PROC.SIG_AUTH_PUB,m(m.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"ap",errcode:i}))}break;case at.Event.START_PUBLISH:var u=(n=this._getPushAct(t)).exdata;r?n.finished(s.ACT_PROC.SIG_START_PUB):(Te.push({error:{streamid:t}},Te.CODES.REPORT_TYPE_MESS_START_PUBLISH_FAILED,this.rparam,t,u.streaminConfig.videoWidth||0,u.streaminConfig.videoHeight||0),n.jump(s.ACT_PHASE.SIG_START_PUB_FAIL,i));break;case at.Event.SET_WATCHINFO:n=this._getPushAct(t),r?(this.watchInfoFlag=!0,n.finished(s.ACT_PROC.SIG_SET_WATCH_INFO)):n.failed(s.ACT_PROC.SIG_SET_WATCH_INFO,m(m.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"swi",errcode:i}));break;case at.Event.STOP_PUBLISH:n=this._getPushAct(t),r?n.finished(s.ACT_PROC.SIG_STOP_PUB):n.failed(s.ACT_PROC.SIG_STOP_PUB,m(m.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"np",errcode:i}));break;case at.Event.START_PLAY:n=this._getPullAct(t),r?n.finished(s.ACT_PROC.SIG_START_PULL):n.failed(s.ACT_PROC.SIG_START_PULL,m(m.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"sw",errcode:i}));break;case at.Event.STOP_PLAY:n=this._getPullAct(t),r?n.finished(s.ACT_PROC.SIG_STOP_PULL):n.failed(s.ACT_PROC.SIG_STOP_PULL,m(m.CODE.CHUANG_WEBRTC_SIGNAL_ERROR,null,{req:"nw",errcode:i}))}}},{key:"onResourceEvent",value:function(t){var r=this;switch(t.type){case Le.Event.TOKEN_RESULT:this.rparam.appid=t.data.appKey,this.dpservact.finished(s.ACT_PROC.TOKEN);break;case Le.Event.TOKEN_NET_FAIL:this.connect_status=s.ChuangRoomState.DISCONNECTED,this.emitsafe(e.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_TOKEN_AUTH_ERROR]),this.dpservact.finished(s.ACT_PROC.TOKEN,s.ACT_NET_FAIL);break;case Le.Event.TOKEN_FAIL:this.dpservact.failed(s.ACT_PROC.TOKEN,t.data);break;case Le.Event.KEY_RESULT:this.rparam.appkey=t.data.res,this.rparam.reqKeyCost=t.data.cost-this.rparam.reqKeystart,this.dpservact.finished(s.ACT_PROC.KEY);break;case Le.Event.KEY_NET_FAIL:this.dpservact.finished(s.ACT_PROC.KEY,s.ACT_NET_FAIL);break;case Le.Event.KEY_FAIL:this.dpservact.failed(s.ACT_PROC.KEY,t.data);break;case Le.Event.UID_RESULT:this.rparam.uid=t.data,this.dpservact.finished(s.ACT_PROC.UID);break;case Le.Event.UID_NET_FAIL:this.dpservact.finished(s.ACT_PROC.UID,s.ACT_NET_FAIL);break;case Le.Event.UID_FAIL:this.dpservact.failed(s.ACT_PROC.UID,t.data);break;case Le.Event.DP_RESULT:this.rparam.servelist=t.data.content.cost,this.dpEmpty=!1;var i=t.data.resp[s.DPKEYS.MESSAGE][0].split(/[-:/]/);this.rparam.ip=i[3]+"."+i[4]+"."+i[5]+"."+i[6],this.rparam.port=i[i.length-2],E.FOLLOWServer=t.data.resp[s.DPKEYS.PUBLISH],this.dpservact.finished(s.ACT_PROC.DP,t.data.resp),Te.room(t.data.content,Te.CODES.REPORT_TYPE_GET_SERVER_LIST_SUCCEED,this.rparam);break;case Le.Event.MDP_RESULT:var n=t.data.resp,a=t.data.id;this.rtcPuller.setMServers(n[s.DPKEYS.WATCH]),this._getPullAct(a)&&this._getPullAct(a).finished(s.ACT_PROC.STM_PULL);break;case Le.Event.DP_EMPTY:if(this.dpEmpty)return void this.dpservact.failed(s.ACT_PROC.DP,m(m.CODE.CHUANG_LOGIN_FAILED));this.dpEmpty=!0,this.dpservact.jump(s.ACT_PHASE.LOAD_DP);break;case Le.Event.DP_NET_FAIL:this.dpservact.finished(s.ACT_PROC.DP,s.ACT_NET_FAIL);break;case Le.Event.DP_FAIL:this.dpservact.failed(s.ACT_PROC.DP,t.data);break;case Le.Event.CONFIG_RESULT:this.rparam.getconfig=t.data.cost,Te.room(t.data,Te.CODES.REPORT_TYPE_GET_CONFIG_SUCCEED,this.rparam),this.dpservact.finished(s.ACT_PROC.LOAD_CONFIG);break;case Le.Event.CONFIG_FAIL:Te.room(t.data,Te.CODES.REPORT_TYPE_GET_CONFIG_FAILED,this.rparam),this.dpservact.failed(s.ACT_PROC.LOAD_CONFIG);break;case Le.Event.FOLLOW_RESULT:var o=t.data;if(console.log("streamfollow",o.streamname),a=o.streamname,console.log("streamfollow222",o.streamname),o.addr.length)if("0"==o.request_type){var c=this.rtcPusher.getPusher(a);c.ccstream.streaminConfig.pushUrl="rtmp://"+t.data.addr[0].ip,c.ccstream.streaminConfig.puship=t.data.puship||"0.0.0.0",c.ccstream.streaminConfig.pushport=t.data.pushport||0,c.ccstream.streaminConfig.appname=t.data.addr[0].appname,this._getPushAct(a)&&this._getPushAct(a).finished(s.ACT_PROC.STM_ASK_SERVER)}else{var u=this.rtcPuller.getPuller(a);u.ccstream.sparam.pullUrl="rtmp://"+t.data.addr[0].ip,u.ccstream.sparam.pullip=t.data.pullip||"0.0.0.0",u.ccstream.sparam.pullport=t.data.pullport||0,u.ccstream.sparam.appname=t.data.addr[0].appname,this._getPullAct(a)&&this._getPullAct(a).finished(s.ACT_PROC.STM_ASK_SERVER)}else"0"==o.request_type?setTimeout((function(){return r.getActPush(a)}),500):setTimeout((function(){return r.getActPull(a)}),500);break;case Le.Event.FOLLOW_FAIL:o.addr[0].type?this._getPullAct(a)&&this._getPullAct(a).finished(s.ACT_PROC.STM_ASK_SERVER,s.ACT_NET_FAIL):this._getPushAct(a)&&this._getPushAct(a).finished(s.ACT_PROC.STM_ASK_SERVER,s.ACT_NET_FAIL)}}},{key:"onTimer",value:function(t){switch(t.type){case e.TimerEvent.PUSH_HEARTBEAT:var r=t.data,i=this.rtcPusher.getPusher(r.streamId),n=i&&i.getDuration()||Math.ceil((Date.now()-this.startTime)/1e3);this.rtcSignal.sendStreamHeartBeat(r.streamId,n);break;case e.TimerEvent.MIX_REQMERGESTAT:Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_RESTART_CONNECT_COUNT_ZERO,this.rparam,this.mergeinfo.mergestreamid,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.jump(s.ACT_PHASE.MIXIN_RESTART_DELAY);break;case e.TimerEvent.SIGNAL_CONNECT:Te.room({},Te.CODES.REPORT_TYPE_MESS_CONNECT_PROCESS_TIMEOUT,this.rparam);break;case e.TimerEvent.REPORT_NORMAL:r=t.data,this.reportNormal(r.streamId,r.url)}}},{key:"getActPush",value:function(e){this._getPushAct(e)&&this._getPushAct(e).jump(s.ACT_PHASE.STM_ASK_SERVER)}},{key:"getActPull",value:function(e){this._getPullAct(e)&&this._getPullAct(e).jump(s.ACT_PHASE.STM_ASK_SERVER)}},{key:pt,value:function(e,t){var r="pushx-"+e.getStreamId()+"-"+this.rparam.innerid,i=K.find(r);i||(i=K.create(r,r)).bindData(e).defMachine(Dt).defProcess(yt).record(),i.bind(this),i.start(s.ACT_PHASE.PUSH,null,(function(e,r,i){r&&K.remove(i.uid),t(e,r,i)}))}},{key:Ct,value:function(e,t){this._getPushAct(e).start(s.ACT_PHASE.SIG_STOP_PUB,null,(function(e,r,i){K.remove(i.uid),t(e,r,i)}))}},{key:Rt,value:function(e,t){var r="pullx-"+e.getStreamId()+"-"+this.rparam.innerid,i=K.find(r);i||(i=K.create(r,r)).bindData(e).defMachine(Mt).defProcess(Gt),i.bind(this),i.start(s.ACT_PHASE.PULL,e.getStreamId(),(function(e,r,i){r&&K.remove(i.uid),t(e,r,i)}))}},{key:At,value:function(e,t){this._getPullAct(e).start(s.ACT_PHASE.UNPULL,null,(function(e,r,i){K.remove(i.uid),t(e,r,i)}))}},{key:Ot,value:function(e){var t="pushx-"+e+"-"+this.rparam.innerid;return K.find(t)||K.dummy}},{key:It,value:function(e){var t="pullx-"+e+"-"+this.rparam.innerid;return K.find(t)||K.dummy}},{key:"_getConnector",value:function(e){var t,r;return(r=this.rtcPuller.getPuller(e))?r:(t=this.rtcPusher.getPusher(e))?t:null}},{key:ft,value:function(){for(var e=this.mixStreamConfig.mixStreams,t=[],r=[],i=0,s=0,n=e.length;s<n;s++){var a=function(){var e=0,t=0,r=c.width/c.height,i=(c.dstRect.right-c.dstRect.left)/(c.dstRect.bottom-c.dstRect.top);return r/i>1?(e=c.height,t=c.height*i):(t=c.width,e=1*c.width/i),c.srcRect={left:(parseInt(c.width)/2-parseInt(t/2)).toString(),top:(parseInt(c.height)/2-parseInt(e/2)).toString(),right:(parseInt(c.width)/2+parseInt(t/2)).toString(),bottom:(parseInt(c.height)/2+parseInt(e/2)).toString()}},o=e[s].streamId,c={srcRect:{},dstRect:{}};c.mixa=E.Mix_Stream_Mixa,c.zlevel=i.toString();var u=this.rtcPusher.getPusher(o);if(u){var h=_.parseUrl(u.wssUrl),l=u.getStream();if(!h){Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_FAILED_INVALID_PUBLISH_ADDRESS,this.rparam,o,l.getStreamConfig().videoWidth.toString(),l.getStreamConfig().videoHeight.toString());continue}c.pushaddr=h.host,c.pushport=h.port.toString(),c.uid=this.rparam.uid,c.roomid=l.getroomid(),c.width=l.getStreamConfig().videoWidth.toString(),c.height=l.getStreamConfig().videoHeight.toString(),c.mixv=l.sparam.mixv,c.dstRect={left:(i>4?160*(i-5):160*i).toString(),right:i>4?(160*(i-4)).toString():(160*(i+1)).toString(),top:i>4?"130":"0",bottom:i>4?"250":"120"},c.srcRect=a(),t.push(c)}else{var m=this.roomusers[o];if(!m)continue;c.pushaddr=m.pushaddr,c.pushport=m.pushport,c.roomid=m.roomid,c.uid=m.uid,c.width=m.width.toString(),c.height=m.height.toString(),c.mixv=m.mixv,c.dstRect={left:(i>4?160*(i-5):160*i).toString(),right:i>4?(160*(i-4)).toString():(160*(i+1)).toString(),top:i>4?"130":"0",bottom:i>4?"250":"120"},c.srcRect=a(),r.push(c)}i++}return 0==t.length?void 0:t.concat(r)}}])&&mt(t.prototype,r),i&&mt(t,i),e}();Pt.TimerEvent={PUSH_HEARTBEAT:"push-hb",MIX_REQMERGESTAT:"mix-reqmer",SIGNAL_CONNECT:"signal-connect",REPORT_NORMAL:"report-normal"},Pt.Event={RoomStateUpdate:"RoomStateUpdate",RoomStreamUpdate:"RoomStreamUpdate",MixStreamResult:"MixStreamResult",STREAM_AUDIO_REVOKED:"stream-Audio-revoked",STREAM_VIDEO_REVOKED:"stream-video-revoked",PublishStreamStateUpdate:"PublishStreamStateUpdate",PlayStreamStateUpdate:"PlayStreamStateUpdate",SDK_ERROR:"sdk-error"};const vt=Pt;function gt(e,t){switch(e){case s.ACT_PHASE.LOGIN:if(s.ROOM_STATUS.LOGIN===this.room_status||s.ROOM_STATUS.LOGIN_PROC===this.room_status)return K.SKIP;var r=t[0],i=t[1],n=t[2];return r=r.toString(),i=i.toString(),this.rparam.appid&&this.rparam.uid_string==i||(this.rtcSignal.clearServers(),this.rtcPusher.clearServers(),this.rtcPuller.clearServers(),this.rparam.uid=""),this.rparam.appid&&(this.rparam.roomname=me.roomnameFilter(r,this.rparam.appid)),this.rparam.roomname_string=r,this.rparam.uid_string=i,this.rparam.nickname=i,this.rparam.act=n.toString(),this.rparam.expass=i,this.rparam.roomid=dt,this.watchInfoFlag=!1,s.ACT_PHASE.LOGIN_CONN;case s.ACT_PHASE.RELOGIN:return s.ACT_PHASE.LOGIN_CONN;case s.ACT_PHASE.LOGIN_CONN:var a=null;return this.rtcSignal.getCurServer()?(this.roomact.process(s.ACT_PROC.LOGIN_CONN,null),s.ACT_PHASE.SIG_LOGIN):(a=t[s.ACT_PROC.LOAD_DP])?(this.roomact.process(s.ACT_PROC.LOGIN_CONN,a),s.ACT_PHASE.SIG_LOGIN):(this.roomact.process(s.ACT_PROC.LOAD_DP),s.ACT_PHASE.LOGIN_CONN);case s.ACT_PHASE.SIG_LOGIN:return this.roomact.process(s.ACT_PROC.SIG_LOGIN,null,null,E.Signal_login_Timeout),K.DONE;case K.$.UN+s.ACT_PHASE.LOGIN:case K.$.UN+s.ACT_PHASE.RELOGIN:return K.DONE;case s.ACT_PHASE.LOGOUT:return s.ROOM_STATUS.PRELOGIN===this.room_status||s.ROOM_STATUS.LOGOUT_PROC===this.room_status?K.DONE:(this.room_status=s.ROOM_STATUS.LOGOUT_PROC,this.dpservact.stop(),s.ACT_PHASE.LOGOUT_STREAMS);case s.ACT_PHASE.LOGOUT_STREAMS:return this.roomact.process(s.ACT_PROC.LOGOUT_STREAMS),s.ACT_PHASE.LOGOUT_LOGOUT;case s.ACT_PHASE.LOGOUT_LOGOUT:return this.roomact.process(s.ACT_PROC.LOGOUT,null,null,E.Signal_logout_Timeout),K.DONE;case K.$.FIN+s.ACT_PHASE.LOGOUT_LOGOUT:return this.rtcSignal.close(),K.NULL}}function Nt(e,t){var r=this;switch(e){case s.ACT_PROC.LOGIN_CONN:this.rparam.loginConnStart=_.curTimeInMilli(),this.room_status=s.ROOM_STATUS.LOGIN_PROC,this.rparam.messConStart=_.curTimeInMilli(),this.rtcSignal.connect(t),this.event.timerAdd(Pt.TimerEvent.SIGNAL_CONNECT,1e4);break;case s.ACT_PROC.SIG_LOGIN:this.rparam.loginConnEnd=_.curTimeInMilli(),this.event.timerRemove(Pt.TimerEvent.SIGNAL_CONNECT),this.rtcSignal.sendLogin();break;case K.$.TO+s.ACT_PROC.SIG_LOGIN:Te.room({mess:{command:1024}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),this.roomact.repeat(s.ACT_PROC.SIG_LOGIN);break;case s.ACT_PROC.LOAD_DP:this.dpservact.start(s.ACT_PHASE.LOAD,null,(function(e,t){if(null===t){var i=null;null!=(i=e[s.DPKEYS.PUBLISH])&&r.rtcPusher.setServers(i),null!=(i=e[s.DPKEYS.WATCH])&&r.rtcPuller.setServers(i),null!=(i=e[s.DPKEYS.MESSAGE])&&r.roomact.finished(s.ACT_PROC.LOAD_DP,i)}else r.roomact.failed(s.ACT_PROC.LOAD_DP,t)}));break;case s.ACT_PROC.LOGOUT_STREAMS:var i,n,a,o,c=this.rtcPusher.getAllStreamIds(),u=this.rtcPuller.getAllStreamIds(),h=this,l=function(e,t,r){var i,n=r.exdata.getStreamId();(i=c.indexOf(n))>=0&&c.splice(i,1),(i=u.indexOf(n))>=0&&u.splice(i,1),0==c.length&&0==u.length&&h.roomact.finished(s.ACT_PROC.LOGOUT_STREAMS)};for(n=0,o=c.length;n<o;n++)i=c[n],this._unpush(i,l);for(a=0,o=u.length;a<o;a++)i=u[a],this._unpull(i,l);0==n&&0==a&&this.roomact.finished(s.ACT_PROC.LOGOUT_STREAMS);break;case K.$.FIN+s.ACT_PROC.LOGOUT_STREAMS:this.onUserlist([]),this.roomusers={};break;case s.ACT_PROC.LOGOUT:this.rtcSignal.sendLogout();break;case K.$.TO+s.ACT_PROC.LOGOUT:Te.room({mess:{command:128}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam),L().log(" ".concat(this.rparam.innerid,"  logout timeout"),"error"),this.roomact.finished(s.ACT_PROC.LOGOUT)}}function Ut(e,t,r){var i=s.ACT_FLOW.PRE_LOAD==K.getFlow(r);switch(this.rparam.reqKeystart=_.curTimeInMilli(),e){case s.ACT_PHASE.LOAD:return s.ACT_PHASE.LOAD_TOKEN;case s.ACT_PHASE.LOAD_TOKEN:return this.rparam.appid||this.dpservact.process(s.ACT_PROC.TOKEN),s.ACT_PHASE.LOAD_KEY_N_UID;case s.ACT_PHASE.LOAD_KEY_N_UID:return this.rparam.appid?(i||(this.rparam.roomname=me.roomnameFilter(this.rparam.roomname_string,this.rparam.appid),""===this.rparam.uid&&this.dpservact.process(s.ACT_PROC.UID,this.rparam.uid_string)),this.rparam.appkey||this.dpservact.process(s.ACT_PROC.KEY),s.ACT_PHASE.LOAD_DP):s.ACT_PHASE.LOAD_TOKEN;case s.ACT_PHASE.LOAD_CONFIG:return i||this.dpservact.process(s.ACT_PROC.LOAD_CONFIG),K.DONE;case s.ACT_PHASE.LOAD_DP:if(!i){if(!this.rparam.appkey||""===this.rparam.uid)return s.ACT_PHASE.LOAD_KEY_N_UID;this.dpservact.process(s.ACT_PROC.DP,this.rparam.uid,null,3e3)}return K.DONE;case K.$.FIN+s.ACT_PHASE.LOAD_DP:return delete t[s.ACT_PROC.DP_RETRY],K.NULL;case K.$.UN+s.ACT_PHASE.LOAD:return this.tokenLoader.close(),this.dpLoader.close(),this.uidLoader.close(),this.keyLoader.close(),K.DONE}}function Lt(e,t,r){switch(e){case s.ACT_PROC.TOKEN:this.tokenLoader.load(this.rparam.roomtoken);break;case K.$.FIN+s.ACT_PROC.TOKEN:s.ACT_NET_FAIL==t&&r.process(s.ACT_PROC.TOKEN_RETRY,null,null,E.Room_tk_Timeout);break;case s.ACT_PROC.TOKEN_RETRY:break;case K.$.TO+s.ACT_PROC.TOKEN_RETRY:this.connect_status=s.ChuangRoomState.DISCONNECTED,L().log("".concat(m.MSG.CHUANG_TOKEN_AUTH_FAILED),"warn"),this.emitsafe(Pt.Event.RoomStateUpdate,[this.rparam.roomId,this.connect_status,m.ErrorCode.CHUANG_TOKEN_AUTH_FAILED]),r.process(s.ACT_PROC.TOKEN),r.finished(s.ACT_PROC.TOKEN_RETRY);break;case s.ACT_PROC.UID:var i=t;this.uidLoader.load(this.rparam.appid,i);break;case K.$.FIN+s.ACT_PROC.UID:s.ACT_NET_FAIL==t&&r.process(s.ACT_PROC.UID_RETRY,null,null,E.Room_uid_Timeout);break;case s.ACT_PROC.UID_RETRY:break;case K.$.TO+s.ACT_PROC.UID_RETRY:r.process(s.ACT_PROC.UID,this.rparam.uid_string),r.finished(s.ACT_PROC.UID_RETRY);break;case s.ACT_PROC.KEY:this.keyLoader.load(this.rparam.appid);break;case K.$.FIN+s.ACT_PROC.KEY:s.ACT_NET_FAIL==t&&r.process(s.ACT_PROC.KEY_RETRY,null,null,E.Room_key_Timeout);break;case s.ACT_PROC.KEY_RETRY:break;case K.$.TO+s.ACT_PROC.KEY_RETRY:r.process(s.ACT_PROC.KEY),r.finished(s.ACT_PROC.KEY_RETRY);break;case s.ACT_PROC.LOAD_CONFIG:this.configLoader.load();break;case K.$.FIN+s.ACT_PROC.LOAD_CONFIG:s.ACT_NET_FAIL==t&&r.process(s.ACT_PROC.CONFIG_RETRY,null,null,E.Room_tk_Timeout);break;case s.ACT_PROC.CONFIG_RETRY:break;case K.$.TO+s.ACT_PROC.LOAD_CONFIG:r.process(s.ACT_PROC.CONFIG),r.finished(s.ACT_PROC.CONFIG_RETRY);case s.ACT_PROC.DP:var n=t;this.dpLoader.load(this.rparam.appkey,n);break;case K.$.FIN+s.ACT_PROC.DP:s.ACT_NET_FAIL==t&&r.process(s.ACT_PROC.DP_RETRY,null,null,E.Room_dp_Timeout);break;case s.ACT_PROC.DP_RETRY:break;case K.$.TO+s.ACT_PROC.DP_RETRY:r.process(s.ACT_PROC.DP,this.rparam.uid),r.finished(s.ACT_PROC.DP_RETRY)}}function Dt(e,t,r){var i=r.exdata,n=i.getStreamId();switch(e){case s.ACT_PHASE.PUSH:return this.rtcPusher.connectorExists(n)?K.SKIP:me.checkStreamChannel(this.rtcPusher,i)?(this.rtcPusher.newPusher(i),s.ACT_PHASE.LOAD_CONFIG):(r.setError(m(m.CODE.CHUANG_WEBRTC_CHANNEL_EXISTS)),K.DONE);case s.ACT_PHASE.LOAD_CONFIG:return r.process(s.ACT_PROC.LOAD_CONFIG),s.ACT_PHASE.SIG_AUTH_PUB;case s.ACT_PHASE.SIG_AUTH_PUB:return r.process(s.ACT_PROC.SIG_AUTH_PUB,null,null,E.Signal_authpublish_Timeout),s.ACT_PHASE.STM_ASK_SERVER;case s.ACT_PHASE.STM_ASK_SERVER:return r.process(s.ACT_PROC.STM_ASK_SERVER,i),K.DONE;case s.ACT_PHASE.REPUSH:return s.ACT_PHASE.SIG_START_PUB;case s.ACT_PHASE.SIG_START_PUB:return r.process(s.ACT_PROC.SIG_START_PUB,null,null,E.Signal_startpublish_Timeout),s.ACT_PHASE.SIG_SET_WATCH_INFO;case s.ACT_PHASE.SIG_START_PUB_FAIL:return r.process(s.ACT_PROC.STM_UNPUSH,!1),s.ACT_PHASE.SIG_AUTH_PUB;case s.ACT_PHASE.SIG_SET_WATCH_INFO:var a;return(a=this.rtcPuller.getCurServer())?(r.process(s.ACT_PROC.SIG_SET_WATCH_INFO,a,s.ACT_PROC.SIG_SET_WATCH_INFO,E.Signal_setwatchinfo_Timeout),s.ACT_PHASE.PUSH_FIN):(r.process(s.ACT_PROC.LOAD_DP),s.ACT_PHASE.SIG_SET_WATCH_INFO);case s.ACT_PHASE.PUSH_FIN:var o={streamId:n};return this.event.timerAdd(Pt.TimerEvent.PUSH_HEARTBEAT,-E.Signal_Stream_Heartbeat_Interval,o,Pt.TimerEvent.PUSH_HEARTBEAT+"-"+n),K.DONE;case K.$.UN+s.ACT_PHASE.PUSH:return r.process(s.ACT_PROC.STM_UNPUSH,!0),K.DONE;case s.ACT_PHASE.SIG_STOP_PUB:return this.rtcPusher.connectorExists(n)&&r.process(s.ACT_PROC.SIG_STOP_PUB,null,null,E.Signal_stoppublish_Timeout),s.ACT_PHASE.UNPUSH;case K.$.FIN+s.ACT_PHASE.SIG_STOP_PUB:return 0==this.rtcPusher.getAllStreamIds().length&&(this.watchInfoFlag=!1),this.event.timerRemove(Pt.TimerEvent.PUSH_HEARTBEAT+"-"+n),K.NULL;case s.ACT_PHASE.UNPUSH:return r.process(s.ACT_PROC.STM_UNPUSH,!0),K.DONE}}function yt(e,t,r){var i=this,n=r.exdata,a=n.getStreamId();switch(e){case s.ACT_PROC.LOAD_CONFIG:this.dpservact.start(s.ACT_PHASE.LOAD_CONFIG,null,(function(e,t){null===t?r.finished(s.ACT_PROC.LOAD_CONFIG):r.failed(s.ACT_PROC.LOAD_CONFIG)}));break;case s.ACT_PROC.SIG_AUTH_PUB:this.rtcSignal.sendAuthpublish(a);break;case K.$.TO+s.ACT_PROC.SIG_AUTH_PUB:Te.push({mess:{command:1}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,n.streaminConfig.videoWidth||0,n.streaminConfig.videoHeight||0),r.repeat(s.ACT_PROC.SIG_AUTH_PUB);break;case s.ACT_PROC.STM_ASK_SERVER:var o="act=0&appid="+this.rparam.appid+"&streamname="+t.streamId+"&roomname="+this.rparam.roomId+"&roomid="+this.rparam.roomid+"&uidstring="+(this.rparam.uid_string||"")+"&uid="+this.rparam.uid+"&bitrate="+t.streaminConfig.initBandwidth+"&clienttype=miniapp&";Le.newFollowLoader(this.event).load(0,o);break;case Le.Event.FOLLOW_FAIL:this.connact.finished(s.ACT_PROC.STM_ASK_SERVER,s.ACT_NET_FAIL);break;case s.ACT_PROC.SIG_START_PUB:var c=this.rtcPusher.getCurServer();if(!c)return r.process(s.ACT_PROC.LOAD_DP),s.ACT_PROC.SIG_START_PUB;var u=this.rtcPusher.getPusher(a).getStreamParam(c);this.rtcSignal.sendStartpublish(a,u);break;case K.$.TO+s.ACT_PROC.SIG_START_PUB:Te.push({mess:{command:2}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,n.streaminConfig.videoWidth||0,n.streaminConfig.videoHeight||0),r.repeat(s.ACT_PROC.SIG_START_PUB);break;case s.ACT_PROC.SIG_SET_WATCH_INFO:if(this.watchInfoFlag)r.finished(s.ACT_PROC.SIG_SET_WATCH_INFO);else{var h=t,l=_.parseUrl(h);this.swiStreamId=a,this.rtcSignal.sendSetwatchinfo(l)}break;case K.$.TO+s.ACT_PROC.SIG_SET_WATCH_INFO:r.repeat(s.ACT_PROC.SIG_SET_WATCH_INFO);break;case s.ACT_PROC.LOAD_DP:this.dpservact.start(s.ACT_PHASE.LOAD,null,(function(e,t){var n;null===t?(n=e[s.DPKEYS.WATCH])&&(i.rtcPuller.setServers(n),r.finished(s.ACT_PROC.LOAD_DP)):r.failed(s.ACT_PROC.LOAD_DP,t)}));break;case s.ACT_PROC.SIG_STOP_PUB:u=this.rtcPusher.getPusher(a).getStreamParam();this.rtcSignal.sendStoppublish(a,u);break;case K.$.TO+s.ACT_PROC.SIG_STOP_PUB:Te.push({mess:{command:4}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,a,n.streaminConfig.videoWidth||0,n.streaminConfig.videoHeight||0),r.finished(s.ACT_PROC.SIG_STOP_PUB);break;case s.ACT_PROC.STM_UNPUSH:if(!this.rtcPusher.getPusher(a))return void r.failed(s.ACT_PROC.STM_UNPUSH,!1);t&&this.rtcPusher.removeConnector(a),r.finished(s.ACT_PROC.STM_UNPUSH)}}function Mt(e,t,r){var i=r.exdata,n=i.getStreamId(),a=this.roomusers[n];switch(e){case s.ACT_PHASE.PULL:return this.rtcPuller.connectorExists(n)?K.SKIP:(a||(L().log("have no sparam"),Te.pull({},Te.CODES.REPORT_TYPE_PLAY_STREAM_NOT_FOUND,this.rparam,n,i.streaminConfig.videoWidth||0,i.streaminConfig.videoHeight||0)),i.setSparam(a),this.rtcPuller.newPuller(i),s.ACT_PHASE.LOAD_DP);case s.ACT_PHASE.LOAD_DP:return s.ACT_PHASE.STM_ASK_SERVER;case s.ACT_PHASE.STM_ASK_SERVER:return r.process(s.ACT_PROC.STM_ASK_SERVER,i),K.DONE;case s.ACT_PHASE.SIG_START_PULL:return r.process(s.ACT_PROC.SIG_START_PULL,a,null,E.Signal_startplay_Timeout),K.DONE;case K.$.UN+s.ACT_PHASE.PULL:return r.process(s.ACT_PROC.STM_UNPULL),K.DONE;case s.ACT_PHASE.SIG_STOP_PULL:return(o=this.rtcPuller.getPuller(n))&&r.process(s.ACT_PROC.SIG_STOP_PULL,o,null,E.Signal_stopplay_Timeout),s.ACT_PHASE.UNPULL;case s.ACT_PHASE.UNPULL:var o;return(o=this.rtcPuller.getPuller(n))&&r.process(s.ACT_PROC.STM_UNPULL),K.DONE}}function Gt(e,t,r){var i=r.exdata,n=i.getStreamId();switch(e){case s.ACT_PROC.STM_PULL:var a=t.uid,o=t.server;this.dpLoader.load(this.rparam.appkey,a,o,t.streamId);break;case s.ACT_PROC.STM_ASK_SERVER:var c="act=1&appid="+this.rparam.appid+"&streamname="+t.streamId+"&roomname="+this.rparam.roomId+"&roomid="+i.sparam.roomid+"&uidstring="+(i.sparam.uid_string||"")+"&uid="+i.sparam.uid+"&publish_ip="+i.sparam.pushaddr+"&publish_port="+i.sparam.pushport+"&bitrate="+t.sparam.bitrate+"&clienttype=miniapp&";Le.newFollowLoader(this.event).load(1,c);break;case s.ACT_PROC.SIG_START_PULL:var u=t;this.rtcSignal.sendStartplay(n,u);break;case K.$.TO+s.ACT_PROC.SIG_START_PULL:r.repeat(s.ACT_PROC.SIG_START_PULL);break;case s.ACT_PROC.SIG_STOP_PULL:var _=t;this.rtcSignal.sendStopplay(n,_.getStream(),_.getDuration());break;case K.$.TO+s.ACT_PROC.SIG_STOP_PULL:Te.push({mess:{command:512}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,n,0,0),r.finished(s.ACT_PROC.SIG_STOP_PULL);break;case s.ACT_PROC.STM_UNPULL:if(!(_=this.rtcPuller.getPuller(n)))return void r.failed(s.ACT_PROC.STM_UNPULL,!1);this.rtcPuller.removeConnector(n),r.finished(s.ACT_PROC.STM_UNPULL)}}function kt(e,t){switch(e){case s.ACT_PHASE.MIX_START:if(this.mix_status==s.MIX_STATUS.START)return K.SKIP;this.mixStreamConfig=t,this.mergeinfo.userlist=this._getStreamMixItems(),this.mergeinfo.streamcount=this.mergeinfo.userlist.length.toString();var r=_.parseUrl(this.mixStreamConfig.rtmpAddress);return r&&r.host&&r.path?(this.mergeinfo.rtmpaddr=r.host,this.mergeinfo.rtmpport=r.port?r.port.toString:"1935",this.mergeinfo.appname=r.path.substr(1),this.mergeinfo.mergestreamid=this.mixStreamConfig.outputStremId,this.mergeinfo.gain=E.Mix_Stream_Gain,this.mergeinfo.backid=E.Mix_Stream_Back,this.mergeinfo.resolution=this.mixStreamConfig.outputVideoResolution,this.mergeinfo.bitrate=this.mixStreamConfig.outputVideoBitrate,this.mergeinfo.roomname=this.rparam.roomname,this.mergeinfo.masterroomid=this.mergeinfo.userlist[0].roomid,this.mergeinfo.merge_uid=this.rparam.uid,this.mergeinfo.expass=this.rparam.uid,this.mergeinfo.curtime=_.curTime().toString(),this.mergeinfo.appid=this.rparam.appid,s.ACT_PHASE.MIX_STARTIN):(Te.mix({},Te.CODES.REPORT_TYPE_MESS_MERGE_FAILED_INVALID_RTMP_ADDR,this.rparam,this.mixStreamConfig.outputStremId,this.getMixSize(this.mixStreamConfig).mixWidth,this.getMixSize(this.mixStreamConfig).mixHeight),this.mixact.setError(m(m.CODE.CHUANG_MIX_STREAM_ADDRESS_INVALID)),K.DONE);case K.$.UN+s.ACT_PHASE.MIX_START:return K.DONE;case s.ACT_PHASE.MIX_STARTIN:return this.mixact.process(s.ACT_PROC.MIX_STARTIN),K.DONE;case s.ACT_PHASE.MIX_UPDATE:return this.mix_status==s.MIX_STATUS.PRESTART||this.mix_status==s.MIX_STATUS.STOP?K.SKIP:(this.mixStreamConfig.mixStreams=t,this.mergeinfo.userlist=this._getStreamMixItems(),K.DONE);case s.ACT_PHASE.MIX_STOP:return s.ACT_PHASE.MIX_STOPIN;case s.ACT_PHASE.MIX_STOPIN:return this.mixact.process(s.ACT_PROC.MIX_STOPIN),K.DONE}}function Ht(e){var t=this;switch(e){case s.ACT_PROC.MIX_STARTIN:this.mixinact.start(s.ACT_PHASE.MIXIN_START,null,(function(e,r,i){null===r||t.mixact.failed(s.ACT_PROC.MIX_STARTIN,r)}));break;case s.ACT_PROC.MIX_STOPIN:this.mixinact.start(s.ACT_PHASE.MIXIN_STOP,null,(function(e,r,i){null==r?t.mix_status=s.MIX_STATUS.STOP:t.mixact.failed(s.ACT_PROC.MIX_STOPIN,r)}))}}function bt(e,t){switch(e){case s.ACT_PHASE.MIXIN_START:return s.ACT_PHASE.SIG_REQMERGE;case K.$.UN+s.ACT_PHASE.MIXIN_START:return this.event.timerRemove(Pt.TimerEvent.MIX_REQMERGESTAT),K.DONE;case s.ACT_PHASE.SIG_REQMERGE:var r;if(r=this.rtcPusher.getCurServer()){var i=_.parseUrl(r);return this.mergeinfo.pushaddr=i.host,this.mergeinfo.pushport=i.port.toString(),this.mixinact.process(s.ACT_PROC.SIG_REQMERGE,null,null,E.Signal_reqmerge_Timeout),s.ACT_PHASE.SIG_REQMERGESTAT}return this.mixinact.process(s.ACT_PROC.LOAD_DP),s.ACT_PHASE.SIG_REQMERGE;case s.ACT_PHASE.SIG_REQMERGESTAT:return this.mixinact.process(s.ACT_PROC.SIG_REQMERGESTAT),s.ACT_PHASE.SIG_REQMERGESTAT_DELAY;case s.ACT_PHASE.SIG_REQMERGESTAT_DELAY:var n=t[s.ACT_PROC.SIG_REQMERGESTAT];return n&&this.mixinact.process(s.ACT_PROC.SIG_REQMERGESTAT_DELAY,null,null,n),s.ACT_PHASE.SIG_REQMERGESTAT;case s.ACT_PHASE.MIXIN_RESTART_DELAY:return this.mixinact.process(s.ACT_PROC.MIXIN_RESTART_DELAY,null,null,1e3),s.ACT_PHASE.MIXIN_RESTART;case s.ACT_PHASE.MIXIN_RESTART:return this.mixinact.process(s.ACT_PROC.SIG_STOPMERGE,null,null,E.Signal_stopmerge_Timeout),s.ACT_PHASE.SIG_REQMERGE;case s.ACT_PHASE.MIXIN_STOP:return this.mixinact.process(s.ACT_PROC.SIG_STOPMERGE,null,null,1e3),K.DONE}}function xt(e,t){var r=this;switch(e){case s.ACT_PROC.SIG_REQMERGE:this.rtcSignal.sendReqMerge(this.mergeinfo);break;case K.$.TO+s.ACT_PROC.SIG_REQMERGE:Te.mix({mess:{command:16}},Te.CODES.REPORT_TYPE_MESS_MERGE_RESTART_PROGRESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.repeat(s.ACT_PROC.SIG_REQMERGE);break;case s.ACT_PROC.SIG_REQMERGESTAT:this.rtcSignal.sendReqmergeStat(this.mergeinfo);break;case K.$.TO+s.ACT_PROC.SIG_REQMERGESTAT:Te.mix({mess:{command:16}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,this.getMixSize(this.mergeinfo).mixWidth,this.getMixSize(this.mergeinfo).mixHeight),this.mixinact.repeat(s.ACT_PROC.SIG_REQMERGESTAT);break;case s.ACT_PROC.SIG_REQMERGESTAT_DELAY:break;case K.$.TO+s.ACT_PROC.SIG_REQMERGESTAT_DELAY:this.mixinact.finished(s.ACT_PROC.SIG_REQMERGESTAT_DELAY);break;case s.ACT_PROC.MIXIN_RESTART_DELAY:break;case K.$.TO+s.ACT_PROC.MIXIN_RESTART_DELAY:this.mixinact.finished(s.ACT_PROC.MIXIN_RESTART_DELAY);break;case s.ACT_PROC.LOAD_DP:this.dpservact.start(s.ACT_PHASE.LOAD,null,(function(e,t){var i;null===t?(i=e[s.DPKEYS.PUBLISH])&&(r.rtcPusher.setServers(i),r.mixinact.finished(s.ACT_PROC.LOAD_DP)):r.mixinact.failed(s.ACT_PROC.LOAD_DP,t)}));break;case s.ACT_PROC.SIG_STOPMERGE:this.rtcSignal.sendStopMerge(this.mergeinfo);break;case K.$.TO+s.ACT_PROC.SIG_STOPMERGE:Te.mix({mess:{command:32}},Te.CODES.REPORT_TYPE_MESS_TASK_PROCESS_TIMEOUT,this.rparam,this.mergeinfo.outputStremId,0,0),this.mixinact.isPhase(s.ACT_PHASE.MIXIN_RESTART)?this.mixact.repeat(s.ACT_PROC.SIG_STOPMERGE):this.mixact.finished(s.ACT_PROC.SIG_STOPMERGE)}}K.onQueue(/room.*/,(function(e,t){t.phase0==s.ACT_PHASE.LOGOUT&&(K.cutail(t.actTag),(e[0].phase0==s.ACT_PHASE.LOGIN||e[0].phase0==s.ACT_PHASE.RELOGIN)&&this.cancel()),t.phase0==s.ACT_PHASE.LOGIN&&(K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.LOGOUT&&this.cancel())})),K.setProcKey(s.ACT_PROC.SIG_SET_WATCH_INFO),K.onQueue(/pushx-.*/,(function(e,t){t.phase0==s.ACT_PHASE.UNPUSH&&(K.cutail(t.actTag),e[0].phase0!=s.ACT_PHASE.PUSH&&e[0].phase0!=s.ACT_PHASE.REPUSH||this.cancel()),t.phase0==s.ACT_PHASE.REPUSH&&(e[0].phase0==s.ACT_PHASE.REPUSH&&K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.UNPUSH&&this.cancel()),t.phase0==s.ACT_PHASE.PUSH&&e[0].phase0==s.ACT_PHASE.UNPUSH&&this.cancel()})),K.onQueue(/pullx-.*/,(function(e,t){t.phase0==s.ACT_PHASE.UNPULL&&(K.cutail(t.actTag),e[0].phase0!=s.ACT_PHASE.PULL&&e[0].phase0!=s.ACT_PHASE.REPULL||this.cancel()),t.phase0==s.ACT_PHASE.REPULL&&(e[0].phase0==s.ACT_PHASE.PULL&&K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.UNPULL&&K.cutail(e[0].actTag)),t.phase0==s.ACT_PHASE.PULL&&e[0].phase0==s.ACT_PHASE.UNPULL&&K.cutail(e[0].actTag)})),K.onQueue(/mix-.*/,(function(e,t){t.phase0==s.ACT_PHASE.MIX_STOP?(K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.MIX_START&&this.cancel()):t.phase0==s.ACT_PHASE.MIX_START&&(K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.MIX_STOP&&this.cancel())})),K.onQueue(/mixin-.*/,(function(e,t){t.phase0==s.ACT_PHASE.MIXIN_STOP&&(K.cutail(t.actTag),e[0].phase0==s.ACT_PHASE.MIXIN_START&&this.cancel())}));const wt={inited:!1,uuid:_.uuid(),clientId:_.randomString(6),startTime:0,appId:"",serAppid:"",isIOS:!1,sysver:"",devmodel:"",defroom:null,rooms:{},roomId:100,isActive:!0,init:function(e,t){if(this.serAppid=e.appkey,!e||!e.appid){var r=m(m.CODE.CHUANG_APPID_NULL);return L().log(r.msg,"error"),t&&t(r),!1}if(!e.appkey){r=m(m.CODE.CHUANG_APPKEY_NULL);return L().log(r.msg,"error"),t&&t(r),!1}return-1!=e.appid.indexOf("-")?this.appId=e.appid:this.appId=e.appkey,this.inited?(L().log("SDK has been inited!"),!0):(this.inited=!0,wx.onNetworkStatusChange((function(e){L().log("当前网络状态为："+e.isConnected+"网络类型为："+e.networkType),Te.room("",Te.CODES.REPORT_TYPE_NETWORK_CHANGE,{})})),!0)},initroom:function(e,t){if(!e.appid){var r=m(m.CODE.CHUANG_APPID_NULL);return _t.report(r,_t.ACTION.INITROOM,this.appId),void(t&&t(r))}if(!e.appkey){r=m(m.CODE.CHUANG_APPKEY_NULL);return _t.report(r,_t.ACTION.INITROOM,this.appId),void(t&&t(r))}var i=new vt(e,this.roomId);return!this.defroom&&(this.defroom=i),this.rooms[this.roomId++]=i,i.SDKVERSION=this.getSDKVersion(),i},getroom:function(e){return this.rooms[e]},delroom:function(e){var t=this.rooms[e];t&&t.uninit(),delete this.rooms[e]},uninit:function(e){for(var t in this.inited=!1,this.rooms)e&&this.rooms[t].rtcSignal.socket.stopReconnect(),this.rooms[t].logoutRoom(),this.rooms[t].uninit(),K.remove(this.rooms[t].mixinact.uid),K.remove(this.rooms[t].mixact.uid),K.remove(this.rooms[t].roomact.uid),delete this.rooms[t];this.defroom=null},getSDKVersion:function(){return"Mini-"+s.SDKVERSION+"-202111021554"},getDeviceInfo:function(){var e={};return wx.getSystemInfo({success:function(t){e.brand=t.brand,e.devmodel=t.model,e.wechat_version=t.version,e.sysver=t.system,e.platform=t.platform,e.SDKVersion=t.SDKVersion,e.benchmarkLevel=t.benchmarkLevel}}),e}};function Ft(e){return function(t){e&&e(t.no)}}var Yt={VERSION:s.SDKVERSION,BUILD:s.BUILD,ChuangUserRole:s.ChuangUserRole,ChuangPublishChannel:s.ChuangPublishChannel,ChuangStreamMode:s.ChuangStreamMode,ChuangRoomState:s.ChuangRoomState,ChuangMixResolutions:s.ChuangMixResolutions,ChuangEvent:vt.Event,ChuangErrorCode:m.ErrorCode,ChuangPublishState:s.ChuangPublishState,ChuangPlayState:s.ChuangPlayState,ChuangStreamUpdateType:s.ChuangStreamUpdateType,ChuangStreamState:s.ChuangStreamState,ChuangPlayStreamEvent:s.ChuangPlayStreamEvent,ChuangVideoConfigPreset:s.ChuangVideoConfigPreset,ChuangLogLevel:s.ChuangLogLevel,ChuangNoticeCode:s.ChuangNoticeCode,SCREEN_LEVEL:s.SCREEN_LEVEL,initEngine:function(e,t,r){L().log("ChuangLiveEngine SDK inited. clientId is: ["+wt.clientId+"]");var i=Ft(r),s={appid:e,appkey:t};return!!wt.init(s,i)&&(wt.initroom(s,i),L().log("ChuangLiveEngine SDK inited. clientId is: ["+wt.clientId+"]"),!0)},uninitEngine:function(){wt.uninit()},setLogLevel:function(e){L().setLogLevel(e)},setRole:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.setRole(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},on:function(e,t){return wt.defroom&&wt.defroom.on(e,t),Yt},off:function(e,t){return wt.defroom&&wt.defroom.off(e,t),Yt},getPreRoomState:function(){return s.ChuangRoomState.DISCONNECTED},getRoomConnectState:function(){return wt.defroom?wt.defroom.getRoomConnectState():this.getPreRoomState()},loginRoom:function(e,t,r,i){var s=Ft(i);wt.defroom?wt.defroom.loginRoom(e,t,r,s):wt.isActive&&s(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},logoutRoom:function(e){var t=Ft(e);wt.defroom?wt.defroom.logoutRoom(t):wt.isActive&&t(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},newStreamConfig:function(e){return new O(e)},startPublishStream:function(e,t,r){var i=Ft(r);wt.defroom?wt.defroom.publishStream(e,t,i):wt.isActive&&i(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},sendStartPublishSignal:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.sendStartPublishSignal(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},sendStartPlaySingal:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.sendStartPlaySingal(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},playNextConn:function(e,t,r){var i=Ft(r);wt.defroom?wt.defroom.playNextConn(e,t,i):wt.isActive&&i(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},pushNextConn:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.pushNextConn(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},stopPublishStream:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.unpublishStream(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},startMixStream:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.startMixStream(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},updateMixStream:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.updateMixStream(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},stopMixStream:function(e){var t=Ft(e);wt.defroom?wt.defroom.stopMixStream(t):wt.isActive&&t(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},startPlayStream:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.playStream(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},stopPlayStream:function(e,t){var r=Ft(t);wt.defroom?wt.defroom.unplayStream(e,r):wt.isActive&&r(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},startPlayRoomStream:function(e,t,r,i){var s=Ft(i);wt.defroom?wt.defroom.playStream(e,t,r,s):wt.isActive&&s(m(m.CODE.CHUANG_ENGINE_NOT_INIT))},statusNotification:function(e,t,r,i){var s=Ft(i);(wt.defroom||402!=t)&&(wt.defroom?wt.defroom.statusNotification(e,t,r,s):wt.isActive&&s(m(m.CODE.CHUANG_ENGINE_NOT_INIT)))},getSDKVersion:function(){return wt.getSDKVersion()},resume:function(e){return wt.defroom?wt.defroom.resume(e):null},resumeAll:function(){return wt.defroom?wt.defroom.resumeAll():null}};const Kt=Yt})(),i})()}));